
> manuscript-upload-api@1.0.0 test
> cross-env NODE_ENV=test TEST_DATABASE_URL=postgresql://postgres:Bjoran32!@192.168.68.52:5432/manuscript_platform_test vitest run


 RUN  v3.2.4 /mnt/d/manuscript-platform

stdout | tests/integration/handlers/payment-handlers.test.js
[dotenv@17.2.3] injecting env (0) from .env.local -- tip: âš™ï¸  suppress all logs with { quiet: true }
Initializing adapters...
âœ“ Database adapter initialized
âœ“ Storage adapter initialized
âš  Running in test mode without Redis - using in-memory session store

stdout | tests/integration/handlers/payment-handlers.test.js
âœ“ Session store initialized
âœ“ Cache adapter initialized
âœ“ Queue service initialized
âœ“ Environment initialized
âœ“ Session middleware applied
[VirusScanner] Initializing ClamAV at localhost:3310...

stderr | tests/integration/handlers/payment-handlers.test.js
[VirusScanner] Failed to initialize: connect ECONNREFUSED 127.0.0.1:3310

stderr | tests/integration/handlers/payment-handlers.test.js
âš  Virus scanner initialization failed (uploads will continue without scanning)

stdout | tests/integration/handlers/payment-handlers.test.js

ðŸ§ª Setting up test environment...
ðŸ”Œ Attempting to connect to test database...
ðŸ“ Host: 192.168.68.52:5432, Database: manuscript_platform_test

stdout | tests/integration/handlers/payment-handlers.test.js
âœ“ Test database connected

stdout | tests/integration/handlers/payment-handlers.test.js
  Applying base schema...

stdout | tests/integration/handlers/payment-handlers.test.js
  âœ“ Schema and migrations applied

stdout | tests/integration/handlers/payment-handlers.test.js
âœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

stdout | tests/integration/handlers/payment-handlers.test.js
âœ“ Test database initialized
âœ“ Test environment ready


[0mPOST /auth/login [32m200[0m 1542.547 ms - 128[0m
[0mPOST /create-checkout-session [33m400[0m 82.919 ms - 29[0m
[0mPOST /auth/login [32m200[0m 74.129 ms - 128[0m
[0mPOST /create-checkout-session [33m401[0m 8.552 ms - 24[0m
[0mPOST /auth/login [32m200[0m 78.850 ms - 128[0m
[0mPOST /create-checkout-session [33m400[0m 6.470 ms - 29[0m
[0mPOST /auth/login [32m200[0m 84.934 ms - 128[0m
[0mPOST /create-checkout-session [33m400[0m 6.218 ms - 29[0m
[0mPOST /auth/login [32m200[0m 171.787 ms - 128[0m
[0mPOST /create-checkout-session [33m400[0m 5.008 ms - 29[0m
[0mPOST /auth/login [32m200[0m 78.078 ms - 128[0m
[0mPOST /create-checkout-session [33m400[0m 7.488 ms - 29[0m
[0mPOST /auth/login [32m200[0m 258.842 ms - 128[0m
[0mPOST /create-checkout-session [33m400[0m 5.614 ms - 29[0m
[0mPOST /auth/login [32m200[0m 78.722 ms - 128[0m
[0mPOST /create-checkout-session [33m400[0m 7.091 ms - 29[0m
[0mPOST /auth/login [32m200[0m 71.376 ms - 128[0m
[0mPOST /create-checkout-session [33m400[0m 5.419 ms - 29[0m
[0mPOST /auth/login [32m200[0m 519.291 ms - 128[0m
[0mPOST /create-checkout-session [33m400[0m 3.317 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should accept webhook with valid signature
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 4.507 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should reject webhook with invalid signature
[Webhook] Signature verification failed: Unable to extract timestamp and signatures from header

[0mPOST /webhooks/stripe [33m400[0m 2.207 ms - 29[0m
[0mPOST /webhooks/stripe [33m400[0m 0.892 ms - 33[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should reject webhook with expired signature (>5 minutes)
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.776 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should reject replay attacks (duplicate event ID)
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 3.030 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should reject replay attacks (duplicate event ID)
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.674 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should handle malformed signature header
[Webhook] Signature verification failed: Unable to extract timestamp and signatures from header

[0mPOST /webhooks/stripe [33m400[0m 2.348 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should log signature verification failures
[Webhook] Signature verification failed: Unable to extract timestamp and signatures from header

[0mPOST /webhooks/stripe [33m400[0m 2.084 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should return 400 for invalid signatures (not 500)
[Webhook] Signature verification failed: Unable to extract timestamp and signatures from header

[0mPOST /webhooks/stripe [33m400[0m 1.923 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle checkout.session.completed - activate subscription
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 2.514 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle checkout.session.completed - record payment
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 2.755 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle customer.subscription.updated - sync status
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.467 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle customer.subscription.deleted - downgrade to free
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.591 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle customer.subscription.deleted - preserve data
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.374 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle invoice.payment_succeeded - record payment
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.671 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle invoice.payment_succeeded - extend billing period
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.568 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle invoice.payment_failed - mark past_due
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 2.360 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle invoice.payment_failed - cancel after 3 failures
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 2.297 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should ignore unhandled event types
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.397 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle duplicate webhook deliveries (idempotent)
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.999 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle duplicate webhook deliveries (idempotent)
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.914 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle webhook for deleted user gracefully
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 2.214 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle malformed webhook data gracefully
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.372 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should log all webhook events
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.481 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should return 200 for all webhooks (even errors)
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.928 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should process webhook in under 5 seconds
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 2.520 ms - 29[0m
[0mPOST /auth/login [32m200[0m 127.899 ms - 132[0m
[0mGET /subscription [32m200[0m 13.328 ms - 221[0m
[0mPOST /auth/login [32m200[0m 363.248 ms - 132[0m
[0mGET /subscription [33m401[0m 6.612 ms - 24[0m
[0mPOST /auth/login [32m200[0m 82.823 ms - 132[0m
[0mGET /subscription [32m200[0m 12.449 ms - 114[0m
[0mPOST /auth/login [32m200[0m 80.279 ms - 132[0m
[0mGET /subscription [32m200[0m 12.774 ms - 221[0m
[0mPOST /auth/login [32m200[0m 238.715 ms - 132[0m
[0mGET /subscription [32m200[0m 12.736 ms - 221[0m
[0mPOST /auth/login [32m200[0m 71.943 ms - 135[0m
[0mGET /payment-history [32m200[0m 10.340 ms - 484[0m
[0mPOST /auth/login [32m200[0m 245.767 ms - 135[0m
[0mGET /payment-history [33m401[0m 8.082 ms - 24[0m
[0mPOST /auth/login [32m200[0m 103.945 ms - 135[0m
[0mGET /payment-history [32m200[0m 8.976 ms - 15[0m
[0mPOST /auth/login [32m200[0m 88.041 ms - 135[0m
[0mGET /payment-history [32m200[0m 12.489 ms - 484[0m
[0mPOST /auth/login [32m200[0m 241.759 ms - 135[0m
[0mGET /payment-history [32m200[0m 9.999 ms - 484[0m
[0mPOST /auth/login [32m200[0m 72.385 ms - 134[0m
[0mPOST /auth/login [32m200[0m 138.809 ms - 134[0m
[0mPOST /auth/login [32m200[0m 260.167 ms - 134[0m
[0mPOST /auth/login [32m200[0m 78.679 ms - 134[0m
[0mPOST /auth/login [32m200[0m 259.422 ms - 134[0m
[0mPOST /auth/login [32m200[0m 83.546 ms - 134[0m
[0mPOST /auth/login [32m200[0m 77.705 ms - 134[0m
[0mPOST /auth/login [32m200[0m 255.115 ms - 134[0m
[0mPOST /auth/login [32m200[0m 389.657 ms - 134[0m
[0mPOST /auth/login [32m200[0m 74.644 ms - 134[0m
stdout | tests/integration/handlers/payment-handlers.test.js

ðŸ§¹ Tearing down test environment...

stdout | tests/integration/handlers/payment-handlers.test.js
âœ“ Test database cleaned

stdout | tests/integration/handlers/payment-handlers.test.js
âœ“ Database adapter closed

stdout | tests/integration/handlers/payment-handlers.test.js
âœ“ Test database disconnected

stdout | tests/integration/handlers/payment-handlers.test.js
âœ“ Test database cleaned up
âœ“ Test environment cleaned up


 âœ“ tests/integration/handlers/payment-handlers.test.js (54 tests) 129759ms
   âœ“ Payment & Webhook Handlers > POST /create-checkout-session > should create checkout session for valid subscription  3240ms
   âœ“ Payment & Webhook Handlers > POST /create-checkout-session > should require authentication for checkout  1638ms
   âœ“ Payment & Webhook Handlers > POST /create-checkout-session > should reject invalid price IDs  1635ms
   âœ“ Payment & Webhook Handlers > POST /create-checkout-session > should include userId in session metadata  1643ms
   âœ“ Payment & Webhook Handlers > POST /create-checkout-session > should handle missing priceId field  2651ms
   âœ“ Payment & Webhook Handlers > POST /create-checkout-session > should handle missing planType field  2269ms
   âœ“ Payment & Webhook Handlers > POST /create-checkout-session > should create customer if not exists  2475ms
   âœ“ Payment & Webhook Handlers > POST /create-checkout-session > should set correct success and cancel URLs  1850ms
   âœ“ Payment & Webhook Handlers > POST /create-checkout-session > should handle Stripe API errors gracefully  1718ms
   âœ“ Payment & Webhook Handlers > POST /create-checkout-session > should log checkout session creation  2588ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should accept webhook with valid signature  2236ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should reject webhook with invalid signature  1542ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should reject webhook with missing signature  1637ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should reject webhook with expired signature (>5 minutes)  3198ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should reject replay attacks (duplicate event ID)  1469ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should handle malformed signature header  2704ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should log signature verification failures  2528ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should return 400 for invalid signatures (not 500)  1463ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle checkout.session.completed - activate subscription  2342ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle checkout.session.completed - record payment  1683ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle customer.subscription.updated - sync status  1552ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle customer.subscription.deleted - downgrade to free  2574ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle customer.subscription.deleted - preserve data  2437ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle invoice.payment_succeeded - record payment  2010ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle invoice.payment_succeeded - extend billing period  2213ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle invoice.payment_failed - mark past_due  1864ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle invoice.payment_failed - cancel after 3 failures  1794ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should ignore unhandled event types  2563ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle duplicate webhook deliveries (idempotent)  2517ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle webhook for deleted user gracefully  2507ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle malformed webhook data gracefully  1635ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should log all webhook events  1546ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should return 200 for all webhooks (even errors)  2191ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should process webhook in under 5 seconds  2455ms
   âœ“ Payment & Webhook Handlers > GET /subscription > should return current subscription details  1820ms
   âœ“ Payment & Webhook Handlers > GET /subscription > should require authentication  2338ms
   âœ“ Payment & Webhook Handlers > GET /subscription > should return free plan for users without subscription  2480ms
   âœ“ Payment & Webhook Handlers > GET /subscription > should include Stripe subscription ID  1623ms
   âœ“ Payment & Webhook Handlers > GET /subscription > should include current period dates  2947ms
   âœ“ Payment & Webhook Handlers > GET /payment-history > should return payment history for user  1927ms
   âœ“ Payment & Webhook Handlers > GET /payment-history > should require authentication  2728ms
   âœ“ Payment & Webhook Handlers > GET /payment-history > should return empty array for no payments  2451ms
   âœ“ Payment & Webhook Handlers > GET /payment-history > should order payments by date (newest first)  1682ms
   âœ“ Payment & Webhook Handlers > GET /payment-history > should not include other users payments  3427ms
   âœ“ Payment & Webhook Handlers > Usage Tracking > should track manuscript analysis usage  1647ms
   âœ“ Payment & Webhook Handlers > Usage Tracking > should track different analysis types  2651ms
   âœ“ Payment & Webhook Handlers > Usage Tracking > should track asset generation separately  3334ms
   âœ“ Payment & Webhook Handlers > Usage Tracking > should calculate usage within billing period  1683ms
   âœ“ Payment & Webhook Handlers > Usage Tracking > should separate usage across different billing periods  2856ms
   âœ“ Payment & Webhook Handlers > Usage Tracking > should track usage for users without subscription (pay-per-use)  1737ms
   âœ“ Payment & Webhook Handlers > Usage Tracking > should link usage to specific manuscript  1759ms
   âœ“ Payment & Webhook Handlers > Usage Tracking > should accumulate credits across multiple analyses  3834ms
   âœ“ Payment & Webhook Handlers > Usage Tracking > should track timestamp for usage analytics  2562ms
   âœ“ Payment & Webhook Handlers > Usage Tracking > should delete usage records when manuscript is deleted (CASCADE)  2482ms
stdout | process.<anonymous> (/mnt/d/manuscript-platform/tests/setup.js:115:11)

âš  Received SIGTERM, cleaning up...

stdout | tests/integration/handlers/auth-handlers.test.js

ðŸ§ª Setting up test environment...
ðŸ”Œ Attempting to connect to test database...
ðŸ“ Host: 192.168.68.52:5432, Database: manuscript_platform_test

stdout | tests/integration/handlers/auth-handlers.test.js
âœ“ Test database connected

stdout | tests/integration/handlers/auth-handlers.test.js
  Applying base schema...

stdout | tests/integration/handlers/auth-handlers.test.js
  âœ“ Schema and migrations applied

stdout | tests/integration/handlers/auth-handlers.test.js
âœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

stdout | tests/integration/handlers/auth-handlers.test.js
âœ“ Test database initialized
âœ“ Test environment ready


stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should register a new user with valid credentials
[Payment] Free subscription created for user b3d8602c-5ab2-41c3-9e9f-64b3199f43be

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should register a new user with valid credentials
Verification email sent to: newuser@example.com

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should hash password with bcrypt
[Payment] Free subscription created for user 2b891759-b305-4d67-bc31-20f2dc6598d6

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should hash password with bcrypt
Verification email sent to: bcrypt-test@example.com

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should normalize email to lowercase
[Payment] Free subscription created for user 8756b0a9-bbf3-458f-ab46-5921f3a24885

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should normalize email to lowercase
Verification email sent to: casesensitive@example.com

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should create verification token
[Payment] Free subscription created for user b9ebddaa-15c6-47ca-bb60-e5e1f58c6320

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should create verification token
Verification email sent to: verify-test@example.com

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should send verification email
[Payment] Free subscription created for user 3d2e7e34-b157-49e6-85a2-a293891efade

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should send verification email
Verification email sent to: email-test@example.com

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should log registration event in audit log
[Payment] Free subscription created for user cc8b5a9e-3ee0-492d-9927-1edf1b21e3fa

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should log registration event in audit log
Verification email sent to: audit-test@example.com

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should set default role to author if not specified
[Payment] Free subscription created for user 425b03ba-42e1-4f63-95fc-9136e98adb88

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should set default role to author if not specified
Verification email sent to: default-role@example.com

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should reject login with non-existent email
[Audit] Skipping audit log for login_failed - no valid user_id

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/verify-email > should verify email with valid token
Cache delete many error: TypeError: Cannot read properties of undefined (reading 'delete')
    at [90m/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:109:49
    at Array.map (<anonymous>)
    at CacheManager.deleteMany [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:109:30[90m)[39m
    at UserCache.invalidate [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:185:22[90m)[39m
    at Module.handleVerifyEmail [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:455:22[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:519:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/verify-email > should verify email with valid token
Cache INVALIDATED: user a1159fb54453cdb88ba635fd10027b10

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/verify-email > should log email verification event
Cache delete many error: TypeError: Cannot read properties of undefined (reading 'delete')
    at [90m/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:109:49
    at Array.map (<anonymous>)
    at CacheManager.deleteMany [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:109:30[90m)[39m
    at UserCache.invalidate [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:185:22[90m)[39m
    at Module.handleVerifyEmail [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:455:22[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:618:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/verify-email > should log email verification event
Cache INVALIDATED: user 1280801bf34f4302b9961916a2608d17

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should create password reset token for valid email
Failed to send password reset email: Error: Failed to send email: <html>
<head><title>401 Authorization Required</title></head>
<body>
<center><h1>401 Authorization Required</h1></center>
<hr><center>nginx/1.27.1</center>
</body>
</html>

    at sendPasswordResetEmail [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:834:11[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:537:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:653:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should send password reset email
Failed to send password reset email: Error: Failed to send email: <html>
<head><title>401 Authorization Required</title></head>
<body>
<center><h1>401 Authorization Required</h1></center>
<hr><center>nginx/1.27.1</center>
</body>
</html>

    at sendPasswordResetEmail [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:834:11[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:537:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:677:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should rate limit password reset requests
Failed to send password reset email: Error: Failed to send email: <html>
<head><title>401 Authorization Required</title></head>
<body>
<center><h1>401 Authorization Required</h1></center>
<hr><center>nginx/1.27.1</center>
</body>
</html>

    at sendPasswordResetEmail [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:834:11[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:537:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:723:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should rate limit password reset requests
Failed to send password reset email: Error: Failed to send email: <html>
<head><title>401 Authorization Required</title></head>
<body>
<center><h1>401 Authorization Required</h1></center>
<hr><center>nginx/1.27.1</center>
</body>
</html>

    at sendPasswordResetEmail [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:834:11[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:537:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:723:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should rate limit password reset requests
Failed to send password reset email: Error: Failed to send email: <html>
<head><title>401 Authorization Required</title></head>
<body>
<center><h1>401 Authorization Required</h1></center>
<hr><center>nginx/1.27.1</center>
</body>
</html>

    at sendPasswordResetEmail [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:834:11[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:537:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:723:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should normalize email to lowercase
Failed to send password reset email: Error: Failed to send email: <html>
<head><title>401 Authorization Required</title></head>
<body>
<center><h1>401 Authorization Required</h1></center>
<hr><center>nginx/1.27.1</center>
</body>
</html>

    at sendPasswordResetEmail [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:834:11[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:537:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:757:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should log password reset request
Failed to send password reset email: Error: Failed to send email: <html>
<head><title>401 Authorization Required</title></head>
<body>
<center><h1>401 Authorization Required</h1></center>
<hr><center>nginx/1.27.1</center>
</body>
</html>

    at sendPasswordResetEmail [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:834:11[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:537:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:804:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > GET /auth/me > should return current user with valid session
Cache get error for key user:fe6b823c20b67b34fc25320dd6264440: TypeError: Cannot read properties of undefined (reading 'get')
    at CacheManager.get [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:62:35[90m)[39m
    at CacheManager.getOrFetch [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:124:31[90m)[39m
    at UserCache.getProfile [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:153:23[90m)[39m
    at Module.handleGetMe [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:387:35[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1114:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > GET /auth/me > should return current user with valid session
Cache set error for key user:fe6b823c20b67b34fc25320dd6264440: TypeError: Cannot read properties of undefined (reading 'put')
    at CacheManager.set [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:79:21[90m)[39m
    at CacheManager.getOrFetch [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:134:18[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at Module.handleGetMe [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:387:18[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1114:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > GET /auth/me > should not return password hash
Cache get error for key user:ffbaf88f377363d136a3ca96c9927004: TypeError: Cannot read properties of undefined (reading 'get')
    at CacheManager.get [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:62:35[90m)[39m
    at CacheManager.getOrFetch [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:124:31[90m)[39m
    at UserCache.getProfile [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:153:23[90m)[39m
    at Module.handleGetMe [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:387:35[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1131:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > GET /auth/me > should not return password hash
Cache set error for key user:ffbaf88f377363d136a3ca96c9927004: TypeError: Cannot read properties of undefined (reading 'put')
    at CacheManager.set [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:79:21[90m)[39m
    at CacheManager.getOrFetch [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:134:18[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at Module.handleGetMe [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:387:18[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1131:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > GET /auth/me > should return email verification status
Cache get error for key user:012c697dac564e6ae305d03f9f41af39: TypeError: Cannot read properties of undefined (reading 'get')
    at CacheManager.get [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:62:35[90m)[39m
    at CacheManager.getOrFetch [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:124:31[90m)[39m
    at UserCache.getProfile [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:153:23[90m)[39m
    at Module.handleGetMe [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:387:35[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1173:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > GET /auth/me > should return email verification status
Cache set error for key user:012c697dac564e6ae305d03f9f41af39: TypeError: Cannot read properties of undefined (reading 'put')
    at CacheManager.set [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:79:21[90m)[39m
    at CacheManager.getOrFetch [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:134:18[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at Module.handleGetMe [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:387:18[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1173:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/resend-verification > should resend verification email for unverified user
Verification email resent to: resend@example.com

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/resend-verification > should rate limit resend requests
Verification email resent to: resend@example.com

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/resend-verification > should rate limit resend requests
Verification email resent to: resend@example.com

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/resend-verification > should rate limit resend requests
Verification email resent to: resend@example.com

stdout | tests/integration/handlers/auth-handlers.test.js

ðŸ§¹ Tearing down test environment...

stdout | tests/integration/handlers/auth-handlers.test.js
âœ“ Test database cleaned

stdout | tests/integration/handlers/auth-handlers.test.js
âœ“ Database adapter closed

stdout | tests/integration/handlers/auth-handlers.test.js
âœ“ Test database disconnected

stdout | tests/integration/handlers/auth-handlers.test.js
âœ“ Test database cleaned up
âœ“ Test environment cleaned up


 âœ“ tests/integration/handlers/auth-handlers.test.js (53 tests) 132513ms
   âœ“ POST /auth/register > should register a new user with valid credentials  2677ms
   âœ“ POST /auth/register > should reject registration with weak password  1487ms
   âœ“ POST /auth/register > should reject registration with invalid email  2151ms
   âœ“ POST /auth/register > should reject registration with duplicate email  1837ms
   âœ“ POST /auth/register > should hash password with bcrypt  1661ms
   âœ“ POST /auth/register > should normalize email to lowercase  2881ms
   âœ“ POST /auth/register > should create verification token  2407ms
   âœ“ POST /auth/register > should send verification email  1567ms
   âœ“ POST /auth/register > should log registration event in audit log  2859ms
   âœ“ POST /auth/register > should set default role to author if not specified  2322ms
   âœ“ POST /auth/login > should login with valid credentials  1860ms
   âœ“ POST /auth/login > should reject login with wrong password  3224ms
   âœ“ POST /auth/login > should reject login with non-existent email  1897ms
   âœ“ POST /auth/login > should reject login with unverified email  2820ms
   âœ“ POST /auth/login > should rate limit after 5 failed attempts  1950ms
   âœ“ POST /auth/login > should update last_login timestamp  1871ms
   âœ“ POST /auth/login > should create session in Redis  2309ms
   âœ“ POST /auth/login > should log successful login  2409ms
   âœ“ POST /auth/login > should log failed login attempts  2423ms
   âœ“ POST /auth/verify-email > should verify email with valid token  2040ms
   âœ“ POST /auth/verify-email > should reject invalid token  1643ms
   âœ“ POST /auth/verify-email > should reject expired token  2844ms
   âœ“ POST /auth/verify-email > should reject already used token  2477ms
   âœ“ POST /auth/verify-email > should handle missing token  1756ms
   âœ“ POST /auth/verify-email > should log email verification event  3363ms
   âœ“ POST /auth/request-password-reset > should create password reset token for valid email  2156ms
   âœ“ POST /auth/request-password-reset > should send password reset email  2457ms
   âœ“ POST /auth/request-password-reset > should not reveal if email does not exist (security)  1978ms
   âœ“ POST /auth/request-password-reset > should rate limit password reset requests  1965ms
   âœ“ POST /auth/request-password-reset > should normalize email to lowercase  2807ms
   âœ“ POST /auth/request-password-reset > should reject invalid email format  2434ms
   âœ“ POST /auth/request-password-reset > should handle missing email  2395ms
   âœ“ POST /auth/request-password-reset > should log password reset request  2373ms
   âœ“ POST /auth/reset-password > should reset password with valid token  2615ms
   âœ“ POST /auth/reset-password > should mark reset token as used  2508ms
   âœ“ POST /auth/reset-password > should reject weak new password  1556ms
   âœ“ POST /auth/reset-password > should reject invalid token  1568ms
   âœ“ POST /auth/reset-password > should reject expired token  3105ms
   âœ“ POST /auth/reset-password > should reject already used token  2171ms
   âœ“ POST /auth/reset-password > should hash new password with bcrypt  3107ms
   âœ“ POST /auth/reset-password > should log password reset event  1729ms
   âœ“ POST /auth/logout > should logout and destroy session  2136ms
   âœ“ POST /auth/logout > should clear session cookie  2624ms
   âœ“ POST /auth/logout > should log logout event  1924ms
   âœ“ GET /auth/me > should return current user with valid session  1586ms
   âœ“ GET /auth/me > should not return password hash  2595ms
   âœ“ GET /auth/me > should reject request without session  2574ms
   âœ“ GET /auth/me > should reject request with invalid session  1754ms
   âœ“ GET /auth/me > should return email verification status  3306ms
   âœ“ POST /auth/resend-verification > should resend verification email for unverified user  1590ms
   âœ“ POST /auth/resend-verification > should reject resend for already verified user  2042ms
   âœ“ POST /auth/resend-verification > should rate limit resend requests  1974ms
   âœ“ POST /auth/resend-verification > should not reveal if email does not exist (security)  1565ms
stdout | process.<anonymous> (/mnt/d/manuscript-platform/tests/setup.js:115:11)

âš  Received SIGTERM, cleaning up...

stdout | tests/submission-packages.test.js

ðŸ§ª Setting up test environment...
ðŸ”Œ Attempting to connect to test database...
ðŸ“ Host: 192.168.68.52:5432, Database: manuscript_platform_test

stdout | tests/submission-packages.test.js
âœ“ Test database connected

stdout | tests/submission-packages.test.js
  Applying base schema...

stdout | tests/submission-packages.test.js
  âœ“ Schema and migrations applied

stdout | tests/submission-packages.test.js
âœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

stdout | tests/submission-packages.test.js
âœ“ Test database initialized
âœ“ Test environment ready


stdout | tests/submission-packages.test.js

ðŸ§¹ Tearing down test environment...

stdout | tests/submission-packages.test.js
âœ“ Test database cleaned

stdout | tests/submission-packages.test.js
âœ“ Database adapter closed

stdout | tests/submission-packages.test.js
âœ“ Test database disconnected

stdout | tests/submission-packages.test.js
âœ“ Test database cleaned up
âœ“ Test environment cleaned up


 âœ“ tests/submission-packages.test.js (31 tests) 82085ms
   âœ“ Submission Package Bundler > Package Templates > should have agent query template  1812ms
   âœ“ Submission Package Bundler > Package Templates > should have full manuscript template  2223ms
   âœ“ Submission Package Bundler > Package Templates > should have query only template  1579ms
   âœ“ Submission Package Bundler > Package Templates > should have contest template  2069ms
   âœ“ Submission Package Bundler > Package Templates > should validate required documents  2445ms
   âœ“ Submission Package Bundler > Package Creation > should create package with metadata  1535ms
   âœ“ Submission Package Bundler > Package Creation > should include document list with ordering  1542ms
   âœ“ Submission Package Bundler > Package Creation > should validate package has at least one document  1537ms
   âœ“ Submission Package Bundler > Package Creation > should allow custom package names  2359ms
   âœ“ Submission Package Bundler > Document Selection > should allow selecting multiple documents  1954ms
   âœ“ Submission Package Bundler > Document Selection > should maintain document order  1606ms
   âœ“ Submission Package Bundler > Document Selection > should allow reordering documents  2692ms
   âœ“ Submission Package Bundler > ZIP File Generation > should generate ZIP with multiple files  2662ms
   âœ“ Submission Package Bundler > ZIP File Generation > should prefix files with order numbers  2005ms
   âœ“ Submission Package Bundler > ZIP File Generation > should sanitize filenames  1817ms
   âœ“ Submission Package Bundler > ZIP File Generation > should support different file formats  1657ms
   âœ“ Submission Package Bundler > ZIP File Generation > should include metadata file in ZIP  1636ms
   âœ“ Submission Package Bundler > Package Duplication > should create copy of existing package  2368ms
   âœ“ Submission Package Bundler > Package Duplication > should increment copy counter in name  2634ms
   âœ“ Submission Package Bundler > Package Management > should list packages for manuscript  1954ms
   âœ“ Submission Package Bundler > Package Management > should update package details  2420ms
   âœ“ Submission Package Bundler > Package Management > should delete package  2273ms
   âœ“ Submission Package Bundler > Validation > should validate package has required documents  2242ms
   âœ“ Submission Package Bundler > Validation > should validate document exists before adding to package  1922ms
   âœ“ Submission Package Bundler > Validation > should prevent duplicate documents in package  2862ms
   âœ“ Submission Package Bundler > Download Tracking > should track download count  2585ms
   âœ“ Submission Package Bundler > Download Tracking > should track last downloaded timestamp  2273ms
   âœ“ Submission Package Bundler > Edge Cases > should handle empty package name  2389ms
   âœ“ Submission Package Bundler > Edge Cases > should handle very long package name  1830ms
   âœ“ Submission Package Bundler > Edge Cases > should handle package with only one document  1880ms
   âœ“ Submission Package Bundler > Edge Cases > should handle large file sizes  2283ms
stdout | process.<anonymous> (/mnt/d/manuscript-platform/tests/setup.js:115:11)

âš  Received SIGTERM, cleaning up...

stdout | tests/error-handling.test.js

ðŸ§ª Setting up test environment...
ðŸ”Œ Attempting to connect to test database...
ðŸ“ Host: 192.168.68.52:5432, Database: manuscript_platform_test

stdout | tests/error-handling.test.js
âœ“ Test database connected

stdout | tests/error-handling.test.js
  Applying base schema...

stdout | tests/error-handling.test.js
  âœ“ Schema and migrations applied

stdout | tests/error-handling.test.js
âœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

stdout | tests/error-handling.test.js
âœ“ Test database initialized
âœ“ Test environment ready


stdout | tests/error-handling.test.js

ðŸ§¹ Tearing down test environment...

stdout | tests/error-handling.test.js
âœ“ Test database cleaned

stdout | tests/error-handling.test.js
âœ“ Database adapter closed

stdout | tests/error-handling.test.js
âœ“ Test database disconnected

stdout | tests/error-handling.test.js
âœ“ Test database cleaned up
âœ“ Test environment cleaned up


 âœ“ tests/error-handling.test.js (24 tests) 71533ms
   âœ“ Error Handling > Error Classes > should create AppError with correct properties  2034ms
   âœ“ Error Handling > Error Classes > should serialize AppError to JSON correctly  1997ms
   âœ“ Error Handling > Error Classes > should create AuthenticationError with 401 status  2148ms
   âœ“ Error Handling > Error Classes > should create AuthorizationError with 403 status  3489ms
   âœ“ Error Handling > Error Classes > should create ValidationError with 400 status  1884ms
   âœ“ Error Handling > Error Classes > should create NotFoundError with 404 status  2743ms
   âœ“ Error Handling > Error Classes > should create RateLimitError with 429 status  1848ms
   âœ“ Error Handling > Error Classes > should create ConflictError with 409 status  3614ms
   âœ“ Error Handling > Error Classes > should create ServerError with 500 status  2065ms
   âœ“ Error Handling > Error Classes > should create ExternalServiceError with service name  1877ms
   âœ“ Error Handling > createErrorResponse > should create Response with correct status and JSON  2686ms
   âœ“ Error Handling > createErrorResponse > should handle generic Error objects  1970ms
   âœ“ Error Handling > createErrorResponse > should include Retry-After header for rate limit errors  1876ms
   âœ“ Error Handling > createErrorResponse > should merge additional headers  3682ms
   âœ“ Error Handling > Assertion Helpers > assert should not throw when condition is true  2713ms
   âœ“ Error Handling > Assertion Helpers > assert should throw ValidationError when condition is false  1924ms
   âœ“ Error Handling > Assertion Helpers > assert should include details in error  1904ms
   âœ“ Error Handling > Assertion Helpers > assertAuthenticated should not throw when userId exists  2645ms
   âœ“ Error Handling > Assertion Helpers > assertAuthenticated should throw when userId is null  3137ms
   âœ“ Error Handling > Assertion Helpers > assertAuthenticated should throw when userId is undefined  2068ms
   âœ“ Error Handling > Assertion Helpers > assertAuthorized should not throw when permission is true  2779ms
   âœ“ Error Handling > Assertion Helpers > assertAuthorized should throw when permission is false  1920ms
   âœ“ Error Handling > Error Inheritance > should maintain instanceof relationships  2404ms
   âœ“ Error Handling > Error Inheritance > should have correct error names  2527ms
stdout | process.<anonymous> (/mnt/d/manuscript-platform/tests/setup.js:115:11)

âš  Received SIGTERM, cleaning up...

stdout | tests/unit/test-helpers.test.js

ðŸ§ª Setting up test environment...
ðŸ”Œ Attempting to connect to test database...
ðŸ“ Host: 192.168.68.52:5432, Database: manuscript_platform_test

stdout | tests/unit/test-helpers.test.js
âœ“ Test database connected

stdout | tests/unit/test-helpers.test.js
  Applying base schema...

stdout | tests/unit/test-helpers.test.js
  âœ“ Schema and migrations applied

stdout | tests/unit/test-helpers.test.js
âœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

stdout | tests/unit/test-helpers.test.js
âœ“ Test database initialized
âœ“ Test environment ready


stdout | tests/unit/test-helpers.test.js

ðŸ§¹ Tearing down test environment...

stdout | tests/unit/test-helpers.test.js
âœ“ Test database cleaned

stdout | tests/unit/test-helpers.test.js
âœ“ Database adapter closed

stdout | tests/unit/test-helpers.test.js
âœ“ Test database disconnected

stdout | tests/unit/test-helpers.test.js
âœ“ Test database cleaned up
âœ“ Test environment cleaned up


 âœ“ tests/unit/test-helpers.test.js (24 tests) 80286ms
   âœ“ Mock Factories > Storage Adapter Mock > should put and get objects  1970ms
   âœ“ Mock Factories > Storage Adapter Mock > should delete objects  2278ms
   âœ“ Mock Factories > Storage Adapter Mock > should list objects by prefix  1930ms
   âœ“ Mock Factories > Redis Mock > should set and get values  4659ms
   âœ“ Mock Factories > Redis Mock > should set values with expiration  2087ms
   âœ“ Mock Factories > Redis Mock > should delete keys  1882ms
   âœ“ Mock Factories > Redis Mock > should increment values  2290ms
   âœ“ Mock Factories > Claude API Mock > should return mock AI responses  1906ms
   âœ“ Mock Factories > Claude API Mock > should include custom response text  2161ms
   âœ“ Mock Factories > Email Service Mock > should track sent emails  3005ms
   âœ“ Mock Factories > Email Service Mock > should find emails by recipient  2084ms
   âœ“ Mock Factories > Email Service Mock > should clear sent emails  1758ms
   âœ“ Mock Factories > Stripe Mock > should create checkout sessions  2640ms
   âœ“ Mock Factories > Stripe Mock > should create payment intents  1905ms
   âœ“ Mock Factories > Stripe Mock > should construct webhook events  2907ms
   âœ“ Test Data Factories > User Factory > should create valid user data  2339ms
   âœ“ Test Data Factories > User Factory > should accept overrides  2058ms
   âœ“ Test Data Factories > Manuscript Factory > should create valid manuscript data  2792ms
   âœ“ Test Data Factories > Manuscript Factory > should accept overrides  4573ms
   âœ“ Test Data Factories > Analysis Factory > should create valid analysis data  3239ms
   âœ“ Test Data Factories > Analysis Factory > should include result JSON  3319ms
   âœ“ Test Data Factories > Payment Factory > should create valid payment data  3170ms
   âœ“ Test Data Factories > Utility Functions > should generate unique email addresses  3487ms
   âœ“ Test Data Factories > Utility Functions > should generate unique IDs  2779ms
stdout | process.<anonymous> (/mnt/d/manuscript-platform/tests/setup.js:115:11)

âš  Received SIGTERM, cleaning up...

stdout | tests/document-generation.test.js

ðŸ§ª Setting up test environment...
ðŸ”Œ Attempting to connect to test database...
ðŸ“ Host: 192.168.68.52:5432, Database: manuscript_platform_test

stdout | tests/document-generation.test.js
âœ“ Test database connected

stdout | tests/document-generation.test.js
  Applying base schema...

stdout | tests/document-generation.test.js
  âœ“ Schema and migrations applied

stdout | tests/document-generation.test.js
âœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

stdout | tests/document-generation.test.js
âœ“ Test database initialized
âœ“ Test environment ready


stdout | tests/document-generation.test.js

ðŸ§¹ Tearing down test environment...

stdout | tests/document-generation.test.js
âœ“ Test database cleaned

stdout | tests/document-generation.test.js
âœ“ Database adapter closed

stdout | tests/document-generation.test.js
âœ“ Test database disconnected

stdout | tests/document-generation.test.js
âœ“ Test database cleaned up
âœ“ Test environment cleaned up


 âœ“ tests/document-generation.test.js (27 tests) 66975ms
   âœ“ Document Generation > Query Letter Generation > should generate query letter within word count range  1465ms
   âœ“ Document Generation > Query Letter Generation > should include essential query letter components  1522ms
   âœ“ Document Generation > Query Letter Generation > should validate query letter structure  2139ms
   âœ“ Document Generation > Query Letter Generation > should reject query letters that are too short  1866ms
   âœ“ Document Generation > Query Letter Generation > should reject query letters that are too long  1514ms
   âœ“ Document Generation > Synopsis Generation > should generate short synopsis at 500 words  1606ms
   âœ“ Document Generation > Synopsis Generation > should generate long synopsis at 2500 words  2557ms
   âœ“ Document Generation > Synopsis Generation > should include beginning, middle, and end  2350ms
   âœ“ Document Generation > Synopsis Generation > should reveal ending (unlike blurb)  1606ms
   âœ“ Document Generation > Synopsis Generation > should maintain chronological order  3120ms
   âœ“ Document Generation > Version Management > should create new version on update  1648ms
   âœ“ Document Generation > Version Management > should track version metadata  2482ms
   âœ“ Document Generation > Version Management > should allow rollback to previous version  2688ms
   âœ“ Document Generation > Version Management > should maintain version history after rollback  1459ms
   âœ“ Document Generation > Document Validation > should validate document type  4894ms
   âœ“ Document Generation > Document Validation > should reject invalid document type  1480ms
   âœ“ Document Generation > Document Validation > should validate required fields  2540ms
   âœ“ Document Generation > Document Validation > should calculate word count accurately  1554ms
   âœ“ Document Generation > Document Validation > should handle empty document  1455ms
   âœ“ Document Generation > AI Generation Metadata > should track generation parameters  2215ms
   âœ“ Document Generation > AI Generation Metadata > should calculate cost based on token usage  2437ms
   âœ“ Document Generation > Batch Generation > should generate all document types at once  1655ms
   âœ“ Document Generation > Batch Generation > should track individual generation status  2357ms
   âœ“ Document Generation > Edge Cases > should handle very short manuscript title  2129ms
   âœ“ Document Generation > Edge Cases > should handle very long manuscript title  1635ms
   âœ“ Document Generation > Edge Cases > should handle special characters in content  1984ms
   âœ“ Document Generation > Edge Cases > should handle unicode characters  2771ms
stdout | process.<anonymous> (/mnt/d/manuscript-platform/tests/setup.js:115:11)

âš  Received SIGTERM, cleaning up...

stdout | tests/auth-utils.test.js

ðŸ§ª Setting up test environment...
ðŸ”Œ Attempting to connect to test database...
ðŸ“ Host: 192.168.68.52:5432, Database: manuscript_platform_test

stdout | tests/auth-utils.test.js
âœ“ Test database connected

stdout | tests/auth-utils.test.js
  Applying base schema...

stdout | tests/auth-utils.test.js
  âœ“ Schema and migrations applied

stdout | tests/auth-utils.test.js
âœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

stdout | tests/auth-utils.test.js
âœ“ Test database initialized
âœ“ Test environment ready


stdout | tests/auth-utils.test.js

ðŸ§¹ Tearing down test environment...

stdout | tests/auth-utils.test.js
âœ“ Test database cleaned

stdout | tests/auth-utils.test.js
âœ“ Database adapter closed

stdout | tests/auth-utils.test.js
âœ“ Test database disconnected

stdout | tests/auth-utils.test.js
âœ“ Test database cleaned up
âœ“ Test environment cleaned up


 âœ“ tests/auth-utils.test.js (22 tests) 57276ms
   âœ“ Authentication Utilities > validatePassword > should accept a valid password  1518ms
   âœ“ Authentication Utilities > validatePassword > should reject password shorter than 8 characters  1456ms
   âœ“ Authentication Utilities > validatePassword > should reject password without uppercase letter  1537ms
   âœ“ Authentication Utilities > validatePassword > should reject password without lowercase letter  2702ms
   âœ“ Authentication Utilities > validatePassword > should reject password without number  1845ms
   âœ“ Authentication Utilities > validatePassword > should reject password without special character  1521ms
   âœ“ Authentication Utilities > validatePassword > should reject null or undefined password  2371ms
   âœ“ Authentication Utilities > validatePassword > should accept password with all requirements  1954ms
   âœ“ Authentication Utilities > validatePassword > should return multiple errors for invalid password  1561ms
   âœ“ Authentication Utilities > validateEmail > should accept valid email addresses  3208ms
   âœ“ Authentication Utilities > validateEmail > should reject invalid email addresses  1660ms
   âœ“ Authentication Utilities > validateEmail > should handle edge cases  1573ms
   âœ“ Authentication Utilities > hashPassword and verifyPassword > should hash a password  2753ms
   âœ“ Authentication Utilities > hashPassword and verifyPassword > should produce different hashes for same password  2453ms
   âœ“ Authentication Utilities > hashPassword and verifyPassword > should verify correct password  2384ms
   âœ“ Authentication Utilities > hashPassword and verifyPassword > should reject incorrect password  2139ms
   âœ“ Authentication Utilities > hashPassword and verifyPassword > should handle empty passwords  2079ms
   âœ“ Authentication Utilities > hashPassword and verifyPassword > should be case sensitive  2478ms
   âœ“ Authentication Utilities > hashPassword and verifyPassword > should handle long passwords  1706ms
   âœ“ Authentication Utilities > AUTH_CONFIG > should have valid configuration values  1600ms
   âœ“ Authentication Utilities > AUTH_CONFIG > should have password requirements defined  2307ms
   âœ“ Authentication Utilities > AUTH_CONFIG > should have rate limit configuration  2138ms
stdout | process.<anonymous> (/mnt/d/manuscript-platform/tests/setup.js:115:11)

âš  Received SIGTERM, cleaning up...

stdout | tests/metadata-handlers.test.js

ðŸ§ª Setting up test environment...
ðŸ”Œ Attempting to connect to test database...
ðŸ“ Host: 192.168.68.52:5432, Database: manuscript_platform_test

stdout | tests/metadata-handlers.test.js
âœ“ Test database connected

stdout | tests/metadata-handlers.test.js
  Applying base schema...

stdout | tests/metadata-handlers.test.js
  âœ“ Schema and migrations applied

stdout | tests/metadata-handlers.test.js
âœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

stdout | tests/metadata-handlers.test.js
âœ“ Test database initialized
âœ“ Test environment ready


stdout | tests/metadata-handlers.test.js

ðŸ§¹ Tearing down test environment...

stdout | tests/metadata-handlers.test.js
âœ“ Test database cleaned

stdout | tests/metadata-handlers.test.js
âœ“ Database adapter closed

stdout | tests/metadata-handlers.test.js
âœ“ Test database disconnected

stdout | tests/metadata-handlers.test.js
âœ“ Test database cleaned up
âœ“ Test environment cleaned up


 âœ“ tests/metadata-handlers.test.js (21 tests) 53056ms
   âœ“ Enhanced Metadata Handlers > Genre Validation > should validate word count for romance novel  1546ms
   âœ“ Enhanced Metadata Handlers > Genre Validation > should flag word count outside genre norms  1514ms
   âœ“ Enhanced Metadata Handlers > Genre Validation > should accept novella word counts for appropriate genres  1477ms
   âœ“ Enhanced Metadata Handlers > Content Warning Validation > should validate content warning categories  1541ms
   âœ“ Enhanced Metadata Handlers > Content Warning Validation > should validate severity levels  2242ms
   âœ“ Enhanced Metadata Handlers > Content Warning Validation > should handle multiple content warnings  1980ms
   âœ“ Enhanced Metadata Handlers > Metadata Structure > should validate primary genre and subgenres  1555ms
   âœ“ Enhanced Metadata Handlers > Metadata Structure > should validate age category  5484ms
   âœ“ Enhanced Metadata Handlers > Metadata Structure > should validate manuscript status  1808ms
   âœ“ Enhanced Metadata Handlers > Metadata Structure > should validate series information  1484ms
   âœ“ Enhanced Metadata Handlers > Metadata History Tracking > should record metadata changes with timestamp  1474ms
   âœ“ Enhanced Metadata Handlers > Metadata History Tracking > should track multiple change types  1515ms
   âœ“ Enhanced Metadata Handlers > Genre Hierarchy > should validate parent-child genre relationships  2425ms
   âœ“ Enhanced Metadata Handlers > Genre Hierarchy > should handle subgenre depth  2651ms
   âœ“ Enhanced Metadata Handlers > Word Count Validation Logic > should categorize flash fiction correctly  1649ms
   âœ“ Enhanced Metadata Handlers > Word Count Validation Logic > should categorize novel correctly  1641ms
   âœ“ Enhanced Metadata Handlers > Word Count Validation Logic > should categorize epic correctly  1782ms
   âœ“ Enhanced Metadata Handlers > Edge Cases > should handle missing optional metadata fields  1515ms
   âœ“ Enhanced Metadata Handlers > Edge Cases > should handle empty subgenres array  1484ms
   âœ“ Enhanced Metadata Handlers > Edge Cases > should validate completion percentage range  1635ms
   âœ“ Enhanced Metadata Handlers > Edge Cases > should reject invalid completion percentage  2704ms
stdout | process.<anonymous> (/mnt/d/manuscript-platform/tests/setup.js:115:11)

âš  Received SIGTERM, cleaning up...

stdout | tests/integration/infrastructure.test.js
[dotenv@17.2.3] injecting env (0) from .env.local -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
Initializing adapters...
âœ“ Database adapter initialized
âœ“ Storage adapter initialized
âš  Running in test mode without Redis - using in-memory session store

stdout | tests/integration/infrastructure.test.js
âœ“ Session store initialized
âœ“ Cache adapter initialized
âœ“ Queue service initialized
âœ“ Environment initialized
âœ“ Session middleware applied
[VirusScanner] Initializing ClamAV at localhost:3310...

stderr | tests/integration/infrastructure.test.js
[VirusScanner] Failed to initialize: connect ECONNREFUSED 127.0.0.1:3310

stderr | tests/integration/infrastructure.test.js
âš  Virus scanner initialization failed (uploads will continue without scanning)

stdout | tests/integration/infrastructure.test.js

ðŸ§ª Setting up test environment...
ðŸ”Œ Attempting to connect to test database...
ðŸ“ Host: 192.168.68.52:5432, Database: manuscript_platform_test

stdout | tests/integration/infrastructure.test.js
âœ“ Test database connected

stdout | tests/integration/infrastructure.test.js
  Applying base schema...

stdout | tests/integration/infrastructure.test.js
  âœ“ Schema and migrations applied

stdout | tests/integration/infrastructure.test.js
âœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

stdout | tests/integration/infrastructure.test.js
âœ“ Test database initialized
âœ“ Test environment ready


[0mGET /health [32m200[0m 10.168 ms - 105[0m
stdout | tests/integration/infrastructure.test.js

ðŸ§¹ Tearing down test environment...

stdout | tests/integration/infrastructure.test.js
âœ“ Test database cleaned

stdout | tests/integration/infrastructure.test.js
âœ“ Database adapter closed

stdout | tests/integration/infrastructure.test.js
âœ“ Test database disconnected

stdout | tests/integration/infrastructure.test.js
âœ“ Test database cleaned up
âœ“ Test environment cleaned up


 âœ“ tests/integration/infrastructure.test.js (13 tests) 40883ms
   âœ“ Test Infrastructure > Database Utilities > should insert and retrieve test records  1986ms
   âœ“ Test Infrastructure > Database Utilities > should count test records  1924ms
   âœ“ Test Infrastructure > Database Utilities > should reset database between tests  1915ms
   âœ“ Test Infrastructure > API Client > should make HTTP requests  2564ms
   âœ“ Test Infrastructure > Mock Factories > should create mock Redis client  2559ms
   âœ“ Test Infrastructure > Mock Factories > should create mock Redis client with expiration  1891ms
   âœ“ Test Infrastructure > Mock Factories > should create mock storage adapter  2282ms
   âœ“ Test Infrastructure > Test Data Factories > should create test user data  2991ms
   âœ“ Test Infrastructure > Test Data Factories > should create test user with overrides  2347ms
   âœ“ Test Infrastructure > Test Data Factories > should create test manuscript data  2080ms
   âœ“ Test Infrastructure > Test Data Factories > should generate unique test emails  1907ms
   âœ“ Test Infrastructure > Integration: Factories + Database > should insert factory-generated user into database  1995ms
   âœ“ Test Infrastructure > Integration: Factories + Database > should insert factory-generated manuscript into database  3554ms
stdout | process.<anonymous> (/mnt/d/manuscript-platform/tests/setup.js:115:11)

âš  Received SIGTERM, cleaning up...

stdout | tests/integration/webhook-signature-verification.test.js

ðŸ§ª Setting up test environment...
ðŸ”Œ Attempting to connect to test database...
ðŸ“ Host: 192.168.68.52:5432, Database: manuscript_platform_test

stdout | tests/integration/webhook-signature-verification.test.js
âœ“ Test database connected

stdout | tests/integration/webhook-signature-verification.test.js
  Applying base schema...

stdout | tests/integration/webhook-signature-verification.test.js
  âœ“ Schema and migrations applied

stdout | tests/integration/webhook-signature-verification.test.js
âœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

stdout | tests/integration/webhook-signature-verification.test.js
âœ“ Test database initialized
âœ“ Test environment ready


stdout | tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Valid Signatures > should accept webhook with valid signature
[Webhook] Processing event: checkout.session.completed evt_test_1dcd3ffbefcc194cb930cf0d
[Webhook] Checkout completed for user: user-123 plan: [90mundefined[39m

stdout | tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Valid Signatures > should accept webhook with valid signature
[Webhook] One-time payment recorded: 702d64ce-44cb-42f1-bf1a-d7e6fe4761d0

stderr | tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Valid Signatures > should accept webhook with valid signature
[Budget] No budget config found

stderr | tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Valid Signatures > should accept webhook with valid signature
[Budget] Error updating user spend: TypeError: Cannot read properties of undefined (reading 'current_spend_usd')
    at updateUserSpend [90m(/mnt/d/manuscript-platform/[39msrc/utils/cost-utils.js:296:34[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at logCost [90m(/mnt/d/manuscript-platform/[39msrc/utils/cost-utils.js:169:7[90m)[39m
    at handleCheckoutCompleted [90m(/mnt/d/manuscript-platform/[39msrc/handlers/webhook-handlers.js:183:7[90m)[39m
    at handleStripeWebhook [90m(/mnt/d/manuscript-platform/[39msrc/handlers/webhook-handlers.js:55:9[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/webhook-signature-verification.test.js:110:26

stdout | tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Valid Signatures > should accept webhook with valid signature
[Cost Tracking] Logged stripe_fees/payment_processing/one_time_payment: $1.1697

stdout | tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Valid Signatures > should accept webhook with recent timestamp (within 5 min)
[Webhook] Processing event: checkout.session.completed evt_test_b0bcfb2801008bd582b6b9ad
[Webhook] Checkout completed for user: [90mundefined[39m plan: [90mundefined[39m

stdout | tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Valid Signatures > should accept webhook with recent timestamp (within 5 min)
[Webhook] One-time payment recorded: ca92ed34-b5a6-4178-b12e-b3a40f61a656

stderr | tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Valid Signatures > should accept webhook with recent timestamp (within 5 min)
[Budget] No budget config found

stdout | tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Valid Signatures > should accept webhook with recent timestamp (within 5 min)
[Cost Tracking] Logged stripe_fees/payment_processing/one_time_payment: $1.1697

stderr | tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Invalid Signatures > should reject webhook with incorrect signature
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


stderr | tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Invalid Signatures > should reject webhook with malformed signature format
[Webhook] Signature verification failed: No signatures found with expected scheme

stderr | tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Invalid Signatures > should reject webhook with tampered payload
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


stderr | tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Replay Attack Prevention > should reject webhook with expired timestamp (>5 min old)
[Webhook] Signature verification failed: Timestamp outside the tolerance zone

stdout | tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Replay Attack Prevention > should accept webhook with future timestamp (Stripe allows clock skew)
[Webhook] Processing event: checkout.session.completed evt_test_06f05a9f5896fa63d0f91d7e
[Webhook] Checkout completed for user: [90mundefined[39m plan: [90mundefined[39m

stdout | tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Replay Attack Prevention > should accept webhook with future timestamp (Stripe allows clock skew)
[Webhook] One-time payment recorded: 5c48dfc3-3335-4c8e-95d0-c120433d2e86

stderr | tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Replay Attack Prevention > should accept webhook with future timestamp (Stripe allows clock skew)
[Budget] No budget config found

stdout | tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Replay Attack Prevention > should accept webhook with future timestamp (Stripe allows clock skew)
[Cost Tracking] Logged stripe_fees/payment_processing/one_time_payment: $1.1697

stdout | tests/integration/webhook-signature-verification.test.js

ðŸ§¹ Tearing down test environment...

stdout | tests/integration/webhook-signature-verification.test.js
âœ“ Test database cleaned

stdout | tests/integration/webhook-signature-verification.test.js
âœ“ Database adapter closed

stdout | tests/integration/webhook-signature-verification.test.js
âœ“ Test database disconnected

stdout | tests/integration/webhook-signature-verification.test.js
âœ“ Test database cleaned up
âœ“ Test environment cleaned up


 âœ“ tests/integration/webhook-signature-verification.test.js (9 tests) 39490ms
   âœ“ Webhook Signature Verification > Valid Signatures > should accept webhook with valid signature  2237ms
   âœ“ Webhook Signature Verification > Valid Signatures > should accept webhook with recent timestamp (within 5 min)  2577ms
   âœ“ Webhook Signature Verification > Missing Signature > should reject webhook with no signature header  3707ms
   âœ“ Webhook Signature Verification > Missing Signature > should reject webhook with empty signature  2809ms
   âœ“ Webhook Signature Verification > Invalid Signatures > should reject webhook with incorrect signature  4034ms
   âœ“ Webhook Signature Verification > Invalid Signatures > should reject webhook with malformed signature format  2665ms
   âœ“ Webhook Signature Verification > Invalid Signatures > should reject webhook with tampered payload  3626ms
   âœ“ Webhook Signature Verification > Replay Attack Prevention > should reject webhook with expired timestamp (>5 min old)  2739ms
   âœ“ Webhook Signature Verification > Replay Attack Prevention > should accept webhook with future timestamp (Stripe allows clock skew)  3248ms
stdout | process.<anonymous> (/mnt/d/manuscript-platform/tests/setup.js:115:11)

âš  Received SIGTERM, cleaning up...


 Test Files  10 passed (10)
      Tests  278 passed (278)
   Start at  21:59:15
   Duration  855.01s (transform 4.00s, setup 4.66s, collect 71.15s, tests 753.86s, environment 2ms, prepare 8.94s)


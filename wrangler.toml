name = "manuscript-upload-api"
main = "worker-router.js"
compatibility_date = "2024-09-23"
compatibility_flags = ["nodejs_compat"]

# Serve frontend files as static assets
[assets]
directory = "./frontend"
binding = "ASSETS"

# Enable logging
logpush = false
observability = { enabled = true }

# Queue for async analysis
[[queues.producers]]
queue = "manuscript-analysis-queue"
binding = "ANALYSIS_QUEUE"

# Queue consumer for processing analysis jobs
[[queues.consumers]]
queue = "manuscript-analysis-queue"
max_batch_size = 1  # Process one manuscript at a time
max_batch_timeout = 60  # Wait up to 60 seconds before processing
max_retries = 3  # Retry failed jobs up to 3 times
dead_letter_queue = "manuscript-analysis-dlq"  # Failed jobs go here

# Queue for async asset generation
[[queues.producers]]
queue = "asset-generation-queue"
binding = "ASSET_QUEUE"

# Queue consumer for processing asset generation jobs
[[queues.consumers]]
queue = "asset-generation-queue"
max_batch_size = 1  # Process one manuscript at a time
max_batch_timeout = 60  # Wait up to 60 seconds before processing
max_retries = 2  # Retry failed jobs up to 2 times
dead_letter_queue = "asset-generation-dlq"  # Failed jobs go here

# R2 Bucket bindings
[[r2_buckets]]
binding = "MANUSCRIPTS_RAW"
bucket_name = "manuscripts-raw"

[[r2_buckets]]
binding = "MANUSCRIPTS_PROCESSED"
bucket_name = "manuscripts-processed"

[[r2_buckets]]
binding = "MARKETING_ASSETS"
bucket_name = "marketing-assets"

[[r2_buckets]]
binding = "BACKUPS"
bucket_name = "manuscript-platform-backups"

# Scheduled CRON trigger for automated backups
# Runs daily at 3 AM UTC
[triggers]
crons = ["0 3 * * *"]

# Note: Custom domain is configured via Cloudflare Dashboard
# Go to Workers & Pages > manuscript-upload-api > Custom Domains
# Add: api.scarter4workmanuscripthub.com

# D1 Database - User and manuscript management
[[d1_databases]]
binding = "DB"
database_name = "manuscript-platform"
database_id = "3d9000ef-95fb-4561-bb84-192b395eadd2"

# KV Namespace - Session storage and rate limiting
[[kv_namespaces]]
binding = "SESSIONS"
id = "48959d60fe25478db01651f3eef4daff"

# KV Namespace - Query result caching (MAN-28)
[[kv_namespaces]]
binding = "CACHE_KV"
id = "ee58654ea8644618990fbd32fb99d140"

# Environment variables (set via Cloudflare Dashboard for production)
# For local development, create a .dev.vars file with:
# ANTHROPIC_API_KEY=your_key_here
# STRIPE_SECRET_KEY=sk_test_...
# STRIPE_WEBHOOK_SECRET=whsec_...
[vars]
# ANTHROPIC_API_KEY will be set via dashboard secrets for production
# STRIPE_SECRET_KEY will be set via dashboard secrets for production
# STRIPE_WEBHOOK_SECRET will be set via dashboard secrets for production
MAX_FILE_SIZE = 52428800  # 50MB in bytes
SESSION_DURATION = 1800  # 30 minutes in seconds (inactivity timeout)
STRIPE_PUBLISHABLE_KEY = "pk_live_51SMYSaGlyuXwBKzmxt41kzNWsyJWvVoTh6Ik2fMpRMVVT8oZC8VMqv0Yldu1SIuCvRxDzEGRJBA2gTCdZgiKnYp400wCyfuh6Q"
FRONTEND_URL = "https://scarter4workmanuscripthub.com"  # Your frontend URL for payment redirects

# Email configuration (MailChannels - free for Cloudflare Workers)
EMAIL_FROM_ADDRESS = "noreply@scarter4workmanuscripthub.com"
EMAIL_FROM_NAME = "ManuscriptHub"
EMAIL_ADMIN_ADDRESS = "scarter4work@yahoo.com"
EMAIL_REPLY_TO_ADDRESS = "support@scarter4workmanuscripthub.com"


> manuscript-upload-api@1.0.0 test
> cross-env NODE_ENV=test TEST_DATABASE_URL=postgresql://postgres:Bjoran32!@172.23.176.1:5432/manuscript_platform_test vitest run


 RUN  v3.2.4 /mnt/d/manuscript-platform

stdout | tests/integration/handlers/payment-handlers.test.js
[dotenv@17.2.3] injecting env (0) from .env.local -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

stdout | tests/integration/handlers/payment-handlers.test.js

ðŸ§ª Setting up test environment...

stdout | tests/integration/handlers/payment-handlers.test.js
âœ“ Test database connected

stdout | tests/integration/handlers/payment-handlers.test.js
  Applying base schema...

stdout | tests/integration/handlers/payment-handlers.test.js
  âœ“ Schema and migrations applied

stdout | tests/integration/handlers/payment-handlers.test.js
âœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

stdout | tests/integration/handlers/payment-handlers.test.js
âœ“ Test database initialized
Initializing adapters...
âœ“ Database adapter initialized
âœ“ Storage adapter initialized
âš  Running in test mode without Redis - using in-memory session store

stdout | tests/integration/handlers/payment-handlers.test.js
âœ“ Session store initialized
âœ“ Cache adapter initialized
âœ“ Queue service initialized
âœ“ Environment initialized
âœ“ Session middleware applied
[VirusScanner] Initializing ClamAV at localhost:3310...

stdout | tests/integration/handlers/payment-handlers.test.js
âœ“ Server adapters initialized
âœ“ Test environment ready


stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /create-checkout-session > should create checkout session for valid subscription
[VirusScanner] Failed to initialize: connect ECONNREFUSED 127.0.0.1:3310

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /create-checkout-session > should create checkout session for valid subscription
âš  Virus scanner initialization failed (uploads will continue without scanning)

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /create-checkout-session > should create checkout session for valid subscription
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'fff77625-71e5-44a4-8e9f-d7b5cacd6919'[39m,
  [32m'34fd85158e7ca28afcfcc74cbd90a38a'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'34fd85158e7ca28afcfcc74cbd90a38a'[39m,
  [33m1763068577[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /create-checkout-session > should create checkout session for valid subscription
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 337.890 ms - 128[0m
[0mPOST /create-checkout-session [33m400[0m 73.494 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /create-checkout-session > should require authentication for checkout
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'df78379f-3bc8-4016-8fe9-c98410843bdd'[39m,
  [32m'be70fd06b2e5071483692c94987f37b6'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'be70fd06b2e5071483692c94987f37b6'[39m,
  [33m1763068579[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /create-checkout-session > should require authentication for checkout
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 121.592 ms - 128[0m
[0mPOST /create-checkout-session [33m401[0m 10.083 ms - 24[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /create-checkout-session > should reject invalid price IDs
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'0140a8b9-4f20-4e1f-a154-107185fb24a9'[39m,
  [32m'b39c32da0274dbb5eb41a742783be541'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'b39c32da0274dbb5eb41a742783be541'[39m,
  [33m1763068581[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /create-checkout-session > should reject invalid price IDs
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 118.432 ms - 128[0m
[0mPOST /create-checkout-session [33m400[0m 8.132 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /create-checkout-session > should include userId in session metadata
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'1886aed1-b068-4da8-a90c-8ce5a4050352'[39m,
  [32m'a519cf817e910903124825068a5420d4'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'a519cf817e910903124825068a5420d4'[39m,
  [33m1763068582[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /create-checkout-session > should include userId in session metadata
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 131.443 ms - 128[0m
[0mPOST /create-checkout-session [33m400[0m 6.763 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /create-checkout-session > should handle missing planType field
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'0c2c71b6-ebec-4487-864b-145f05badc38'[39m,
  [32m'2893645cafd93f265f1d37572857534f'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'2893645cafd93f265f1d37572857534f'[39m,
  [33m1763068588[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /create-checkout-session > should handle missing planType field
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 120.728 ms - 128[0m
[0mPOST /create-checkout-session [33m400[0m 6.872 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /create-checkout-session > should create customer if not exists
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'e139be63-b7dc-4a3f-875d-6175d00f174f'[39m,
  [32m'16a39054a1388ae54beeacecadd94abc'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'16a39054a1388ae54beeacecadd94abc'[39m,
  [33m1763068592[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /create-checkout-session > should create customer if not exists
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 119.082 ms - 128[0m
[0mPOST /create-checkout-session [33m400[0m 5.111 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /create-checkout-session > should set correct success and cancel URLs
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'3a4cf030-ee7b-4bc0-9236-eee47ddf9a52'[39m,
  [32m'ef7a8c17072ad32866035be077d9c5b0'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'ef7a8c17072ad32866035be077d9c5b0'[39m,
  [33m1763068594[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /create-checkout-session > should set correct success and cancel URLs
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 307.061 ms - 128[0m
[0mPOST /create-checkout-session [33m400[0m 5.702 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /create-checkout-session > should handle Stripe API errors gracefully
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'e185839a-335e-4eb9-b66d-7e650eaa0fe4'[39m,
  [32m'e030b5e16bd2e7580def0305ddbf7ec7'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'e030b5e16bd2e7580def0305ddbf7ec7'[39m,
  [33m1763068598[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /create-checkout-session > should handle Stripe API errors gracefully
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 114.272 ms - 128[0m
[0mPOST /create-checkout-session [33m400[0m 4.963 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /create-checkout-session > should log checkout session creation
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'bcfc3ed3-0ba3-4742-b4f8-490f52ceb344'[39m,
  [32m'a092aef323cb7c2722ac59fa94cbe1d6'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'a092aef323cb7c2722ac59fa94cbe1d6'[39m,
  [33m1763068601[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /create-checkout-session > should log checkout session creation
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 115.976 ms - 128[0m
[0mPOST /create-checkout-session [33m400[0m 6.630 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should accept webhook with valid signature
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 5.997 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should reject webhook with invalid signature
[Webhook] Signature verification failed: Unable to extract timestamp and signatures from header

[0mPOST /webhooks/stripe [33m400[0m 2.199 ms - 29[0m
[0mPOST /webhooks/stripe [33m400[0m 1.118 ms - 33[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should reject webhook with expired signature (>5 minutes)
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.705 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should reject replay attacks (duplicate event ID)
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 2.938 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should reject replay attacks (duplicate event ID)
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.710 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should handle malformed signature header
[Webhook] Signature verification failed: Unable to extract timestamp and signatures from header

[0mPOST /webhooks/stripe [33m400[0m 1.610 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should log signature verification failures
[Webhook] Signature verification failed: Unable to extract timestamp and signatures from header

[0mPOST /webhooks/stripe [33m400[0m 2.133 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should return 400 for invalid signatures (not 500)
[Webhook] Signature verification failed: Unable to extract timestamp and signatures from header

[0mPOST /webhooks/stripe [33m400[0m 1.652 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle checkout.session.completed - activate subscription
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.715 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle checkout.session.completed - record payment
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 2.067 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle customer.subscription.updated - sync status
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 2.393 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle customer.subscription.deleted - downgrade to free
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 2.917 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle customer.subscription.deleted - preserve data
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.692 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle invoice.payment_succeeded - record payment
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.558 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle invoice.payment_succeeded - extend billing period
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.796 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle invoice.payment_failed - mark past_due
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 2.013 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle invoice.payment_failed - cancel after 3 failures
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 2.470 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should ignore unhandled event types
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 2.624 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle duplicate webhook deliveries (idempotent)
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.607 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle duplicate webhook deliveries (idempotent)
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 2.081 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle webhook for deleted user gracefully
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 2.113 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle malformed webhook data gracefully
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 2.394 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should log all webhook events
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 2.446 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should return 200 for all webhooks (even errors)
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.515 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should process webhook in under 5 seconds
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.594 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > GET /subscription > should return current subscription details
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'4059593d-3a87-40bb-8b6a-c03de2cc2f27'[39m,
  [32m'85a50abd7089680fd4471f9c2088b563'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'85a50abd7089680fd4471f9c2088b563'[39m,
  [33m1763068669[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > GET /subscription > should return current subscription details
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 118.823 ms - 132[0m
[0mGET /subscription [32m200[0m 58.153 ms - 221[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > GET /subscription > should require authentication
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'2e61acf6-e235-4d3d-977d-be1127f01af8'[39m,
  [32m'dc3590ef54d15549e171d1e8f1ccfb8c'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'dc3590ef54d15549e171d1e8f1ccfb8c'[39m,
  [33m1763068671[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > GET /subscription > should require authentication
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 71.621 ms - 132[0m
[0mGET /subscription [33m401[0m 9.147 ms - 24[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > GET /subscription > should return free plan for users without subscription
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'cfb8657f-8947-4cff-907e-e5415ea4d6f8'[39m,
  [32m'470aed3d1c9ab69aa50916d2b81c4ed2'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'470aed3d1c9ab69aa50916d2b81c4ed2'[39m,
  [33m1763068673[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > GET /subscription > should return free plan for users without subscription
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 260.293 ms - 132[0m
[0mGET /subscription [32m200[0m 61.446 ms - 114[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > GET /subscription > should include Stripe subscription ID
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'd724e892-d84c-4a38-ba02-740fd62e7995'[39m,
  [32m'4e415e435ce07dd3c82ed11133fc33d2'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'4e415e435ce07dd3c82ed11133fc33d2'[39m,
  [33m1763068685[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > GET /subscription > should include Stripe subscription ID
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 72.871 ms - 132[0m
[0mGET /subscription [32m200[0m 57.549 ms - 221[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > GET /subscription > should include current period dates
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'df476c5e-5831-4f1e-8c4c-5abc2a46ddce'[39m,
  [32m'fbfdb75dfb5b55eebd587d00167a2dd9'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'fbfdb75dfb5b55eebd587d00167a2dd9'[39m,
  [33m1763068679[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > GET /subscription > should include current period dates
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 76.122 ms - 132[0m
[0mGET /subscription [32m200[0m 175.382 ms - 221[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > GET /payment-history > should return payment history for user
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'0e7cbc0a-aa22-43ca-b423-6882e5677538'[39m,
  [32m'6e31bfe964d89397c1875939427b5c4e'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'6e31bfe964d89397c1875939427b5c4e'[39m,
  [33m1763068682[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > GET /payment-history > should return payment history for user
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 75.625 ms - 135[0m
[0mGET /payment-history [32m200[0m 51.290 ms - 484[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > GET /payment-history > should require authentication
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'36e289f8-e44c-450b-8624-2692bf6014d1'[39m,
  [32m'f3c1e3d9edd698932c1d5acc5b63b176'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'f3c1e3d9edd698932c1d5acc5b63b176'[39m,
  [33m1763068685[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > GET /payment-history > should require authentication
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 72.436 ms - 135[0m
[0mGET /payment-history [33m401[0m 6.115 ms - 24[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > GET /payment-history > should return empty array for no payments
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'b01305d1-f537-44d8-b224-b2b567a52002'[39m,
  [32m'e7bc977d4f038a7b8f0c2e13345692bb'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'e7bc977d4f038a7b8f0c2e13345692bb'[39m,
  [33m1763068687[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > GET /payment-history > should return empty array for no payments
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 117.175 ms - 135[0m
[0mGET /payment-history [32m200[0m 155.132 ms - 15[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > GET /payment-history > should order payments by date (newest first)
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'0ea7dca6-f016-46ba-9795-8a53fc46e9d6'[39m,
  [32m'14d18e1e6f9a064190c296d56ec8e53c'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'14d18e1e6f9a064190c296d56ec8e53c'[39m,
  [33m1763068689[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > GET /payment-history > should order payments by date (newest first)
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 74.965 ms - 135[0m
[0mGET /payment-history [32m200[0m 50.091 ms - 484[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > GET /payment-history > should not include other users payments
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'a6295dc2-0289-4b86-9f18-1f82ec17f116'[39m,
  [32m'029ee9f9e3f0bc78b3f7420bd9810d98'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'029ee9f9e3f0bc78b3f7420bd9810d98'[39m,
  [33m1763068694[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > GET /payment-history > should not include other users payments
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 76.683 ms - 135[0m
[0mGET /payment-history [32m200[0m 49.987 ms - 484[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > Usage Tracking > should track different analysis types
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'b5098148-9664-48bf-ab45-9904d701aa5f'[39m,
  [32m'df0d9bd4f1bf7982bbd53ad4051277b4'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'df0d9bd4f1bf7982bbd53ad4051277b4'[39m,
  [33m1763068699[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > Usage Tracking > should track different analysis types
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 78.799 ms - 134[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > Usage Tracking > should track asset generation separately
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'89fdfbef-6aec-423e-8321-f947d2c82b22'[39m,
  [32m'177a3893726bcac6c0ad72a5498066ed'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'177a3893726bcac6c0ad72a5498066ed'[39m,
  [33m1763068701[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > Usage Tracking > should track asset generation separately
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 156.821 ms - 134[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > Usage Tracking > should calculate usage within billing period
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'bd13fead-c7f9-42f8-8698-895527faf987'[39m,
  [32m'88d8f06142d0b0a5959d5721a0520c3a'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'88d8f06142d0b0a5959d5721a0520c3a'[39m,
  [33m1763068706[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > Usage Tracking > should calculate usage within billing period
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 117.154 ms - 134[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > Usage Tracking > should separate usage across different billing periods
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'c29d0996-88e6-4bac-9238-3c52149660e4'[39m,
  [32m'e2000584282403a3252fa45a81d59e27'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'e2000584282403a3252fa45a81d59e27'[39m,
  [33m1763068707[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > Usage Tracking > should separate usage across different billing periods
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 120.472 ms - 134[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > Usage Tracking > should track usage for users without subscription (pay-per-use)
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'bf226550-5dea-47de-b8f9-28040dfccacf'[39m,
  [32m'3df530a78f914ec8db7bab829896d487'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'3df530a78f914ec8db7bab829896d487'[39m,
  [33m1763068709[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > Usage Tracking > should track usage for users without subscription (pay-per-use)
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 126.845 ms - 134[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > Usage Tracking > should link usage to specific manuscript
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'8aa5d7d8-2eb2-4e10-9d62-96a3a60b24eb'[39m,
  [32m'7d7d076a7b3e46e9148867a32044707b'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'7d7d076a7b3e46e9148867a32044707b'[39m,
  [33m1763068714[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > Usage Tracking > should link usage to specific manuscript
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 121.748 ms - 134[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > Usage Tracking > should accumulate credits across multiple analyses
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'b6fe24af-1bc3-45ca-8e98-9349976fec0b'[39m,
  [32m'5d266d09a8f255a26ed0e78a7b8bc804'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'5d266d09a8f255a26ed0e78a7b8bc804'[39m,
  [33m1763068716[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > Usage Tracking > should accumulate credits across multiple analyses
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 223.324 ms - 134[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > Usage Tracking > should track timestamp for usage analytics
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'7e200e43-5c06-417e-8708-d88607788058'[39m,
  [32m'21914fe8addd9d1d5c4939cf6f18c475'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'21914fe8addd9d1d5c4939cf6f18c475'[39m,
  [33m1763068720[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > Usage Tracking > should track timestamp for usage analytics
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 121.265 ms - 134[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > Usage Tracking > should delete usage records when manuscript is deleted (CASCADE)
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'2ee1eaaa-b69f-4aeb-863f-3c0e3fa5cd9d'[39m,
  [32m'e22cf1ea42a753ba3b8c037c5c724332'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'e22cf1ea42a753ba3b8c037c5c724332'[39m,
  [33m1763068722[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > Usage Tracking > should delete usage records when manuscript is deleted (CASCADE)
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 118.824 ms - 134[0m
stdout | tests/integration/handlers/payment-handlers.test.js

ðŸ§¹ Tearing down test environment...

stdout | tests/integration/handlers/payment-handlers.test.js
âœ“ Test database cleaned

stdout | tests/integration/handlers/payment-handlers.test.js
âœ“ Database adapter closed

stdout | tests/integration/handlers/payment-handlers.test.js
âœ“ Test database disconnected

stdout | tests/integration/handlers/payment-handlers.test.js
âœ“ Test database cleaned up
âœ“ Test environment cleaned up


 â¯ tests/integration/handlers/payment-handlers.test.js (54 tests | 2 failed) 169203ms
   âœ“ Payment & Webhook Handlers > POST /create-checkout-session > should create checkout session for valid subscription  2156ms
   âœ“ Payment & Webhook Handlers > POST /create-checkout-session > should require authentication for checkout  2450ms
   âœ“ Payment & Webhook Handlers > POST /create-checkout-session > should reject invalid price IDs  1746ms
   âœ“ Payment & Webhook Handlers > POST /create-checkout-session > should include userId in session metadata  1796ms
   Ã— Payment & Webhook Handlers > POST /create-checkout-session > should handle missing priceId field 4627ms
     â†’ Hook timed out in 10000ms.
If this is a long-running hook, pass a timeout value as the last argument or configure it globally with "hookTimeout".
   âœ“ Payment & Webhook Handlers > POST /create-checkout-session > should handle missing planType field  1961ms
   âœ“ Payment & Webhook Handlers > POST /create-checkout-session > should create customer if not exists  4481ms
   âœ“ Payment & Webhook Handlers > POST /create-checkout-session > should set correct success and cancel URLs  2018ms
   âœ“ Payment & Webhook Handlers > POST /create-checkout-session > should handle Stripe API errors gracefully  4292ms
   âœ“ Payment & Webhook Handlers > POST /create-checkout-session > should log checkout session creation  3067ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should accept webhook with valid signature  1654ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should reject webhook with invalid signature  1604ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should reject webhook with missing signature  6014ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should reject webhook with expired signature (>5 minutes)  2166ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should reject replay attacks (duplicate event ID)  1544ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should handle malformed signature header  1553ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should log signature verification failures  1581ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should return 400 for invalid signatures (not 500)  6871ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle checkout.session.completed - activate subscription  1875ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle checkout.session.completed - record payment  1599ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle customer.subscription.updated - sync status  1655ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle customer.subscription.deleted - downgrade to free  5699ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle customer.subscription.deleted - preserve data  3455ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle invoice.payment_succeeded - record payment  1672ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle invoice.payment_succeeded - extend billing period  1688ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle invoice.payment_failed - mark past_due  5395ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle invoice.payment_failed - cancel after 3 failures  1910ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should ignore unhandled event types  3196ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle duplicate webhook deliveries (idempotent)  1697ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle webhook for deleted user gracefully  4817ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle malformed webhook data gracefully  1606ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should log all webhook events  4588ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should return 200 for all webhooks (even errors)  1607ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should process webhook in under 5 seconds  6393ms
   âœ“ Payment & Webhook Handlers > GET /subscription > should return current subscription details  2819ms
   âœ“ Payment & Webhook Handlers > GET /subscription > should require authentication  1733ms
   âœ“ Payment & Webhook Handlers > GET /subscription > should return free plan for users without subscription  2844ms
   âœ“ Payment & Webhook Handlers > GET /subscription > should include Stripe subscription ID  4052ms
   âœ“ Payment & Webhook Handlers > GET /subscription > should include current period dates  2854ms
   âœ“ Payment & Webhook Handlers > GET /payment-history > should return payment history for user  3473ms
   âœ“ Payment & Webhook Handlers > GET /payment-history > should require authentication  2697ms
   âœ“ Payment & Webhook Handlers > GET /payment-history > should return empty array for no payments  1994ms
   âœ“ Payment & Webhook Handlers > GET /payment-history > should order payments by date (newest first)  2080ms
   âœ“ Payment & Webhook Handlers > GET /payment-history > should not include other users payments  6136ms
   Ã— Payment & Webhook Handlers > Usage Tracking > should track manuscript analysis usage 2763ms
     â†’ Hook timed out in 10000ms.
If this is a long-running hook, pass a timeout value as the last argument or configure it globally with "hookTimeout".
   âœ“ Payment & Webhook Handlers > Usage Tracking > should track different analysis types  1984ms
   âœ“ Payment & Webhook Handlers > Usage Tracking > should track asset generation separately  2591ms
   âœ“ Payment & Webhook Handlers > Usage Tracking > should calculate usage within billing period  5456ms
   âœ“ Payment & Webhook Handlers > Usage Tracking > should separate usage across different billing periods  1794ms
   âœ“ Payment & Webhook Handlers > Usage Tracking > should track usage for users without subscription (pay-per-use)  1913ms
   âœ“ Payment & Webhook Handlers > Usage Tracking > should link usage to specific manuscript  5391ms
   âœ“ Payment & Webhook Handlers > Usage Tracking > should accumulate credits across multiple analyses  1877ms
   âœ“ Payment & Webhook Handlers > Usage Tracking > should track timestamp for usage analytics  4258ms
   âœ“ Payment & Webhook Handlers > Usage Tracking > should delete usage records when manuscript is deleted (CASCADE)  1916ms
stdout | process.<anonymous> (/mnt/d/manuscript-platform/tests/setup.js:115:11)

âš  Received SIGTERM, cleaning up...

stdout | tests/integration/handlers/auth-handlers.test.js
[dotenv@17.2.3] injecting env (0) from .env.local -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

stdout | tests/integration/handlers/auth-handlers.test.js

ðŸ§ª Setting up test environment...

stdout | tests/integration/handlers/auth-handlers.test.js
âœ“ Test database connected

stdout | tests/integration/handlers/auth-handlers.test.js
  Applying base schema...

stdout | tests/integration/handlers/auth-handlers.test.js
  âœ“ Schema and migrations applied

stdout | tests/integration/handlers/auth-handlers.test.js
âœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

stdout | tests/integration/handlers/auth-handlers.test.js
âœ“ Test database initialized
Initializing adapters...
âœ“ Database adapter initialized
âœ“ Storage adapter initialized
âš  Running in test mode without Redis - using in-memory session store

stdout | tests/integration/handlers/auth-handlers.test.js
âœ“ Session store initialized
âœ“ Cache adapter initialized
âœ“ Queue service initialized
âœ“ Environment initialized
âœ“ Session middleware applied
[VirusScanner] Initializing ClamAV at localhost:3310...

stdout | tests/integration/handlers/auth-handlers.test.js
âœ“ Server adapters initialized
âœ“ Test environment ready


stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should register a new user with valid credentials
[VirusScanner] Failed to initialize: connect ECONNREFUSED 127.0.0.1:3310

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should register a new user with valid credentials
âš  Virus scanner initialization failed (uploads will continue without scanning)

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should register a new user with valid credentials
[Payment] Create free subscription error: ReferenceError: crypto is not defined
    at createFreeSubscription [90m(/mnt/d/manuscript-platform/[39msrc/handlers/payment-handlers.js:464:28[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:166:13[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:65:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should register a new user with valid credentials
Failed to create free subscription: ReferenceError: crypto is not defined
    at createFreeSubscription [90m(/mnt/d/manuscript-platform/[39msrc/handlers/payment-handlers.js:464:28[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:166:13[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:65:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should register a new user with valid credentials
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:176:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:65:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'e52dc698-c5ea-4b5a-b51d-4635ce46b324'[39m,
  [32m'3a3629fa-6b55-428a-8401-93dfe8c5c90f'[39m,
  [32m'register'[39m,
  [32m'auth'[39m,
  [32m'3a3629fa-6b55-428a-8401-93dfe8c5c90f'[39m,
  [33m1763068754[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"role":"author","email":"newuser@example.com"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should register a new user with valid credentials
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:176:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:65:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should register a new user with valid credentials
[Email] RESEND_API_KEY not configured

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should register a new user with valid credentials
[Email] Error logging email: ReferenceError: crypto is not defined
    at logEmail [90m(/mnt/d/manuscript-platform/[39msrc/services/email-service.js:420:7[90m)[39m
    at sendNotificationEmail [90m(/mnt/d/manuscript-platform/[39msrc/services/email-service.js:453:9[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at sendEmailVerification [90m(/mnt/d/manuscript-platform/[39msrc/services/email-service.js:863:10[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:183:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:65:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should register a new user with valid credentials
Verification email sent to: newuser@example.com

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should hash password with bcrypt
[Payment] Create free subscription error: ReferenceError: crypto is not defined
    at createFreeSubscription [90m(/mnt/d/manuscript-platform/[39msrc/handlers/payment-handlers.js:464:28[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:166:13[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:150:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should hash password with bcrypt
Failed to create free subscription: ReferenceError: crypto is not defined
    at createFreeSubscription [90m(/mnt/d/manuscript-platform/[39msrc/handlers/payment-handlers.js:464:28[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:166:13[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:150:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should hash password with bcrypt
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:176:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:150:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'd49ff09b-8413-478f-8944-337cbf7214d0'[39m,
  [32m'822c7b68-def9-4d01-b2ce-6c293b487d03'[39m,
  [32m'register'[39m,
  [32m'auth'[39m,
  [32m'822c7b68-def9-4d01-b2ce-6c293b487d03'[39m,
  [33m1763068765[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"role":"author","email":"bcrypt-test@example.com"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should hash password with bcrypt
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:176:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:150:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should hash password with bcrypt
[Email] RESEND_API_KEY not configured

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should hash password with bcrypt
[Email] Error logging email: ReferenceError: crypto is not defined
    at logEmail [90m(/mnt/d/manuscript-platform/[39msrc/services/email-service.js:420:7[90m)[39m
    at sendNotificationEmail [90m(/mnt/d/manuscript-platform/[39msrc/services/email-service.js:453:9[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at sendEmailVerification [90m(/mnt/d/manuscript-platform/[39msrc/services/email-service.js:863:10[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:183:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:150:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should hash password with bcrypt
Verification email sent to: bcrypt-test@example.com

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should normalize email to lowercase
[Payment] Create free subscription error: ReferenceError: crypto is not defined
    at createFreeSubscription [90m(/mnt/d/manuscript-platform/[39msrc/handlers/payment-handlers.js:464:28[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:166:13[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:174:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should normalize email to lowercase
Failed to create free subscription: ReferenceError: crypto is not defined
    at createFreeSubscription [90m(/mnt/d/manuscript-platform/[39msrc/handlers/payment-handlers.js:464:28[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:166:13[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:174:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should normalize email to lowercase
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:176:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:174:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'11b8ba05-d2cc-433a-9d48-dc359121a2d6'[39m,
  [32m'3767cd5e-f9c5-464d-8bff-2d85a1936273'[39m,
  [32m'register'[39m,
  [32m'auth'[39m,
  [32m'3767cd5e-f9c5-464d-8bff-2d85a1936273'[39m,
  [33m1763068775[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"role":"author","email":"casesensitive@example.com"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should normalize email to lowercase
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:176:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:174:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should normalize email to lowercase
[Email] RESEND_API_KEY not configured

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should normalize email to lowercase
[Email] Error logging email: ReferenceError: crypto is not defined
    at logEmail [90m(/mnt/d/manuscript-platform/[39msrc/services/email-service.js:420:7[90m)[39m
    at sendNotificationEmail [90m(/mnt/d/manuscript-platform/[39msrc/services/email-service.js:453:9[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at sendEmailVerification [90m(/mnt/d/manuscript-platform/[39msrc/services/email-service.js:863:10[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:183:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:174:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should normalize email to lowercase
Verification email sent to: casesensitive@example.com

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should create verification token
[Payment] Create free subscription error: ReferenceError: crypto is not defined
    at createFreeSubscription [90m(/mnt/d/manuscript-platform/[39msrc/handlers/payment-handlers.js:464:28[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:166:13[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:190:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should create verification token
Failed to create free subscription: ReferenceError: crypto is not defined
    at createFreeSubscription [90m(/mnt/d/manuscript-platform/[39msrc/handlers/payment-handlers.js:464:28[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:166:13[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:190:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should create verification token
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:176:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:190:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'93dde97c-8f3d-4107-9de2-b1876de1b8ec'[39m,
  [32m'80df863f-f318-4c25-8624-7d85473d04c6'[39m,
  [32m'register'[39m,
  [32m'auth'[39m,
  [32m'80df863f-f318-4c25-8624-7d85473d04c6'[39m,
  [33m1763068771[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"role":"author","email":"verify-test@example.com"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should create verification token
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:176:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:190:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should create verification token
[Email] RESEND_API_KEY not configured

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should create verification token
[Email] Error logging email: ReferenceError: crypto is not defined
    at logEmail [90m(/mnt/d/manuscript-platform/[39msrc/services/email-service.js:420:7[90m)[39m
    at sendNotificationEmail [90m(/mnt/d/manuscript-platform/[39msrc/services/email-service.js:453:9[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at sendEmailVerification [90m(/mnt/d/manuscript-platform/[39msrc/services/email-service.js:863:10[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:183:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:190:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should create verification token
Verification email sent to: verify-test@example.com

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should send verification email
[Payment] Create free subscription error: ReferenceError: crypto is not defined
    at createFreeSubscription [90m(/mnt/d/manuscript-platform/[39msrc/handlers/payment-handlers.js:464:28[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:166:13[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:217:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should send verification email
Failed to create free subscription: ReferenceError: crypto is not defined
    at createFreeSubscription [90m(/mnt/d/manuscript-platform/[39msrc/handlers/payment-handlers.js:464:28[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:166:13[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:217:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should send verification email
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:176:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:217:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'c05bd9fa-992c-4af3-bfee-6300bf5f7c7a'[39m,
  [32m'e3622688-e361-4264-9c61-6d9b2660d624'[39m,
  [32m'register'[39m,
  [32m'auth'[39m,
  [32m'e3622688-e361-4264-9c61-6d9b2660d624'[39m,
  [33m1763068772[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"role":"author","email":"email-test@example.com"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should send verification email
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:176:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:217:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should send verification email
[Email] RESEND_API_KEY not configured

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should send verification email
[Email] Error logging email: ReferenceError: crypto is not defined
    at logEmail [90m(/mnt/d/manuscript-platform/[39msrc/services/email-service.js:420:7[90m)[39m
    at sendNotificationEmail [90m(/mnt/d/manuscript-platform/[39msrc/services/email-service.js:453:9[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at sendEmailVerification [90m(/mnt/d/manuscript-platform/[39msrc/services/email-service.js:863:10[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:183:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:217:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should send verification email
Verification email sent to: email-test@example.com

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should log registration event in audit log
[Payment] Create free subscription error: ReferenceError: crypto is not defined
    at createFreeSubscription [90m(/mnt/d/manuscript-platform/[39msrc/handlers/payment-handlers.js:464:28[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:166:13[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:241:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should log registration event in audit log
Failed to create free subscription: ReferenceError: crypto is not defined
    at createFreeSubscription [90m(/mnt/d/manuscript-platform/[39msrc/handlers/payment-handlers.js:464:28[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:166:13[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:241:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should log registration event in audit log
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:176:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:241:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'4d769e56-e348-4802-a377-62da3257a28b'[39m,
  [32m'6e477dc3-58d1-4fbd-90a5-cc6f9de854a8'[39m,
  [32m'register'[39m,
  [32m'auth'[39m,
  [32m'6e477dc3-58d1-4fbd-90a5-cc6f9de854a8'[39m,
  [33m1763068777[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"role":"author","email":"audit-test@example.com"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should log registration event in audit log
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:176:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:241:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should log registration event in audit log
[Email] RESEND_API_KEY not configured

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should log registration event in audit log
[Email] Error logging email: ReferenceError: crypto is not defined
    at logEmail [90m(/mnt/d/manuscript-platform/[39msrc/services/email-service.js:420:7[90m)[39m
    at sendNotificationEmail [90m(/mnt/d/manuscript-platform/[39msrc/services/email-service.js:453:9[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at sendEmailVerification [90m(/mnt/d/manuscript-platform/[39msrc/services/email-service.js:863:10[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:183:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:241:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should log registration event in audit log
Verification email sent to: audit-test@example.com

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should set default role to author if not specified
[Payment] Create free subscription error: ReferenceError: crypto is not defined
    at createFreeSubscription [90m(/mnt/d/manuscript-platform/[39msrc/handlers/payment-handlers.js:464:28[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:166:13[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:258:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should set default role to author if not specified
Failed to create free subscription: ReferenceError: crypto is not defined
    at createFreeSubscription [90m(/mnt/d/manuscript-platform/[39msrc/handlers/payment-handlers.js:464:28[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:166:13[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:258:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should set default role to author if not specified
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:176:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:258:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'84cb704f-fa28-4b33-aa43-56669c9e89e8'[39m,
  [32m'16f44f4c-b583-413e-ae65-862a6f273c5b'[39m,
  [32m'register'[39m,
  [32m'auth'[39m,
  [32m'16f44f4c-b583-413e-ae65-862a6f273c5b'[39m,
  [33m1763068778[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"role":"author","email":"default-role@example.com"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should set default role to author if not specified
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:176:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:258:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should set default role to author if not specified
[Email] RESEND_API_KEY not configured

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should set default role to author if not specified
[Email] Error logging email: ReferenceError: crypto is not defined
    at logEmail [90m(/mnt/d/manuscript-platform/[39msrc/services/email-service.js:420:7[90m)[39m
    at sendNotificationEmail [90m(/mnt/d/manuscript-platform/[39msrc/services/email-service.js:453:9[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at sendEmailVerification [90m(/mnt/d/manuscript-platform/[39msrc/services/email-service.js:863:10[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:183:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:258:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should set default role to author if not specified
Verification email sent to: default-role@example.com

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should login with valid credentials
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogin [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:295:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'97bf82c6-78bc-44e1-b956-d71bda10a9a9'[39m,
  [32m'477c914f93fb07087ea20fdd49b62072'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'477c914f93fb07087ea20fdd49b62072'[39m,
  [33m1763068780[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should login with valid credentials
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogin [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:295:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should reject login with wrong password
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogin [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:263:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:321:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'5098fd07-d9ee-419c-af64-e2e3641fd8b9'[39m,
  [32m'ac5ed75d822f9b0d2db5388a50d51668'[39m,
  [32m'login_failed'[39m,
  [32m'auth'[39m,
  [32m'ac5ed75d822f9b0d2db5388a50d51668'[39m,
  [33m1763068782[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"login-test@example.com","reason":"invalid_credentials"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should reject login with wrong password
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogin [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:263:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:321:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should reject login with non-existent email
[Audit] Skipping audit log for login_failed - no valid user_id

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should reject login with unverified email
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogin [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:273:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:364:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'41a30b7b-57aa-4df9-88c6-0bccb4154c55'[39m,
  [32m'a4814c52a560951b82d41e3206fff2a9'[39m,
  [32m'login_failed'[39m,
  [32m'auth'[39m,
  [32m'a4814c52a560951b82d41e3206fff2a9'[39m,
  [33m1763068787[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"reason":"email_not_verified"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should reject login with unverified email
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogin [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:273:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:364:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should rate limit after 5 failed attempts
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogin [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:263:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:384:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'3c01c6b4-b232-452a-bbc6-f96d8583aa67'[39m,
  [32m'1636c9cc4580fd1a6de323e39d85f068'[39m,
  [32m'login_failed'[39m,
  [32m'auth'[39m,
  [32m'1636c9cc4580fd1a6de323e39d85f068'[39m,
  [33m1763068792[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"login-test@example.com","reason":"invalid_credentials"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should rate limit after 5 failed attempts
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogin [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:263:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:384:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should rate limit after 5 failed attempts
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogin [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:263:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:384:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'a9f12252-becc-4fd0-a76d-d727c78a911d'[39m,
  [32m'1636c9cc4580fd1a6de323e39d85f068'[39m,
  [32m'login_failed'[39m,
  [32m'auth'[39m,
  [32m'1636c9cc4580fd1a6de323e39d85f068'[39m,
  [33m1763068792[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"login-test@example.com","reason":"invalid_credentials"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should rate limit after 5 failed attempts
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogin [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:263:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:384:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should rate limit after 5 failed attempts
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogin [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:263:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:384:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'3ab82524-7d6f-48d7-b81f-0217b070402a'[39m,
  [32m'1636c9cc4580fd1a6de323e39d85f068'[39m,
  [32m'login_failed'[39m,
  [32m'auth'[39m,
  [32m'1636c9cc4580fd1a6de323e39d85f068'[39m,
  [33m1763068793[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"login-test@example.com","reason":"invalid_credentials"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should rate limit after 5 failed attempts
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogin [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:263:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:384:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should rate limit after 5 failed attempts
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogin [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:263:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:384:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'4a542c5c-604e-4fbd-b13f-eeb2457a4078'[39m,
  [32m'1636c9cc4580fd1a6de323e39d85f068'[39m,
  [32m'login_failed'[39m,
  [32m'auth'[39m,
  [32m'1636c9cc4580fd1a6de323e39d85f068'[39m,
  [33m1763068793[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"login-test@example.com","reason":"invalid_credentials"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should rate limit after 5 failed attempts
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogin [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:263:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:384:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should rate limit after 5 failed attempts
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogin [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:263:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:384:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'f56d07c2-18de-429b-a2c6-140beb053e7c'[39m,
  [32m'1636c9cc4580fd1a6de323e39d85f068'[39m,
  [32m'login_failed'[39m,
  [32m'auth'[39m,
  [32m'1636c9cc4580fd1a6de323e39d85f068'[39m,
  [33m1763068793[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"login-test@example.com","reason":"invalid_credentials"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should rate limit after 5 failed attempts
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogin [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:263:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:384:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should update last_login timestamp
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogin [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:416:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'37590c51-a5cd-41d0-b676-afd1ff0e42af'[39m,
  [32m'72b4bb3ac2f248bc89fd9f460411f3ab'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'72b4bb3ac2f248bc89fd9f460411f3ab'[39m,
  [33m1763068796[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should update last_login timestamp
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogin [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:416:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should create session in Redis
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogin [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:436:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'ab326a13-1738-44fb-aa42-4078a934ca78'[39m,
  [32m'4aa3f3eb20b2feb862fb53c68695b66d'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'4aa3f3eb20b2feb862fb53c68695b66d'[39m,
  [33m1763068797[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should create session in Redis
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogin [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:436:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should log successful login
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogin [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:465:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'89bf8901-dc89-4e0a-8170-6a785718ce94'[39m,
  [32m'8d4a3e4a43ad09238243e88cd9bc5ca3'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'8d4a3e4a43ad09238243e88cd9bc5ca3'[39m,
  [33m1763068802[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should log successful login
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogin [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:465:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should log failed login attempts
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogin [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:263:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:482:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'fa5e5442-f2c4-4bdf-accb-e7480af09cfd'[39m,
  [32m'a094d7fbb5241b1fe81611a8d7bf7117'[39m,
  [32m'login_failed'[39m,
  [32m'auth'[39m,
  [32m'a094d7fbb5241b1fe81611a8d7bf7117'[39m,
  [33m1763068803[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"login-test@example.com","reason":"invalid_credentials"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should log failed login attempts
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogin [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:263:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:482:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/verify-email > should verify email with valid token
Cache delete many error: TypeError: Cannot read properties of undefined (reading 'delete')
    at [90m/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:109:49
    at Array.map (<anonymous>)
    at CacheManager.deleteMany [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:109:30[90m)[39m
    at UserCache.invalidate [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:185:22[90m)[39m
    at Module.handleVerifyEmail [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:455:22[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:523:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/verify-email > should verify email with valid token
Cache INVALIDATED: user 773d3d4d9adc4a116124cf384c52cf98

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/verify-email > should verify email with valid token
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleVerifyEmail [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:459:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:523:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'01c60b89-9c67-48cb-bdec-9c6fe5811d99'[39m,
  [32m'773d3d4d9adc4a116124cf384c52cf98'[39m,
  [32m'email_verified'[39m,
  [32m'auth'[39m,
  [32m'773d3d4d9adc4a116124cf384c52cf98'[39m,
  [33m1763068807[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/verify-email > should verify email with valid token
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleVerifyEmail [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:459:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:523:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/verify-email > should log email verification event
Cache delete many error: TypeError: Cannot read properties of undefined (reading 'delete')
    at [90m/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:109:49
    at Array.map (<anonymous>)
    at CacheManager.deleteMany [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:109:30[90m)[39m
    at UserCache.invalidate [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:185:22[90m)[39m
    at Module.handleVerifyEmail [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:455:22[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:622:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/verify-email > should log email verification event
Cache INVALIDATED: user 82c07952904a287e0d852b00730761df

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/verify-email > should log email verification event
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleVerifyEmail [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:459:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:622:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'33a7d7c5-1efb-4dfa-8494-c830453f09ca'[39m,
  [32m'82c07952904a287e0d852b00730761df'[39m,
  [32m'email_verified'[39m,
  [32m'auth'[39m,
  [32m'82c07952904a287e0d852b00730761df'[39m,
  [33m1763068818[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/verify-email > should log email verification event
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleVerifyEmail [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:459:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:622:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should create password reset token for valid email
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:527:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:657:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'2a248c64-3c33-46b5-b86b-8984cc82e3e5'[39m,
  [32m'123a8dcfff8307e5d2cef8959b92d958'[39m,
  [32m'password_reset_requested'[39m,
  [32m'auth'[39m,
  [32m'123a8dcfff8307e5d2cef8959b92d958'[39m,
  [33m1763068820[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"reset@example.com"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should create password reset token for valid email
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:527:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:657:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should create password reset token for valid email
Failed to send password reset email: Error: Failed to send email: <html>
<head><title>401 Authorization Required</title></head>
<body>
<center><h1>401 Authorization Required</h1></center>
<hr><center>nginx/1.27.1</center>
</body>
</html>

    at sendPasswordResetEmail [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:834:11[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:537:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:657:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should send password reset email
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:527:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:681:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'32a6ff28-ac4e-4c76-8ece-7f72cdcba24c'[39m,
  [32m'ad24602cbd4e35e491b8180cbacb866b'[39m,
  [32m'password_reset_requested'[39m,
  [32m'auth'[39m,
  [32m'ad24602cbd4e35e491b8180cbacb866b'[39m,
  [33m1763068827[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"reset@example.com"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should send password reset email
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:527:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:681:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should send password reset email
Failed to send password reset email: Error: Failed to send email: <html>
<head><title>401 Authorization Required</title></head>
<body>
<center><h1>401 Authorization Required</h1></center>
<hr><center>nginx/1.27.1</center>
</body>
</html>

    at sendPasswordResetEmail [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:834:11[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:537:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:681:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should rate limit password reset requests
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:527:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:727:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'17113716-8aa5-4fac-b5d0-e8332a3623fb'[39m,
  [32m'f1ac2988b10b833ade8b87e157980414'[39m,
  [32m'password_reset_requested'[39m,
  [32m'auth'[39m,
  [32m'f1ac2988b10b833ade8b87e157980414'[39m,
  [33m1763068830[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"reset@example.com"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should rate limit password reset requests
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:527:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:727:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should rate limit password reset requests
Failed to send password reset email: Error: Failed to send email: <html>
<head><title>401 Authorization Required</title></head>
<body>
<center><h1>401 Authorization Required</h1></center>
<hr><center>nginx/1.27.1</center>
</body>
</html>

    at sendPasswordResetEmail [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:834:11[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:537:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:727:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should rate limit password reset requests
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:527:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:727:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'2b658706-1ce2-4e9f-97af-964c0dd793ad'[39m,
  [32m'f1ac2988b10b833ade8b87e157980414'[39m,
  [32m'password_reset_requested'[39m,
  [32m'auth'[39m,
  [32m'f1ac2988b10b833ade8b87e157980414'[39m,
  [33m1763068830[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"reset@example.com"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should rate limit password reset requests
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:527:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:727:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should rate limit password reset requests
Failed to send password reset email: Error: Failed to send email: <html>
<head><title>401 Authorization Required</title></head>
<body>
<center><h1>401 Authorization Required</h1></center>
<hr><center>nginx/1.27.1</center>
</body>
</html>

    at sendPasswordResetEmail [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:834:11[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:537:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:727:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should rate limit password reset requests
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:527:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:727:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'089d11c4-93c7-4ea4-8709-b27577dbf7b0'[39m,
  [32m'f1ac2988b10b833ade8b87e157980414'[39m,
  [32m'password_reset_requested'[39m,
  [32m'auth'[39m,
  [32m'f1ac2988b10b833ade8b87e157980414'[39m,
  [33m1763068831[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"reset@example.com"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should rate limit password reset requests
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:527:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:727:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should rate limit password reset requests
Failed to send password reset email: Error: Failed to send email: <html>
<head><title>401 Authorization Required</title></head>
<body>
<center><h1>401 Authorization Required</h1></center>
<hr><center>nginx/1.27.1</center>
</body>
</html>

    at sendPasswordResetEmail [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:834:11[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:537:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:727:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should normalize email to lowercase
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:527:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:761:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'7ba03c7a-a59e-4035-be50-95d11033788a'[39m,
  [32m'9babe200524e6992f3602650128b4b9a'[39m,
  [32m'password_reset_requested'[39m,
  [32m'auth'[39m,
  [32m'9babe200524e6992f3602650128b4b9a'[39m,
  [33m1763068835[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"casesensitive@example.com"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should normalize email to lowercase
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:527:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:761:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should normalize email to lowercase
Failed to send password reset email: Error: Failed to send email: <html>
<head><title>401 Authorization Required</title></head>
<body>
<center><h1>401 Authorization Required</h1></center>
<hr><center>nginx/1.27.1</center>
</body>
</html>

    at sendPasswordResetEmail [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:834:11[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:537:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:761:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should log password reset request
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:527:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:808:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'7810a775-3f16-4273-9a40-487d86739706'[39m,
  [32m'167f2e9c990e2da137318189fc6f5e4b'[39m,
  [32m'password_reset_requested'[39m,
  [32m'auth'[39m,
  [32m'167f2e9c990e2da137318189fc6f5e4b'[39m,
  [33m1763068841[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"reset@example.com"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should log password reset request
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:527:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:808:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should log password reset request
Failed to send password reset email: Error: Failed to send email: <html>
<head><title>401 Authorization Required</title></head>
<body>
<center><h1>401 Authorization Required</h1></center>
<hr><center>nginx/1.27.1</center>
</body>
</html>

    at sendPasswordResetEmail [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:834:11[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:537:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:808:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/reset-password > should reset password with valid token
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handlePasswordReset [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:617:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:849:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'a7065e60-f84e-453a-ab33-567a606fd591'[39m,
  [32m'6643b55960f671d1ac629628249f4297'[39m,
  [32m'password_reset'[39m,
  [32m'auth'[39m,
  [32m'6643b55960f671d1ac629628249f4297'[39m,
  [33m1763068843[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/reset-password > should reset password with valid token
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handlePasswordReset [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:617:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:849:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/reset-password > should mark reset token as used
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handlePasswordReset [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:617:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:875:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'dd6a4d5e-293a-4c96-95d0-48781a4c1bcd'[39m,
  [32m'f33c4dc613e7f76b9937717dd5665af4'[39m,
  [32m'password_reset'[39m,
  [32m'auth'[39m,
  [32m'f33c4dc613e7f76b9937717dd5665af4'[39m,
  [33m1763068849[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/reset-password > should mark reset token as used
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handlePasswordReset [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:617:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:875:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/reset-password > should hash new password with bcrypt
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handlePasswordReset [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:617:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:970:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'b081e695-3afd-457b-b69e-34399fa2cc59'[39m,
  [32m'e6a2ab24cbee4f06890cc177491655c0'[39m,
  [32m'password_reset'[39m,
  [32m'auth'[39m,
  [32m'e6a2ab24cbee4f06890cc177491655c0'[39m,
  [33m1763068862[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/reset-password > should hash new password with bcrypt
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handlePasswordReset [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:617:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:970:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/reset-password > should log password reset event
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handlePasswordReset [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:617:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:990:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'621bfce6-1b56-46be-be03-52bff6681cb1'[39m,
  [32m'b86311103dde8a3c181fb79133790099'[39m,
  [32m'password_reset'[39m,
  [32m'auth'[39m,
  [32m'b86311103dde8a3c181fb79133790099'[39m,
  [33m1763068864[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/reset-password > should log password reset event
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handlePasswordReset [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:617:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:990:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/logout > should logout and destroy session
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogout [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:343:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1037:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'2d60ee1d-2693-456b-a247-324c0676798f'[39m,
  [32m'c188fa995a3d6f4a9d1be7b62876e0e4'[39m,
  [32m'logout'[39m,
  [32m'auth'[39m,
  [32m'c188fa995a3d6f4a9d1be7b62876e0e4'[39m,
  [33m1763068865[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/logout > should logout and destroy session
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogout [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:343:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1037:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/logout > should clear session cookie
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogout [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:343:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1055:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'27dc1b20-4d2f-470b-b598-c3da2821625c'[39m,
  [32m'03c9fb979afa85acfe8f4c76fa8e89ac'[39m,
  [32m'logout'[39m,
  [32m'auth'[39m,
  [32m'03c9fb979afa85acfe8f4c76fa8e89ac'[39m,
  [33m1763068869[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/logout > should clear session cookie
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogout [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:343:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1055:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/logout > should log logout event
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogout [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:343:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1069:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'6238d965-04e9-47dd-a0a5-b5679b40763b'[39m,
  [32m'9e7587c21c5736a5a7104eb395027ae0'[39m,
  [32m'logout'[39m,
  [32m'auth'[39m,
  [32m'9e7587c21c5736a5a7104eb395027ae0'[39m,
  [33m1763068871[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/logout > should log logout event
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogout [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:343:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1069:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > GET /auth/me > should return current user with valid session
Cache get error for key user:aedc9343f5bbcd25eb68bb12f285cbb1: TypeError: Cannot read properties of undefined (reading 'get')
    at CacheManager.get [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:62:35[90m)[39m
    at CacheManager.getOrFetch [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:124:31[90m)[39m
    at UserCache.getProfile [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:153:23[90m)[39m
    at Module.handleGetMe [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:387:35[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1118:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > GET /auth/me > should return current user with valid session
Cache set error for key user:aedc9343f5bbcd25eb68bb12f285cbb1: TypeError: Cannot read properties of undefined (reading 'put')
    at CacheManager.set [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:79:21[90m)[39m
    at CacheManager.getOrFetch [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:134:18[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at Module.handleGetMe [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:387:18[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1118:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > GET /auth/me > should not return password hash
Cache get error for key user:7a94ca8a6e532428b7acb481b9f17766: TypeError: Cannot read properties of undefined (reading 'get')
    at CacheManager.get [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:62:35[90m)[39m
    at CacheManager.getOrFetch [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:124:31[90m)[39m
    at UserCache.getProfile [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:153:23[90m)[39m
    at Module.handleGetMe [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:387:35[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1135:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > GET /auth/me > should not return password hash
Cache set error for key user:7a94ca8a6e532428b7acb481b9f17766: TypeError: Cannot read properties of undefined (reading 'put')
    at CacheManager.set [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:79:21[90m)[39m
    at CacheManager.getOrFetch [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:134:18[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at Module.handleGetMe [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:387:18[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1135:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > GET /auth/me > should return email verification status
Cache get error for key user:c4df3503733df967ab369f5884a69c73: TypeError: Cannot read properties of undefined (reading 'get')
    at CacheManager.get [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:62:35[90m)[39m
    at CacheManager.getOrFetch [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:124:31[90m)[39m
    at UserCache.getProfile [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:153:23[90m)[39m
    at Module.handleGetMe [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:387:35[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1177:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > GET /auth/me > should return email verification status
Cache set error for key user:c4df3503733df967ab369f5884a69c73: TypeError: Cannot read properties of undefined (reading 'put')
    at CacheManager.set [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:79:21[90m)[39m
    at CacheManager.getOrFetch [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:134:18[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at Module.handleGetMe [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:387:18[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1177:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/resend-verification > should resend verification email for unverified user
[Email] RESEND_API_KEY not configured

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/resend-verification > should resend verification email for unverified user
[Email] Error logging email: ReferenceError: crypto is not defined
    at logEmail [90m(/mnt/d/manuscript-platform/[39msrc/services/email-service.js:420:7[90m)[39m
    at sendNotificationEmail [90m(/mnt/d/manuscript-platform/[39msrc/services/email-service.js:453:9[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at sendEmailVerification [90m(/mnt/d/manuscript-platform/[39msrc/services/email-service.js:863:10[90m)[39m
    at Module.handleResendVerification [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:734:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1213:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/resend-verification > should resend verification email for unverified user
Verification email resent to: resend@example.com

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/resend-verification > should resend verification email for unverified user
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleResendVerification [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:747:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1213:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'c65eeee2-e52c-4520-baf3-77d04bd5f375'[39m,
  [32m'6a04bc0a6427e3706f698d332959cfd8'[39m,
  [32m'verification_resent'[39m,
  [32m'auth'[39m,
  [32m'6a04bc0a6427e3706f698d332959cfd8'[39m,
  [33m1763068887[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"resend@example.com"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/resend-verification > should resend verification email for unverified user
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleResendVerification [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:747:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1213:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/resend-verification > should rate limit resend requests
[Email] RESEND_API_KEY not configured

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/resend-verification > should rate limit resend requests
[Email] Error logging email: ReferenceError: crypto is not defined
    at logEmail [90m(/mnt/d/manuscript-platform/[39msrc/services/email-service.js:420:7[90m)[39m
    at sendNotificationEmail [90m(/mnt/d/manuscript-platform/[39msrc/services/email-service.js:453:9[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at sendEmailVerification [90m(/mnt/d/manuscript-platform/[39msrc/services/email-service.js:863:10[90m)[39m
    at Module.handleResendVerification [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:734:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1262:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/resend-verification > should rate limit resend requests
Verification email resent to: resend@example.com

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/resend-verification > should rate limit resend requests
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleResendVerification [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:747:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1262:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'26168a81-8a79-4f46-a384-c545d6134906'[39m,
  [32m'338e6ab532f65d38962d5fc8d0066089'[39m,
  [32m'verification_resent'[39m,
  [32m'auth'[39m,
  [32m'338e6ab532f65d38962d5fc8d0066089'[39m,
  [33m1763068892[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"resend@example.com"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/resend-verification > should rate limit resend requests
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleResendVerification [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:747:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1262:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/resend-verification > should rate limit resend requests
[Email] RESEND_API_KEY not configured

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/resend-verification > should rate limit resend requests
[Email] Error logging email: ReferenceError: crypto is not defined
    at logEmail [90m(/mnt/d/manuscript-platform/[39msrc/services/email-service.js:420:7[90m)[39m
    at sendNotificationEmail [90m(/mnt/d/manuscript-platform/[39msrc/services/email-service.js:453:9[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at sendEmailVerification [90m(/mnt/d/manuscript-platform/[39msrc/services/email-service.js:863:10[90m)[39m
    at Module.handleResendVerification [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:734:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1262:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/resend-verification > should rate limit resend requests
Verification email resent to: resend@example.com

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/resend-verification > should rate limit resend requests
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleResendVerification [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:747:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1262:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'7dcf734e-ef98-4088-9525-85539d8cc70f'[39m,
  [32m'338e6ab532f65d38962d5fc8d0066089'[39m,
  [32m'verification_resent'[39m,
  [32m'auth'[39m,
  [32m'338e6ab532f65d38962d5fc8d0066089'[39m,
  [33m1763068892[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"resend@example.com"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/resend-verification > should rate limit resend requests
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleResendVerification [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:747:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1262:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/resend-verification > should rate limit resend requests
[Email] RESEND_API_KEY not configured

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/resend-verification > should rate limit resend requests
[Email] Error logging email: ReferenceError: crypto is not defined
    at logEmail [90m(/mnt/d/manuscript-platform/[39msrc/services/email-service.js:420:7[90m)[39m
    at sendNotificationEmail [90m(/mnt/d/manuscript-platform/[39msrc/services/email-service.js:453:9[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at sendEmailVerification [90m(/mnt/d/manuscript-platform/[39msrc/services/email-service.js:863:10[90m)[39m
    at Module.handleResendVerification [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:734:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1262:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/resend-verification > should rate limit resend requests
Verification email resent to: resend@example.com

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/resend-verification > should rate limit resend requests
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleResendVerification [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:747:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1262:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'b626b565-b556-477e-8f1e-2addef658179'[39m,
  [32m'338e6ab532f65d38962d5fc8d0066089'[39m,
  [32m'verification_resent'[39m,
  [32m'auth'[39m,
  [32m'338e6ab532f65d38962d5fc8d0066089'[39m,
  [33m1763068892[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"resend@example.com"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/resend-verification > should rate limit resend requests
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleResendVerification [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:747:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1262:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stdout | tests/integration/handlers/auth-handlers.test.js

ðŸ§¹ Tearing down test environment...

stdout | tests/integration/handlers/auth-handlers.test.js
âœ“ Test database cleaned

stdout | tests/integration/handlers/auth-handlers.test.js
âœ“ Database adapter closed

stdout | tests/integration/handlers/auth-handlers.test.js
âœ“ Test database disconnected

stdout | tests/integration/handlers/auth-handlers.test.js
âœ“ Test database cleaned up
âœ“ Test environment cleaned up


 â¯ tests/integration/handlers/auth-handlers.test.js (53 tests | 8 failed) 167043ms
   âœ“ POST /auth/register > should register a new user with valid credentials  1749ms
   âœ“ POST /auth/register > should reject registration with weak password  1522ms
   âœ“ POST /auth/register > should reject registration with invalid email  1500ms
   âœ“ POST /auth/register > should reject registration with duplicate email  1733ms
   âœ“ POST /auth/register > should hash password with bcrypt  7321ms
   âœ“ POST /auth/register > should normalize email to lowercase  2545ms
   âœ“ POST /auth/register > should create verification token  4000ms
   âœ“ POST /auth/register > should send verification email  1917ms
   Ã— POST /auth/register > should log registration event in audit log 4895ms
     â†’ expected 0 to be greater than 0
   âœ“ POST /auth/register > should set default role to author if not specified  1803ms
   âœ“ POST /auth/login > should login with valid credentials  1680ms
   âœ“ POST /auth/login > should reject login with wrong password  1785ms
   âœ“ POST /auth/login > should reject login with non-existent email  4249ms
   âœ“ POST /auth/login > should reject login with unverified email  1909ms
   âœ“ POST /auth/login > should rate limit after 5 failed attempts  6325ms
   âœ“ POST /auth/login > should update last_login timestamp  2950ms
   âœ“ POST /auth/login > should create session in Redis  1651ms
   Ã— POST /auth/login > should log successful login 4717ms
     â†’ expected 0 to be greater than 0
   Ã— POST /auth/login > should log failed login attempts 1665ms
     â†’ expected 0 to be greater than 0
   âœ“ POST /auth/verify-email > should verify email with valid token  4361ms
   âœ“ POST /auth/verify-email > should reject invalid token  1769ms
   âœ“ POST /auth/verify-email > should reject expired token  4420ms
   âœ“ POST /auth/verify-email > should reject already used token  3187ms
   âœ“ POST /auth/verify-email > should handle missing token  1632ms
   Ã— POST /auth/verify-email > should log email verification event 1664ms
     â†’ expected 0 to be greater than 0
   âœ“ POST /auth/request-password-reset > should create password reset token for valid email  2754ms
   âœ“ POST /auth/request-password-reset > should send password reset email  6407ms
   âœ“ POST /auth/request-password-reset > should not reveal if email does not exist (security)  2220ms
   âœ“ POST /auth/request-password-reset > should rate limit password reset requests  2022ms
   âœ“ POST /auth/request-password-reset > should normalize email to lowercase  5551ms
   âœ“ POST /auth/request-password-reset > should reject invalid email format  2958ms
   âœ“ POST /auth/request-password-reset > should handle missing email  1544ms
   Ã— POST /auth/request-password-reset > should log password reset request 1876ms
     â†’ expected 0 to be greater than 0
   âœ“ POST /auth/reset-password > should reset password with valid token  2136ms
   âœ“ POST /auth/reset-password > should mark reset token as used  5995ms
   âœ“ POST /auth/reset-password > should reject weak new password  1800ms
   âœ“ POST /auth/reset-password > should reject invalid token  1566ms
   âœ“ POST /auth/reset-password > should reject expired token  1601ms
   âœ“ POST /auth/reset-password > should reject already used token  6277ms
   âœ“ POST /auth/reset-password > should hash new password with bcrypt  3643ms
   Ã— POST /auth/reset-password > should log password reset event 1753ms
     â†’ expected 0 to be greater than 0
   âœ“ POST /auth/logout > should logout and destroy session  1623ms
   âœ“ POST /auth/logout > should clear session cookie  4040ms
   Ã— POST /auth/logout > should log logout event 1758ms
     â†’ expected 0 to be greater than 0
   âœ“ GET /auth/me > should return current user with valid session  5036ms
   âœ“ GET /auth/me > should not return password hash  2691ms
   âœ“ GET /auth/me > should reject request without session  2599ms
   Ã— GET /auth/me > should reject request with invalid session 2281ms
     â†’ Hook timed out in 10000ms.
If this is a long-running hook, pass a timeout value as the last argument or configure it globally with "hookTimeout".
   âœ“ GET /auth/me > should return email verification status  3523ms
   âœ“ POST /auth/resend-verification > should resend verification email for unverified user  1781ms
   âœ“ POST /auth/resend-verification > should reject resend for already verified user  3915ms
   âœ“ POST /auth/resend-verification > should rate limit resend requests  2047ms
   âœ“ POST /auth/resend-verification > should not reveal if email does not exist (security)  3153ms
stdout | process.<anonymous> (/mnt/d/manuscript-platform/tests/setup.js:115:11)

âš  Received SIGTERM, cleaning up...

stdout | tests/document-generation.test.js
[dotenv@17.2.3] injecting env (0) from .env.local -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

stdout | tests/document-generation.test.js

ðŸ§ª Setting up test environment...

stdout | tests/document-generation.test.js
âœ“ Test database connected

stdout | tests/document-generation.test.js
  Applying base schema...

stdout | tests/document-generation.test.js
  âœ“ Schema and migrations applied

stdout | tests/document-generation.test.js
âœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

stdout | tests/document-generation.test.js
âœ“ Test database initialized
Initializing adapters...
âœ“ Database adapter initialized
âœ“ Storage adapter initialized
âš  Running in test mode without Redis - using in-memory session store

stdout | tests/document-generation.test.js
âœ“ Session store initialized
âœ“ Cache adapter initialized
âœ“ Queue service initialized
âœ“ Environment initialized
âœ“ Session middleware applied
[VirusScanner] Initializing ClamAV at localhost:3310...

stdout | tests/document-generation.test.js
âœ“ Server adapters initialized
âœ“ Test environment ready


stderr | tests/document-generation.test.js > Document Generation > Query Letter Generation > should generate query letter within word count range
[VirusScanner] Failed to initialize: connect ECONNREFUSED 127.0.0.1:3310

stderr | tests/document-generation.test.js > Document Generation > Query Letter Generation > should generate query letter within word count range
âš  Virus scanner initialization failed (uploads will continue without scanning)

stdout | tests/document-generation.test.js

ðŸ§¹ Tearing down test environment...

stdout | tests/document-generation.test.js
âœ“ Test database cleaned

stdout | tests/document-generation.test.js
âœ“ Database adapter closed

stdout | tests/document-generation.test.js
âœ“ Test database disconnected

stdout | tests/document-generation.test.js
âœ“ Test database cleaned up
âœ“ Test environment cleaned up


 âœ“ tests/document-generation.test.js (27 tests) 93333ms
   âœ“ Document Generation > Query Letter Generation > should generate query letter within word count range  1965ms
   âœ“ Document Generation > Query Letter Generation > should include essential query letter components  1994ms
   âœ“ Document Generation > Query Letter Generation > should validate query letter structure  4230ms
   âœ“ Document Generation > Query Letter Generation > should reject query letters that are too short  1970ms
   âœ“ Document Generation > Query Letter Generation > should reject query letters that are too long  3902ms
   âœ“ Document Generation > Synopsis Generation > should generate short synopsis at 500 words  1883ms
   âœ“ Document Generation > Synopsis Generation > should generate long synopsis at 2500 words  3609ms
   âœ“ Document Generation > Synopsis Generation > should include beginning, middle, and end  4315ms
   âœ“ Document Generation > Synopsis Generation > should reveal ending (unlike blurb)  2008ms
   âœ“ Document Generation > Synopsis Generation > should maintain chronological order  4536ms
   âœ“ Document Generation > Version Management > should create new version on update  1843ms
   âœ“ Document Generation > Version Management > should track version metadata  2028ms
   âœ“ Document Generation > Version Management > should allow rollback to previous version  5047ms
   âœ“ Document Generation > Version Management > should maintain version history after rollback  3451ms
   âœ“ Document Generation > Document Validation > should validate document type  1927ms
   âœ“ Document Generation > Document Validation > should reject invalid document type  1847ms
   âœ“ Document Generation > Document Validation > should validate required fields  6490ms
   âœ“ Document Generation > Document Validation > should calculate word count accurately  1903ms
   âœ“ Document Generation > Document Validation > should handle empty document  1877ms
   âœ“ Document Generation > AI Generation Metadata > should track generation parameters  2512ms
   âœ“ Document Generation > AI Generation Metadata > should calculate cost based on token usage  4801ms
   âœ“ Document Generation > Batch Generation > should generate all document types at once  4813ms
   âœ“ Document Generation > Batch Generation > should track individual generation status  1912ms
   âœ“ Document Generation > Edge Cases > should handle very short manuscript title  4269ms
   âœ“ Document Generation > Edge Cases > should handle very long manuscript title  2108ms
   âœ“ Document Generation > Edge Cases > should handle special characters in content  3431ms
   âœ“ Document Generation > Edge Cases > should handle unicode characters  1968ms
stdout | process.<anonymous> (/mnt/d/manuscript-platform/tests/setup.js:115:11)

âš  Received SIGTERM, cleaning up...

stdout | tests/error-handling.test.js
[dotenv@17.2.3] injecting env (0) from .env.local -- tip: âš™ï¸  suppress all logs with { quiet: true }

stdout | tests/error-handling.test.js

ðŸ§ª Setting up test environment...

stdout | tests/error-handling.test.js
âœ“ Test database connected

stdout | tests/error-handling.test.js
  Applying base schema...

stdout | tests/error-handling.test.js
  âœ“ Schema and migrations applied

stdout | tests/error-handling.test.js
âœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

stdout | tests/error-handling.test.js
âœ“ Test database initialized
Initializing adapters...
âœ“ Database adapter initialized
âœ“ Storage adapter initialized
âš  Running in test mode without Redis - using in-memory session store

stdout | tests/error-handling.test.js
âœ“ Session store initialized
âœ“ Cache adapter initialized
âœ“ Queue service initialized
âœ“ Environment initialized
âœ“ Session middleware applied
[VirusScanner] Initializing ClamAV at localhost:3310...

stdout | tests/error-handling.test.js
âœ“ Server adapters initialized
âœ“ Test environment ready


stderr | tests/error-handling.test.js > Error Handling > Error Classes > should create AppError with correct properties
[VirusScanner] Failed to initialize: connect ECONNREFUSED 127.0.0.1:3310

stderr | tests/error-handling.test.js > Error Handling > Error Classes > should create AppError with correct properties
âš  Virus scanner initialization failed (uploads will continue without scanning)

stdout | tests/error-handling.test.js

ðŸ§¹ Tearing down test environment...

stdout | tests/error-handling.test.js
âœ“ Test database cleaned

stdout | tests/error-handling.test.js
âœ“ Database adapter closed

stdout | tests/error-handling.test.js
âœ“ Test database disconnected

stdout | tests/error-handling.test.js
âœ“ Test database cleaned up
âœ“ Test environment cleaned up


 â¯ tests/error-handling.test.js (24 tests | 4 failed) 63061ms
   âœ“ Error Handling > Error Classes > should create AppError with correct properties  1558ms
   âœ“ Error Handling > Error Classes > should serialize AppError to JSON correctly  2606ms
   âœ“ Error Handling > Error Classes > should create AuthenticationError with 401 status  1438ms
   âœ“ Error Handling > Error Classes > should create AuthorizationError with 403 status  1480ms
   âœ“ Error Handling > Error Classes > should create ValidationError with 400 status  4682ms
   âœ“ Error Handling > Error Classes > should create NotFoundError with 404 status  1518ms
   âœ“ Error Handling > Error Classes > should create RateLimitError with 429 status  1788ms
   âœ“ Error Handling > Error Classes > should create ConflictError with 409 status  1494ms
   âœ“ Error Handling > Error Classes > should create ServerError with 500 status  4189ms
   âœ“ Error Handling > Error Classes > should create ExternalServiceError with service name  1621ms
   Ã— Error Handling > createErrorResponse > should create Response with correct status and JSON 1954ms
     â†’ crypto is not defined
   Ã— Error Handling > createErrorResponse > should handle generic Error objects 1720ms
     â†’ crypto is not defined
   Ã— Error Handling > createErrorResponse > should include Retry-After header for rate limit errors 1550ms
     â†’ crypto is not defined
   Ã— Error Handling > createErrorResponse > should merge additional headers 1503ms
     â†’ crypto is not defined
   âœ“ Error Handling > Assertion Helpers > assert should not throw when condition is true  1443ms
   âœ“ Error Handling > Assertion Helpers > assert should throw ValidationError when condition is false  1562ms
   âœ“ Error Handling > Assertion Helpers > assert should include details in error  1421ms
   âœ“ Error Handling > Assertion Helpers > assertAuthenticated should not throw when userId exists  5049ms
   âœ“ Error Handling > Assertion Helpers > assertAuthenticated should throw when userId is null  1680ms
   âœ“ Error Handling > Assertion Helpers > assertAuthenticated should throw when userId is undefined  2426ms
   âœ“ Error Handling > Assertion Helpers > assertAuthorized should not throw when permission is true  2606ms
   âœ“ Error Handling > Assertion Helpers > assertAuthorized should throw when permission is false  1938ms
   âœ“ Error Handling > Error Inheritance > should maintain instanceof relationships  1501ms
   âœ“ Error Handling > Error Inheritance > should have correct error names  2920ms
stdout | process.<anonymous> (/mnt/d/manuscript-platform/tests/setup.js:115:11)

âš  Received SIGTERM, cleaning up...

stdout | tests/integration/infrastructure.test.js
[dotenv@17.2.3] injecting env (0) from .env.local -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

stdout | tests/integration/infrastructure.test.js

ðŸ§ª Setting up test environment...

stdout | tests/integration/infrastructure.test.js
âœ“ Test database connected

stdout | tests/integration/infrastructure.test.js
  Applying base schema...

stdout | tests/integration/infrastructure.test.js
  âœ“ Schema and migrations applied

stdout | tests/integration/infrastructure.test.js
âœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

stdout | tests/integration/infrastructure.test.js
âœ“ Test database initialized
Initializing adapters...
âœ“ Database adapter initialized
âœ“ Storage adapter initialized
âš  Running in test mode without Redis - using in-memory session store

stdout | tests/integration/infrastructure.test.js
âœ“ Session store initialized
âœ“ Cache adapter initialized
âœ“ Queue service initialized
âœ“ Environment initialized
âœ“ Session middleware applied
[VirusScanner] Initializing ClamAV at localhost:3310...

stdout | tests/integration/infrastructure.test.js
âœ“ Server adapters initialized
âœ“ Test environment ready


stderr | tests/integration/infrastructure.test.js > Test Infrastructure > Database Utilities > should insert and retrieve test records
[VirusScanner] Failed to initialize: connect ECONNREFUSED 127.0.0.1:3310

stderr | tests/integration/infrastructure.test.js > Test Infrastructure > Database Utilities > should insert and retrieve test records
âš  Virus scanner initialization failed (uploads will continue without scanning)

[0mGET /health [32m200[0m 9.517 ms - 105[0m
stdout | tests/integration/infrastructure.test.js

ðŸ§¹ Tearing down test environment...

stdout | tests/integration/infrastructure.test.js
âœ“ Test database cleaned

stdout | tests/integration/infrastructure.test.js
âœ“ Database adapter closed

stdout | tests/integration/infrastructure.test.js
âœ“ Test database disconnected

stdout | tests/integration/infrastructure.test.js
âœ“ Test database cleaned up
âœ“ Test environment cleaned up


 âœ“ tests/integration/infrastructure.test.js (13 tests) 43014ms
   âœ“ Test Infrastructure > Database Utilities > should insert and retrieve test records  1529ms
   âœ“ Test Infrastructure > Database Utilities > should count test records  4137ms
   âœ“ Test Infrastructure > Database Utilities > should reset database between tests  2368ms
   âœ“ Test Infrastructure > API Client > should make HTTP requests  1814ms
   âœ“ Test Infrastructure > Mock Factories > should create mock Redis client  1432ms
   âœ“ Test Infrastructure > Mock Factories > should create mock Redis client with expiration  1512ms
   âœ“ Test Infrastructure > Mock Factories > should create mock storage adapter  3049ms
   âœ“ Test Infrastructure > Test Data Factories > should create test user data  2604ms
   âœ“ Test Infrastructure > Test Data Factories > should create test user with overrides  2528ms
   âœ“ Test Infrastructure > Test Data Factories > should create test manuscript data  4253ms
   âœ“ Test Infrastructure > Test Data Factories > should generate unique test emails  2237ms
   âœ“ Test Infrastructure > Integration: Factories + Database > should insert factory-generated user into database  1447ms
   âœ“ Test Infrastructure > Integration: Factories + Database > should insert factory-generated manuscript into database  1564ms
stdout | process.<anonymous> (/mnt/d/manuscript-platform/tests/setup.js:115:11)

âš  Received SIGTERM, cleaning up...

stdout | tests/unit/test-helpers.test.js
[dotenv@17.2.3] injecting env (0) from .env.local -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

stdout | tests/unit/test-helpers.test.js

ðŸ§ª Setting up test environment...

stdout | tests/unit/test-helpers.test.js
âœ“ Test database connected

stdout | tests/unit/test-helpers.test.js
  Applying base schema...

stdout | tests/unit/test-helpers.test.js
  âœ“ Schema and migrations applied

stdout | tests/unit/test-helpers.test.js
âœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

stdout | tests/unit/test-helpers.test.js
âœ“ Test database initialized
Initializing adapters...
âœ“ Database adapter initialized
âœ“ Storage adapter initialized
âš  Running in test mode without Redis - using in-memory session store

stdout | tests/unit/test-helpers.test.js
âœ“ Session store initialized
âœ“ Cache adapter initialized
âœ“ Queue service initialized
âœ“ Environment initialized
âœ“ Session middleware applied
[VirusScanner] Initializing ClamAV at localhost:3310...

stdout | tests/unit/test-helpers.test.js
âœ“ Server adapters initialized
âœ“ Test environment ready


stderr | tests/unit/test-helpers.test.js > Mock Factories > Storage Adapter Mock > should put and get objects
[VirusScanner] Failed to initialize: connect ECONNREFUSED 127.0.0.1:3310

stderr | tests/unit/test-helpers.test.js > Mock Factories > Storage Adapter Mock > should put and get objects
âš  Virus scanner initialization failed (uploads will continue without scanning)

stdout | tests/unit/test-helpers.test.js

ðŸ§¹ Tearing down test environment...

stdout | tests/unit/test-helpers.test.js
âœ“ Test database cleaned

stdout | tests/unit/test-helpers.test.js
âœ“ Database adapter closed

stdout | tests/unit/test-helpers.test.js
âœ“ Test database disconnected

stdout | tests/unit/test-helpers.test.js
âœ“ Test database cleaned up
âœ“ Test environment cleaned up


 âœ“ tests/unit/test-helpers.test.js (24 tests) 56317ms
   âœ“ Mock Factories > Storage Adapter Mock > should put and get objects  1624ms
   âœ“ Mock Factories > Storage Adapter Mock > should delete objects  1469ms
   âœ“ Mock Factories > Storage Adapter Mock > should list objects by prefix  1439ms
   âœ“ Mock Factories > Redis Mock > should set and get values  1508ms
   âœ“ Mock Factories > Redis Mock > should set values with expiration  2270ms
   âœ“ Mock Factories > Redis Mock > should delete keys  1764ms
   âœ“ Mock Factories > Redis Mock > should increment values  2202ms
   âœ“ Mock Factories > Claude API Mock > should return mock AI responses  2009ms
   âœ“ Mock Factories > Claude API Mock > should include custom response text  2812ms
   âœ“ Mock Factories > Email Service Mock > should track sent emails  1444ms
   âœ“ Mock Factories > Email Service Mock > should find emails by recipient  2034ms
   âœ“ Mock Factories > Email Service Mock > should clear sent emails  2107ms
   âœ“ Mock Factories > Stripe Mock > should create checkout sessions  1684ms
   âœ“ Mock Factories > Stripe Mock > should create payment intents  3024ms
   âœ“ Mock Factories > Stripe Mock > should construct webhook events  1506ms
   âœ“ Test Data Factories > User Factory > should create valid user data  1514ms
   âœ“ Test Data Factories > User Factory > should accept overrides  1877ms
   âœ“ Test Data Factories > Manuscript Factory > should create valid manuscript data  2804ms
   âœ“ Test Data Factories > Manuscript Factory > should accept overrides  1486ms
   âœ“ Test Data Factories > Analysis Factory > should create valid analysis data  1667ms
   âœ“ Test Data Factories > Analysis Factory > should include result JSON  2570ms
   âœ“ Test Data Factories > Payment Factory > should create valid payment data  1572ms
   âœ“ Test Data Factories > Utility Functions > should generate unique email addresses  1821ms
   âœ“ Test Data Factories > Utility Functions > should generate unique IDs  2470ms
stdout | process.<anonymous> (/mnt/d/manuscript-platform/tests/setup.js:115:11)

âš  Received SIGTERM, cleaning up...

stdout | tests/auth-utils.test.js
[dotenv@17.2.3] injecting env (0) from .env.local -- tip: âš™ï¸  override existing env vars with { override: true }

stdout | tests/auth-utils.test.js

ðŸ§ª Setting up test environment...

stdout | tests/auth-utils.test.js
âœ“ Test database connected

stdout | tests/auth-utils.test.js
  Applying base schema...

stdout | tests/auth-utils.test.js
  âœ“ Schema and migrations applied

stdout | tests/auth-utils.test.js
âœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

stdout | tests/auth-utils.test.js
âœ“ Test database initialized
Initializing adapters...
âœ“ Database adapter initialized
âœ“ Storage adapter initialized
âš  Running in test mode without Redis - using in-memory session store

stdout | tests/auth-utils.test.js
âœ“ Session store initialized
âœ“ Cache adapter initialized
âœ“ Queue service initialized
âœ“ Environment initialized
âœ“ Session middleware applied
[VirusScanner] Initializing ClamAV at localhost:3310...

stdout | tests/auth-utils.test.js
âœ“ Server adapters initialized
âœ“ Test environment ready


stderr | tests/auth-utils.test.js > Authentication Utilities > validatePassword > should accept a valid password
[VirusScanner] Failed to initialize: connect ECONNREFUSED 127.0.0.1:3310

stderr | tests/auth-utils.test.js > Authentication Utilities > validatePassword > should accept a valid password
âš  Virus scanner initialization failed (uploads will continue without scanning)

stdout | tests/auth-utils.test.js

ðŸ§¹ Tearing down test environment...

stdout | tests/auth-utils.test.js
âœ“ Test database cleaned

stdout | tests/auth-utils.test.js
âœ“ Database adapter closed

stdout | tests/auth-utils.test.js
âœ“ Test database disconnected

stdout | tests/auth-utils.test.js
âœ“ Test database cleaned up
âœ“ Test environment cleaned up


 âœ“ tests/auth-utils.test.js (22 tests) 72603ms
   âœ“ Authentication Utilities > validatePassword > should accept a valid password  1497ms
   âœ“ Authentication Utilities > validatePassword > should reject password shorter than 8 characters  1556ms
   âœ“ Authentication Utilities > validatePassword > should reject password without uppercase letter  2407ms
   âœ“ Authentication Utilities > validatePassword > should reject password without lowercase letter  1961ms
   âœ“ Authentication Utilities > validatePassword > should reject password without number  2094ms
   âœ“ Authentication Utilities > validatePassword > should reject password without special character  2989ms
   âœ“ Authentication Utilities > validatePassword > should reject null or undefined password  2255ms
   âœ“ Authentication Utilities > validatePassword > should accept password with all requirements  2778ms
   âœ“ Authentication Utilities > validatePassword > should return multiple errors for invalid password  2938ms
   âœ“ Authentication Utilities > validateEmail > should accept valid email addresses  1982ms
   âœ“ Authentication Utilities > validateEmail > should reject invalid email addresses  4704ms
   âœ“ Authentication Utilities > validateEmail > should handle edge cases  1821ms
   âœ“ Authentication Utilities > hashPassword and verifyPassword > should hash a password  4674ms
   âœ“ Authentication Utilities > hashPassword and verifyPassword > should produce different hashes for same password  2003ms
   âœ“ Authentication Utilities > hashPassword and verifyPassword > should verify correct password  4500ms
   âœ“ Authentication Utilities > hashPassword and verifyPassword > should reject incorrect password  3647ms
   âœ“ Authentication Utilities > hashPassword and verifyPassword > should handle empty passwords  2864ms
   âœ“ Authentication Utilities > hashPassword and verifyPassword > should be case sensitive  3307ms
   âœ“ Authentication Utilities > hashPassword and verifyPassword > should handle long passwords  2175ms
   âœ“ Authentication Utilities > AUTH_CONFIG > should have valid configuration values  3105ms
   âœ“ Authentication Utilities > AUTH_CONFIG > should have password requirements defined  2975ms
   âœ“ Authentication Utilities > AUTH_CONFIG > should have rate limit configuration  4390ms
stdout | process.<anonymous> (/mnt/d/manuscript-platform/tests/setup.js:115:11)

âš  Received SIGTERM, cleaning up...

stdout | tests/submission-packages.test.js
[dotenv@17.2.3] injecting env (0) from .env.local -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

stdout | tests/submission-packages.test.js

ðŸ§ª Setting up test environment...

stdout | tests/submission-packages.test.js
âœ“ Test database connected

stdout | tests/submission-packages.test.js
  Applying base schema...

stdout | tests/submission-packages.test.js
  âœ“ Schema and migrations applied

stdout | tests/submission-packages.test.js
âœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

stdout | tests/submission-packages.test.js
âœ“ Test database initialized
Initializing adapters...
âœ“ Database adapter initialized
âœ“ Storage adapter initialized
âš  Running in test mode without Redis - using in-memory session store

stdout | tests/submission-packages.test.js
âœ“ Session store initialized
âœ“ Cache adapter initialized
âœ“ Queue service initialized
âœ“ Environment initialized
âœ“ Session middleware applied
[VirusScanner] Initializing ClamAV at localhost:3310...

stdout | tests/submission-packages.test.js
âœ“ Server adapters initialized
âœ“ Test environment ready


stderr | tests/submission-packages.test.js > Submission Package Bundler > Package Templates > should have agent query template
[VirusScanner] Failed to initialize: connect ECONNREFUSED 127.0.0.1:3310

stderr | tests/submission-packages.test.js > Submission Package Bundler > Package Templates > should have agent query template
âš  Virus scanner initialization failed (uploads will continue without scanning)

stdout | tests/submission-packages.test.js

ðŸ§¹ Tearing down test environment...

stdout | tests/submission-packages.test.js
âœ“ Test database cleaned

stdout | tests/submission-packages.test.js
âœ“ Database adapter closed

stdout | tests/submission-packages.test.js
âœ“ Test database disconnected

stdout | tests/submission-packages.test.js
âœ“ Test database cleaned up
âœ“ Test environment cleaned up


 âœ“ tests/submission-packages.test.js (31 tests) 74712ms
   âœ“ Submission Package Bundler > Package Templates > should have agent query template  2663ms
   âœ“ Submission Package Bundler > Package Templates > should have full manuscript template  2661ms
   âœ“ Submission Package Bundler > Package Templates > should have query only template  2709ms
   âœ“ Submission Package Bundler > Package Templates > should have contest template  1607ms
   âœ“ Submission Package Bundler > Package Templates > should validate required documents  1586ms
   âœ“ Submission Package Bundler > Package Creation > should create package with metadata  1455ms
   âœ“ Submission Package Bundler > Package Creation > should include document list with ordering  1444ms
   âœ“ Submission Package Bundler > Package Creation > should validate package has at least one document  1895ms
   âœ“ Submission Package Bundler > Package Creation > should allow custom package names  2535ms
   âœ“ Submission Package Bundler > Document Selection > should allow selecting multiple documents  2001ms
   âœ“ Submission Package Bundler > Document Selection > should maintain document order  1959ms
   âœ“ Submission Package Bundler > Document Selection > should allow reordering documents  2912ms
   âœ“ Submission Package Bundler > ZIP File Generation > should generate ZIP with multiple files  1497ms
   âœ“ Submission Package Bundler > ZIP File Generation > should prefix files with order numbers  1569ms
   âœ“ Submission Package Bundler > ZIP File Generation > should sanitize filenames  1837ms
   âœ“ Submission Package Bundler > ZIP File Generation > should support different file formats  2101ms
   âœ“ Submission Package Bundler > ZIP File Generation > should include metadata file in ZIP  2112ms
   âœ“ Submission Package Bundler > Package Duplication > should create copy of existing package  1416ms
   âœ“ Submission Package Bundler > Package Duplication > should increment copy counter in name  1404ms
   âœ“ Submission Package Bundler > Package Management > should list packages for manuscript  1413ms
   âœ“ Submission Package Bundler > Package Management > should update package details  2140ms
   âœ“ Submission Package Bundler > Package Management > should delete package  3519ms
   âœ“ Submission Package Bundler > Validation > should validate package has required documents  2901ms
   âœ“ Submission Package Bundler > Validation > should validate document exists before adding to package  2027ms
   âœ“ Submission Package Bundler > Validation > should prevent duplicate documents in package  1439ms
   âœ“ Submission Package Bundler > Download Tracking > should track download count  1597ms
   âœ“ Submission Package Bundler > Download Tracking > should track last downloaded timestamp  2424ms
   âœ“ Submission Package Bundler > Edge Cases > should handle empty package name  1415ms
   âœ“ Submission Package Bundler > Edge Cases > should handle very long package name  1628ms
   âœ“ Submission Package Bundler > Edge Cases > should handle package with only one document  2437ms
   âœ“ Submission Package Bundler > Edge Cases > should handle large file sizes  2723ms
stdout | process.<anonymous> (/mnt/d/manuscript-platform/tests/setup.js:115:11)

âš  Received SIGTERM, cleaning up...

stdout | tests/metadata-handlers.test.js
[dotenv@17.2.3] injecting env (0) from .env.local -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

stdout | tests/metadata-handlers.test.js

ðŸ§ª Setting up test environment...

stdout | tests/metadata-handlers.test.js
âœ“ Test database connected

stdout | tests/metadata-handlers.test.js
  Applying base schema...

stdout | tests/metadata-handlers.test.js
  âœ“ Schema and migrations applied

stdout | tests/metadata-handlers.test.js
âœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

stdout | tests/metadata-handlers.test.js
âœ“ Test database initialized
Initializing adapters...
âœ“ Database adapter initialized
âœ“ Storage adapter initialized
âš  Running in test mode without Redis - using in-memory session store

stdout | tests/metadata-handlers.test.js
âœ“ Session store initialized
âœ“ Cache adapter initialized
âœ“ Queue service initialized
âœ“ Environment initialized
âœ“ Session middleware applied
[VirusScanner] Initializing ClamAV at localhost:3310...

stdout | tests/metadata-handlers.test.js
âœ“ Server adapters initialized
âœ“ Test environment ready


stderr | tests/metadata-handlers.test.js > Enhanced Metadata Handlers > Genre Validation > should validate word count for romance novel
[VirusScanner] Failed to initialize: connect ECONNREFUSED 127.0.0.1:3310

stderr | tests/metadata-handlers.test.js > Enhanced Metadata Handlers > Genre Validation > should validate word count for romance novel
âš  Virus scanner initialization failed (uploads will continue without scanning)

stdout | tests/metadata-handlers.test.js

ðŸ§¹ Tearing down test environment...

stdout | tests/metadata-handlers.test.js
âœ“ Test database cleaned

stdout | tests/metadata-handlers.test.js
âœ“ Database adapter closed

stdout | tests/metadata-handlers.test.js
âœ“ Test database disconnected

stdout | tests/metadata-handlers.test.js
âœ“ Test database cleaned up
âœ“ Test environment cleaned up


 âœ“ tests/metadata-handlers.test.js (21 tests) 50082ms
   âœ“ Enhanced Metadata Handlers > Genre Validation > should validate word count for romance novel  1573ms
   âœ“ Enhanced Metadata Handlers > Genre Validation > should flag word count outside genre norms  1523ms
   âœ“ Enhanced Metadata Handlers > Genre Validation > should accept novella word counts for appropriate genres  1504ms
   âœ“ Enhanced Metadata Handlers > Content Warning Validation > should validate content warning categories  1496ms
   âœ“ Enhanced Metadata Handlers > Content Warning Validation > should validate severity levels  1518ms
   âœ“ Enhanced Metadata Handlers > Content Warning Validation > should handle multiple content warnings  2403ms
   âœ“ Enhanced Metadata Handlers > Metadata Structure > should validate primary genre and subgenres  2255ms
   âœ“ Enhanced Metadata Handlers > Metadata Structure > should validate age category  2932ms
   âœ“ Enhanced Metadata Handlers > Metadata Structure > should validate manuscript status  1879ms
   âœ“ Enhanced Metadata Handlers > Metadata Structure > should validate series information  1458ms
   âœ“ Enhanced Metadata Handlers > Metadata History Tracking > should record metadata changes with timestamp  1429ms
   âœ“ Enhanced Metadata Handlers > Metadata History Tracking > should track multiple change types  1824ms
   âœ“ Enhanced Metadata Handlers > Genre Hierarchy > should validate parent-child genre relationships  2683ms
   âœ“ Enhanced Metadata Handlers > Genre Hierarchy > should handle subgenre depth  1647ms
   âœ“ Enhanced Metadata Handlers > Word Count Validation Logic > should categorize flash fiction correctly  1924ms
   âœ“ Enhanced Metadata Handlers > Word Count Validation Logic > should categorize novel correctly  2059ms
   âœ“ Enhanced Metadata Handlers > Word Count Validation Logic > should categorize epic correctly  2276ms
   âœ“ Enhanced Metadata Handlers > Edge Cases > should handle missing optional metadata fields  2761ms
   âœ“ Enhanced Metadata Handlers > Edge Cases > should handle empty subgenres array  1671ms
   âœ“ Enhanced Metadata Handlers > Edge Cases > should validate completion percentage range  1896ms
   âœ“ Enhanced Metadata Handlers > Edge Cases > should reject invalid completion percentage  1523ms
stdout | process.<anonymous> (/mnt/d/manuscript-platform/tests/setup.js:115:11)

âš  Received SIGTERM, cleaning up...

stdout | tests/integration/webhook-signature-verification.test.js
[dotenv@17.2.3] injecting env (0) from .env.local -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

stdout | tests/integration/webhook-signature-verification.test.js

ðŸ§ª Setting up test environment...

stdout | tests/integration/webhook-signature-verification.test.js
âœ“ Test database connected

stdout | tests/integration/webhook-signature-verification.test.js
  Applying base schema...

stdout | tests/integration/webhook-signature-verification.test.js
  âœ“ Schema and migrations applied

stdout | tests/integration/webhook-signature-verification.test.js
âœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

stdout | tests/integration/webhook-signature-verification.test.js
âœ“ Test database initialized
Initializing adapters...
âœ“ Database adapter initialized
âœ“ Storage adapter initialized
âš  Running in test mode without Redis - using in-memory session store

stdout | tests/integration/webhook-signature-verification.test.js
âœ“ Session store initialized
âœ“ Cache adapter initialized
âœ“ Queue service initialized
âœ“ Environment initialized
âœ“ Session middleware applied
[VirusScanner] Initializing ClamAV at localhost:3310...

stdout | tests/integration/webhook-signature-verification.test.js
âœ“ Server adapters initialized
âœ“ Test environment ready


stderr | tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Valid Signatures > should accept webhook with valid signature
[VirusScanner] Failed to initialize: connect ECONNREFUSED 127.0.0.1:3310

stderr | tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Valid Signatures > should accept webhook with valid signature
âš  Virus scanner initialization failed (uploads will continue without scanning)

stdout | tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Valid Signatures > should accept webhook with valid signature
[Webhook] Processing event: checkout.session.completed evt_test_3723395a7804f1ba69b27c1e
[Webhook] Checkout completed for user: user-123 plan: [90mundefined[39m

stderr | tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Valid Signatures > should accept webhook with valid signature
[Webhook] Error: ReferenceError: crypto is not defined
    at handleCheckoutCompleted [90m(/mnt/d/manuscript-platform/[39msrc/handlers/webhook-handlers.js:159:23[90m)[39m
    at handleStripeWebhook [90m(/mnt/d/manuscript-platform/[39msrc/handlers/webhook-handlers.js:54:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/webhook-signature-verification.test.js:110:26

stdout | tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Valid Signatures > should accept webhook with recent timestamp (within 5 min)
[Webhook] Processing event: checkout.session.completed evt_test_11952ee939a1e14bbd2f91fd
[Webhook] Checkout completed for user: [90mundefined[39m plan: [90mundefined[39m

stderr | tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Valid Signatures > should accept webhook with recent timestamp (within 5 min)
[Webhook] Error: ReferenceError: crypto is not defined
    at handleCheckoutCompleted [90m(/mnt/d/manuscript-platform/[39msrc/handlers/webhook-handlers.js:159:23[90m)[39m
    at handleStripeWebhook [90m(/mnt/d/manuscript-platform/[39msrc/handlers/webhook-handlers.js:54:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/webhook-signature-verification.test.js:110:26

stderr | tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Invalid Signatures > should reject webhook with incorrect signature
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


stderr | tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Invalid Signatures > should reject webhook with malformed signature format
[Webhook] Signature verification failed: No signatures found with expected scheme

stderr | tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Invalid Signatures > should reject webhook with tampered payload
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


stderr | tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Replay Attack Prevention > should reject webhook with expired timestamp (>5 min old)
[Webhook] Signature verification failed: Timestamp outside the tolerance zone

stdout | tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Replay Attack Prevention > should accept webhook with future timestamp (Stripe allows clock skew)
[Webhook] Processing event: checkout.session.completed evt_test_148f7d8c5206d7c237860a63
[Webhook] Checkout completed for user: [90mundefined[39m plan: [90mundefined[39m

stderr | tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Replay Attack Prevention > should accept webhook with future timestamp (Stripe allows clock skew)
[Webhook] Error: ReferenceError: crypto is not defined
    at handleCheckoutCompleted [90m(/mnt/d/manuscript-platform/[39msrc/handlers/webhook-handlers.js:159:23[90m)[39m
    at handleStripeWebhook [90m(/mnt/d/manuscript-platform/[39msrc/handlers/webhook-handlers.js:54:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/webhook-signature-verification.test.js:110:26

stdout | tests/integration/webhook-signature-verification.test.js

ðŸ§¹ Tearing down test environment...

stdout | tests/integration/webhook-signature-verification.test.js
âœ“ Test database cleaned

stdout | tests/integration/webhook-signature-verification.test.js
âœ“ Database adapter closed

stdout | tests/integration/webhook-signature-verification.test.js
âœ“ Test database disconnected

stdout | tests/integration/webhook-signature-verification.test.js
âœ“ Test database cleaned up
âœ“ Test environment cleaned up


 â¯ tests/integration/webhook-signature-verification.test.js (9 tests | 3 failed) 26254ms
   Ã— Webhook Signature Verification > Valid Signatures > should accept webhook with valid signature 1849ms
     â†’ expected 500 to be 200 // Object.is equality
   Ã— Webhook Signature Verification > Valid Signatures > should accept webhook with recent timestamp (within 5 min) 1504ms
     â†’ expected 500 to be 200 // Object.is equality
   âœ“ Webhook Signature Verification > Missing Signature > should reject webhook with no signature header  1450ms
   âœ“ Webhook Signature Verification > Missing Signature > should reject webhook with empty signature  1426ms
   âœ“ Webhook Signature Verification > Invalid Signatures > should reject webhook with incorrect signature  1478ms
   âœ“ Webhook Signature Verification > Invalid Signatures > should reject webhook with malformed signature format  1740ms
   âœ“ Webhook Signature Verification > Invalid Signatures > should reject webhook with tampered payload  1723ms
   âœ“ Webhook Signature Verification > Replay Attack Prevention > should reject webhook with expired timestamp (>5 min old)  3737ms
   Ã— Webhook Signature Verification > Replay Attack Prevention > should accept webhook with future timestamp (Stripe allows clock skew) 2322ms
     â†’ expected 500 to be 200 // Object.is equality
stdout | process.<anonymous> (/mnt/d/manuscript-platform/tests/setup.js:115:11)

âš  Received SIGTERM, cleaning up...


âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯ Failed Tests 17 âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯

 FAIL  tests/error-handling.test.js > Error Handling > createErrorResponse > should create Response with correct status and JSON
ReferenceError: crypto is not defined
 â¯ createErrorResponse src/utils/error-handling.js:133:21
    131| export function createErrorResponse(error, request = null, headers = {â€¦
    132|   // Generate request ID for tracking
    133|   const requestId = crypto.randomUUID();
       |                     ^
    134| 
    135|   // Determine if this is an AppError or generic Error
 â¯ tests/error-handling.test.js:106:43

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[1/17]âŽ¯

 FAIL  tests/error-handling.test.js > Error Handling > createErrorResponse > should handle generic Error objects
ReferenceError: crypto is not defined
 â¯ createErrorResponse src/utils/error-handling.js:133:21
    131| export function createErrorResponse(error, request = null, headers = {â€¦
    132|   // Generate request ID for tracking
    133|   const requestId = crypto.randomUUID();
       |                     ^
    134| 
    135|   // Determine if this is an AppError or generic Error
 â¯ tests/error-handling.test.js:114:43

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[2/17]âŽ¯

 FAIL  tests/error-handling.test.js > Error Handling > createErrorResponse > should include Retry-After header for rate limit errors
ReferenceError: crypto is not defined
 â¯ createErrorResponse src/utils/error-handling.js:133:21
    131| export function createErrorResponse(error, request = null, headers = {â€¦
    132|   // Generate request ID for tracking
    133|   const requestId = crypto.randomUUID();
       |                     ^
    134| 
    135|   // Determine if this is an AppError or generic Error
 â¯ tests/error-handling.test.js:121:43

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[3/17]âŽ¯

 FAIL  tests/error-handling.test.js > Error Handling > createErrorResponse > should merge additional headers
ReferenceError: crypto is not defined
 â¯ createErrorResponse src/utils/error-handling.js:133:21
    131| export function createErrorResponse(error, request = null, headers = {â€¦
    132|   // Generate request ID for tracking
    133|   const requestId = crypto.randomUUID();
       |                     ^
    134| 
    135|   // Determine if this is an AppError or generic Error
 â¯ tests/error-handling.test.js:128:43

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[4/17]âŽ¯

 FAIL  tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Valid Signatures > should accept webhook with valid signature
AssertionError: expected 500 to be 200 // Object.is equality

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 500[39m

 â¯ tests/integration/webhook-signature-verification.test.js:136:31
    134|       const response = await sendWebhook(app, payload, signature);
    135| 
    136|       expect(response.status).toBe(200);
       |                               ^
    137|     });
    138| 

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[5/17]âŽ¯

 FAIL  tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Valid Signatures > should accept webhook with recent timestamp (within 5 min)
AssertionError: expected 500 to be 200 // Object.is equality

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 500[39m

 â¯ tests/integration/webhook-signature-verification.test.js:151:31
    149|       const response = await sendWebhook(app, payload, signature);
    150| 
    151|       expect(response.status).toBe(200);
       |                               ^
    152|     });
    153|   });

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[6/17]âŽ¯

 FAIL  tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Replay Attack Prevention > should accept webhook with future timestamp (Stripe allows clock skew)
AssertionError: expected 500 to be 200 // Object.is equality

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 500[39m

 â¯ tests/integration/webhook-signature-verification.test.js:269:31
    267| 
    268|       // Stripe accepts future timestamps (prevents false positives frâ€¦
    269|       expect(response.status).toBe(200);
       |                               ^
    270|       expect(response.body.received).toBe(true);
    271|     });

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[7/17]âŽ¯

 FAIL  tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should log registration event in audit log
AssertionError: expected 0 to be greater than 0
 â¯ tests/integration/handlers/auth-handlers.test.js:244:24
    242| 
    243|     const auditCount = await countTestRecords('audit_log', { event_typâ€¦
    244|     expect(auditCount).toBeGreaterThan(0);
       |                        ^
    245|   });
    246| 

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[8/17]âŽ¯

 FAIL  tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should log successful login
AssertionError: expected 0 to be greater than 0
 â¯ tests/integration/handlers/auth-handlers.test.js:468:24
    466| 
    467|     const auditCount = await countTestRecords('audit_log', { event_typâ€¦
    468|     expect(auditCount).toBeGreaterThan(0);
       |                        ^
    469|   });
    470| 

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[9/17]âŽ¯

 FAIL  tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should log failed login attempts
AssertionError: expected 0 to be greater than 0
 â¯ tests/integration/handlers/auth-handlers.test.js:485:24
    483| 
    484|     const auditCount = await countTestRecords('audit_log', { event_typâ€¦
    485|     expect(auditCount).toBeGreaterThan(0);
       |                        ^
    486|   });
    487| });

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[10/17]âŽ¯

 FAIL  tests/integration/handlers/auth-handlers.test.js > POST /auth/verify-email > should log email verification event
AssertionError: expected 0 to be greater than 0
 â¯ tests/integration/handlers/auth-handlers.test.js:625:24
    623| 
    624|     const auditCount = await countTestRecords('audit_log', { event_typâ€¦
    625|     expect(auditCount).toBeGreaterThan(0);
       |                        ^
    626|   });
    627| });

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[11/17]âŽ¯

 FAIL  tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should log password reset request
AssertionError: expected 0 to be greater than 0
 â¯ tests/integration/handlers/auth-handlers.test.js:811:24
    809| 
    810|     const auditCount = await countTestRecords('audit_log', { event_typâ€¦
    811|     expect(auditCount).toBeGreaterThan(0);
       |                        ^
    812|   });
    813| });

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[12/17]âŽ¯

 FAIL  tests/integration/handlers/auth-handlers.test.js > POST /auth/reset-password > should log password reset event
AssertionError: expected 0 to be greater than 0
 â¯ tests/integration/handlers/auth-handlers.test.js:993:24
    991| 
    992|     const auditCount = await countTestRecords('audit_log', { event_typâ€¦
    993|     expect(auditCount).toBeGreaterThan(0);
       |                        ^
    994|   });
    995| });

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[13/17]âŽ¯

 FAIL  tests/integration/handlers/auth-handlers.test.js > POST /auth/logout > should log logout event
AssertionError: expected 0 to be greater than 0
 â¯ tests/integration/handlers/auth-handlers.test.js:1072:24
    1070| 
    1071|     const auditCount = await countTestRecords('audit_log', { event_typâ€¦
    1072|     expect(auditCount).toBeGreaterThan(0);
       |                        ^
    1073|   });
    1074| });

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[14/17]âŽ¯

 FAIL  tests/integration/handlers/auth-handlers.test.js > GET /auth/me > should reject request with invalid session
 FAIL  tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /create-checkout-session > should handle missing priceId field
 FAIL  tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > Usage Tracking > should track manuscript analysis usage
Error: Hook timed out in 10000ms.
If this is a long-running hook, pass a timeout value as the last argument or configure it globally with "hookTimeout".
 â¯ tests/setup.js:80:11
     78|  * Only runs if database was initialized.
     79|  */
     80| beforeEach(async () => {
       |           ^
     81|   if (testDb) {
     82|     await resetTestDatabase();

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[15/17]âŽ¯


 Test Files  4 failed | 6 passed (10)
      Tests  17 failed | 261 passed (278)
   Start at  21:15:42
   Duration  1053.86s (transform 2.23s, setup 216.64s, collect 2.32s, tests 815.62s, environment 2ms, prepare 8.95s)


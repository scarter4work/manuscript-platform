
> manuscript-upload-api@1.0.0 test
> cross-env NODE_ENV=test TEST_DATABASE_URL=postgresql://postgres:Bjoran32!@127.0.0.1:5432/manuscript_platform_test vitest run


[1m[46m RUN [49m[22m [36mv3.2.4 [39m[90mD:/manuscript-platform[39m

[90mstdout[2m | tests/integration/handlers/payment-handlers.test.js
[22m[39m[dotenv@17.2.3] injecting env (0) from .env.local -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/handlers/payment-handlers.test.js
[22m[39m
ðŸ§ª Setting up test environment...

[90mstdout[2m | tests/integration/handlers/payment-handlers.test.js
[22m[39mâœ“ Test database connected

[90mstdout[2m | tests/integration/handlers/payment-handlers.test.js
[22m[39m  Applying base schema...

[90mstdout[2m | tests/integration/handlers/payment-handlers.test.js
[22m[39m  âœ“ Schema and migrations applied

[90mstdout[2m | tests/integration/handlers/payment-handlers.test.js
[22m[39mâœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

[90mstdout[2m | tests/integration/handlers/payment-handlers.test.js
[22m[39mâœ“ Test database initialized
Initializing adapters...
âœ“ Database adapter initialized
âœ“ Storage adapter initialized
âš  Running in test mode without Redis - using in-memory session store

[90mstdout[2m | tests/integration/handlers/payment-handlers.test.js
[22m[39mâœ“ Session store initialized
âœ“ Cache adapter initialized
âœ“ Queue service initialized
âœ“ Environment initialized
âœ“ Session middleware applied
[VirusScanner] Initializing ClamAV at localhost:3310...

[90mstdout[2m | tests/integration/handlers/payment-handlers.test.js
[22m[39mâœ“ Server adapters initialized
âœ“ Test environment ready


[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /create-checkout-session[2m > [22m[2mshould create checkout session for valid subscription
[22m[39m[VirusScanner] Failed to initialize: 

[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /create-checkout-session[2m > [22m[2mshould create checkout session for valid subscription
[22m[39mâš  Virus scanner initialization failed (uploads will continue without scanning)

[0mPOST /auth/login [32m200[0m 126.532 ms - 128[0m
[0mPOST /create-checkout-session [33m400[0m 27.663 ms - 29[0m
[0mPOST /auth/login [32m200[0m 454.575 ms - 128[0m
[0mPOST /create-checkout-session [33m401[0m 2.914 ms - 24[0m
[0mPOST /auth/login [32m200[0m 68.685 ms - 128[0m
[0mPOST /create-checkout-session [33m400[0m 1.927 ms - 29[0m
[0mPOST /auth/login [32m200[0m 67.376 ms - 128[0m
[0mPOST /create-checkout-session [33m400[0m 0.924 ms - 29[0m
[0mPOST /auth/login [32m200[0m 68.319 ms - 128[0m
[0mPOST /create-checkout-session [33m400[0m 1.074 ms - 29[0m
[0mPOST /auth/login [32m200[0m 224.772 ms - 128[0m
[0mPOST /create-checkout-session [33m400[0m 0.839 ms - 29[0m
[0mPOST /auth/login [32m200[0m 65.500 ms - 128[0m
[0mPOST /create-checkout-session [33m400[0m 0.967 ms - 29[0m
[0mPOST /auth/login [32m200[0m 67.670 ms - 128[0m
[0mPOST /create-checkout-session [33m400[0m 1.975 ms - 29[0m
[0mPOST /auth/login [32m200[0m 118.587 ms - 128[0m
[0mPOST /create-checkout-session [33m400[0m 0.750 ms - 29[0m
[0mPOST /auth/login [32m200[0m 63.990 ms - 128[0m
[0mPOST /create-checkout-session [33m400[0m 0.807 ms - 29[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Signature Verification[2m > [22m[2mshould accept webhook with valid signature
[22m[39m[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 2.649 ms - 29[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Signature Verification[2m > [22m[2mshould reject webhook with invalid signature
[22m[39m[Webhook] Signature verification failed: Unable to extract timestamp and signatures from header

[0mPOST /webhooks/stripe [33m400[0m 1.078 ms - 29[0m
[0mPOST /webhooks/stripe [33m400[0m 0.592 ms - 33[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Signature Verification[2m > [22m[2mshould reject webhook with expired signature (>5 minutes)
[22m[39m[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.616 ms - 29[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Signature Verification[2m > [22m[2mshould reject replay attacks (duplicate event ID)
[22m[39m[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 2.450 ms - 29[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Signature Verification[2m > [22m[2mshould handle malformed signature header
[22m[39m[Webhook] Signature verification failed: Unable to extract timestamp and signatures from header

[0mPOST /webhooks/stripe [33m400[0m 1.000 ms - 29[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Signature Verification[2m > [22m[2mshould log signature verification failures
[22m[39m[Webhook] Signature verification failed: Unable to extract timestamp and signatures from header

[0mPOST /webhooks/stripe [33m400[0m 1.013 ms - 29[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Signature Verification[2m > [22m[2mshould return 400 for invalid signatures (not 500)
[22m[39m[Webhook] Signature verification failed: Unable to extract timestamp and signatures from header

[0mPOST /webhooks/stripe [33m400[0m 1.408 ms - 29[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Event Handling[2m > [22m[2mshould handle checkout.session.completed - activate subscription
[22m[39m[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.019 ms - 29[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Event Handling[2m > [22m[2mshould handle checkout.session.completed - record payment
[22m[39m[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.098 ms - 29[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Event Handling[2m > [22m[2mshould handle customer.subscription.updated - sync status
[22m[39m[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.095 ms - 29[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Event Handling[2m > [22m[2mshould handle invoice.payment_succeeded - record payment
[22m[39m[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 0.990 ms - 29[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Event Handling[2m > [22m[2mshould handle invoice.payment_succeeded - extend billing period
[22m[39m[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.126 ms - 29[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Event Handling[2m > [22m[2mshould handle invoice.payment_failed - mark past_due
[22m[39m[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.519 ms - 29[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Event Handling[2m > [22m[2mshould handle invoice.payment_failed - cancel after 3 failures
[22m[39m[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 0.957 ms - 29[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Event Handling[2m > [22m[2mshould ignore unhandled event types
[22m[39m[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.081 ms - 29[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Event Handling[2m > [22m[2mshould handle duplicate webhook deliveries (idempotent)
[22m[39m[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.030 ms - 29[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Event Handling[2m > [22m[2mshould handle duplicate webhook deliveries (idempotent)
[22m[39m[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.314 ms - 29[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Event Handling[2m > [22m[2mshould handle webhook for deleted user gracefully
[22m[39m[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 0.978 ms - 29[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Event Handling[2m > [22m[2mshould handle malformed webhook data gracefully
[22m[39m[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 0.894 ms - 29[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Event Handling[2m > [22m[2mshould log all webhook events
[22m[39m[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.135 ms - 29[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Event Handling[2m > [22m[2mshould return 200 for all webhooks (even errors)
[22m[39m[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.010 ms - 29[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Event Handling[2m > [22m[2mshould process webhook in under 5 seconds
[22m[39m[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.061 ms - 29[0m
[0mPOST /auth/login [32m200[0m 227.140 ms - 132[0m
[0mGET /subscription [32m200[0m 7.785 ms - 168[0m
[0mPOST /auth/login [32m200[0m 68.115 ms - 132[0m
[0mGET /subscription [33m401[0m 1.303 ms - 24[0m
[0mPOST /auth/login [32m200[0m 64.396 ms - 132[0m
[0mGET /subscription [32m200[0m 5.353 ms - 132[0m
[0mPOST /auth/login [32m200[0m 67.241 ms - 132[0m
[0mGET /subscription [32m200[0m 6.756 ms - 168[0m
[0mPOST /auth/login [32m200[0m 222.757 ms - 132[0m
[0mGET /subscription [32m200[0m 6.316 ms - 168[0m
[0mPOST /auth/login [32m200[0m 65.975 ms - 135[0m
[0mGET /payment-history [32m200[0m 3.831 ms - 444[0m
[0mPOST /auth/login [32m200[0m 65.035 ms - 135[0m
[0mGET /payment-history [33m401[0m 0.878 ms - 24[0m
[0mPOST /auth/login [32m200[0m 66.605 ms - 135[0m
[0mGET /payment-history [32m200[0m 3.449 ms - 15[0m
[0mPOST /auth/login [32m200[0m 67.258 ms - 135[0m
[0mGET /payment-history [32m200[0m 3.478 ms - 444[0m
[0mPOST /auth/login [32m200[0m 65.116 ms - 135[0m
[0mGET /payment-history [32m200[0m 3.040 ms - 444[0m
[0mPOST /auth/login [32m200[0m 148.178 ms - 134[0m
[0mPOST /auth/login [32m200[0m 222.451 ms - 134[0m
[0mPOST /auth/login [32m200[0m 65.842 ms - 134[0m
[0mPOST /auth/login [32m200[0m 70.559 ms - 134[0m
[0mPOST /auth/login [32m200[0m 70.814 ms - 134[0m
[0mPOST /auth/login [32m200[0m 66.133 ms - 134[0m
[0mPOST /auth/login [32m200[0m 240.130 ms - 134[0m
[0mPOST /auth/login [32m200[0m 67.826 ms - 134[0m
[0mPOST /auth/login [32m200[0m 66.610 ms - 134[0m
[0mPOST /auth/login [32m200[0m 70.780 ms - 134[0m
[90mstdout[2m | tests/integration/handlers/payment-handlers.test.js
[22m[39m
ðŸ§¹ Tearing down test environment...

[90mstdout[2m | tests/integration/handlers/payment-handlers.test.js
[22m[39mâœ“ Test database cleaned

[90mstdout[2m | tests/integration/handlers/payment-handlers.test.js
[22m[39mâœ“ Database adapter closed

[90mstdout[2m | tests/integration/handlers/payment-handlers.test.js
[22m[39mâœ“ Test database disconnected

[90mstdout[2m | tests/integration/handlers/payment-handlers.test.js
[22m[39mâœ“ Test database cleaned up
âœ“ Test environment cleaned up


 [31mâ¯[39m tests/integration/handlers/payment-handlers.test.js [2m([22m[2m54 tests[22m[2m | [22m[31m26 failed[39m[2m)[22m[33m 97765[2mms[22m[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /create-checkout-session[2m > [22mshould create checkout session for valid subscription[39m[33m 1570[2mms[22m[39m
[31m     â†’ expected [ 200, 404, 501 ] to include 400[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /create-checkout-session[2m > [22mshould require authentication for checkout [33m 2093[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /create-checkout-session[2m > [22mshould reject invalid price IDs [33m 1631[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /create-checkout-session[2m > [22mshould include userId in session metadata [33m 1421[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /create-checkout-session[2m > [22mshould handle missing priceId field [33m 1432[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /create-checkout-session[2m > [22mshould handle missing planType field [33m 2608[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /create-checkout-session[2m > [22mshould create customer if not exists [33m 1532[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /create-checkout-session[2m > [22mshould set correct success and cancel URLs [33m 1502[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /create-checkout-session[2m > [22mshould handle Stripe API errors gracefully [33m 2235[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /create-checkout-session[2m > [22mshould log checkout session creation [33m 1396[2mms[22m[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Signature Verification[2m > [22mshould accept webhook with valid signature[39m[33m 1276[2mms[22m[39m
[31m     â†’ expected [ 200, 404 ] to include 400[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Signature Verification[2m > [22mshould reject webhook with invalid signature [33m 1332[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Signature Verification[2m > [22mshould reject webhook with missing signature [33m 1341[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Signature Verification[2m > [22mshould reject webhook with expired signature (>5 minutes) [33m 2428[2mms[22m[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Signature Verification[2m > [22mshould reject replay attacks (duplicate event ID)[39m[33m 1335[2mms[22m[39m
[31m     â†’ expected [ 200, 404 ] to include 400[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Signature Verification[2m > [22mshould handle malformed signature header [33m 1955[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Signature Verification[2m > [22mshould log signature verification failures [33m 1369[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Signature Verification[2m > [22mshould return 400 for invalid signatures (not 500) [33m 1268[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle checkout.session.completed - activate subscription [33m 2142[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle checkout.session.completed - record payment [33m 1950[2mms[22m[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle customer.subscription.updated - sync status[39m[33m 1384[2mms[22m[39m
[31m     â†’ expected [ 200, 404 ] to include 400[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle customer.subscription.deleted - downgrade to free[39m[33m 1979[2mms[22m[39m
[31m     â†’ column "plan" of relation "subscriptions" does not exist[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle customer.subscription.deleted - preserve data[39m[33m 1371[2mms[22m[39m
[31m     â†’ column "storage_key" of relation "manuscripts" does not exist[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle invoice.payment_succeeded - record payment[39m[33m 1316[2mms[22m[39m
[31m     â†’ expected [ 200, 404 ] to include 400[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle invoice.payment_succeeded - extend billing period [33m 1427[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle invoice.payment_failed - mark past_due [33m 2336[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle invoice.payment_failed - cancel after 3 failures [33m 1952[2mms[22m[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould ignore unhandled event types[39m[33m 1327[2mms[22m[39m
[31m     â†’ expected [ 200, 404 ] to include 400[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle duplicate webhook deliveries (idempotent)[39m[33m 1871[2mms[22m[39m
[31m     â†’ expected [ 200, 404 ] to include 400[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle webhook for deleted user gracefully [33m 1352[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle malformed webhook data gracefully [33m 1342[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould log all webhook events [33m 1556[2mms[22m[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould return 200 for all webhooks (even errors)[39m[33m 1927[2mms[22m[39m
[31m     â†’ expected [ 200, 404, 500 ] to include 400[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould process webhook in under 5 seconds [33m 1752[2mms[22m[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mGET /subscription[2m > [22mshould return current subscription details[39m[33m 1578[2mms[22m[39m
[31m     â†’ expected undefined to be 'freelancer' // Object.is equality[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mGET /subscription[2m > [22mshould require authentication [33m 1915[2mms[22m[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mGET /subscription[2m > [22mshould return free plan for users without subscription[39m[33m 1435[2mms[22m[39m
[31m     â†’ expected undefined to be 'free' // Object.is equality[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mGET /subscription[2m > [22mshould include Stripe subscription ID[39m[33m 1405[2mms[22m[39m
[31m     â†’ expected undefined to be 'sub_test_123' // Object.is equality[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mGET /subscription[2m > [22mshould include current period dates[39m[33m 2808[2mms[22m[39m
[31m     â†’ expected undefined to be defined[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mGET /payment-history[2m > [22mshould return payment history for user [33m 1415[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mGET /payment-history[2m > [22mshould require authentication [33m 1413[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mGET /payment-history[2m > [22mshould return empty array for no payments [33m 1977[2mms[22m[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mGET /payment-history[2m > [22mshould order payments by date (newest first)[39m[33m 1425[2mms[22m[39m
[31m     â†’ actual value must be number or bigint, received "string"[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mGET /payment-history[2m > [22mshould not include other users payments[39m[33m 1537[2mms[22m[39m
[31m     â†’ expected undefined to be 'e313af090418f8c6bfe62bd362b114ca' // Object.is equality[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould track manuscript analysis usage[39m[33m 1961[2mms[22m[39m
[31m     â†’ generateId is not defined[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould track different analysis types[39m[33m 2785[2mms[22m[39m
[31m     â†’ generateId is not defined[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould track asset generation separately[39m[33m 1412[2mms[22m[39m
[31m     â†’ generateId is not defined[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould calculate usage within billing period[39m[33m 2195[2mms[22m[39m
[31m     â†’ generateId is not defined[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould separate usage across different billing periods[39m[33m 1404[2mms[22m[39m
[31m     â†’ generateId is not defined[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould track usage for users without subscription (pay-per-use)[39m[33m 1480[2mms[22m[39m
[31m     â†’ generateId is not defined[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould link usage to specific manuscript[39m[33m 2365[2mms[22m[39m
[31m     â†’ generateId is not defined[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould accumulate credits across multiple analyses[39m[33m 2364[2mms[22m[39m
[31m     â†’ generateId is not defined[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould track timestamp for usage analytics[39m[33m 1386[2mms[22m[39m
[31m     â†’ generateId is not defined[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould delete usage records when manuscript is deleted (CASCADE)[39m[33m 2148[2mms[22m[39m
[31m     â†’ generateId is not defined[39m
[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js
[22m[39m[dotenv@17.2.3] injecting env (0) from .env.local -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js
[22m[39m
ðŸ§ª Setting up test environment...

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js
[22m[39mâœ“ Test database connected

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js
[22m[39m  Applying base schema...

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js
[22m[39m  âœ“ Schema and migrations applied

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js
[22m[39mâœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js
[22m[39mâœ“ Test database initialized
Initializing adapters...
âœ“ Database adapter initialized
âœ“ Storage adapter initialized
âš  Running in test mode without Redis - using in-memory session store

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js
[22m[39mâœ“ Session store initialized
âœ“ Cache adapter initialized
âœ“ Queue service initialized
âœ“ Environment initialized
âœ“ Session middleware applied
[VirusScanner] Initializing ClamAV at localhost:3310...

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js
[22m[39mâœ“ Server adapters initialized
âœ“ Test environment ready


[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/register[2m > [22m[2mshould register a new user with valid credentials
[22m[39m[VirusScanner] Failed to initialize: 

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/register[2m > [22m[2mshould register a new user with valid credentials
[22m[39mâš  Virus scanner initialization failed (uploads will continue without scanning)

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/register[2m > [22m[2mshould register a new user with valid credentials
[22m[39m[Payment] Free subscription created for user f758e0f7-6bd3-4c1b-a2d7-792425e963d9

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/register[2m > [22m[2mshould register a new user with valid credentials
[22m[39m[Email] RESEND_API_KEY not configured

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/register[2m > [22m[2mshould register a new user with valid credentials
[22m[39mVerification email sent to: newuser@example.com

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/register[2m > [22m[2mshould hash password with bcrypt
[22m[39m[Payment] Free subscription created for user 0b137bfa-4d62-4946-9793-188a9c24ed4a

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/register[2m > [22m[2mshould hash password with bcrypt
[22m[39m[Email] RESEND_API_KEY not configured

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/register[2m > [22m[2mshould hash password with bcrypt
[22m[39mVerification email sent to: bcrypt-test@example.com

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/register[2m > [22m[2mshould normalize email to lowercase
[22m[39m[Payment] Free subscription created for user 29cb1da5-ca6f-4a65-9f53-2c53461462f8

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/register[2m > [22m[2mshould normalize email to lowercase
[22m[39m[Email] RESEND_API_KEY not configured

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/register[2m > [22m[2mshould normalize email to lowercase
[22m[39mVerification email sent to: casesensitive@example.com

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/register[2m > [22m[2mshould create verification token
[22m[39m[Payment] Free subscription created for user 67c7cbf6-b83e-4bdb-8d89-23518039e910

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/register[2m > [22m[2mshould create verification token
[22m[39m[Email] RESEND_API_KEY not configured

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/register[2m > [22m[2mshould create verification token
[22m[39mVerification email sent to: verify-test@example.com

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/register[2m > [22m[2mshould send verification email
[22m[39m[Payment] Free subscription created for user 27b1b2da-70fe-4c22-a397-436603e6b697

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/register[2m > [22m[2mshould send verification email
[22m[39m[Email] RESEND_API_KEY not configured

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/register[2m > [22m[2mshould send verification email
[22m[39mVerification email sent to: email-test@example.com

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/register[2m > [22m[2mshould log registration event in audit log
[22m[39m[Payment] Free subscription created for user 9efefd40-dbc0-4a30-a4df-a68527560b3b

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/register[2m > [22m[2mshould log registration event in audit log
[22m[39m[Email] RESEND_API_KEY not configured

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/register[2m > [22m[2mshould log registration event in audit log
[22m[39mVerification email sent to: audit-test@example.com

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/register[2m > [22m[2mshould set default role to author if not specified
[22m[39m[Payment] Free subscription created for user b18d08b8-7983-46bf-83db-8a35d98bcbbc

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/register[2m > [22m[2mshould set default role to author if not specified
[22m[39m[Email] RESEND_API_KEY not configured

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/register[2m > [22m[2mshould set default role to author if not specified
[22m[39mVerification email sent to: default-role@example.com

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/login[2m > [22m[2mshould reject login with wrong password
[22m[39m[Audit] Skipping audit log for login_failed - no valid user_id

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/login[2m > [22m[2mshould reject login with non-existent email
[22m[39m[Audit] Skipping audit log for login_failed - no valid user_id

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/login[2m > [22m[2mshould rate limit after 5 failed attempts
[22m[39m[Audit] Skipping audit log for login_failed - no valid user_id

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/login[2m > [22m[2mshould rate limit after 5 failed attempts
[22m[39m[Audit] Skipping audit log for login_failed - no valid user_id

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/login[2m > [22m[2mshould rate limit after 5 failed attempts
[22m[39m[Audit] Skipping audit log for login_failed - no valid user_id

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/login[2m > [22m[2mshould rate limit after 5 failed attempts
[22m[39m[Audit] Skipping audit log for login_failed - no valid user_id

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/login[2m > [22m[2mshould rate limit after 5 failed attempts
[22m[39m[Audit] Skipping audit log for login_failed - no valid user_id

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/login[2m > [22m[2mshould log failed login attempts
[22m[39m[Audit] Skipping audit log for login_failed - no valid user_id

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/request-password-reset[2m > [22m[2mshould create password reset token for valid email
[22m[39mFailed to send password reset email: Error: Failed to send email: <html>
<head><title>401 Authorization Required</title></head>
<body>
<center><h1>401 Authorization Required</h1></center>
<hr><center>nginx/1.27.1</center>
</body>
</html>

    at sendPasswordResetEmail [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:792:11[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at Module.handlePasswordResetRequest [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:522:7[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:653:22
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/request-password-reset[2m > [22m[2mshould send password reset email
[22m[39mFailed to send password reset email: Error: Failed to send email: <html>
<head><title>401 Authorization Required</title></head>
<body>
<center><h1>401 Authorization Required</h1></center>
<hr><center>nginx/1.27.1</center>
</body>
</html>

    at sendPasswordResetEmail [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:792:11[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at Module.handlePasswordResetRequest [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:522:7[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:677:5
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/request-password-reset[2m > [22m[2mshould rate limit password reset requests
[22m[39mFailed to send password reset email: Error: Failed to send email: <html>
<head><title>401 Authorization Required</title></head>
<body>
<center><h1>401 Authorization Required</h1></center>
<hr><center>nginx/1.27.1</center>
</body>
</html>

    at sendPasswordResetEmail [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:792:11[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at Module.handlePasswordResetRequest [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:522:7[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:718:7
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/request-password-reset[2m > [22m[2mshould rate limit password reset requests
[22m[39mFailed to send password reset email: Error: Failed to send email: <html>
<head><title>401 Authorization Required</title></head>
<body>
<center><h1>401 Authorization Required</h1></center>
<hr><center>nginx/1.27.1</center>
</body>
</html>

    at sendPasswordResetEmail [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:792:11[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at Module.handlePasswordResetRequest [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:522:7[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:718:7
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/request-password-reset[2m > [22m[2mshould rate limit password reset requests
[22m[39mFailed to send password reset email: Error: Failed to send email: <html>
<head><title>401 Authorization Required</title></head>
<body>
<center><h1>401 Authorization Required</h1></center>
<hr><center>nginx/1.27.1</center>
</body>
</html>

    at sendPasswordResetEmail [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:792:11[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at Module.handlePasswordResetRequest [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:522:7[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:718:7
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/request-password-reset[2m > [22m[2mshould rate limit password reset requests
[22m[39mFailed to send password reset email: Error: Failed to send email: <html>
<head><title>401 Authorization Required</title></head>
<body>
<center><h1>401 Authorization Required</h1></center>
<hr><center>nginx/1.27.1</center>
</body>
</html>

    at sendPasswordResetEmail [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:792:11[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at Module.handlePasswordResetRequest [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:522:7[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:729:22
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/request-password-reset[2m > [22m[2mshould normalize email to lowercase
[22m[39mFailed to send password reset email: Error: Failed to send email: <html>
<head><title>401 Authorization Required</title></head>
<body>
<center><h1>401 Authorization Required</h1></center>
<hr><center>nginx/1.27.1</center>
</body>
</html>

    at sendPasswordResetEmail [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:792:11[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at Module.handlePasswordResetRequest [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:522:7[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:752:22
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/request-password-reset[2m > [22m[2mshould log password reset request
[22m[39mFailed to send password reset email: Error: Failed to send email: <html>
<head><title>401 Authorization Required</title></head>
<body>
<center><h1>401 Authorization Required</h1></center>
<hr><center>nginx/1.27.1</center>
</body>
</html>

    at sendPasswordResetEmail [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:792:11[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at Module.handlePasswordResetRequest [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:522:7[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:799:5
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/resend-verification[2m > [22m[2mshould resend verification email for unverified user
[22m[39m[Email] RESEND_API_KEY not configured

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/resend-verification[2m > [22m[2mshould resend verification email for unverified user
[22m[39mVerification email resent to: resend@example.com

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/resend-verification[2m > [22m[2mshould rate limit resend requests
[22m[39m[Email] RESEND_API_KEY not configured

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/resend-verification[2m > [22m[2mshould rate limit resend requests
[22m[39mVerification email resent to: resend@example.com

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/resend-verification[2m > [22m[2mshould rate limit resend requests
[22m[39m[Email] RESEND_API_KEY not configured

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/resend-verification[2m > [22m[2mshould rate limit resend requests
[22m[39mVerification email resent to: resend@example.com

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/resend-verification[2m > [22m[2mshould rate limit resend requests
[22m[39m[Email] RESEND_API_KEY not configured

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/resend-verification[2m > [22m[2mshould rate limit resend requests
[22m[39mVerification email resent to: resend@example.com

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/resend-verification[2m > [22m[2mshould rate limit resend requests
[22m[39m[Email] RESEND_API_KEY not configured

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/resend-verification[2m > [22m[2mshould rate limit resend requests
[22m[39mVerification email resent to: resend@example.com

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js
[22m[39m
ðŸ§¹ Tearing down test environment...

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js
[22m[39mâœ“ Test database cleaned

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js
[22m[39mâœ“ Database adapter closed

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js
[22m[39mâœ“ Test database disconnected

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js
[22m[39mâœ“ Test database cleaned up
âœ“ Test environment cleaned up


 [31mâ¯[39m tests/integration/handlers/auth-handlers.test.js [2m([22m[2m53 tests[22m[2m | [22m[31m23 failed[39m[2m)[22m[33m 100013[2mms[22m[39m
[31m   [31mÃ—[31m POST /auth/register[2m > [22mshould register a new user with valid credentials[39m[33m 1586[2mms[22m[39m
[31m     â†’ expected 'Registration successful. Please checkâ€¦' to match /registered successfully/i[39m
   [33m[2mâœ“[22m[39m POST /auth/register[2m > [22mshould reject registration with weak password [33m 1257[2mms[22m[39m
   [33m[2mâœ“[22m[39m POST /auth/register[2m > [22mshould reject registration with invalid email [33m 1289[2mms[22m[39m
   [33m[2mâœ“[22m[39m POST /auth/register[2m > [22mshould reject registration with duplicate email [33m 2012[2mms[22m[39m
[31m   [31mÃ—[31m POST /auth/register[2m > [22mshould hash password with bcrypt[39m[33m 1847[2mms[22m[39m
[31m     â†’ expected '$2b$12$PT6kFOhkKHP8msKrUSK4xuZAIZn.IBâ€¦' to match /^\$2[ab]\$10\$/[39m
   [33m[2mâœ“[22m[39m POST /auth/register[2m > [22mshould normalize email to lowercase [33m 1522[2mms[22m[39m
[31m   [31mÃ—[31m POST /auth/register[2m > [22mshould create verification token[39m[33m 2438[2mms[22m[39m
[31m     â†’ expected +0 to be false // Object.is equality[39m
[31m   [31mÃ—[31m POST /auth/register[2m > [22mshould send verification email[39m[33m 1566[2mms[22m[39m
[31m     â†’ expected "spy" to be called with arguments: [ ObjectContaining{â€¦}, Any<Object> ][90m

Number of calls: [1m0[22m
[31m[39m
   [33m[2mâœ“[22m[39m POST /auth/register[2m > [22mshould log registration event in audit log [33m 1510[2mms[22m[39m
   [33m[2mâœ“[22m[39m POST /auth/register[2m > [22mshould set default role to author if not specified [33m 2816[2mms[22m[39m
   [33m[2mâœ“[22m[39m POST /auth/login[2m > [22mshould login with valid credentials [33m 1421[2mms[22m[39m
   [33m[2mâœ“[22m[39m POST /auth/login[2m > [22mshould reject login with wrong password [33m 1481[2mms[22m[39m
   [33m[2mâœ“[22m[39m POST /auth/login[2m > [22mshould reject login with non-existent email [33m 2222[2mms[22m[39m
   [33m[2mâœ“[22m[39m POST /auth/login[2m > [22mshould reject login with unverified email [33m 1598[2mms[22m[39m
   [33m[2mâœ“[22m[39m POST /auth/login[2m > [22mshould rate limit after 5 failed attempts [33m 1662[2mms[22m[39m
[31m   [31mÃ—[31m POST /auth/login[2m > [22mshould update last_login timestamp[39m[33m 2240[2mms[22m[39m
[31m     â†’ expected false to be true // Object.is equality[39m
[31m   [31mÃ—[31m POST /auth/login[2m > [22mshould create session in Redis[39m[33m 2094[2mms[22m[39m
[31m     â†’ expected undefined to be 'login-test@example.com' // Object.is equality[39m
   [33m[2mâœ“[22m[39m POST /auth/login[2m > [22mshould log successful login [33m 1451[2mms[22m[39m
[31m   [31mÃ—[31m POST /auth/login[2m > [22mshould log failed login attempts[39m[33m 2023[2mms[22m[39m
[31m     â†’ expected 0 to be greater than 0[39m
[31m   [31mÃ—[31m POST /auth/verify-email[2m > [22mshould verify email with valid token[39m[33m 1365[2mms[22m[39m
[31m     â†’ expected 400 to be 200 // Object.is equality[39m
   [33m[2mâœ“[22m[39m POST /auth/verify-email[2m > [22mshould reject invalid token [33m 1406[2mms[22m[39m
   [33m[2mâœ“[22m[39m POST /auth/verify-email[2m > [22mshould reject expired token [33m 2070[2mms[22m[39m
   [33m[2mâœ“[22m[39m POST /auth/verify-email[2m > [22mshould reject already used token [33m 2284[2mms[22m[39m
   [33m[2mâœ“[22m[39m POST /auth/verify-email[2m > [22mshould handle missing token [33m 1325[2mms[22m[39m
[31m   [31mÃ—[31m POST /auth/verify-email[2m > [22mshould log email verification event[39m[33m 1523[2mms[22m[39m
[31m     â†’ expected 0 to be greater than 0[39m
   [33m[2mâœ“[22m[39m POST /auth/request-password-reset[2m > [22mshould create password reset token for valid email [33m 2353[2mms[22m[39m
[31m   [31mÃ—[31m POST /auth/request-password-reset[2m > [22mshould send password reset email[39m[33m 1403[2mms[22m[39m
[31m     â†’ expected "spy" to be called with arguments: [ ObjectContaining{â€¦}, Any<Object> ][90m

Number of calls: [1m0[22m
[31m[39m
   [33m[2mâœ“[22m[39m POST /auth/request-password-reset[2m > [22mshould not reveal if email does not exist (security) [33m 1397[2mms[22m[39m
[31m   [31mÃ—[31m POST /auth/request-password-reset[2m > [22mshould rate limit password reset requests[39m[33m 3623[2mms[22m[39m
[31m     â†’ expected 200 to be 429 // Object.is equality[39m
   [33m[2mâœ“[22m[39m POST /auth/request-password-reset[2m > [22mshould normalize email to lowercase [33m 1912[2mms[22m[39m
   [33m[2mâœ“[22m[39m POST /auth/request-password-reset[2m > [22mshould reject invalid email format [33m 1492[2mms[22m[39m
[31m   [31mÃ—[31m POST /auth/request-password-reset[2m > [22mshould handle missing email[39m[33m 1354[2mms[22m[39m
[31m     â†’ expected 'Invalid email address' to match /email.*required/i[39m
   [33m[2mâœ“[22m[39m POST /auth/request-password-reset[2m > [22mshould log password reset request [33m 1641[2mms[22m[39m
[31m   [31mÃ—[31m POST /auth/reset-password[2m > [22mshould reset password with valid token[39m[33m 2035[2mms[22m[39m
[31m     â†’ expected 400 to be 200 // Object.is equality[39m
[31m   [31mÃ—[31m POST /auth/reset-password[2m > [22mshould mark reset token as used[39m[33m 2013[2mms[22m[39m
[31m     â†’ Cannot read properties of null (reading 'used')[39m
   [33m[2mâœ“[22m[39m POST /auth/reset-password[2m > [22mshould reject weak new password [33m 1374[2mms[22m[39m
   [33m[2mâœ“[22m[39m POST /auth/reset-password[2m > [22mshould reject invalid token [33m 1426[2mms[22m[39m
   [33m[2mâœ“[22m[39m POST /auth/reset-password[2m > [22mshould reject expired token [33m 1469[2mms[22m[39m
   [33m[2mâœ“[22m[39m POST /auth/reset-password[2m > [22mshould reject already used token [33m 1335[2mms[22m[39m
   [33m[2mâœ“[22m[39m POST /auth/reset-password[2m > [22mshould hash new password with bcrypt [33m 1327[2mms[22m[39m
[31m   [31mÃ—[31m POST /auth/reset-password[2m > [22mshould log password reset event[39m[33m 1521[2mms[22m[39m
[31m     â†’ expected 0 to be greater than 0[39m
[31m   [31mÃ—[31m POST /auth/logout[2m > [22mshould logout and destroy session[39m[33m 2409[2mms[22m[39m
[31m     â†’ expected 401 to be 200 // Object.is equality[39m
[31m   [31mÃ—[31m POST /auth/logout[2m > [22mshould clear session cookie[39m[33m 1418[2mms[22m[39m
[31m     â†’ the given combination of arguments (null and string) is invalid for this assertion. You can use an array, a map, an object, a set, a string, or a weakset instead of a string[39m
[31m   [31mÃ—[31m POST /auth/logout[2m > [22mshould log logout event[39m[33m 1539[2mms[22m[39m
[31m     â†’ expected 0 to be greater than 0[39m
[31m   [31mÃ—[31m GET /auth/me[2m > [22mshould return current user with valid session[39m[33m 1952[2mms[22m[39m
[31m     â†’ expected 401 to be 200 // Object.is equality[39m
   [33m[2mâœ“[22m[39m GET /auth/me[2m > [22mshould not return password hash [33m 1377[2mms[22m[39m
   [33m[2mâœ“[22m[39m GET /auth/me[2m > [22mshould reject request without session [33m 1428[2mms[22m[39m
   [33m[2mâœ“[22m[39m GET /auth/me[2m > [22mshould reject request with invalid session [33m 2053[2mms[22m[39m
[31m   [31mÃ—[31m GET /auth/me[2m > [22mshould return email verification status[39m[33m 1985[2mms[22m[39m
[31m     â†’ expected undefined to be defined[39m
[31m   [31mÃ—[31m POST /auth/resend-verification[2m > [22mshould resend verification email for unverified user[39m[33m 1389[2mms[22m[39m
[31m     â†’ expected "spy" to be called with arguments: [ ObjectContaining{â€¦}, Any<Object> ][90m

Number of calls: [1m0[22m
[31m[39m
[31m   [31mÃ—[31m POST /auth/resend-verification[2m > [22mshould reject resend for already verified user[39m[33m 1887[2mms[22m[39m
[31m     â†’ expected 409 to be 400 // Object.is equality[39m
[31m   [31mÃ—[31m POST /auth/resend-verification[2m > [22mshould rate limit resend requests[39m[33m 1424[2mms[22m[39m
[31m     â†’ expected 200 to be 429 // Object.is equality[39m
   [33m[2mâœ“[22m[39m POST /auth/resend-verification[2m > [22mshould not reveal if email does not exist (security) [33m 1441[2mms[22m[39m
[90mstdout[2m | tests/unit/test-helpers.test.js
[22m[39m[dotenv@17.2.3] injecting env (0) from .env.local -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/test-helpers.test.js
[22m[39m
ðŸ§ª Setting up test environment...

[90mstdout[2m | tests/unit/test-helpers.test.js
[22m[39mâœ“ Test database connected

[90mstdout[2m | tests/unit/test-helpers.test.js
[22m[39m  Applying base schema...

[90mstdout[2m | tests/unit/test-helpers.test.js
[22m[39m  âœ“ Schema and migrations applied

[90mstdout[2m | tests/unit/test-helpers.test.js
[22m[39mâœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

[90mstdout[2m | tests/unit/test-helpers.test.js
[22m[39mâœ“ Test database initialized
Initializing adapters...
âœ“ Database adapter initialized
âœ“ Storage adapter initialized
âš  Running in test mode without Redis - using in-memory session store

[90mstdout[2m | tests/unit/test-helpers.test.js
[22m[39mâœ“ Session store initialized
âœ“ Cache adapter initialized
âœ“ Queue service initialized
âœ“ Environment initialized
âœ“ Session middleware applied
[VirusScanner] Initializing ClamAV at localhost:3310...

[90mstdout[2m | tests/unit/test-helpers.test.js
[22m[39mâœ“ Server adapters initialized
âœ“ Test environment ready


[90mstderr[2m | tests/unit/test-helpers.test.js[2m > [22m[2mMock Factories[2m > [22m[2mStorage Adapter Mock[2m > [22m[2mshould put and get objects
[22m[39m[VirusScanner] Failed to initialize: 

[90mstderr[2m | tests/unit/test-helpers.test.js[2m > [22m[2mMock Factories[2m > [22m[2mStorage Adapter Mock[2m > [22m[2mshould put and get objects
[22m[39mâš  Virus scanner initialization failed (uploads will continue without scanning)

[90mstdout[2m | tests/unit/test-helpers.test.js
[22m[39m
ðŸ§¹ Tearing down test environment...

[90mstdout[2m | tests/unit/test-helpers.test.js
[22m[39mâœ“ Test database cleaned

[90mstdout[2m | tests/unit/test-helpers.test.js
[22m[39mâœ“ Database adapter closed

[90mstdout[2m | tests/unit/test-helpers.test.js
[22m[39mâœ“ Test database disconnected

[90mstdout[2m | tests/unit/test-helpers.test.js
[22m[39mâœ“ Test database cleaned up
âœ“ Test environment cleaned up


 [31mâ¯[39m tests/unit/test-helpers.test.js [2m([22m[2m24 tests[22m[2m | [22m[31m4 failed[39m[2m)[22m[33m 44513[2mms[22m[39m
   [33m[2mâœ“[22m[39m Mock Factories[2m > [22mStorage Adapter Mock[2m > [22mshould put and get objects [33m 1330[2mms[22m[39m
   [33m[2mâœ“[22m[39m Mock Factories[2m > [22mStorage Adapter Mock[2m > [22mshould delete objects [33m 1372[2mms[22m[39m
   [33m[2mâœ“[22m[39m Mock Factories[2m > [22mStorage Adapter Mock[2m > [22mshould list objects by prefix [33m 1447[2mms[22m[39m
   [33m[2mâœ“[22m[39m Mock Factories[2m > [22mRedis Mock[2m > [22mshould set and get values [33m 1244[2mms[22m[39m
   [33m[2mâœ“[22m[39m Mock Factories[2m > [22mRedis Mock[2m > [22mshould set values with expiration [33m 1282[2mms[22m[39m
   [33m[2mâœ“[22m[39m Mock Factories[2m > [22mRedis Mock[2m > [22mshould delete keys [33m 1316[2mms[22m[39m
   [33m[2mâœ“[22m[39m Mock Factories[2m > [22mRedis Mock[2m > [22mshould increment values [33m 2538[2mms[22m[39m
   [33m[2mâœ“[22m[39m Mock Factories[2m > [22mClaude API Mock[2m > [22mshould return mock AI responses [33m 1601[2mms[22m[39m
   [33m[2mâœ“[22m[39m Mock Factories[2m > [22mClaude API Mock[2m > [22mshould include custom response text [33m 1421[2mms[22m[39m
   [33m[2mâœ“[22m[39m Mock Factories[2m > [22mEmail Service Mock[2m > [22mshould track sent emails [33m 1268[2mms[22m[39m
   [33m[2mâœ“[22m[39m Mock Factories[2m > [22mEmail Service Mock[2m > [22mshould find emails by recipient [33m 1312[2mms[22m[39m
   [33m[2mâœ“[22m[39m Mock Factories[2m > [22mEmail Service Mock[2m > [22mshould clear sent emails [33m 1266[2mms[22m[39m
   [33m[2mâœ“[22m[39m Mock Factories[2m > [22mStripe Mock[2m > [22mshould create checkout sessions [33m 1281[2mms[22m[39m
   [33m[2mâœ“[22m[39m Mock Factories[2m > [22mStripe Mock[2m > [22mshould create payment intents [33m 1926[2mms[22m[39m
   [33m[2mâœ“[22m[39m Mock Factories[2m > [22mStripe Mock[2m > [22mshould construct webhook events [33m 2408[2mms[22m[39m
[31m   [31mÃ—[31m Test Data Factories[2m > [22mUser Factory[2m > [22mshould create valid user data[39m[33m 1325[2mms[22m[39m
[31m     â†’ expected undefined to be truthy[39m
[31m   [31mÃ—[31m Test Data Factories[2m > [22mUser Factory[2m > [22mshould accept overrides[39m[33m 1665[2mms[22m[39m
[31m     â†’ expected undefined to be 'custom@test.com' // Object.is equality[39m
[31m   [31mÃ—[31m Test Data Factories[2m > [22mManuscript Factory[2m > [22mshould create valid manuscript data[39m[33m 1252[2mms[22m[39m
[31m     â†’ expected undefined to be truthy[39m
   [33m[2mâœ“[22m[39m Test Data Factories[2m > [22mManuscript Factory[2m > [22mshould accept overrides [33m 1262[2mms[22m[39m
   [33m[2mâœ“[22m[39m Test Data Factories[2m > [22mAnalysis Factory[2m > [22mshould create valid analysis data [33m 1287[2mms[22m[39m
   [33m[2mâœ“[22m[39m Test Data Factories[2m > [22mAnalysis Factory[2m > [22mshould include result JSON [33m 2030[2mms[22m[39m
[31m   [31mÃ—[31m Test Data Factories[2m > [22mPayment Factory[2m > [22mshould create valid payment data[39m[33m 1813[2mms[22m[39m
[31m     â†’ .toMatch() expects to receive a string, but got undefined[39m
   [33m[2mâœ“[22m[39m Test Data Factories[2m > [22mUtility Functions[2m > [22mshould generate unique email addresses [33m 1319[2mms[22m[39m
   [33m[2mâœ“[22m[39m Test Data Factories[2m > [22mUtility Functions[2m > [22mshould generate unique IDs [33m 1788[2mms[22m[39m
[90mstdout[2m | tests/integration/infrastructure.test.js
[22m[39m[dotenv@17.2.3] injecting env (0) from .env.local -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/infrastructure.test.js
[22m[39m
ðŸ§ª Setting up test environment...

[90mstdout[2m | tests/integration/infrastructure.test.js
[22m[39mâœ“ Test database connected

[90mstdout[2m | tests/integration/infrastructure.test.js
[22m[39m  Applying base schema...

[90mstdout[2m | tests/integration/infrastructure.test.js
[22m[39m  âœ“ Schema and migrations applied

[90mstdout[2m | tests/integration/infrastructure.test.js
[22m[39mâœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

[90mstdout[2m | tests/integration/infrastructure.test.js
[22m[39mâœ“ Test database initialized
Initializing adapters...
âœ“ Database adapter initialized
âœ“ Storage adapter initialized
âš  Running in test mode without Redis - using in-memory session store

[90mstdout[2m | tests/integration/infrastructure.test.js
[22m[39mâœ“ Session store initialized
âœ“ Cache adapter initialized
âœ“ Queue service initialized
âœ“ Environment initialized
âœ“ Session middleware applied
[VirusScanner] Initializing ClamAV at localhost:3310...

[90mstdout[2m | tests/integration/infrastructure.test.js
[22m[39mâœ“ Server adapters initialized
âœ“ Test environment ready


[90mstderr[2m | tests/integration/infrastructure.test.js[2m > [22m[2mTest Infrastructure[2m > [22m[2mDatabase Utilities[2m > [22m[2mshould insert and retrieve test records
[22m[39m[VirusScanner] Failed to initialize: 

[90mstderr[2m | tests/integration/infrastructure.test.js[2m > [22m[2mTest Infrastructure[2m > [22m[2mDatabase Utilities[2m > [22m[2mshould insert and retrieve test records
[22m[39mâš  Virus scanner initialization failed (uploads will continue without scanning)

[0mGET /health [32m200[0m 9.051 ms - 105[0m
[90mstdout[2m | tests/integration/infrastructure.test.js
[22m[39m
ðŸ§¹ Tearing down test environment...

[90mstdout[2m | tests/integration/infrastructure.test.js
[22m[39mâœ“ Test database cleaned

[90mstdout[2m | tests/integration/infrastructure.test.js
[22m[39mâœ“ Database adapter closed

[90mstdout[2m | tests/integration/infrastructure.test.js
[22m[39mâœ“ Test database disconnected

[90mstdout[2m | tests/integration/infrastructure.test.js
[22m[39mâœ“ Test database cleaned up
âœ“ Test environment cleaned up


 [31mâ¯[39m tests/integration/infrastructure.test.js [2m([22m[2m13 tests[22m[2m | [22m[31m7 failed[39m[2m)[22m[33m 27461[2mms[22m[39m
[31m   [31mÃ—[31m Test Infrastructure[2m > [22mDatabase Utilities[2m > [22mshould insert and retrieve test records[39m[33m 1463[2mms[22m[39m
[31m     â†’ syntax error at or near ")"[39m
[31m   [31mÃ—[31m Test Infrastructure[2m > [22mDatabase Utilities[2m > [22mshould count test records[39m[33m 1321[2mms[22m[39m
[31m     â†’ syntax error at or near ")"[39m
   [33m[2mâœ“[22m[39m Test Infrastructure[2m > [22mDatabase Utilities[2m > [22mshould reset database between tests [33m 1300[2mms[22m[39m
   [33m[2mâœ“[22m[39m Test Infrastructure[2m > [22mAPI Client[2m > [22mshould make HTTP requests [33m 1274[2mms[22m[39m
   [33m[2mâœ“[22m[39m Test Infrastructure[2m > [22mMock Factories[2m > [22mshould create mock Redis client [33m 1323[2mms[22m[39m
   [33m[2mâœ“[22m[39m Test Infrastructure[2m > [22mMock Factories[2m > [22mshould create mock Redis client with expiration [33m 2015[2mms[22m[39m
[31m   [31mÃ—[31m Test Infrastructure[2m > [22mMock Factories[2m > [22mshould create mock storage adapter[39m[33m 1646[2mms[22m[39m
[31m     â†’ The first argument must be of type string or an instance of Buffer, ArrayBuffer, or Array or an Array-like Object. Received undefined[39m
[31m   [31mÃ—[31m Test Infrastructure[2m > [22mTest Data Factories[2m > [22mshould create test user data[39m[33m 2426[2mms[22m[39m
[31m     â†’ expected undefined to be truthy[39m
[31m   [31mÃ—[31m Test Infrastructure[2m > [22mTest Data Factories[2m > [22mshould create test user with overrides[39m[33m 1319[2mms[22m[39m
[31m     â†’ expected undefined to be 'custom@example.com' // Object.is equality[39m
   [33m[2mâœ“[22m[39m Test Infrastructure[2m > [22mTest Data Factories[2m > [22mshould create test manuscript data [33m 1253[2mms[22m[39m
   [33m[2mâœ“[22m[39m Test Infrastructure[2m > [22mTest Data Factories[2m > [22mshould generate unique test emails [33m 1315[2mms[22m[39m
[31m   [31mÃ—[31m Test Infrastructure[2m > [22mIntegration: Factories + Database[2m > [22mshould insert factory-generated user into database[39m[33m 1915[2mms[22m[39m
[31m     â†’ syntax error at or near ")"[39m
[31m   [31mÃ—[31m Test Infrastructure[2m > [22mIntegration: Factories + Database[2m > [22mshould insert factory-generated manuscript into database[39m[33m 2354[2mms[22m[39m
[31m     â†’ syntax error at or near ")"[39m
[90mstdout[2m | tests/submission-packages.test.js
[22m[39m[dotenv@17.2.3] injecting env (0) from .env.local -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/submission-packages.test.js
[22m[39m
ðŸ§ª Setting up test environment...

[90mstdout[2m | tests/submission-packages.test.js
[22m[39mâœ“ Test database connected

[90mstdout[2m | tests/submission-packages.test.js
[22m[39m  Applying base schema...

[90mstdout[2m | tests/submission-packages.test.js
[22m[39m  âœ“ Schema and migrations applied

[90mstdout[2m | tests/submission-packages.test.js
[22m[39mâœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

[90mstdout[2m | tests/submission-packages.test.js
[22m[39mâœ“ Test database initialized
Initializing adapters...
âœ“ Database adapter initialized
âœ“ Storage adapter initialized
âš  Running in test mode without Redis - using in-memory session store

[90mstdout[2m | tests/submission-packages.test.js
[22m[39mâœ“ Session store initialized
âœ“ Cache adapter initialized
âœ“ Queue service initialized
âœ“ Environment initialized
âœ“ Session middleware applied
[VirusScanner] Initializing ClamAV at localhost:3310...

[90mstdout[2m | tests/submission-packages.test.js
[22m[39mâœ“ Server adapters initialized
âœ“ Test environment ready


[90mstderr[2m | tests/submission-packages.test.js[2m > [22m[2mSubmission Package Bundler[2m > [22m[2mPackage Templates[2m > [22m[2mshould have agent query template
[22m[39m[VirusScanner] Failed to initialize: 

[90mstderr[2m | tests/submission-packages.test.js[2m > [22m[2mSubmission Package Bundler[2m > [22m[2mPackage Templates[2m > [22m[2mshould have agent query template
[22m[39mâš  Virus scanner initialization failed (uploads will continue without scanning)

[90mstdout[2m | tests/submission-packages.test.js
[22m[39m
ðŸ§¹ Tearing down test environment...

[90mstdout[2m | tests/submission-packages.test.js
[22m[39mâœ“ Test database cleaned

[90mstdout[2m | tests/submission-packages.test.js
[22m[39mâœ“ Database adapter closed

[90mstdout[2m | tests/submission-packages.test.js
[22m[39mâœ“ Test database disconnected

[90mstdout[2m | tests/submission-packages.test.js
[22m[39mâœ“ Test database cleaned up
âœ“ Test environment cleaned up


 [32mâœ“[39m tests/submission-packages.test.js [2m([22m[2m31 tests[22m[2m)[22m[33m 55105[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mPackage Templates[2m > [22mshould have agent query template [33m 1284[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mPackage Templates[2m > [22mshould have full manuscript template [33m 1257[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mPackage Templates[2m > [22mshould have query only template [33m 1273[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mPackage Templates[2m > [22mshould have contest template [33m 1278[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mPackage Templates[2m > [22mshould validate required documents [33m 1977[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mPackage Creation[2m > [22mshould create package with metadata [33m 1477[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mPackage Creation[2m > [22mshould include document list with ordering [33m 1308[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mPackage Creation[2m > [22mshould validate package has at least one document [33m 2654[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mPackage Creation[2m > [22mshould allow custom package names [33m 1266[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mDocument Selection[2m > [22mshould allow selecting multiple documents [33m 1253[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mDocument Selection[2m > [22mshould maintain document order [33m 1825[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mDocument Selection[2m > [22mshould allow reordering documents [33m 1945[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mZIP File Generation[2m > [22mshould generate ZIP with multiple files [33m 1388[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mZIP File Generation[2m > [22mshould prefix files with order numbers [33m 1453[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mZIP File Generation[2m > [22mshould sanitize filenames [33m 2074[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mZIP File Generation[2m > [22mshould support different file formats [33m 1331[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mZIP File Generation[2m > [22mshould include metadata file in ZIP [33m 1251[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mPackage Duplication[2m > [22mshould create copy of existing package [33m 1357[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mPackage Duplication[2m > [22mshould increment copy counter in name [33m 2258[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mPackage Management[2m > [22mshould list packages for manuscript [33m 1663[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mPackage Management[2m > [22mshould update package details [33m 1255[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mPackage Management[2m > [22mshould delete package [33m 2231[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mValidation[2m > [22mshould validate package has required documents [33m 1233[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mValidation[2m > [22mshould validate document exists before adding to package [33m 1306[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mValidation[2m > [22mshould prevent duplicate documents in package [33m 1400[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mDownload Tracking[2m > [22mshould track download count [33m 2405[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mDownload Tracking[2m > [22mshould track last downloaded timestamp [33m 1329[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mEdge Cases[2m > [22mshould handle empty package name [33m 1318[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mEdge Cases[2m > [22mshould handle very long package name [33m 2243[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mEdge Cases[2m > [22mshould handle package with only one document [33m 1285[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mEdge Cases[2m > [22mshould handle large file sizes [33m 1328[2mms[22m[39m
[90mstdout[2m | tests/error-handling.test.js
[22m[39m[dotenv@17.2.3] injecting env (0) from .env.local -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/error-handling.test.js
[22m[39m
ðŸ§ª Setting up test environment...

[90mstdout[2m | tests/error-handling.test.js
[22m[39mâœ“ Test database connected

[90mstdout[2m | tests/error-handling.test.js
[22m[39m  Applying base schema...

[90mstdout[2m | tests/error-handling.test.js
[22m[39m  âœ“ Schema and migrations applied

[90mstdout[2m | tests/error-handling.test.js
[22m[39mâœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

[90mstdout[2m | tests/error-handling.test.js
[22m[39mâœ“ Test database initialized
Initializing adapters...
âœ“ Database adapter initialized
âœ“ Storage adapter initialized
âš  Running in test mode without Redis - using in-memory session store

[90mstdout[2m | tests/error-handling.test.js
[22m[39mâœ“ Session store initialized
âœ“ Cache adapter initialized
âœ“ Queue service initialized
âœ“ Environment initialized
âœ“ Session middleware applied
[VirusScanner] Initializing ClamAV at localhost:3310...

[90mstdout[2m | tests/error-handling.test.js
[22m[39mâœ“ Server adapters initialized
âœ“ Test environment ready


[90mstderr[2m | tests/error-handling.test.js[2m > [22m[2mError Handling[2m > [22m[2mError Classes[2m > [22m[2mshould create AppError with correct properties
[22m[39m[VirusScanner] Failed to initialize: 

[90mstderr[2m | tests/error-handling.test.js[2m > [22m[2mError Handling[2m > [22m[2mError Classes[2m > [22m[2mshould create AppError with correct properties
[22m[39mâš  Virus scanner initialization failed (uploads will continue without scanning)

[90mstdout[2m | tests/error-handling.test.js
[22m[39m
ðŸ§¹ Tearing down test environment...

[90mstdout[2m | tests/error-handling.test.js
[22m[39mâœ“ Test database cleaned

[90mstdout[2m | tests/error-handling.test.js
[22m[39mâœ“ Database adapter closed

[90mstdout[2m | tests/error-handling.test.js
[22m[39mâœ“ Test database disconnected

[90mstdout[2m | tests/error-handling.test.js
[22m[39mâœ“ Test database cleaned up
âœ“ Test environment cleaned up


 [32mâœ“[39m tests/error-handling.test.js [2m([22m[2m24 tests[22m[2m)[22m[33m 52343[2mms[22m[39m
   [33m[2mâœ“[22m[39m Error Handling[2m > [22mError Classes[2m > [22mshould create AppError with correct properties [33m 1635[2mms[22m[39m
   [33m[2mâœ“[22m[39m Error Handling[2m > [22mError Classes[2m > [22mshould serialize AppError to JSON correctly [33m 1794[2mms[22m[39m
   [33m[2mâœ“[22m[39m Error Handling[2m > [22mError Classes[2m > [22mshould create AuthenticationError with 401 status [33m 1618[2mms[22m[39m
   [33m[2mâœ“[22m[39m Error Handling[2m > [22mError Classes[2m > [22mshould create AuthorizationError with 403 status [33m 1624[2mms[22m[39m
   [33m[2mâœ“[22m[39m Error Handling[2m > [22mError Classes[2m > [22mshould create ValidationError with 400 status [33m 1585[2mms[22m[39m
   [33m[2mâœ“[22m[39m Error Handling[2m > [22mError Classes[2m > [22mshould create NotFoundError with 404 status [33m 2669[2mms[22m[39m
   [33m[2mâœ“[22m[39m Error Handling[2m > [22mError Classes[2m > [22mshould create RateLimitError with 429 status [33m 1628[2mms[22m[39m
   [33m[2mâœ“[22m[39m Error Handling[2m > [22mError Classes[2m > [22mshould create ConflictError with 409 status [33m 1883[2mms[22m[39m
   [33m[2mâœ“[22m[39m Error Handling[2m > [22mError Classes[2m > [22mshould create ServerError with 500 status [33m 1649[2mms[22m[39m
   [33m[2mâœ“[22m[39m Error Handling[2m > [22mError Classes[2m > [22mshould create ExternalServiceError with service name [33m 2534[2mms[22m[39m
   [33m[2mâœ“[22m[39m Error Handling[2m > [22mcreateErrorResponse[2m > [22mshould create Response with correct status and JSON [33m 1759[2mms[22m[39m
   [33m[2mâœ“[22m[39m Error Handling[2m > [22mcreateErrorResponse[2m > [22mshould handle generic Error objects [33m 1612[2mms[22m[39m
   [33m[2mâœ“[22m[39m Error Handling[2m > [22mcreateErrorResponse[2m > [22mshould include Retry-After header for rate limit errors [33m 1675[2mms[22m[39m
   [33m[2mâœ“[22m[39m Error Handling[2m > [22mcreateErrorResponse[2m > [22mshould merge additional headers [33m 1659[2mms[22m[39m
   [33m[2mâœ“[22m[39m Error Handling[2m > [22mAssertion Helpers[2m > [22massert should not throw when condition is true [33m 2548[2mms[22m[39m
   [33m[2mâœ“[22m[39m Error Handling[2m > [22mAssertion Helpers[2m > [22massert should throw ValidationError when condition is false [33m 1753[2mms[22m[39m
   [33m[2mâœ“[22m[39m Error Handling[2m > [22mAssertion Helpers[2m > [22massert should include details in error [33m 2455[2mms[22m[39m
   [33m[2mâœ“[22m[39m Error Handling[2m > [22mAssertion Helpers[2m > [22massertAuthenticated should not throw when userId exists [33m 1669[2mms[22m[39m
   [33m[2mâœ“[22m[39m Error Handling[2m > [22mAssertion Helpers[2m > [22massertAuthenticated should throw when userId is null [33m 1633[2mms[22m[39m
   [33m[2mâœ“[22m[39m Error Handling[2m > [22mAssertion Helpers[2m > [22massertAuthenticated should throw when userId is undefined [33m 2377[2mms[22m[39m
   [33m[2mâœ“[22m[39m Error Handling[2m > [22mAssertion Helpers[2m > [22massertAuthorized should not throw when permission is true [33m 2138[2mms[22m[39m
   [33m[2mâœ“[22m[39m Error Handling[2m > [22mAssertion Helpers[2m > [22massertAuthorized should throw when permission is false [33m 1563[2mms[22m[39m
   [33m[2mâœ“[22m[39m Error Handling[2m > [22mError Inheritance[2m > [22mshould maintain instanceof relationships [33m 2082[2mms[22m[39m
   [33m[2mâœ“[22m[39m Error Handling[2m > [22mError Inheritance[2m > [22mshould have correct error names [33m 1648[2mms[22m[39m
[90mstdout[2m | tests/document-generation.test.js
[22m[39m[dotenv@17.2.3] injecting env (0) from .env.local -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/document-generation.test.js
[22m[39m
ðŸ§ª Setting up test environment...

[90mstdout[2m | tests/document-generation.test.js
[22m[39mâœ“ Test database connected

[90mstdout[2m | tests/document-generation.test.js
[22m[39m  Applying base schema...

[90mstdout[2m | tests/document-generation.test.js
[22m[39m  âœ“ Schema and migrations applied

[90mstdout[2m | tests/document-generation.test.js
[22m[39mâœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

[90mstdout[2m | tests/document-generation.test.js
[22m[39mâœ“ Test database initialized
Initializing adapters...
âœ“ Database adapter initialized
âœ“ Storage adapter initialized
âš  Running in test mode without Redis - using in-memory session store

[90mstdout[2m | tests/document-generation.test.js
[22m[39mâœ“ Session store initialized
âœ“ Cache adapter initialized
âœ“ Queue service initialized
âœ“ Environment initialized
âœ“ Session middleware applied
[VirusScanner] Initializing ClamAV at localhost:3310...

[90mstdout[2m | tests/document-generation.test.js
[22m[39mâœ“ Server adapters initialized
âœ“ Test environment ready


[90mstderr[2m | tests/document-generation.test.js[2m > [22m[2mDocument Generation[2m > [22m[2mQuery Letter Generation[2m > [22m[2mshould generate query letter within word count range
[22m[39m[VirusScanner] Failed to initialize: 

[90mstderr[2m | tests/document-generation.test.js[2m > [22m[2mDocument Generation[2m > [22m[2mQuery Letter Generation[2m > [22m[2mshould generate query letter within word count range
[22m[39mâš  Virus scanner initialization failed (uploads will continue without scanning)

[90mstdout[2m | tests/document-generation.test.js
[22m[39m
ðŸ§¹ Tearing down test environment...

[90mstdout[2m | tests/document-generation.test.js
[22m[39mâœ“ Test database cleaned

[90mstdout[2m | tests/document-generation.test.js
[22m[39mâœ“ Database adapter closed

[90mstdout[2m | tests/document-generation.test.js
[22m[39mâœ“ Test database disconnected

[90mstdout[2m | tests/document-generation.test.js
[22m[39mâœ“ Test database cleaned up
âœ“ Test environment cleaned up


 [32mâœ“[39m tests/document-generation.test.js [2m([22m[2m27 tests[22m[2m)[22m[33m 58713[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mQuery Letter Generation[2m > [22mshould generate query letter within word count range [33m 1623[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mQuery Letter Generation[2m > [22mshould include essential query letter components [33m 1948[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mQuery Letter Generation[2m > [22mshould validate query letter structure [33m 1585[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mQuery Letter Generation[2m > [22mshould reject query letters that are too short [33m 1660[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mQuery Letter Generation[2m > [22mshould reject query letters that are too long [33m 1707[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mSynopsis Generation[2m > [22mshould generate short synopsis at 500 words [33m 2201[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mSynopsis Generation[2m > [22mshould generate long synopsis at 2500 words [33m 1871[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mSynopsis Generation[2m > [22mshould include beginning, middle, and end [33m 1942[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mSynopsis Generation[2m > [22mshould reveal ending (unlike blurb) [33m 1860[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mSynopsis Generation[2m > [22mshould maintain chronological order [33m 1648[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mVersion Management[2m > [22mshould create new version on update [33m 1786[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mVersion Management[2m > [22mshould track version metadata [33m 2801[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mVersion Management[2m > [22mshould allow rollback to previous version [33m 1707[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mVersion Management[2m > [22mshould maintain version history after rollback [33m 2388[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mDocument Validation[2m > [22mshould validate document type [33m 1641[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mDocument Validation[2m > [22mshould reject invalid document type [33m 1633[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mDocument Validation[2m > [22mshould validate required fields [33m 2277[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mDocument Validation[2m > [22mshould calculate word count accurately [33m 2028[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mDocument Validation[2m > [22mshould handle empty document [33m 1878[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mAI Generation Metadata[2m > [22mshould track generation parameters [33m 1843[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mAI Generation Metadata[2m > [22mshould calculate cost based on token usage [33m 1628[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mBatch Generation[2m > [22mshould generate all document types at once [33m 1603[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mBatch Generation[2m > [22mshould track individual generation status [33m 2473[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mEdge Cases[2m > [22mshould handle very short manuscript title [33m 1864[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mEdge Cases[2m > [22mshould handle very long manuscript title [33m 1697[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mEdge Cases[2m > [22mshould handle special characters in content [33m 2165[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mEdge Cases[2m > [22mshould handle unicode characters [33m 1597[2mms[22m[39m
[90mstdout[2m | tests/auth-utils.test.js
[22m[39m[dotenv@17.2.3] injecting env (0) from .env.local -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/auth-utils.test.js
[22m[39m
ðŸ§ª Setting up test environment...

[90mstdout[2m | tests/auth-utils.test.js
[22m[39mâœ“ Test database connected

[90mstdout[2m | tests/auth-utils.test.js
[22m[39m  Applying base schema...

[90mstdout[2m | tests/auth-utils.test.js
[22m[39m  âœ“ Schema and migrations applied

[90mstdout[2m | tests/auth-utils.test.js
[22m[39mâœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

[90mstdout[2m | tests/auth-utils.test.js
[22m[39mâœ“ Test database initialized
Initializing adapters...
âœ“ Database adapter initialized
âœ“ Storage adapter initialized
âš  Running in test mode without Redis - using in-memory session store

[90mstdout[2m | tests/auth-utils.test.js
[22m[39mâœ“ Session store initialized
âœ“ Cache adapter initialized
âœ“ Queue service initialized
âœ“ Environment initialized
âœ“ Session middleware applied
[VirusScanner] Initializing ClamAV at localhost:3310...

[90mstdout[2m | tests/auth-utils.test.js
[22m[39mâœ“ Server adapters initialized
âœ“ Test environment ready


[90mstderr[2m | tests/auth-utils.test.js[2m > [22m[2mAuthentication Utilities[2m > [22m[2mvalidatePassword[2m > [22m[2mshould accept a valid password
[22m[39m[VirusScanner] Failed to initialize: 

[90mstderr[2m | tests/auth-utils.test.js[2m > [22m[2mAuthentication Utilities[2m > [22m[2mvalidatePassword[2m > [22m[2mshould accept a valid password
[22m[39mâš  Virus scanner initialization failed (uploads will continue without scanning)

[90mstdout[2m | tests/auth-utils.test.js
[22m[39m
ðŸ§¹ Tearing down test environment...

[90mstdout[2m | tests/auth-utils.test.js
[22m[39mâœ“ Test database cleaned

[90mstdout[2m | tests/auth-utils.test.js
[22m[39mâœ“ Database adapter closed

[90mstdout[2m | tests/auth-utils.test.js
[22m[39mâœ“ Test database disconnected

[90mstdout[2m | tests/auth-utils.test.js
[22m[39mâœ“ Test database cleaned up
âœ“ Test environment cleaned up


 [32mâœ“[39m tests/auth-utils.test.js [2m([22m[2m22 tests[22m[2m)[22m[33m 54276[2mms[22m[39m
   [33m[2mâœ“[22m[39m Authentication Utilities[2m > [22mvalidatePassword[2m > [22mshould accept a valid password [33m 1692[2mms[22m[39m
   [33m[2mâœ“[22m[39m Authentication Utilities[2m > [22mvalidatePassword[2m > [22mshould reject password shorter than 8 characters [33m 1996[2mms[22m[39m
   [33m[2mâœ“[22m[39m Authentication Utilities[2m > [22mvalidatePassword[2m > [22mshould reject password without uppercase letter [33m 1649[2mms[22m[39m
   [33m[2mâœ“[22m[39m Authentication Utilities[2m > [22mvalidatePassword[2m > [22mshould reject password without lowercase letter [33m 1646[2mms[22m[39m
   [33m[2mâœ“[22m[39m Authentication Utilities[2m > [22mvalidatePassword[2m > [22mshould reject password without number [33m 2781[2mms[22m[39m
   [33m[2mâœ“[22m[39m Authentication Utilities[2m > [22mvalidatePassword[2m > [22mshould reject password without special character [33m 1808[2mms[22m[39m
   [33m[2mâœ“[22m[39m Authentication Utilities[2m > [22mvalidatePassword[2m > [22mshould reject null or undefined password [33m 1985[2mms[22m[39m
   [33m[2mâœ“[22m[39m Authentication Utilities[2m > [22mvalidatePassword[2m > [22mshould accept password with all requirements [33m 1738[2mms[22m[39m
   [33m[2mâœ“[22m[39m Authentication Utilities[2m > [22mvalidatePassword[2m > [22mshould return multiple errors for invalid password [33m 1618[2mms[22m[39m
   [33m[2mâœ“[22m[39m Authentication Utilities[2m > [22mvalidateEmail[2m > [22mshould accept valid email addresses [33m 1658[2mms[22m[39m
   [33m[2mâœ“[22m[39m Authentication Utilities[2m > [22mvalidateEmail[2m > [22mshould reject invalid email addresses [33m 2497[2mms[22m[39m
   [33m[2mâœ“[22m[39m Authentication Utilities[2m > [22mvalidateEmail[2m > [22mshould handle edge cases [33m 1805[2mms[22m[39m
   [33m[2mâœ“[22m[39m Authentication Utilities[2m > [22mhashPassword and verifyPassword[2m > [22mshould hash a password [33m 1928[2mms[22m[39m
   [33m[2mâœ“[22m[39m Authentication Utilities[2m > [22mhashPassword and verifyPassword[2m > [22mshould produce different hashes for same password [33m 2504[2mms[22m[39m
   [33m[2mâœ“[22m[39m Authentication Utilities[2m > [22mhashPassword and verifyPassword[2m > [22mshould verify correct password [33m 2234[2mms[22m[39m
   [33m[2mâœ“[22m[39m Authentication Utilities[2m > [22mhashPassword and verifyPassword[2m > [22mshould reject incorrect password [33m 2740[2mms[22m[39m
   [33m[2mâœ“[22m[39m Authentication Utilities[2m > [22mhashPassword and verifyPassword[2m > [22mshould handle empty passwords [33m 2255[2mms[22m[39m
   [33m[2mâœ“[22m[39m Authentication Utilities[2m > [22mhashPassword and verifyPassword[2m > [22mshould be case sensitive [33m 2613[2mms[22m[39m
   [33m[2mâœ“[22m[39m Authentication Utilities[2m > [22mhashPassword and verifyPassword[2m > [22mshould handle long passwords [33m 2249[2mms[22m[39m
   [33m[2mâœ“[22m[39m Authentication Utilities[2m > [22mAUTH_CONFIG[2m > [22mshould have valid configuration values [33m 1642[2mms[22m[39m
   [33m[2mâœ“[22m[39m Authentication Utilities[2m > [22mAUTH_CONFIG[2m > [22mshould have password requirements defined [33m 2640[2mms[22m[39m
   [33m[2mâœ“[22m[39m Authentication Utilities[2m > [22mAUTH_CONFIG[2m > [22mshould have rate limit configuration [33m 2207[2mms[22m[39m
[90mstdout[2m | tests/metadata-handlers.test.js
[22m[39m[dotenv@17.2.3] injecting env (0) from .env.local -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/metadata-handlers.test.js
[22m[39m
ðŸ§ª Setting up test environment...

[90mstdout[2m | tests/metadata-handlers.test.js
[22m[39mâœ“ Test database connected

[90mstdout[2m | tests/metadata-handlers.test.js
[22m[39m  Applying base schema...

[90mstdout[2m | tests/metadata-handlers.test.js
[22m[39m  âœ“ Schema and migrations applied

[90mstdout[2m | tests/metadata-handlers.test.js
[22m[39mâœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

[90mstdout[2m | tests/metadata-handlers.test.js
[22m[39mâœ“ Test database initialized
Initializing adapters...
âœ“ Database adapter initialized
âœ“ Storage adapter initialized
âš  Running in test mode without Redis - using in-memory session store

[90mstdout[2m | tests/metadata-handlers.test.js
[22m[39mâœ“ Session store initialized
âœ“ Cache adapter initialized
âœ“ Queue service initialized
âœ“ Environment initialized
âœ“ Session middleware applied
[VirusScanner] Initializing ClamAV at localhost:3310...

[90mstdout[2m | tests/metadata-handlers.test.js
[22m[39mâœ“ Server adapters initialized
âœ“ Test environment ready


[90mstderr[2m | tests/metadata-handlers.test.js[2m > [22m[2mEnhanced Metadata Handlers[2m > [22m[2mGenre Validation[2m > [22m[2mshould validate word count for romance novel
[22m[39m[VirusScanner] Failed to initialize: 

[90mstderr[2m | tests/metadata-handlers.test.js[2m > [22m[2mEnhanced Metadata Handlers[2m > [22m[2mGenre Validation[2m > [22m[2mshould validate word count for romance novel
[22m[39mâš  Virus scanner initialization failed (uploads will continue without scanning)

[90mstdout[2m | tests/metadata-handlers.test.js
[22m[39m
ðŸ§¹ Tearing down test environment...

[90mstdout[2m | tests/metadata-handlers.test.js
[22m[39mâœ“ Test database cleaned

[90mstdout[2m | tests/metadata-handlers.test.js
[22m[39mâœ“ Database adapter closed

[90mstdout[2m | tests/metadata-handlers.test.js
[22m[39mâœ“ Test database disconnected

[90mstdout[2m | tests/metadata-handlers.test.js
[22m[39mâœ“ Test database cleaned up
âœ“ Test environment cleaned up


 [32mâœ“[39m tests/metadata-handlers.test.js [2m([22m[2m21 tests[22m[2m)[22m[33m 46732[2mms[22m[39m
   [33m[2mâœ“[22m[39m Enhanced Metadata Handlers[2m > [22mGenre Validation[2m > [22mshould validate word count for romance novel [33m 1653[2mms[22m[39m
   [33m[2mâœ“[22m[39m Enhanced Metadata Handlers[2m > [22mGenre Validation[2m > [22mshould flag word count outside genre norms [33m 1642[2mms[22m[39m
   [33m[2mâœ“[22m[39m Enhanced Metadata Handlers[2m > [22mGenre Validation[2m > [22mshould accept novella word counts for appropriate genres [33m 2253[2mms[22m[39m
   [33m[2mâœ“[22m[39m Enhanced Metadata Handlers[2m > [22mContent Warning Validation[2m > [22mshould validate content warning categories [33m 1643[2mms[22m[39m
   [33m[2mâœ“[22m[39m Enhanced Metadata Handlers[2m > [22mContent Warning Validation[2m > [22mshould validate severity levels [33m 1602[2mms[22m[39m
   [33m[2mâœ“[22m[39m Enhanced Metadata Handlers[2m > [22mContent Warning Validation[2m > [22mshould handle multiple content warnings [33m 2474[2mms[22m[39m
   [33m[2mâœ“[22m[39m Enhanced Metadata Handlers[2m > [22mMetadata Structure[2m > [22mshould validate primary genre and subgenres [33m 1598[2mms[22m[39m
   [33m[2mâœ“[22m[39m Enhanced Metadata Handlers[2m > [22mMetadata Structure[2m > [22mshould validate age category [33m 2447[2mms[22m[39m
   [33m[2mâœ“[22m[39m Enhanced Metadata Handlers[2m > [22mMetadata Structure[2m > [22mshould validate manuscript status [33m 1965[2mms[22m[39m
   [33m[2mâœ“[22m[39m Enhanced Metadata Handlers[2m > [22mMetadata Structure[2m > [22mshould validate series information [33m 1608[2mms[22m[39m
   [33m[2mâœ“[22m[39m Enhanced Metadata Handlers[2m > [22mMetadata History Tracking[2m > [22mshould record metadata changes with timestamp [33m 1623[2mms[22m[39m
   [33m[2mâœ“[22m[39m Enhanced Metadata Handlers[2m > [22mMetadata History Tracking[2m > [22mshould track multiple change types [33m 2485[2mms[22m[39m
   [33m[2mâœ“[22m[39m Enhanced Metadata Handlers[2m > [22mGenre Hierarchy[2m > [22mshould validate parent-child genre relationships [33m 1866[2mms[22m[39m
   [33m[2mâœ“[22m[39m Enhanced Metadata Handlers[2m > [22mGenre Hierarchy[2m > [22mshould handle subgenre depth [33m 2242[2mms[22m[39m
   [33m[2mâœ“[22m[39m Enhanced Metadata Handlers[2m > [22mWord Count Validation Logic[2m > [22mshould categorize flash fiction correctly [33m 2230[2mms[22m[39m
   [33m[2mâœ“[22m[39m Enhanced Metadata Handlers[2m > [22mWord Count Validation Logic[2m > [22mshould categorize novel correctly [33m 1642[2mms[22m[39m
   [33m[2mâœ“[22m[39m Enhanced Metadata Handlers[2m > [22mWord Count Validation Logic[2m > [22mshould categorize epic correctly [33m 2527[2mms[22m[39m
   [33m[2mâœ“[22m[39m Enhanced Metadata Handlers[2m > [22mEdge Cases[2m > [22mshould handle missing optional metadata fields [33m 1878[2mms[22m[39m
   [33m[2mâœ“[22m[39m Enhanced Metadata Handlers[2m > [22mEdge Cases[2m > [22mshould handle empty subgenres array [33m 1664[2mms[22m[39m
   [33m[2mâœ“[22m[39m Enhanced Metadata Handlers[2m > [22mEdge Cases[2m > [22mshould validate completion percentage range [33m 2515[2mms[22m[39m
   [33m[2mâœ“[22m[39m Enhanced Metadata Handlers[2m > [22mEdge Cases[2m > [22mshould reject invalid completion percentage [33m 1758[2mms[22m[39m
[90mstdout[2m | tests/integration/webhook-signature-verification.test.js
[22m[39m[dotenv@17.2.3] injecting env (0) from .env.local -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/webhook-signature-verification.test.js
[22m[39m
ðŸ§ª Setting up test environment...

[90mstdout[2m | tests/integration/webhook-signature-verification.test.js
[22m[39mâœ“ Test database connected

[90mstdout[2m | tests/integration/webhook-signature-verification.test.js
[22m[39m  Applying base schema...

[90mstdout[2m | tests/integration/webhook-signature-verification.test.js
[22m[39m  âœ“ Schema and migrations applied

[90mstdout[2m | tests/integration/webhook-signature-verification.test.js
[22m[39mâœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

[90mstdout[2m | tests/integration/webhook-signature-verification.test.js
[22m[39mâœ“ Test database initialized
Initializing adapters...
âœ“ Database adapter initialized
âœ“ Storage adapter initialized
âš  Running in test mode without Redis - using in-memory session store

[90mstdout[2m | tests/integration/webhook-signature-verification.test.js
[22m[39mâœ“ Session store initialized
âœ“ Cache adapter initialized
âœ“ Queue service initialized
âœ“ Environment initialized
âœ“ Session middleware applied
[VirusScanner] Initializing ClamAV at localhost:3310...

[90mstdout[2m | tests/integration/webhook-signature-verification.test.js
[22m[39mâœ“ Server adapters initialized
âœ“ Test environment ready


[90mstderr[2m | tests/integration/webhook-signature-verification.test.js[2m > [22m[2mWebhook Signature Verification[2m > [22m[2mValid Signatures[2m > [22m[2mshould accept webhook with valid signature
[22m[39m[VirusScanner] Failed to initialize: 

[90mstderr[2m | tests/integration/webhook-signature-verification.test.js[2m > [22m[2mWebhook Signature Verification[2m > [22m[2mValid Signatures[2m > [22m[2mshould accept webhook with valid signature
[22m[39mâš  Virus scanner initialization failed (uploads will continue without scanning)

[90mstdout[2m | tests/integration/webhook-signature-verification.test.js[2m > [22m[2mWebhook Signature Verification[2m > [22m[2mValid Signatures[2m > [22m[2mshould accept webhook with valid signature
[22m[39m[Webhook] Processing event: checkout.session.completed evt_test_ff00b5dc72302bab71f5b73c
[Webhook] Checkout completed for user: user-123 plan: [90mundefined[39m

[90mstdout[2m | tests/integration/webhook-signature-verification.test.js[2m > [22m[2mWebhook Signature Verification[2m > [22m[2mValid Signatures[2m > [22m[2mshould accept webhook with valid signature
[22m[39m[Webhook] One-time payment recorded: c1c00806-2328-47bc-a955-9cf1a810e54f

[90mstderr[2m | tests/integration/webhook-signature-verification.test.js[2m > [22m[2mWebhook Signature Verification[2m > [22m[2mValid Signatures[2m > [22m[2mshould accept webhook with valid signature
[22m[39m[Budget] Error updating spend: TypeError: env.DB.prepare(...).first is not a function
    at updateBudgetSpend [90m(D:\manuscript-platform\[39msrc\utils\cost-utils.js:226:85[90m)[39m
    at logCost [90m(D:\manuscript-platform\[39msrc\utils\cost-utils.js:164:11[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at handleCheckoutCompleted [90m(D:\manuscript-platform\[39msrc\handlers\webhook-handlers.js:181:7[90m)[39m
    at handleStripeWebhook [90m(D:\manuscript-platform\[39msrc\handlers\webhook-handlers.js:54:9[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\webhook-signature-verification.test.js:107:26

[90mstderr[2m | tests/integration/webhook-signature-verification.test.js[2m > [22m[2mWebhook Signature Verification[2m > [22m[2mValid Signatures[2m > [22m[2mshould accept webhook with valid signature
[22m[39m[Budget] Error updating user spend: TypeError: Cannot read properties of null (reading 'current_spend_usd')
    at updateUserSpend [90m(D:\manuscript-platform\[39msrc\utils\cost-utils.js:291:34[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at logCost [90m(D:\manuscript-platform\[39msrc\utils\cost-utils.js:168:7[90m)[39m
    at handleCheckoutCompleted [90m(D:\manuscript-platform\[39msrc\handlers\webhook-handlers.js:181:7[90m)[39m
    at handleStripeWebhook [90m(D:\manuscript-platform\[39msrc\handlers\webhook-handlers.js:54:9[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\webhook-signature-verification.test.js:107:26

[90mstdout[2m | tests/integration/webhook-signature-verification.test.js[2m > [22m[2mWebhook Signature Verification[2m > [22m[2mValid Signatures[2m > [22m[2mshould accept webhook with valid signature
[22m[39m[Cost Tracking] Logged stripe_fees/payment_processing/one_time_payment: $1.1697

[90mstdout[2m | tests/integration/webhook-signature-verification.test.js[2m > [22m[2mWebhook Signature Verification[2m > [22m[2mValid Signatures[2m > [22m[2mshould accept webhook with recent timestamp (within 5 min)
[22m[39m[Webhook] Processing event: checkout.session.completed evt_test_b8044962e7f48d26b1b83729
[Webhook] Checkout completed for user: [90mundefined[39m plan: [90mundefined[39m

[90mstdout[2m | tests/integration/webhook-signature-verification.test.js[2m > [22m[2mWebhook Signature Verification[2m > [22m[2mValid Signatures[2m > [22m[2mshould accept webhook with recent timestamp (within 5 min)
[22m[39m[Webhook] One-time payment recorded: cd676e35-3512-4144-ab7f-db7b30dd8e88

[90mstderr[2m | tests/integration/webhook-signature-verification.test.js[2m > [22m[2mWebhook Signature Verification[2m > [22m[2mValid Signatures[2m > [22m[2mshould accept webhook with recent timestamp (within 5 min)
[22m[39m[Budget] Error updating spend: TypeError: env.DB.prepare(...).first is not a function
    at updateBudgetSpend [90m(D:\manuscript-platform\[39msrc\utils\cost-utils.js:226:85[90m)[39m
    at logCost [90m(D:\manuscript-platform\[39msrc\utils\cost-utils.js:164:11[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at handleCheckoutCompleted [90m(D:\manuscript-platform\[39msrc\handlers\webhook-handlers.js:181:7[90m)[39m
    at handleStripeWebhook [90m(D:\manuscript-platform\[39msrc\handlers\webhook-handlers.js:54:9[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\webhook-signature-verification.test.js:107:26

[90mstdout[2m | tests/integration/webhook-signature-verification.test.js[2m > [22m[2mWebhook Signature Verification[2m > [22m[2mValid Signatures[2m > [22m[2mshould accept webhook with recent timestamp (within 5 min)
[22m[39m[Cost Tracking] Logged stripe_fees/payment_processing/one_time_payment: $1.1697

[90mstderr[2m | tests/integration/webhook-signature-verification.test.js[2m > [22m[2mWebhook Signature Verification[2m > [22m[2mInvalid Signatures[2m > [22m[2mshould reject webhook with incorrect signature
[22m[39m[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[90mstderr[2m | tests/integration/webhook-signature-verification.test.js[2m > [22m[2mWebhook Signature Verification[2m > [22m[2mInvalid Signatures[2m > [22m[2mshould reject webhook with malformed signature format
[22m[39m[Webhook] Signature verification failed: No signatures found with expected scheme

[90mstderr[2m | tests/integration/webhook-signature-verification.test.js[2m > [22m[2mWebhook Signature Verification[2m > [22m[2mInvalid Signatures[2m > [22m[2mshould reject webhook with tampered payload
[22m[39m[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[90mstderr[2m | tests/integration/webhook-signature-verification.test.js[2m > [22m[2mWebhook Signature Verification[2m > [22m[2mReplay Attack Prevention[2m > [22m[2mshould reject webhook with expired timestamp (>5 min old)
[22m[39m[Webhook] Signature verification failed: Timestamp outside the tolerance zone

[90mstdout[2m | tests/integration/webhook-signature-verification.test.js[2m > [22m[2mWebhook Signature Verification[2m > [22m[2mReplay Attack Prevention[2m > [22m[2mshould accept webhook with future timestamp (Stripe allows clock skew)
[22m[39m[Webhook] Processing event: checkout.session.completed evt_test_ce0c949b5351c2c6e4a33969
[Webhook] Checkout completed for user: [90mundefined[39m plan: [90mundefined[39m

[90mstdout[2m | tests/integration/webhook-signature-verification.test.js[2m > [22m[2mWebhook Signature Verification[2m > [22m[2mReplay Attack Prevention[2m > [22m[2mshould accept webhook with future timestamp (Stripe allows clock skew)
[22m[39m[Webhook] One-time payment recorded: 2647ec0a-5e8d-4cb3-9940-51fe347cc00b

[90mstderr[2m | tests/integration/webhook-signature-verification.test.js[2m > [22m[2mWebhook Signature Verification[2m > [22m[2mReplay Attack Prevention[2m > [22m[2mshould accept webhook with future timestamp (Stripe allows clock skew)
[22m[39m[Budget] Error updating spend: TypeError: env.DB.prepare(...).first is not a function
    at updateBudgetSpend [90m(D:\manuscript-platform\[39msrc\utils\cost-utils.js:226:85[90m)[39m
    at logCost [90m(D:\manuscript-platform\[39msrc\utils\cost-utils.js:164:11[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at handleCheckoutCompleted [90m(D:\manuscript-platform\[39msrc\handlers\webhook-handlers.js:181:7[90m)[39m
    at handleStripeWebhook [90m(D:\manuscript-platform\[39msrc\handlers\webhook-handlers.js:54:9[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\webhook-signature-verification.test.js:107:26

[90mstdout[2m | tests/integration/webhook-signature-verification.test.js[2m > [22m[2mWebhook Signature Verification[2m > [22m[2mReplay Attack Prevention[2m > [22m[2mshould accept webhook with future timestamp (Stripe allows clock skew)
[22m[39m[Cost Tracking] Logged stripe_fees/payment_processing/one_time_payment: $1.1697

[90mstdout[2m | tests/integration/webhook-signature-verification.test.js
[22m[39m
ðŸ§¹ Tearing down test environment...

[90mstdout[2m | tests/integration/webhook-signature-verification.test.js
[22m[39mâœ“ Test database cleaned

[90mstdout[2m | tests/integration/webhook-signature-verification.test.js
[22m[39mâœ“ Database adapter closed

[90mstdout[2m | tests/integration/webhook-signature-verification.test.js
[22m[39mâœ“ Test database disconnected

[90mstdout[2m | tests/integration/webhook-signature-verification.test.js
[22m[39mâœ“ Test database cleaned up
âœ“ Test environment cleaned up


 [32mâœ“[39m tests/integration/webhook-signature-verification.test.js [2m([22m[2m9 tests[22m[2m)[22m[33m 31143[2mms[22m[39m
   [33m[2mâœ“[22m[39m Webhook Signature Verification[2m > [22mValid Signatures[2m > [22mshould accept webhook with valid signature [33m 1741[2mms[22m[39m
   [33m[2mâœ“[22m[39m Webhook Signature Verification[2m > [22mValid Signatures[2m > [22mshould accept webhook with recent timestamp (within 5 min) [33m 2470[2mms[22m[39m
   [33m[2mâœ“[22m[39m Webhook Signature Verification[2m > [22mMissing Signature[2m > [22mshould reject webhook with no signature header [33m 2415[2mms[22m[39m
   [33m[2mâœ“[22m[39m Webhook Signature Verification[2m > [22mMissing Signature[2m > [22mshould reject webhook with empty signature [33m 3944[2mms[22m[39m
   [33m[2mâœ“[22m[39m Webhook Signature Verification[2m > [22mInvalid Signatures[2m > [22mshould reject webhook with incorrect signature [33m 2463[2mms[22m[39m
   [33m[2mâœ“[22m[39m Webhook Signature Verification[2m > [22mInvalid Signatures[2m > [22mshould reject webhook with malformed signature format [33m 2554[2mms[22m[39m
   [33m[2mâœ“[22m[39m Webhook Signature Verification[2m > [22mInvalid Signatures[2m > [22mshould reject webhook with tampered payload [33m 2822[2mms[22m[39m
   [33m[2mâœ“[22m[39m Webhook Signature Verification[2m > [22mReplay Attack Prevention[2m > [22mshould reject webhook with expired timestamp (>5 min old) [33m 2842[2mms[22m[39m
   [33m[2mâœ“[22m[39m Webhook Signature Verification[2m > [22mReplay Attack Prevention[2m > [22mshould accept webhook with future timestamp (Stripe allows clock skew) [33m 2408[2mms[22m[39m

[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m[1m[41m Failed Tests 60 [49m[22m[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m

[41m[1m FAIL [22m[49m tests/integration/infrastructure.test.js[2m > [22mTest Infrastructure[2m > [22mDatabase Utilities[2m > [22mshould insert and retrieve test records
[31m[1merror[22m: syntax error at or near ")"[39m
[90m [2mâ¯[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[36m [2mâ¯[22m insertTestRecord tests/test-helpers/database.js:[2m217:18[22m[39m
    [90m215| [39m  `[39m[33m;[39m
    [90m216| [39m
    [90m217| [39m  [35mconst[39m result [33m=[39m [35mawait[39m testDb[33m.[39m[34mquery[39m(query[33m,[39m values)[33m;[39m
    [90m   | [39m                 [31m^[39m
    [90m218| [39m  [35mreturn[39m result[33m.[39mrows[[34m0[39m][33m;[39m
    [90m219| [39m}
[90m [2mâ¯[22m tests/integration/infrastructure.test.js:[2m22:24[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[1/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/infrastructure.test.js[2m > [22mTest Infrastructure[2m > [22mDatabase Utilities[2m > [22mshould count test records
[31m[1merror[22m: syntax error at or near ")"[39m
[90m [2mâ¯[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[36m [2mâ¯[22m insertTestRecord tests/test-helpers/database.js:[2m217:18[22m[39m
    [90m215| [39m  `[39m[33m;[39m
    [90m216| [39m
    [90m217| [39m  [35mconst[39m result [33m=[39m [35mawait[39m testDb[33m.[39m[34mquery[39m(query[33m,[39m values)[33m;[39m
    [90m   | [39m                 [31m^[39m
    [90m218| [39m  [35mreturn[39m result[33m.[39mrows[[34m0[39m][33m;[39m
    [90m219| [39m}
[90m [2mâ¯[22m tests/integration/infrastructure.test.js:[2m36:7[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[2/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/infrastructure.test.js[2m > [22mTest Infrastructure[2m > [22mMock Factories[2m > [22mshould create mock storage adapter
[31m[1mTypeError[22m: The first argument must be of type string or an instance of Buffer, ArrayBuffer, or Array or an Array-like Object. Received undefined[39m
[36m [2mâ¯[22m Object.<anonymous> tests/test-helpers/mocks.js:[2m28:60[22m[39m
    [90m 26| [39m      [35mreturn[39m {
    [90m 27| [39m        key[33m,[39m
    [90m 28| [39m        size: Buffer.isBuffer(body) ? body.length : Buffer.from(body).â€¦
    [90m   | [39m                                                           [31m^[39m
    [90m 29| [39m        etag[33m:[39m crypto[33m.[39m[34mrandomBytes[39m([34m16[39m)[33m.[39m[34mtoString[39m([32m'hex'[39m)
    [90m 30| [39m      }[33m;[39m
[90m [2mâ¯[22m tests/integration/infrastructure.test.js:[2m98:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[3/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/infrastructure.test.js[2m > [22mTest Infrastructure[2m > [22mTest Data Factories[2m > [22mshould create test user data
[31m[1mAssertionError[22m: expected undefined to be truthy[39m

[32m- Expected:[39m 
true

[31m+ Received:[39m 
undefined

[36m [2mâ¯[22m tests/integration/infrastructure.test.js:[2m117:23[22m[39m
    [90m115| [39m      [35mconst[39m user [33m=[39m [34mcreateTestUser[39m()[33m;[39m
    [90m116| [39m
    [90m117| [39m      [34mexpect[39m(user[33m.[39mid)[33m.[39m[34mtoBeTruthy[39m()[33m;[39m
    [90m   | [39m                      [31m^[39m
    [90m118| [39m      [34mexpect[39m(user[33m.[39memail)[33m.[39m[34mtoContain[39m([32m'@example.com'[39m)[33m;[39m
    [90m119| [39m      [34mexpect[39m(user[33m.[39mrole)[33m.[39m[34mtoBe[39m([32m'author'[39m)[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[4/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/infrastructure.test.js[2m > [22mTest Infrastructure[2m > [22mTest Data Factories[2m > [22mshould create test user with overrides
[31m[1mAssertionError[22m: expected undefined to be 'custom@example.com' // Object.is equality[39m

[32m- Expected:[39m 
"custom@example.com"

[31m+ Received:[39m 
undefined

[36m [2mâ¯[22m tests/integration/infrastructure.test.js:[2m131:26[22m[39m
    [90m129| [39m      })[33m;[39m
    [90m130| [39m
    [90m131| [39m      [34mexpect[39m(user[33m.[39memail)[33m.[39m[34mtoBe[39m([32m'custom@example.com'[39m)[33m;[39m
    [90m   | [39m                         [31m^[39m
    [90m132| [39m      [34mexpect[39m(user[33m.[39mrole)[33m.[39m[34mtoBe[39m([32m'publisher'[39m)[33m;[39m
    [90m133| [39m      [34mexpect[39m(user[33m.[39memail_verified)[33m.[39m[34mtoBe[39m([35mfalse[39m)[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[5/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/infrastructure.test.js[2m > [22mTest Infrastructure[2m > [22mIntegration: Factories + Database[2m > [22mshould insert factory-generated user into database
[31m[1merror[22m: syntax error at or near ")"[39m
[90m [2mâ¯[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[36m [2mâ¯[22m insertTestRecord tests/test-helpers/database.js:[2m217:18[22m[39m
    [90m215| [39m  `[39m[33m;[39m
    [90m216| [39m
    [90m217| [39m  [35mconst[39m result [33m=[39m [35mawait[39m testDb[33m.[39m[34mquery[39m(query[33m,[39m values)[33m;[39m
    [90m   | [39m                 [31m^[39m
    [90m218| [39m  [35mreturn[39m result[33m.[39mrows[[34m0[39m][33m;[39m
    [90m219| [39m}
[90m [2mâ¯[22m tests/integration/infrastructure.test.js:[2m163:7[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[6/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/infrastructure.test.js[2m > [22mTest Infrastructure[2m > [22mIntegration: Factories + Database[2m > [22mshould insert factory-generated manuscript into database
[31m[1merror[22m: syntax error at or near ")"[39m
[90m [2mâ¯[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[36m [2mâ¯[22m insertTestRecord tests/test-helpers/database.js:[2m217:18[22m[39m
    [90m215| [39m  `[39m[33m;[39m
    [90m216| [39m
    [90m217| [39m  [35mconst[39m result [33m=[39m [35mawait[39m testDb[33m.[39m[34mquery[39m(query[33m,[39m values)[33m;[39m
    [90m   | [39m                 [31m^[39m
    [90m218| [39m  [35mreturn[39m result[33m.[39mrows[[34m0[39m][33m;[39m
    [90m219| [39m}
[90m [2mâ¯[22m tests/integration/infrastructure.test.js:[2m173:7[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[7/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/test-helpers.test.js[2m > [22mTest Data Factories[2m > [22mUser Factory[2m > [22mshould create valid user data
[31m[1mAssertionError[22m: expected undefined to be truthy[39m

[32m- Expected:[39m 
true

[31m+ Received:[39m 
undefined

[36m [2mâ¯[22m tests/unit/test-helpers.test.js:[2m241:23[22m[39m
    [90m239| [39m      [35mconst[39m user [33m=[39m [34mcreateTestUser[39m()[33m;[39m
    [90m240| [39m
    [90m241| [39m      [34mexpect[39m(user[33m.[39mid)[33m.[39m[34mtoBeTruthy[39m()[33m;[39m
    [90m   | [39m                      [31m^[39m
    [90m242| [39m      [34mexpect[39m(user[33m.[39memail)[33m.[39m[34mtoMatch[39m([36m/@example\.com$/[39m)[33m;[39m
    [90m243| [39m      [34mexpect[39m(user[33m.[39mpassword_hash)[33m.[39m[34mtoBeTruthy[39m()[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[8/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/test-helpers.test.js[2m > [22mTest Data Factories[2m > [22mUser Factory[2m > [22mshould accept overrides
[31m[1mAssertionError[22m: expected undefined to be 'custom@test.com' // Object.is equality[39m

[32m- Expected:[39m 
"custom@test.com"

[31m+ Received:[39m 
undefined

[36m [2mâ¯[22m tests/unit/test-helpers.test.js:[2m255:26[22m[39m
    [90m253| [39m      })[33m;[39m
    [90m254| [39m
    [90m255| [39m      [34mexpect[39m(user[33m.[39memail)[33m.[39m[34mtoBe[39m([32m'custom@test.com'[39m)[33m;[39m
    [90m   | [39m                         [31m^[39m
    [90m256| [39m      [34mexpect[39m(user[33m.[39mrole)[33m.[39m[34mtoBe[39m([32m'publisher'[39m)[33m;[39m
    [90m257| [39m      [34mexpect[39m(user[33m.[39mplan)[33m.[39m[34mtoBe[39m([32m'premium'[39m)[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[9/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/test-helpers.test.js[2m > [22mTest Data Factories[2m > [22mManuscript Factory[2m > [22mshould create valid manuscript data
[31m[1mAssertionError[22m: expected undefined to be truthy[39m

[32m- Expected:[39m 
true

[31m+ Received:[39m 
undefined

[36m [2mâ¯[22m tests/unit/test-helpers.test.js:[2m268:36[22m[39m
    [90m266| [39m      [34mexpect[39m(manuscript[33m.[39mid)[33m.[39m[34mtoBeTruthy[39m()[33m;[39m
    [90m267| [39m      [34mexpect[39m(manuscript[33m.[39muser_id)[33m.[39m[34mtoBe[39m(userId)[33m;[39m
    [90m268| [39m      [34mexpect[39m(manuscript[33m.[39mreport_id)[33m.[39m[34mtoBeTruthy[39m()[33m;[39m
    [90m   | [39m                                   [31m^[39m
    [90m269| [39m      [34mexpect[39m(manuscript[33m.[39mtitle)[33m.[39m[34mtoBeTruthy[39m()[33m;[39m
    [90m270| [39m      [34mexpect[39m(manuscript[33m.[39mgenre)[33m.[39m[34mtoBe[39m([32m'fiction'[39m)[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[10/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/test-helpers.test.js[2m > [22mTest Data Factories[2m > [22mPayment Factory[2m > [22mshould create valid payment data
[31m[1mTypeError[22m: .toMatch() expects to receive a string, but got undefined[39m
[36m [2mâ¯[22m tests/unit/test-helpers.test.js:[2m322:41[22m[39m
    [90m320| [39m      [34mexpect[39m(payment[33m.[39mcurrency)[33m.[39m[34mtoBe[39m([32m'usd'[39m)[33m;[39m
    [90m321| [39m      [34mexpect[39m(payment[33m.[39mstatus)[33m.[39m[34mtoBe[39m([32m'succeeded'[39m)[33m;[39m
    [90m322| [39m      [34mexpect[39m(payment[33m.[39mstripe_payment_id)[33m.[39m[34mtoMatch[39m([36m/^pi_/[39m)[33m;[39m
    [90m   | [39m                                        [31m^[39m
    [90m323| [39m    })[33m;[39m
    [90m324| [39m  })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[11/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/register[2m > [22mshould register a new user with valid credentials
[31m[1mAssertionError[22m: expected 'Registration successful. Please checkâ€¦' to match /registered successfully/i[39m

[32m- Expected:[39m 
/registered successfully/i

[31m+ Received:[39m 
"Registration successful. Please check your email to verify your account."

[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m71:28[22m[39m
    [90m 69| [39m    [34mexpect[39m(result[33m.[39muserId)[33m.[39m[34mtoBeDefined[39m()[33m;[39m
    [90m 70| [39m    [34mexpect[39m(result[33m.[39mverificationToken)[33m.[39m[34mtoBeDefined[39m()[33m;[39m
    [90m 71| [39m    [34mexpect[39m(result[33m.[39mmessage)[33m.[39m[34mtoMatch[39m([36m/registered successfully/i[39m)[33m;[39m
    [90m   | [39m                           [31m^[39m
    [90m 72| [39m
    [90m 73| [39m    [90m// Verify user in database[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[12/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/register[2m > [22mshould hash password with bcrypt
[31m[1mAssertionError[22m: expected '$2b$12$PT6kFOhkKHP8msKrUSK4xuZAIZn.IBâ€¦' to match /^\$2[ab]\$10\$/[39m

[32m- Expected:[39m 
/^\$2[ab]\$10\$/

[31m+ Received:[39m 
"$2b$12$PT6kFOhkKHP8msKrUSK4xuZAIZn.IBOnobgw5c1L76ZFr/9LYzzAa"

[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m156:18[22m[39m
    [90m154| [39m
    [90m155| [39m    [90m// bcrypt hashes start with $2a$10$ or $2b$10$[39m
    [90m156| [39m    [34mexpect[39m(hash)[33m.[39m[34mtoMatch[39m([36m/^\$2[ab]\$10\$/[39m)[33m;[39m
    [90m   | [39m                 [31m^[39m
    [90m157| [39m    [34mexpect[39m(hash[33m.[39mlength)[33m.[39m[34mtoBe[39m([34m60[39m)[33m;[39m [90m// bcrypt hash length[39m
    [90m158| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[13/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/register[2m > [22mshould create verification token
[31m[1mAssertionError[22m: expected +0 to be false // Object.is equality[39m

[32m- Expected:[39m 
false

[31m+ Received:[39m 
0

[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m204:38[22m[39m
    [90m202| [39m    [34mexpect[39m(tokenRecord[33m.[39mrows[33m.[39mlength)[33m.[39m[34mtoBe[39m([34m1[39m)[33m;[39m
    [90m203| [39m    [34mexpect[39m(tokenRecord[33m.[39mrows[[34m0[39m][33m.[39mtoken_type)[33m.[39m[34mtoBe[39m([32m'email_verification'[39m)[33m;[39m
    [90m204| [39m    [34mexpect[39m(tokenRecord[33m.[39mrows[[34m0[39m][33m.[39mused)[33m.[39m[34mtoBe[39m([35mfalse[39m)[33m;[39m
    [90m   | [39m                                     [31m^[39m
    [90m205| [39m  })[33m;[39m
    [90m206| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[14/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/register[2m > [22mshould send verification email
[31m[1mAssertionError[22m: expected "spy" to be called with arguments: [ ObjectContaining{â€¦}, Any<Object> ][90m

Number of calls: [1m0[22m
[31m[39m
[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m219:52[22m[39m
    [90m217| [39m    [35mawait[39m authHandlers[33m.[39m[34mhandleRegister[39m(mockRequest[33m,[39m mockEnv)[33m;[39m
    [90m218| [39m
    [90m219| [39m    expect(mockEmailService.sendEmailVerification).toHaveBeenCalledWitâ€¦
    [90m   | [39m                                                   [31m^[39m
    [90m220| [39m      expect[33m.[39m[34mobjectContaining[39m({
    [90m221| [39m        userEmail[33m:[39m [32m'email-test@example.com'[39m[33m,[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[15/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/login[2m > [22mshould update last_login timestamp
[31m[1mAssertionError[22m: expected false to be true // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- true[39m
[31m+ false[39m

[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m418:38[22m[39m
    [90m416| [39m    [35mconst[39m lastLogin [33m=[39m [35mnew[39m [33mDate[39m(user[33m.[39mlast_login)[33m;[39m
    [90m417| [39m
    [90m418| [39m    [34mexpect[39m(lastLogin [33m>=[39m beforeLogin)[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m
    [90m   | [39m                                     [31m^[39m
    [90m419| [39m  })[33m;[39m
    [90m420| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[16/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/login[2m > [22mshould create session in Redis
[31m[1mAssertionError[22m: expected undefined to be 'login-test@example.com' // Object.is equality[39m

[32m- Expected:[39m 
"login-test@example.com"

[31m+ Received:[39m 
undefined

[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m447:27[22m[39m
    [90m445| [39m    [35mconst[39m session [33m=[39m [33mJSON[39m[33m.[39m[34mparse[39m(sessionData)[33m;[39m
    [90m446| [39m    [34mexpect[39m(session[33m.[39muserId)[33m.[39m[34mtoBe[39m(testUser[33m.[39mid)[33m;[39m
    [90m447| [39m    [34mexpect[39m(session[33m.[39memail)[33m.[39m[34mtoBe[39m([32m'login-test@example.com'[39m)[33m;[39m
    [90m   | [39m                          [31m^[39m
    [90m448| [39m  })[33m;[39m
    [90m449| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[17/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/login[2m > [22mshould log failed login attempts
[31m[1mAssertionError[22m: expected 0 to be greater than 0[39m
[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m481:24[22m[39m
    [90m479| [39m
    [90m480| [39m    const auditCount = await countTestRecords('audit_log', { event_typâ€¦
    [90m481| [39m    [34mexpect[39m(auditCount)[33m.[39m[34mtoBeGreaterThan[39m([34m0[39m)[33m;[39m
    [90m   | [39m                       [31m^[39m
    [90m482| [39m  })[33m;[39m
    [90m483| [39m})[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[18/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/verify-email[2m > [22mshould verify email with valid token
[31m[1mAssertionError[22m: expected 400 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 400[39m

[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m522:29[22m[39m
    [90m520| [39m    [35mconst[39m result [33m=[39m [35mawait[39m response[33m.[39m[34mjson[39m()[33m;[39m
    [90m521| [39m
    [90m522| [39m    [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                            [31m^[39m
    [90m523| [39m    [34mexpect[39m(result[33m.[39mmessage)[33m.[39m[34mtoMatch[39m([36m/email verified/i[39m)[33m;[39m
    [90m524| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[19/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/verify-email[2m > [22mshould log email verification event
[31m[1mAssertionError[22m: expected 0 to be greater than 0[39m
[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m621:24[22m[39m
    [90m619| [39m
    [90m620| [39m    const auditCount = await countTestRecords('audit_log', { event_typâ€¦
    [90m621| [39m    [34mexpect[39m(auditCount)[33m.[39m[34mtoBeGreaterThan[39m([34m0[39m)[33m;[39m
    [90m   | [39m                       [31m^[39m
    [90m622| [39m  })[33m;[39m
    [90m623| [39m})[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[20/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/request-password-reset[2m > [22mshould send password reset email
[31m[1mAssertionError[22m: expected "spy" to be called with arguments: [ ObjectContaining{â€¦}, Any<Object> ][90m

Number of calls: [1m0[22m
[31m[39m
[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m679:53[22m[39m
    [90m677| [39m    await authHandlers.handleRequestPasswordReset(mockRequest, mockEnvâ€¦
    [90m678| [39m
    [90m679| [39m    expect(mockEmailService.sendPasswordResetEmail).toHaveBeenCalledWiâ€¦
    [90m   | [39m                                                    [31m^[39m
    [90m680| [39m      expect[33m.[39m[34mobjectContaining[39m({
    [90m681| [39m        userEmail[33m:[39m [32m'reset@example.com'[39m[33m,[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[21/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/request-password-reset[2m > [22mshould rate limit password reset requests
[31m[1mAssertionError[22m: expected 200 to be 429 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 429[39m
[31m+ 200[39m

[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m732:29[22m[39m
    [90m730| [39m    [35mconst[39m result [33m=[39m [35mawait[39m response[33m.[39m[34mjson[39m()[33m;[39m
    [90m731| [39m
    [90m732| [39m    [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m429[39m)[33m;[39m
    [90m   | [39m                            [31m^[39m
    [90m733| [39m    [34mexpect[39m(result[33m.[39merror)[33m.[39m[34mtoMatch[39m([36m/too many.*requests/i[39m)[33m;[39m
    [90m734| [39m  })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/request-password-reset[2m > [22mshould handle missing email
[31m[1mAssertionError[22m: expected 'Invalid email address' to match /email.*required/i[39m

[32m- Expected:[39m 
/email.*required/i

[31m+ Received:[39m 
"Invalid email address"

[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m786:26[22m[39m
    [90m784| [39m
    [90m785| [39m    [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m400[39m)[33m;[39m
    [90m786| [39m    [34mexpect[39m(result[33m.[39merror)[33m.[39m[34mtoMatch[39m([36m/email.*required/i[39m)[33m;[39m
    [90m   | [39m                         [31m^[39m
    [90m787| [39m  })[33m;[39m
    [90m788| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[23/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/reset-password[2m > [22mshould reset password with valid token
[31m[1mAssertionError[22m: expected 400 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 400[39m

[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m843:29[22m[39m
    [90m841| [39m    [35mconst[39m result [33m=[39m [35mawait[39m response[33m.[39m[34mjson[39m()[33m;[39m
    [90m842| [39m
    [90m843| [39m    [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                            [31m^[39m
    [90m844| [39m    [34mexpect[39m(result[33m.[39mmessage)[33m.[39m[34mtoMatch[39m([36m/password.*reset/i[39m)[33m;[39m
    [90m845| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[24/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/reset-password[2m > [22mshould mark reset token as used
[31m[1mTypeError[22m: Cannot read properties of null (reading 'used')[39m
[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m869:18[22m[39m
    [90m867| [39m
    [90m868| [39m    const token = await findTestRecord('verification_tokens', { token:â€¦
    [90m869| [39m    [34mexpect[39m(token[33m.[39mused)[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m
    [90m   | [39m                 [31m^[39m
    [90m870| [39m  })[33m;[39m
    [90m871| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[25/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/reset-password[2m > [22mshould log password reset event
[31m[1mAssertionError[22m: expected 0 to be greater than 0[39m
[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m984:24[22m[39m
    [90m982| [39m
    [90m983| [39m    const auditCount = await countTestRecords('audit_log', { event_typâ€¦
    [90m984| [39m    [34mexpect[39m(auditCount)[33m.[39m[34mtoBeGreaterThan[39m([34m0[39m)[33m;[39m
    [90m   | [39m                       [31m^[39m
    [90m985| [39m  })[33m;[39m
    [90m986| [39m})[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[26/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/logout[2m > [22mshould logout and destroy session
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m1029:29[22m[39m
    [90m1027| [39m    [35mconst[39m result [33m=[39m [35mawait[39m response[33m.[39m[34mjson[39m()[33m;[39m
    [90m1028| [39m
    [90m1029| [39m    [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                            [31m^[39m
    [90m1030| [39m    [34mexpect[39m(result[33m.[39mmessage)[33m.[39m[34mtoMatch[39m([36m/logged out/i[39m)[33m;[39m
    [90m1031| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[27/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/logout[2m > [22mshould clear session cookie
[31m[1mAssertionError[22m: the given combination of arguments (null and string) is invalid for this assertion. You can use an array, a map, an object, a set, a string, or a weakset instead of a string[39m
[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m1047:23[22m[39m
    [90m1045| [39m
    [90m1046| [39m    [35mconst[39m setCookie [33m=[39m response[33m.[39mheaders[33m.[39m[35mget[39m([32m'Set-Cookie'[39m)[33m;[39m
    [90m1047| [39m    [34mexpect[39m(setCookie)[33m.[39m[34mtoContain[39m([32m'session_id='[39m)[33m;[39m
    [90m   | [39m                      [31m^[39m
    [90m1048| [39m    [34mexpect[39m(setCookie)[33m.[39m[34mtoContain[39m([32m'Max-Age=0'[39m)[33m;[39m [90m// Cookie expired[39m
    [90m1049| [39m  })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[28/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/logout[2m > [22mshould log logout event
[31m[1mAssertionError[22m: expected 0 to be greater than 0[39m
[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m1061:24[22m[39m
    [90m1059| [39m
    [90m1060| [39m    const auditCount = await countTestRecords('audit_log', { event_typâ€¦
    [90m1061| [39m    [34mexpect[39m(auditCount)[33m.[39m[34mtoBeGreaterThan[39m([34m0[39m)[33m;[39m
    [90m   | [39m                       [31m^[39m
    [90m1062| [39m  })[33m;[39m
    [90m1063| [39m})[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[29/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mGET /auth/me[2m > [22mshould return current user with valid session
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m1108:29[22m[39m
    [90m1106| [39m    [35mconst[39m result [33m=[39m [35mawait[39m response[33m.[39m[34mjson[39m()[33m;[39m
    [90m1107| [39m
    [90m1108| [39m    [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                            [31m^[39m
    [90m1109| [39m    [34mexpect[39m(result[33m.[39muserId)[33m.[39m[34mtoBe[39m(testUser[33m.[39mid)[33m;[39m
    [90m1110| [39m    [34mexpect[39m(result[33m.[39memail)[33m.[39m[34mtoBe[39m([32m'me@example.com'[39m)[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[30/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mGET /auth/me[2m > [22mshould return email verification status
[31m[1mAssertionError[22m: expected undefined to be defined[39m
[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m1167:34[22m[39m
    [90m1165| [39m    [35mconst[39m result [33m=[39m [35mawait[39m response[33m.[39m[34mjson[39m()[33m;[39m
    [90m1166| [39m
    [90m1167| [39m    [34mexpect[39m(result[33m.[39memailVerified)[33m.[39m[34mtoBeDefined[39m()[33m;[39m
    [90m   | [39m                                 [31m^[39m
    [90m1168| [39m    [34mexpect[39m([35mtypeof[39m result[33m.[39memailVerified)[33m.[39m[34mtoBe[39m([32m'boolean'[39m)[33m;[39m
    [90m1169| [39m  })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[31/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/resend-verification[2m > [22mshould resend verification email for unverified user
[31m[1mAssertionError[22m: expected "spy" to be called with arguments: [ ObjectContaining{â€¦}, Any<Object> ][90m

Number of calls: [1m0[22m
[31m[39m
[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m1206:52[22m[39m
    [90m1204| [39m    [34mexpect[39m(result[33m.[39mmessage)[33m.[39m[34mtoMatch[39m([36m/verification.*sent/i[39m)[33m;[39m
    [90m1205| [39m
    [90m1206| [39m    expect(mockEmailService.sendEmailVerification).toHaveBeenCalledWitâ€¦
    [90m   | [39m                                                   [31m^[39m
    [90m1207| [39m      expect[33m.[39m[34mobjectContaining[39m({
    [90m1208| [39m        userEmail[33m:[39m [32m'resend@example.com'[39m[33m,[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[32/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/resend-verification[2m > [22mshould reject resend for already verified user
[31m[1mAssertionError[22m: expected 409 to be 400 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 400[39m
[31m+ 409[39m

[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m1233:29[22m[39m
    [90m1231| [39m    [35mconst[39m result [33m=[39m [35mawait[39m response[33m.[39m[34mjson[39m()[33m;[39m
    [90m1232| [39m
    [90m1233| [39m    [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m400[39m)[33m;[39m
    [90m   | [39m                            [31m^[39m
    [90m1234| [39m    [34mexpect[39m(result[33m.[39merror)[33m.[39m[34mtoMatch[39m([36m/already verified/i[39m)[33m;[39m
    [90m1235| [39m  })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[33/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/resend-verification[2m > [22mshould rate limit resend requests
[31m[1mAssertionError[22m: expected 200 to be 429 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 429[39m
[31m+ 200[39m

[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m1263:29[22m[39m
    [90m1261| [39m    [35mconst[39m result [33m=[39m [35mawait[39m response[33m.[39m[34mjson[39m()[33m;[39m
    [90m1262| [39m
    [90m1263| [39m    [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m429[39m)[33m;[39m
    [90m   | [39m                            [31m^[39m
    [90m1264| [39m    [34mexpect[39m(result[33m.[39merror)[33m.[39m[34mtoMatch[39m([36m/too many.*requests/i[39m)[33m;[39m
    [90m1265| [39m  })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[34/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /create-checkout-session[2m > [22mshould create checkout session for valid subscription
[31m[1mAssertionError[22m: expected [ 200, 404, 501 ] to include 400[39m
[36m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m94:33[22m[39m
    [90m 92| [39m        expect(response.body.url).toMatch(/checkout\.stripe\.com|stripâ€¦
    [90m 93| [39m      } [35melse[39m {
    [90m 94| [39m        [34mexpect[39m([[34m200[39m[33m,[39m [34m404[39m[33m,[39m [34m501[39m])[33m.[39m[34mtoContain[39m(response[33m.[39mstatus)[33m;[39m
    [90m   | [39m                                [31m^[39m
    [90m 95| [39m      }
    [90m 96| [39m    })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[35/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Signature Verification[2m > [22mshould accept webhook with valid signature
[31m[1mAssertionError[22m: expected [ 200, 404 ] to include 400[39m
[36m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m251:26[22m[39m
    [90m249| [39m
    [90m250| [39m      [90m// Accept 200 (processed) or 404 (endpoint not implemented)[39m
    [90m251| [39m      [34mexpect[39m([[34m200[39m[33m,[39m [34m404[39m])[33m.[39m[34mtoContain[39m(response[33m.[39mstatus)[33m;[39m
    [90m   | [39m                         [31m^[39m
    [90m252| [39m    })[33m;[39m
    [90m253| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[36/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Signature Verification[2m > [22mshould reject replay attacks (duplicate event ID)
[31m[1mAssertionError[22m: expected [ 200, 404 ] to include 400[39m
[36m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m317:26[22m[39m
    [90m315| [39m        [33m.[39m[34msend[39m(payload)[33m;[39m
    [90m316| [39m
    [90m317| [39m      [34mexpect[39m([[34m200[39m[33m,[39m [34m404[39m])[33m.[39m[34mtoContain[39m(response1[33m.[39mstatus)[33m;[39m
    [90m   | [39m                         [31m^[39m
    [90m318| [39m
    [90m319| [39m      [90m// Duplicate request with same event ID should be idempotent[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[37/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle customer.subscription.updated - sync status
[31m[1mAssertionError[22m: expected [ 200, 404 ] to include 400[39m
[36m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m481:26[22m[39m
    [90m479| [39m        [33m.[39m[34msend[39m(payload)[33m;[39m
    [90m480| [39m
    [90m481| [39m      [34mexpect[39m([[34m200[39m[33m,[39m [34m404[39m])[33m.[39m[34mtoContain[39m(response[33m.[39mstatus)[33m;[39m
    [90m   | [39m                         [31m^[39m
    [90m482| [39m    })[33m;[39m
    [90m483| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[38/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle customer.subscription.deleted - downgrade to free
[31m[1merror[22m: column "plan" of relation "subscriptions" does not exist[39m
[90m [2mâ¯[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[36m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m486:7[22m[39m
    [90m484| [39m    it('should handle customer.subscription.deleted - downgrade to freâ€¦
    [90m485| [39m      [90m// Upgrade to paid plan first[39m
    [90m486| [39m      [35mawait[39m [34mqueryTestDb[39m(
    [90m   | [39m      [31m^[39m
    [90m487| [39m        'UPDATE subscriptions SET plan = $1, status = $2 WHERE user_idâ€¦
    [90m488| [39m        [[32m'freelancer'[39m[33m,[39m [32m'active'[39m[33m,[39m testUser[33m.[39mid]

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle customer.subscription.deleted - preserve data
[31m[1merror[22m: column "storage_key" of relation "manuscripts" does not exist[39m
[90m [2mâ¯[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[36m [2mâ¯[22m insertTestRecord tests/test-helpers/database.js:[2m217:18[22m[39m
    [90m215| [39m  `[39m[33m;[39m
    [90m216| [39m
    [90m217| [39m  [35mconst[39m result [33m=[39m [35mawait[39m testDb[33m.[39m[34mquery[39m(query[33m,[39m values)[33m;[39m
    [90m   | [39m                 [31m^[39m
    [90m218| [39m  [35mreturn[39m result[33m.[39mrows[[34m0[39m][33m;[39m
    [90m219| [39m}
[90m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m516:7[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[40/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle invoice.payment_succeeded - record payment
[31m[1mAssertionError[22m: expected [ 200, 404 ] to include 400[39m
[36m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m568:26[22m[39m
    [90m566| [39m        [33m.[39m[34msend[39m(payload)[33m;[39m
    [90m567| [39m
    [90m568| [39m      [34mexpect[39m([[34m200[39m[33m,[39m [34m404[39m])[33m.[39m[34mtoContain[39m(response[33m.[39mstatus)[33m;[39m
    [90m   | [39m                         [31m^[39m
    [90m569| [39m    })[33m;[39m
    [90m570| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[41/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould ignore unhandled event types
[31m[1mAssertionError[22m: expected [ 200, 404 ] to include 400[39m
[36m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m657:26[22m[39m
    [90m655| [39m
    [90m656| [39m      [90m// Should return 200 even for unhandled events[39m
    [90m657| [39m      [34mexpect[39m([[34m200[39m[33m,[39m [34m404[39m])[33m.[39m[34mtoContain[39m(response[33m.[39mstatus)[33m;[39m
    [90m   | [39m                         [31m^[39m
    [90m658| [39m    })[33m;[39m
    [90m659| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[42/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle duplicate webhook deliveries (idempotent)
[31m[1mAssertionError[22m: expected [ 200, 404 ] to include 400[39m
[36m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m682:26[22m[39m
    [90m680| [39m
    [90m681| [39m      [90m// Both should succeed (idempotent)[39m
    [90m682| [39m      [34mexpect[39m([[34m200[39m[33m,[39m [34m404[39m])[33m.[39m[34mtoContain[39m(response1[33m.[39mstatus)[33m;[39m
    [90m   | [39m                         [31m^[39m
    [90m683| [39m      [34mexpect[39m([[34m200[39m[33m,[39m [34m404[39m])[33m.[39m[34mtoContain[39m(response2[33m.[39mstatus)[33m;[39m
    [90m684| [39m    })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[43/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould return 200 for all webhooks (even errors)
[31m[1mAssertionError[22m: expected [ 200, 404, 500 ] to include 400[39m
[36m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m761:31[22m[39m
    [90m759| [39m
    [90m760| [39m      [90m// Stripe expects 200 even if processing fails[39m
    [90m761| [39m      [34mexpect[39m([[34m200[39m[33m,[39m [34m404[39m[33m,[39m [34m500[39m])[33m.[39m[34mtoContain[39m(response[33m.[39mstatus)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m762| [39m    })[33m;[39m
    [90m763| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[44/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mGET /subscription[2m > [22mshould return current subscription details
[31m[1mAssertionError[22m: expected undefined to be 'freelancer' // Object.is equality[39m

[32m- Expected:[39m 
"freelancer"

[31m+ Received:[39m 
undefined

[36m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m831:41[22m[39m
    [90m829| [39m
    [90m830| [39m      [35mif[39m (response[33m.[39mstatus [33m===[39m [34m200[39m) {
    [90m831| [39m        [34mexpect[39m(response[33m.[39mbody[33m.[39mplan_type)[33m.[39m[34mtoBe[39m([32m'freelancer'[39m)[33m;[39m
    [90m   | [39m                                        [31m^[39m
    [90m832| [39m        [34mexpect[39m(response[33m.[39mbody[33m.[39mstatus)[33m.[39m[34mtoBe[39m([32m'active'[39m)[33m;[39m
    [90m833| [39m        [34mexpect[39m(response[33m.[39mbody[33m.[39mcurrentPeriodEnd)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[45/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mGET /subscription[2m > [22mshould return free plan for users without subscription
[31m[1mAssertionError[22m: expected undefined to be 'free' // Object.is equality[39m

[32m- Expected:[39m 
"free"

[31m+ Received:[39m 
undefined

[36m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m856:41[22m[39m
    [90m854| [39m
    [90m855| [39m      [35mif[39m (response[33m.[39mstatus [33m===[39m [34m200[39m) {
    [90m856| [39m        [34mexpect[39m(response[33m.[39mbody[33m.[39mplan_type)[33m.[39m[34mtoBe[39m([32m'free'[39m)[33m;[39m
    [90m   | [39m                                        [31m^[39m
    [90m857| [39m      }
    [90m858| [39m    })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[46/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mGET /subscription[2m > [22mshould include Stripe subscription ID
[31m[1mAssertionError[22m: expected undefined to be 'sub_test_123' // Object.is equality[39m

[32m- Expected:[39m 
"sub_test_123"

[31m+ Received:[39m 
undefined

[36m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m866:52[22m[39m
    [90m864| [39m
    [90m865| [39m      [35mif[39m (response[33m.[39mstatus [33m===[39m [34m200[39m) {
    [90m866| [39m        expect(response.body.stripeSubscriptionId).toBe('sub_test_123'â€¦
    [90m   | [39m                                                   [31m^[39m
    [90m867| [39m      }
    [90m868| [39m    })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[47/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mGET /subscription[2m > [22mshould include current period dates
[31m[1mAssertionError[22m: expected undefined to be defined[39m
[36m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m876:50[22m[39m
    [90m874| [39m
    [90m875| [39m      [35mif[39m (response[33m.[39mstatus [33m===[39m [34m200[39m) {
    [90m876| [39m        [34mexpect[39m(response[33m.[39mbody[33m.[39mcurrentPeriodStart)[33m.[39m[34mtoBeDefined[39m()[33m;[39m
    [90m   | [39m                                                 [31m^[39m
    [90m877| [39m        [34mexpect[39m(response[33m.[39mbody[33m.[39mcurrentPeriodEnd)[33m.[39m[34mtoBeDefined[39m()[33m;[39m
    [90m878| [39m      }

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[48/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mGET /payment-history[2m > [22mshould order payments by date (newest first)
[31m[1mTypeError[22m: actual value must be number or bigint, received "string"[39m
[36m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m974:40[22m[39m
    [90m972| [39m      if (response.status === 200 && response.body.payments.length >= â€¦
    [90m973| [39m        [35mconst[39m payments [33m=[39m response[33m.[39mbody[33m.[39mpayments[33m;[39m
    [90m974| [39m        [34mexpect[39m(payments[[34m0[39m][33m.[39mcreated_at)[33m.[39m[34mtoBeGreaterThanOrEqual[39m(
    [90m   | [39m                                       [31m^[39m
    [90m975| [39m          payments[[34m1[39m][33m.[39mcreated_at
    [90m976| [39m        )[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[49/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mGET /payment-history[2m > [22mshould not include other users payments
[31m[1mAssertionError[22m: expected undefined to be 'e313af090418f8c6bfe62bd362b114ca' // Object.is equality[39m

[32m- Expected:[39m 
"e313af090418f8c6bfe62bd362b114ca"

[31m+ Received:[39m 
undefined

[36m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m998:35[22m[39m
    [90m996| [39m        [35mconst[39m payments [33m=[39m response[33m.[39mbody[33m.[39mpayments[33m;[39m
    [90m997| [39m        payments[33m.[39m[34mforEach[39m((payment) [33m=>[39m {
    [90m998| [39m          [34mexpect[39m(payment[33m.[39muser_id)[33m.[39m[34mtoBe[39m(testUser[33m.[39mid)[33m;[39m
    [90m   | [39m                                  [31m^[39m
    [90m999| [39m        })[33m;[39m
    [90m1000| [39m      }
[90m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m997:18[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[50/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould track manuscript analysis usage
[31m[1mReferenceError[22m: generateId is not defined[39m
[36m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m1051:23[22m[39m
    [90m1049| [39m    [34mit[39m([32m'should track manuscript analysis usage'[39m[33m,[39m [35masync[39m () [33m=>[39m {
    [90m1050| [39m      // Import trackUsage directly (if exported) or test via analysisâ€¦
    [90m1051| [39m      [35mconst[39m usageId [33m=[39m [34mgenerateId[39m()[33m;[39m
    [90m   | [39m                      [31m^[39m
    [90m1052| [39m      [35mconst[39m timestamp [33m=[39m [33mMath[39m[33m.[39m[34mfloor[39m([33mDate[39m[33m.[39m[34mnow[39m() [33m/[39m [34m1000[39m)[33m;[39m
    [90m1053| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[51/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould track different analysis types
[31m[1mReferenceError[22m: generateId is not defined[39m
[36m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m1084:28[22m[39m
    [90m1082| [39m
    [90m1083| [39m      [90m// Track basic analysis[39m
    [90m1084| [39m      [35mconst[39m basicUsageId [33m=[39m [34mgenerateId[39m()[33m;[39m
    [90m   | [39m                           [31m^[39m
    [90m1085| [39m      [35mawait[39m [34minsertTestRecord[39m([32m'usage_tracking'[39m[33m,[39m {
    [90m1086| [39m        id[33m:[39m basicUsageId[33m,[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[52/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould track asset generation separately
[31m[1mReferenceError[22m: generateId is not defined[39m
[36m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m1128:29[22m[39m
    [90m1126| [39m
    [90m1127| [39m      [90m// Without assets[39m
    [90m1128| [39m      [35mconst[39m usageNoAssets [33m=[39m [34mgenerateId[39m()[33m;[39m
    [90m   | [39m                            [31m^[39m
    [90m1129| [39m      [35mawait[39m [34minsertTestRecord[39m([32m'usage_tracking'[39m[33m,[39m {
    [90m1130| [39m        id[33m:[39m usageNoAssets[33m,[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[53/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould calculate usage within billing period
[31m[1mReferenceError[22m: generateId is not defined[39m
[36m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m1176:15[22m[39m
    [90m1174| [39m      [35mfor[39m ([35mlet[39m i [33m=[39m [34m0[39m[33m;[39m i [33m<[39m [34m3[39m[33m;[39m i[33m++[39m) {
    [90m1175| [39m        [35mawait[39m [34minsertTestRecord[39m([32m'usage_tracking'[39m[33m,[39m {
    [90m1176| [39m          id[33m:[39m [34mgenerateId[39m()[33m,[39m
    [90m   | [39m              [31m^[39m
    [90m1177| [39m          user_id[33m:[39m testUser[33m.[39mid[33m,[39m
    [90m1178| [39m          subscription_id[33m:[39m subscription[33m.[39mid[33m,[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[54/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould separate usage across different billing periods
[31m[1mReferenceError[22m: generateId is not defined[39m
[36m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m1209:13[22m[39m
    [90m1207| [39m      [90m// Current period usage[39m
    [90m1208| [39m      [35mawait[39m [34minsertTestRecord[39m([32m'usage_tracking'[39m[33m,[39m {
    [90m1209| [39m        id[33m:[39m [34mgenerateId[39m()[33m,[39m
    [90m   | [39m            [31m^[39m
    [90m1210| [39m        user_id[33m:[39m testUser[33m.[39mid[33m,[39m
    [90m1211| [39m        subscription_id[33m:[39m subscription[33m.[39mid[33m,[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[55/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould track usage for users without subscription (pay-per-use)
[31m[1mReferenceError[22m: generateId is not defined[39m
[36m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m1260:23[22m[39m
    [90m1258| [39m      [35mawait[39m [34minsertTestRecord[39m([32m'manuscripts'[39m[33m,[39m manuscript)[33m;[39m
    [90m1259| [39m
    [90m1260| [39m      [35mconst[39m usageId [33m=[39m [34mgenerateId[39m()[33m;[39m
    [90m   | [39m                      [31m^[39m
    [90m1261| [39m      [35mconst[39m timestamp [33m=[39m [33mMath[39m[33m.[39m[34mfloor[39m([33mDate[39m[33m.[39m[34mnow[39m() [33m/[39m [34m1000[39m)[33m;[39m
    [90m1262| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[56/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould link usage to specific manuscript
[31m[1mReferenceError[22m: generateId is not defined[39m
[36m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m1294:13[22m[39m
    [90m1292| [39m      [90m// Track usage for first manuscript[39m
    [90m1293| [39m      [35mawait[39m [34minsertTestRecord[39m([32m'usage_tracking'[39m[33m,[39m {
    [90m1294| [39m        id[33m:[39m [34mgenerateId[39m()[33m,[39m
    [90m   | [39m            [31m^[39m
    [90m1295| [39m        user_id[33m:[39m testUser[33m.[39mid[33m,[39m
    [90m1296| [39m        subscription_id[33m:[39m subscription[33m.[39mid[33m,[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[57/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould accumulate credits across multiple analyses
[31m[1mReferenceError[22m: generateId is not defined[39m
[36m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m1339:15[22m[39m
    [90m1337| [39m      [35mfor[39m ([35mlet[39m i [33m=[39m [34m0[39m[33m;[39m i [33m<[39m [34m5[39m[33m;[39m i[33m++[39m) {
    [90m1338| [39m        [35mawait[39m [34minsertTestRecord[39m([32m'usage_tracking'[39m[33m,[39m {
    [90m1339| [39m          id[33m:[39m [34mgenerateId[39m()[33m,[39m
    [90m   | [39m              [31m^[39m
    [90m1340| [39m          user_id[33m:[39m testUser[33m.[39mid[33m,[39m
    [90m1341| [39m          subscription_id[33m:[39m subscription[33m.[39mid[33m,[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[58/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould track timestamp for usage analytics
[31m[1mReferenceError[22m: generateId is not defined[39m
[36m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m1372:23[22m[39m
    [90m1370| [39m
    [90m1371| [39m      [35mconst[39m beforeTimestamp [33m=[39m [33mMath[39m[33m.[39m[34mfloor[39m([33mDate[39m[33m.[39m[34mnow[39m() [33m/[39m [34m1000[39m) [33m-[39m [34m10[39m[33m;[39m
    [90m1372| [39m      [35mconst[39m usageId [33m=[39m [34mgenerateId[39m()[33m;[39m
    [90m   | [39m                      [31m^[39m
    [90m1373| [39m      [35mconst[39m timestamp [33m=[39m [33mMath[39m[33m.[39m[34mfloor[39m([33mDate[39m[33m.[39m[34mnow[39m() [33m/[39m [34m1000[39m)[33m;[39m
    [90m1374| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[59/60]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould delete usage records when manuscript is deleted (CASCADE)
[31m[1mReferenceError[22m: generateId is not defined[39m
[36m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m1398:23[22m[39m
    [90m1396| [39m      })[33m;[39m
    [90m1397| [39m
    [90m1398| [39m      [35mconst[39m usageId [33m=[39m [34mgenerateId[39m()[33m;[39m
    [90m   | [39m                      [31m^[39m
    [90m1399| [39m      [35mawait[39m [34minsertTestRecord[39m([32m'usage_tracking'[39m[33m,[39m {
    [90m1400| [39m        id[33m:[39m usageId[33m,[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[60/60]âŽ¯[22m[39m


[2m Test Files [22m [1m[31m4 failed[39m[22m[2m | [22m[1m[32m6 passed[39m[22m[90m (10)[39m
[2m      Tests [22m [1m[31m60 failed[39m[22m[2m | [22m[1m[32m218 passed[39m[22m[90m (278)[39m
[2m   Start at [22m 17:12:04
[2m   Duration [22m 591.05s[2m (transform 524ms, setup 18.91s, collect 811ms, tests 568.06s, environment 2ms, prepare 1.55s)[22m


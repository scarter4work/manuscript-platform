
> manuscript-upload-api@1.0.0 test
> cross-env NODE_ENV=test TEST_DATABASE_URL=postgresql://postgres:Bjoran32!@127.0.0.1:5432/manuscript_platform_test vitest run


 RUN  v3.2.4 /mnt/d/manuscript-platform

stdout | tests/submission-packages.test.js
[dotenv@17.2.3] injecting env (0) from .env.local -- tip: ğŸ” encrypt with Dotenvx: https://dotenvx.com

stdout | tests/submission-packages.test.js

ğŸ§ª Setting up test environment...

stderr | tests/submission-packages.test.js
âŒ Failed to set up test environment: Error: connect ECONNREFUSED 127.0.0.1:5432
[90m    at TCPConnectWrap.afterConnect [as oncomplete] (node:net:1555:16)[39m {
  errno: [33m-111[39m,
  code: [32m'ECONNREFUSED'[39m,
  syscall: [32m'connect'[39m,
  address: [32m'127.0.0.1'[39m,
  port: [33m5432[39m
}
ğŸ’¡ Ensure PostgreSQL is running on 127.0.0.1:5432
ğŸ’¡ Or set TEST_DATABASE_URL to your test database

stdout | tests/submission-packages.test.js

ğŸ§¹ Tearing down test environment...
âœ“ Test environment cleaned up


 â¯ tests/submission-packages.test.js (31 tests | 31 skipped) 7ms
   â†“ Submission Package Bundler > Package Templates > should have agent query template
   â†“ Submission Package Bundler > Package Templates > should have full manuscript template
   â†“ Submission Package Bundler > Package Templates > should have query only template
   â†“ Submission Package Bundler > Package Templates > should have contest template
   â†“ Submission Package Bundler > Package Templates > should validate required documents
   â†“ Submission Package Bundler > Package Creation > should create package with metadata
   â†“ Submission Package Bundler > Package Creation > should include document list with ordering
   â†“ Submission Package Bundler > Package Creation > should validate package has at least one document
   â†“ Submission Package Bundler > Package Creation > should allow custom package names
   â†“ Submission Package Bundler > Document Selection > should allow selecting multiple documents
   â†“ Submission Package Bundler > Document Selection > should maintain document order
   â†“ Submission Package Bundler > Document Selection > should allow reordering documents
   â†“ Submission Package Bundler > ZIP File Generation > should generate ZIP with multiple files
   â†“ Submission Package Bundler > ZIP File Generation > should prefix files with order numbers
   â†“ Submission Package Bundler > ZIP File Generation > should sanitize filenames
   â†“ Submission Package Bundler > ZIP File Generation > should support different file formats
   â†“ Submission Package Bundler > ZIP File Generation > should include metadata file in ZIP
   â†“ Submission Package Bundler > Package Duplication > should create copy of existing package
   â†“ Submission Package Bundler > Package Duplication > should increment copy counter in name
   â†“ Submission Package Bundler > Package Management > should list packages for manuscript
   â†“ Submission Package Bundler > Package Management > should update package details
   â†“ Submission Package Bundler > Package Management > should delete package
   â†“ Submission Package Bundler > Validation > should validate package has required documents
   â†“ Submission Package Bundler > Validation > should validate document exists before adding to package
   â†“ Submission Package Bundler > Validation > should prevent duplicate documents in package
   â†“ Submission Package Bundler > Download Tracking > should track download count
   â†“ Submission Package Bundler > Download Tracking > should track last downloaded timestamp
   â†“ Submission Package Bundler > Edge Cases > should handle empty package name
   â†“ Submission Package Bundler > Edge Cases > should handle very long package name
   â†“ Submission Package Bundler > Edge Cases > should handle package with only one document
   â†“ Submission Package Bundler > Edge Cases > should handle large file sizes
stdout | tests/integration/handlers/auth-handlers.test.js
[dotenv@17.2.3] injecting env (0) from .env.local -- tip: ğŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

stdout | tests/integration/handlers/auth-handlers.test.js

ğŸ§ª Setting up test environment...

stderr | tests/integration/handlers/auth-handlers.test.js
âŒ Failed to set up test environment: Error: connect ECONNREFUSED 127.0.0.1:5432
[90m    at TCPConnectWrap.afterConnect [as oncomplete] (node:net:1555:16)[39m {
  errno: [33m-111[39m,
  code: [32m'ECONNREFUSED'[39m,
  syscall: [32m'connect'[39m,
  address: [32m'127.0.0.1'[39m,
  port: [33m5432[39m
}
ğŸ’¡ Ensure PostgreSQL is running on 127.0.0.1:5432
ğŸ’¡ Or set TEST_DATABASE_URL to your test database

stdout | tests/integration/handlers/auth-handlers.test.js

ğŸ§¹ Tearing down test environment...
âœ“ Test environment cleaned up


 â¯ tests/integration/handlers/auth-handlers.test.js (53 tests | 53 skipped) 9ms
   â†“ POST /auth/register > should register a new user with valid credentials
   â†“ POST /auth/register > should reject registration with weak password
   â†“ POST /auth/register > should reject registration with invalid email
   â†“ POST /auth/register > should reject registration with duplicate email
   â†“ POST /auth/register > should hash password with bcrypt
   â†“ POST /auth/register > should normalize email to lowercase
   â†“ POST /auth/register > should create verification token
   â†“ POST /auth/register > should send verification email
   â†“ POST /auth/register > should log registration event in audit log
   â†“ POST /auth/register > should set default role to author if not specified
   â†“ POST /auth/login > should login with valid credentials
   â†“ POST /auth/login > should reject login with wrong password
   â†“ POST /auth/login > should reject login with non-existent email
   â†“ POST /auth/login > should reject login with unverified email
   â†“ POST /auth/login > should rate limit after 5 failed attempts
   â†“ POST /auth/login > should update last_login timestamp
   â†“ POST /auth/login > should create session in Redis
   â†“ POST /auth/login > should log successful login
   â†“ POST /auth/login > should log failed login attempts
   â†“ POST /auth/verify-email > should verify email with valid token
   â†“ POST /auth/verify-email > should reject invalid token
   â†“ POST /auth/verify-email > should reject expired token
   â†“ POST /auth/verify-email > should reject already used token
   â†“ POST /auth/verify-email > should handle missing token
   â†“ POST /auth/verify-email > should log email verification event
   â†“ POST /auth/request-password-reset > should create password reset token for valid email
   â†“ POST /auth/request-password-reset > should send password reset email
   â†“ POST /auth/request-password-reset > should not reveal if email does not exist (security)
   â†“ POST /auth/request-password-reset > should rate limit password reset requests
   â†“ POST /auth/request-password-reset > should normalize email to lowercase
   â†“ POST /auth/request-password-reset > should reject invalid email format
   â†“ POST /auth/request-password-reset > should handle missing email
   â†“ POST /auth/request-password-reset > should log password reset request
   â†“ POST /auth/reset-password > should reset password with valid token
   â†“ POST /auth/reset-password > should mark reset token as used
   â†“ POST /auth/reset-password > should reject weak new password
   â†“ POST /auth/reset-password > should reject invalid token
   â†“ POST /auth/reset-password > should reject expired token
   â†“ POST /auth/reset-password > should reject already used token
   â†“ POST /auth/reset-password > should hash new password with bcrypt
   â†“ POST /auth/reset-password > should log password reset event
   â†“ POST /auth/logout > should logout and destroy session
   â†“ POST /auth/logout > should clear session cookie
   â†“ POST /auth/logout > should log logout event
   â†“ GET /auth/me > should return current user with valid session
   â†“ GET /auth/me > should not return password hash
   â†“ GET /auth/me > should reject request without session
   â†“ GET /auth/me > should reject request with invalid session
   â†“ GET /auth/me > should return email verification status
   â†“ POST /auth/resend-verification > should resend verification email for unverified user
   â†“ POST /auth/resend-verification > should reject resend for already verified user
   â†“ POST /auth/resend-verification > should rate limit resend requests
   â†“ POST /auth/resend-verification > should not reveal if email does not exist (security)
stdout | tests/document-generation.test.js
[dotenv@17.2.3] injecting env (0) from .env.local -- tip: ğŸ“¡ add observability to secrets: https://dotenvx.com/ops

stdout | tests/document-generation.test.js

ğŸ§ª Setting up test environment...

stderr | tests/document-generation.test.js
âŒ Failed to set up test environment: Error: connect ECONNREFUSED 127.0.0.1:5432
[90m    at TCPConnectWrap.afterConnect [as oncomplete] (node:net:1555:16)[39m {
  errno: [33m-111[39m,
  code: [32m'ECONNREFUSED'[39m,
  syscall: [32m'connect'[39m,
  address: [32m'127.0.0.1'[39m,
  port: [33m5432[39m
}
ğŸ’¡ Ensure PostgreSQL is running on 127.0.0.1:5432
ğŸ’¡ Or set TEST_DATABASE_URL to your test database

stdout | tests/document-generation.test.js

ğŸ§¹ Tearing down test environment...
âœ“ Test environment cleaned up


 â¯ tests/document-generation.test.js (27 tests | 27 skipped) 8ms
   â†“ Document Generation > Query Letter Generation > should generate query letter within word count range
   â†“ Document Generation > Query Letter Generation > should include essential query letter components
   â†“ Document Generation > Query Letter Generation > should validate query letter structure
   â†“ Document Generation > Query Letter Generation > should reject query letters that are too short
   â†“ Document Generation > Query Letter Generation > should reject query letters that are too long
   â†“ Document Generation > Synopsis Generation > should generate short synopsis at 500 words
   â†“ Document Generation > Synopsis Generation > should generate long synopsis at 2500 words
   â†“ Document Generation > Synopsis Generation > should include beginning, middle, and end
   â†“ Document Generation > Synopsis Generation > should reveal ending (unlike blurb)
   â†“ Document Generation > Synopsis Generation > should maintain chronological order
   â†“ Document Generation > Version Management > should create new version on update
   â†“ Document Generation > Version Management > should track version metadata
   â†“ Document Generation > Version Management > should allow rollback to previous version
   â†“ Document Generation > Version Management > should maintain version history after rollback
   â†“ Document Generation > Document Validation > should validate document type
   â†“ Document Generation > Document Validation > should reject invalid document type
   â†“ Document Generation > Document Validation > should validate required fields
   â†“ Document Generation > Document Validation > should calculate word count accurately
   â†“ Document Generation > Document Validation > should handle empty document
   â†“ Document Generation > AI Generation Metadata > should track generation parameters
   â†“ Document Generation > AI Generation Metadata > should calculate cost based on token usage
   â†“ Document Generation > Batch Generation > should generate all document types at once
   â†“ Document Generation > Batch Generation > should track individual generation status
   â†“ Document Generation > Edge Cases > should handle very short manuscript title
   â†“ Document Generation > Edge Cases > should handle very long manuscript title
   â†“ Document Generation > Edge Cases > should handle special characters in content
   â†“ Document Generation > Edge Cases > should handle unicode characters
stdout | tests/unit/test-helpers.test.js
[dotenv@17.2.3] injecting env (0) from .env.local -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

stdout | tests/unit/test-helpers.test.js

ğŸ§ª Setting up test environment...

stderr | tests/unit/test-helpers.test.js
âŒ Failed to set up test environment: Error: connect ECONNREFUSED 127.0.0.1:5432
[90m    at TCPConnectWrap.afterConnect [as oncomplete] (node:net:1555:16)[39m {
  errno: [33m-111[39m,
  code: [32m'ECONNREFUSED'[39m,
  syscall: [32m'connect'[39m,
  address: [32m'127.0.0.1'[39m,
  port: [33m5432[39m
}
ğŸ’¡ Ensure PostgreSQL is running on 127.0.0.1:5432
ğŸ’¡ Or set TEST_DATABASE_URL to your test database

stdout | tests/unit/test-helpers.test.js

ğŸ§¹ Tearing down test environment...
âœ“ Test environment cleaned up


 â¯ tests/unit/test-helpers.test.js (24 tests | 24 skipped) 7ms
   â†“ Mock Factories > Storage Adapter Mock > should put and get objects
   â†“ Mock Factories > Storage Adapter Mock > should delete objects
   â†“ Mock Factories > Storage Adapter Mock > should list objects by prefix
   â†“ Mock Factories > Redis Mock > should set and get values
   â†“ Mock Factories > Redis Mock > should set values with expiration
   â†“ Mock Factories > Redis Mock > should delete keys
   â†“ Mock Factories > Redis Mock > should increment values
   â†“ Mock Factories > Claude API Mock > should return mock AI responses
   â†“ Mock Factories > Claude API Mock > should include custom response text
   â†“ Mock Factories > Email Service Mock > should track sent emails
   â†“ Mock Factories > Email Service Mock > should find emails by recipient
   â†“ Mock Factories > Email Service Mock > should clear sent emails
   â†“ Mock Factories > Stripe Mock > should create checkout sessions
   â†“ Mock Factories > Stripe Mock > should create payment intents
   â†“ Mock Factories > Stripe Mock > should construct webhook events
   â†“ Test Data Factories > User Factory > should create valid user data
   â†“ Test Data Factories > User Factory > should accept overrides
   â†“ Test Data Factories > Manuscript Factory > should create valid manuscript data
   â†“ Test Data Factories > Manuscript Factory > should accept overrides
   â†“ Test Data Factories > Analysis Factory > should create valid analysis data
   â†“ Test Data Factories > Analysis Factory > should include result JSON
   â†“ Test Data Factories > Payment Factory > should create valid payment data
   â†“ Test Data Factories > Utility Functions > should generate unique email addresses
   â†“ Test Data Factories > Utility Functions > should generate unique IDs
stdout | tests/integration/handlers/payment-handlers.test.js
[dotenv@17.2.3] injecting env (0) from .env.local -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

stdout | tests/integration/handlers/payment-handlers.test.js

ğŸ§ª Setting up test environment...

stderr | tests/integration/handlers/payment-handlers.test.js
âŒ Failed to set up test environment: Error: connect ECONNREFUSED 127.0.0.1:5432
[90m    at TCPConnectWrap.afterConnect [as oncomplete] (node:net:1555:16)[39m {
  errno: [33m-111[39m,
  code: [32m'ECONNREFUSED'[39m,
  syscall: [32m'connect'[39m,
  address: [32m'127.0.0.1'[39m,
  port: [33m5432[39m
}
ğŸ’¡ Ensure PostgreSQL is running on 127.0.0.1:5432
ğŸ’¡ Or set TEST_DATABASE_URL to your test database

stdout | tests/integration/handlers/payment-handlers.test.js

ğŸ§¹ Tearing down test environment...
âœ“ Test environment cleaned up


 â¯ tests/integration/handlers/payment-handlers.test.js (54 tests | 54 skipped) 10ms
   â†“ Payment & Webhook Handlers > POST /create-checkout-session > should create checkout session for valid subscription
   â†“ Payment & Webhook Handlers > POST /create-checkout-session > should require authentication for checkout
   â†“ Payment & Webhook Handlers > POST /create-checkout-session > should reject invalid price IDs
   â†“ Payment & Webhook Handlers > POST /create-checkout-session > should include userId in session metadata
   â†“ Payment & Webhook Handlers > POST /create-checkout-session > should handle missing priceId field
   â†“ Payment & Webhook Handlers > POST /create-checkout-session > should handle missing planType field
   â†“ Payment & Webhook Handlers > POST /create-checkout-session > should create customer if not exists
   â†“ Payment & Webhook Handlers > POST /create-checkout-session > should set correct success and cancel URLs
   â†“ Payment & Webhook Handlers > POST /create-checkout-session > should handle Stripe API errors gracefully
   â†“ Payment & Webhook Handlers > POST /create-checkout-session > should log checkout session creation
   â†“ Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should accept webhook with valid signature
   â†“ Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should reject webhook with invalid signature
   â†“ Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should reject webhook with missing signature
   â†“ Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should reject webhook with expired signature (>5 minutes)
   â†“ Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should reject replay attacks (duplicate event ID)
   â†“ Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should handle malformed signature header
   â†“ Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should log signature verification failures
   â†“ Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should return 400 for invalid signatures (not 500)
   â†“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle checkout.session.completed - activate subscription
   â†“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle checkout.session.completed - record payment
   â†“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle customer.subscription.updated - sync status
   â†“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle customer.subscription.deleted - downgrade to free
   â†“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle customer.subscription.deleted - preserve data
   â†“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle invoice.payment_succeeded - record payment
   â†“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle invoice.payment_succeeded - extend billing period
   â†“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle invoice.payment_failed - mark past_due
   â†“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle invoice.payment_failed - cancel after 3 failures
   â†“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should ignore unhandled event types
   â†“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle duplicate webhook deliveries (idempotent)
   â†“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle webhook for deleted user gracefully
   â†“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle malformed webhook data gracefully
   â†“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should log all webhook events
   â†“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should return 200 for all webhooks (even errors)
   â†“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should process webhook in under 5 seconds
   â†“ Payment & Webhook Handlers > GET /subscription > should return current subscription details
   â†“ Payment & Webhook Handlers > GET /subscription > should require authentication
   â†“ Payment & Webhook Handlers > GET /subscription > should return free plan for users without subscription
   â†“ Payment & Webhook Handlers > GET /subscription > should include Stripe subscription ID
   â†“ Payment & Webhook Handlers > GET /subscription > should include current period dates
   â†“ Payment & Webhook Handlers > GET /payment-history > should return payment history for user
   â†“ Payment & Webhook Handlers > GET /payment-history > should require authentication
   â†“ Payment & Webhook Handlers > GET /payment-history > should return empty array for no payments
   â†“ Payment & Webhook Handlers > GET /payment-history > should order payments by date (newest first)
   â†“ Payment & Webhook Handlers > GET /payment-history > should not include other users payments
   â†“ Payment & Webhook Handlers > Usage Tracking > should track manuscript analysis usage
   â†“ Payment & Webhook Handlers > Usage Tracking > should track different analysis types
   â†“ Payment & Webhook Handlers > Usage Tracking > should track asset generation separately
   â†“ Payment & Webhook Handlers > Usage Tracking > should calculate usage within billing period
   â†“ Payment & Webhook Handlers > Usage Tracking > should separate usage across different billing periods
   â†“ Payment & Webhook Handlers > Usage Tracking > should track usage for users without subscription (pay-per-use)
   â†“ Payment & Webhook Handlers > Usage Tracking > should link usage to specific manuscript
   â†“ Payment & Webhook Handlers > Usage Tracking > should accumulate credits across multiple analyses
   â†“ Payment & Webhook Handlers > Usage Tracking > should track timestamp for usage analytics
   â†“ Payment & Webhook Handlers > Usage Tracking > should delete usage records when manuscript is deleted (CASCADE)
stdout | tests/error-handling.test.js
[dotenv@17.2.3] injecting env (0) from .env.local -- tip: âš™ï¸  enable debug logging with { debug: true }

stdout | tests/error-handling.test.js

ğŸ§ª Setting up test environment...

stderr | tests/error-handling.test.js
âŒ Failed to set up test environment: Error: connect ECONNREFUSED 127.0.0.1:5432
[90m    at TCPConnectWrap.afterConnect [as oncomplete] (node:net:1555:16)[39m {
  errno: [33m-111[39m,
  code: [32m'ECONNREFUSED'[39m,
  syscall: [32m'connect'[39m,
  address: [32m'127.0.0.1'[39m,
  port: [33m5432[39m
}
ğŸ’¡ Ensure PostgreSQL is running on 127.0.0.1:5432
ğŸ’¡ Or set TEST_DATABASE_URL to your test database

stdout | tests/error-handling.test.js

ğŸ§¹ Tearing down test environment...
âœ“ Test environment cleaned up


 â¯ tests/error-handling.test.js (24 tests | 24 skipped) 8ms
   â†“ Error Handling > Error Classes > should create AppError with correct properties
   â†“ Error Handling > Error Classes > should serialize AppError to JSON correctly
   â†“ Error Handling > Error Classes > should create AuthenticationError with 401 status
   â†“ Error Handling > Error Classes > should create AuthorizationError with 403 status
   â†“ Error Handling > Error Classes > should create ValidationError with 400 status
   â†“ Error Handling > Error Classes > should create NotFoundError with 404 status
   â†“ Error Handling > Error Classes > should create RateLimitError with 429 status
   â†“ Error Handling > Error Classes > should create ConflictError with 409 status
   â†“ Error Handling > Error Classes > should create ServerError with 500 status
   â†“ Error Handling > Error Classes > should create ExternalServiceError with service name
   â†“ Error Handling > createErrorResponse > should create Response with correct status and JSON
   â†“ Error Handling > createErrorResponse > should handle generic Error objects
   â†“ Error Handling > createErrorResponse > should include Retry-After header for rate limit errors
   â†“ Error Handling > createErrorResponse > should merge additional headers
   â†“ Error Handling > Assertion Helpers > assert should not throw when condition is true
   â†“ Error Handling > Assertion Helpers > assert should throw ValidationError when condition is false
   â†“ Error Handling > Assertion Helpers > assert should include details in error
   â†“ Error Handling > Assertion Helpers > assertAuthenticated should not throw when userId exists
   â†“ Error Handling > Assertion Helpers > assertAuthenticated should throw when userId is null
   â†“ Error Handling > Assertion Helpers > assertAuthenticated should throw when userId is undefined
   â†“ Error Handling > Assertion Helpers > assertAuthorized should not throw when permission is true
   â†“ Error Handling > Assertion Helpers > assertAuthorized should throw when permission is false
   â†“ Error Handling > Error Inheritance > should maintain instanceof relationships
   â†“ Error Handling > Error Inheritance > should have correct error names
stdout | tests/auth-utils.test.js
[dotenv@17.2.3] injecting env (0) from .env.local -- tip: ğŸ”‘ add access controls to secrets: https://dotenvx.com/ops

stdout | tests/auth-utils.test.js

ğŸ§ª Setting up test environment...

stderr | tests/auth-utils.test.js
âŒ Failed to set up test environment: Error: connect ECONNREFUSED 127.0.0.1:5432
[90m    at TCPConnectWrap.afterConnect [as oncomplete] (node:net:1555:16)[39m {
  errno: [33m-111[39m,
  code: [32m'ECONNREFUSED'[39m,
  syscall: [32m'connect'[39m,
  address: [32m'127.0.0.1'[39m,
  port: [33m5432[39m
}
ğŸ’¡ Ensure PostgreSQL is running on 127.0.0.1:5432
ğŸ’¡ Or set TEST_DATABASE_URL to your test database

stdout | tests/auth-utils.test.js

ğŸ§¹ Tearing down test environment...
âœ“ Test environment cleaned up


 â¯ tests/auth-utils.test.js (22 tests | 22 skipped) 7ms
   â†“ Authentication Utilities > validatePassword > should accept a valid password
   â†“ Authentication Utilities > validatePassword > should reject password shorter than 8 characters
   â†“ Authentication Utilities > validatePassword > should reject password without uppercase letter
   â†“ Authentication Utilities > validatePassword > should reject password without lowercase letter
   â†“ Authentication Utilities > validatePassword > should reject password without number
   â†“ Authentication Utilities > validatePassword > should reject password without special character
   â†“ Authentication Utilities > validatePassword > should reject null or undefined password
   â†“ Authentication Utilities > validatePassword > should accept password with all requirements
   â†“ Authentication Utilities > validatePassword > should return multiple errors for invalid password
   â†“ Authentication Utilities > validateEmail > should accept valid email addresses
   â†“ Authentication Utilities > validateEmail > should reject invalid email addresses
   â†“ Authentication Utilities > validateEmail > should handle edge cases
   â†“ Authentication Utilities > hashPassword and verifyPassword > should hash a password
   â†“ Authentication Utilities > hashPassword and verifyPassword > should produce different hashes for same password
   â†“ Authentication Utilities > hashPassword and verifyPassword > should verify correct password
   â†“ Authentication Utilities > hashPassword and verifyPassword > should reject incorrect password
   â†“ Authentication Utilities > hashPassword and verifyPassword > should handle empty passwords
   â†“ Authentication Utilities > hashPassword and verifyPassword > should be case sensitive
   â†“ Authentication Utilities > hashPassword and verifyPassword > should handle long passwords
   â†“ Authentication Utilities > AUTH_CONFIG > should have valid configuration values
   â†“ Authentication Utilities > AUTH_CONFIG > should have password requirements defined
   â†“ Authentication Utilities > AUTH_CONFIG > should have rate limit configuration
stdout | tests/metadata-handlers.test.js
[dotenv@17.2.3] injecting env (0) from .env.local -- tip: ğŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

stdout | tests/metadata-handlers.test.js

ğŸ§ª Setting up test environment...

stderr | tests/metadata-handlers.test.js
âŒ Failed to set up test environment: Error: connect ECONNREFUSED 127.0.0.1:5432
[90m    at TCPConnectWrap.afterConnect [as oncomplete] (node:net:1555:16)[39m {
  errno: [33m-111[39m,
  code: [32m'ECONNREFUSED'[39m,
  syscall: [32m'connect'[39m,
  address: [32m'127.0.0.1'[39m,
  port: [33m5432[39m
}
ğŸ’¡ Ensure PostgreSQL is running on 127.0.0.1:5432
ğŸ’¡ Or set TEST_DATABASE_URL to your test database

stdout | tests/metadata-handlers.test.js

ğŸ§¹ Tearing down test environment...
âœ“ Test environment cleaned up


 â¯ tests/metadata-handlers.test.js (21 tests | 21 skipped) 7ms
   â†“ Enhanced Metadata Handlers > Genre Validation > should validate word count for romance novel
   â†“ Enhanced Metadata Handlers > Genre Validation > should flag word count outside genre norms
   â†“ Enhanced Metadata Handlers > Genre Validation > should accept novella word counts for appropriate genres
   â†“ Enhanced Metadata Handlers > Content Warning Validation > should validate content warning categories
   â†“ Enhanced Metadata Handlers > Content Warning Validation > should validate severity levels
   â†“ Enhanced Metadata Handlers > Content Warning Validation > should handle multiple content warnings
   â†“ Enhanced Metadata Handlers > Metadata Structure > should validate primary genre and subgenres
   â†“ Enhanced Metadata Handlers > Metadata Structure > should validate age category
   â†“ Enhanced Metadata Handlers > Metadata Structure > should validate manuscript status
   â†“ Enhanced Metadata Handlers > Metadata Structure > should validate series information
   â†“ Enhanced Metadata Handlers > Metadata History Tracking > should record metadata changes with timestamp
   â†“ Enhanced Metadata Handlers > Metadata History Tracking > should track multiple change types
   â†“ Enhanced Metadata Handlers > Genre Hierarchy > should validate parent-child genre relationships
   â†“ Enhanced Metadata Handlers > Genre Hierarchy > should handle subgenre depth
   â†“ Enhanced Metadata Handlers > Word Count Validation Logic > should categorize flash fiction correctly
   â†“ Enhanced Metadata Handlers > Word Count Validation Logic > should categorize novel correctly
   â†“ Enhanced Metadata Handlers > Word Count Validation Logic > should categorize epic correctly
   â†“ Enhanced Metadata Handlers > Edge Cases > should handle missing optional metadata fields
   â†“ Enhanced Metadata Handlers > Edge Cases > should handle empty subgenres array
   â†“ Enhanced Metadata Handlers > Edge Cases > should validate completion percentage range
   â†“ Enhanced Metadata Handlers > Edge Cases > should reject invalid completion percentage
stdout | tests/integration/infrastructure.test.js
[dotenv@17.2.3] injecting env (0) from .env.local -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

stdout | tests/integration/infrastructure.test.js

ğŸ§ª Setting up test environment...

stderr | tests/integration/infrastructure.test.js
âŒ Failed to set up test environment: Error: connect ECONNREFUSED 127.0.0.1:5432
[90m    at TCPConnectWrap.afterConnect [as oncomplete] (node:net:1555:16)[39m {
  errno: [33m-111[39m,
  code: [32m'ECONNREFUSED'[39m,
  syscall: [32m'connect'[39m,
  address: [32m'127.0.0.1'[39m,
  port: [33m5432[39m
}
ğŸ’¡ Ensure PostgreSQL is running on 127.0.0.1:5432
ğŸ’¡ Or set TEST_DATABASE_URL to your test database

stdout | tests/integration/infrastructure.test.js

ğŸ§¹ Tearing down test environment...
âœ“ Test environment cleaned up


 â¯ tests/integration/infrastructure.test.js (13 tests | 13 skipped) 8ms
   â†“ Test Infrastructure > Database Utilities > should insert and retrieve test records
   â†“ Test Infrastructure > Database Utilities > should count test records
   â†“ Test Infrastructure > Database Utilities > should reset database between tests
   â†“ Test Infrastructure > API Client > should make HTTP requests
   â†“ Test Infrastructure > Mock Factories > should create mock Redis client
   â†“ Test Infrastructure > Mock Factories > should create mock Redis client with expiration
   â†“ Test Infrastructure > Mock Factories > should create mock storage adapter
   â†“ Test Infrastructure > Test Data Factories > should create test user data
   â†“ Test Infrastructure > Test Data Factories > should create test user with overrides
   â†“ Test Infrastructure > Test Data Factories > should create test manuscript data
   â†“ Test Infrastructure > Test Data Factories > should generate unique test emails
   â†“ Test Infrastructure > Integration: Factories + Database > should insert factory-generated user into database
   â†“ Test Infrastructure > Integration: Factories + Database > should insert factory-generated manuscript into database
stdout | tests/integration/webhook-signature-verification.test.js
[dotenv@17.2.3] injecting env (0) from .env.local -- tip: ğŸ“¡ add observability to secrets: https://dotenvx.com/ops

stdout | tests/integration/webhook-signature-verification.test.js

ğŸ§ª Setting up test environment...

stderr | tests/integration/webhook-signature-verification.test.js
âŒ Failed to set up test environment: Error: connect ECONNREFUSED 127.0.0.1:5432
[90m    at TCPConnectWrap.afterConnect [as oncomplete] (node:net:1555:16)[39m {
  errno: [33m-111[39m,
  code: [32m'ECONNREFUSED'[39m,
  syscall: [32m'connect'[39m,
  address: [32m'127.0.0.1'[39m,
  port: [33m5432[39m
}
ğŸ’¡ Ensure PostgreSQL is running on 127.0.0.1:5432
ğŸ’¡ Or set TEST_DATABASE_URL to your test database

stdout | tests/integration/webhook-signature-verification.test.js

ğŸ§¹ Tearing down test environment...
âœ“ Test environment cleaned up


 â¯ tests/integration/webhook-signature-verification.test.js (9 tests | 9 skipped) 7ms
   â†“ Webhook Signature Verification > Valid Signatures > should accept webhook with valid signature
   â†“ Webhook Signature Verification > Valid Signatures > should accept webhook with recent timestamp (within 5 min)
   â†“ Webhook Signature Verification > Missing Signature > should reject webhook with no signature header
   â†“ Webhook Signature Verification > Missing Signature > should reject webhook with empty signature
   â†“ Webhook Signature Verification > Invalid Signatures > should reject webhook with incorrect signature
   â†“ Webhook Signature Verification > Invalid Signatures > should reject webhook with malformed signature format
   â†“ Webhook Signature Verification > Invalid Signatures > should reject webhook with tampered payload
   â†“ Webhook Signature Verification > Replay Attack Prevention > should reject webhook with expired timestamp (>5 min old)
   â†“ Webhook Signature Verification > Replay Attack Prevention > should accept webhook with future timestamp (Stripe allows clock skew)

â¯â¯â¯â¯â¯â¯ Failed Suites 10 â¯â¯â¯â¯â¯â¯

 FAIL  tests/auth-utils.test.js [ tests/auth-utils.test.js ]
 FAIL  tests/document-generation.test.js [ tests/document-generation.test.js ]
 FAIL  tests/error-handling.test.js [ tests/error-handling.test.js ]
 FAIL  tests/metadata-handlers.test.js [ tests/metadata-handlers.test.js ]
 FAIL  tests/submission-packages.test.js [ tests/submission-packages.test.js ]
 FAIL  tests/integration/infrastructure.test.js [ tests/integration/infrastructure.test.js ]
 FAIL  tests/integration/webhook-signature-verification.test.js [ tests/integration/webhook-signature-verification.test.js ]
 FAIL  tests/unit/test-helpers.test.js [ tests/unit/test-helpers.test.js ]
 FAIL  tests/integration/handlers/auth-handlers.test.js [ tests/integration/handlers/auth-handlers.test.js ]
 FAIL  tests/integration/handlers/payment-handlers.test.js [ tests/integration/handlers/payment-handlers.test.js ]
Error: connect ECONNREFUSED 127.0.0.1:5432
â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/10]â¯


 Test Files  10 failed (10)
      Tests  278 skipped (278)
   Start at  16:46:55
   Duration  227.32s (transform 2.11s, setup 205.88s, collect 3.22s, tests 79ms, environment 2ms, prepare 8.56s)



> manuscript-upload-api@1.0.0 test
> vitest run


[1m[46m RUN [49m[22m [36mv3.2.4 [39m[90mD:/manuscript-platform[39m

[90mstdout[2m | tests/integration/handlers/payment-handlers.test.js
[22m[39m[dotenv@17.2.3] injecting env (0) from .env.local -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
Initializing adapters...

[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js
[22m[39mFailed to initialize adapters: Error: DATABASE_URL environment variable is required
    at createDatabaseAdapter [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:214:11[90m)[39m
    at initializeAdapters [90m(D:\manuscript-platform\[39mserver.js:68:16[90m)[39m
    at start [90m(D:\manuscript-platform\[39mserver.js:306:5[90m)[39m
    at [90mD:\manuscript-platform\[39mserver.js:320:3
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at VitestExecutor.runModule [90m(file:///D:/manuscript-platform/[39mnode_modules/[4mvite-node[24m/dist/client.mjs:397:4[90m)[39m
    at VitestExecutor.directRequest [90m(file:///D:/manuscript-platform/[39mnode_modules/[4mvite-node[24m/dist/client.mjs:375:3[90m)[39m
    at VitestExecutor.cachedRequest [90m(file:///D:/manuscript-platform/[39mnode_modules/[4mvite-node[24m/dist/client.mjs:189:11[90m)[39m
    at VitestExecutor.dependencyRequest [90m(file:///D:/manuscript-platform/[39mnode_modules/[4mvite-node[24m/dist/client.mjs:239:10[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\test-helpers\api-client.js:12:1
    at VitestExecutor.runModule [90m(file:///D:/manuscript-platform/[39mnode_modules/[4mvite-node[24m/dist/client.mjs:397:4[90m)[39m
    at VitestExecutor.directRequest [90m(file:///D:/manuscript-platform/[39mnode_modules/[4mvite-node[24m/dist/client.mjs:375:3[90m)[39m
    at VitestExecutor.cachedRequest [90m(file:///D:/manuscript-platform/[39mnode_modules/[4mvite-node[24m/dist/client.mjs:189:11[90m)[39m
    at VitestExecutor.dependencyRequest [90m(file:///D:/manuscript-platform/[39mnode_modules/[4mvite-node[24m/dist/client.mjs:239:10[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\payment-handlers.test.js:19:1
    at VitestExecutor.runModule [90m(file:///D:/manuscript-platform/[39mnode_modules/[4mvite-node[24m/dist/client.mjs:397:4[90m)[39m

[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js
[22m[39mFailed to initialize adapters: Error: DATABASE_URL environment variable is required
    at createDatabaseAdapter [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:214:11[90m)[39m
    at initializeAdapters [90m(D:\manuscript-platform\[39mserver.js:68:16[90m)[39m
    at start [90m(D:\manuscript-platform\[39mserver.js:306:5[90m)[39m
    at [90mD:\manuscript-platform\[39mserver.js:320:3
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at VitestExecutor.runModule [90m(file:///D:/manuscript-platform/[39mnode_modules/[4mvite-node[24m/dist/client.mjs:397:4[90m)[39m
    at VitestExecutor.directRequest [90m(file:///D:/manuscript-platform/[39mnode_modules/[4mvite-node[24m/dist/client.mjs:375:3[90m)[39m
    at VitestExecutor.cachedRequest [90m(file:///D:/manuscript-platform/[39mnode_modules/[4mvite-node[24m/dist/client.mjs:189:11[90m)[39m
    at VitestExecutor.dependencyRequest [90m(file:///D:/manuscript-platform/[39mnode_modules/[4mvite-node[24m/dist/client.mjs:239:10[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\test-helpers\api-client.js:12:1
    at VitestExecutor.runModule [90m(file:///D:/manuscript-platform/[39mnode_modules/[4mvite-node[24m/dist/client.mjs:397:4[90m)[39m
    at VitestExecutor.directRequest [90m(file:///D:/manuscript-platform/[39mnode_modules/[4mvite-node[24m/dist/client.mjs:375:3[90m)[39m
    at VitestExecutor.cachedRequest [90m(file:///D:/manuscript-platform/[39mnode_modules/[4mvite-node[24m/dist/client.mjs:189:11[90m)[39m
    at VitestExecutor.dependencyRequest [90m(file:///D:/manuscript-platform/[39mnode_modules/[4mvite-node[24m/dist/client.mjs:239:10[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\payment-handlers.test.js:19:1
    at VitestExecutor.runModule [90m(file:///D:/manuscript-platform/[39mnode_modules/[4mvite-node[24m/dist/client.mjs:397:4[90m)[39m
Server will continue running but API requests will fail until adapters are ready

[90mstdout[2m | tests/integration/handlers/payment-handlers.test.js
[22m[39m
âœ“ Server running on port 3000
âœ“ Environment: development
âœ“ Health check: http://localhost:3000/health
â³ Initializing adapters...


[90mstdout[2m | tests/integration/handlers/payment-handlers.test.js
[22m[39m
ðŸ§ª Setting up test environment...

[90mstdout[2m | tests/integration/handlers/payment-handlers.test.js
[22m[39mâœ“ Test database connected

[90mstdout[2m | tests/integration/handlers/payment-handlers.test.js
[22m[39m  Applying base schema...

[90mstdout[2m | tests/integration/handlers/payment-handlers.test.js
[22m[39m  âœ“ Schema and migrations applied

[90mstdout[2m | tests/integration/handlers/payment-handlers.test.js
[22m[39mâœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

[90mstdout[2m | tests/integration/handlers/payment-handlers.test.js
[22m[39mâœ“ Test database initialized
âœ“ Test environment ready


[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /create-checkout-session[2m > [22m[2mshould include userId in session metadata
[22m[39mNo tables found to reset

[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /create-checkout-session[2m > [22m[2mshould handle missing priceId field
[22m[39mNo tables found to reset

[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /create-checkout-session[2m > [22m[2mshould handle missing planType field
[22m[39mNo tables found to reset

[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /create-checkout-session[2m > [22m[2mshould create customer if not exists
[22m[39mNo tables found to reset

[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /create-checkout-session[2m > [22m[2mshould set correct success and cancel URLs
[22m[39mNo tables found to reset

[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /create-checkout-session[2m > [22m[2mshould handle Stripe API errors gracefully
[22m[39mNo tables found to reset

[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /create-checkout-session[2m > [22m[2mshould log checkout session creation
[22m[39mNo tables found to reset

[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Signature Verification[2m > [22m[2mshould accept webhook with valid signature
[22m[39mNo tables found to reset

[0mPOST /webhooks/stripe [31m503[0m 15.468 ms - 46[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Signature Verification[2m > [22m[2mshould reject webhook with invalid signature
[22m[39mNo tables found to reset

[0mPOST /webhooks/stripe [31m503[0m 0.603 ms - 46[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Signature Verification[2m > [22m[2mshould reject webhook with missing signature
[22m[39mNo tables found to reset

[0mPOST /webhooks/stripe [31m503[0m 0.532 ms - 46[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Signature Verification[2m > [22m[2mshould reject webhook with expired signature (>5 minutes)
[22m[39mNo tables found to reset

[0mPOST /webhooks/stripe [31m503[0m 0.370 ms - 46[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Signature Verification[2m > [22m[2mshould reject replay attacks (duplicate event ID)
[22m[39mNo tables found to reset

[0mPOST /webhooks/stripe [31m503[0m 1.529 ms - 46[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Signature Verification[2m > [22m[2mshould handle malformed signature header
[22m[39mNo tables found to reset

[0mPOST /webhooks/stripe [31m503[0m 0.595 ms - 46[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Signature Verification[2m > [22m[2mshould log signature verification failures
[22m[39mNo tables found to reset

[0mPOST /webhooks/stripe [31m503[0m 0.392 ms - 46[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Signature Verification[2m > [22m[2mshould return 400 for invalid signatures (not 500)
[22m[39mNo tables found to reset

[0mPOST /webhooks/stripe [31m503[0m 0.272 ms - 46[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Event Handling[2m > [22m[2mshould handle checkout.session.completed - activate subscription
[22m[39mNo tables found to reset

[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Event Handling[2m > [22m[2mshould handle checkout.session.completed - record payment
[22m[39mNo tables found to reset

[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Event Handling[2m > [22m[2mshould handle customer.subscription.updated - sync status
[22m[39mNo tables found to reset

[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Event Handling[2m > [22m[2mshould handle customer.subscription.deleted - downgrade to free
[22m[39mNo tables found to reset

[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Event Handling[2m > [22m[2mshould handle customer.subscription.deleted - preserve data
[22m[39mNo tables found to reset

[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Event Handling[2m > [22m[2mshould handle invoice.payment_succeeded - record payment
[22m[39mNo tables found to reset

[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Event Handling[2m > [22m[2mshould handle invoice.payment_succeeded - extend billing period
[22m[39mNo tables found to reset

[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Event Handling[2m > [22m[2mshould handle invoice.payment_failed - mark past_due
[22m[39mNo tables found to reset

[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Event Handling[2m > [22m[2mshould handle invoice.payment_failed - cancel after 3 failures
[22m[39mNo tables found to reset

[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Event Handling[2m > [22m[2mshould ignore unhandled event types
[22m[39mNo tables found to reset

[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Event Handling[2m > [22m[2mshould handle duplicate webhook deliveries (idempotent)
[22m[39mNo tables found to reset

[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Event Handling[2m > [22m[2mshould handle webhook for deleted user gracefully
[22m[39mNo tables found to reset

[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Event Handling[2m > [22m[2mshould handle malformed webhook data gracefully
[22m[39mNo tables found to reset

[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Event Handling[2m > [22m[2mshould log all webhook events
[22m[39mNo tables found to reset

[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Event Handling[2m > [22m[2mshould return 200 for all webhooks (even errors)
[22m[39mNo tables found to reset

[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Event Handling[2m > [22m[2mshould process webhook in under 5 seconds
[22m[39mNo tables found to reset

[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mGET /subscription[2m > [22m[2mshould return current subscription details
[22m[39mNo tables found to reset

[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mGET /subscription[2m > [22m[2mshould require authentication
[22m[39mNo tables found to reset

[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mGET /subscription[2m > [22m[2mshould return free plan for users without subscription
[22m[39mNo tables found to reset

[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mGET /subscription[2m > [22m[2mshould include Stripe subscription ID
[22m[39mNo tables found to reset

[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mGET /subscription[2m > [22m[2mshould include current period dates
[22m[39mNo tables found to reset

[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mGET /payment-history[2m > [22m[2mshould return payment history for user
[22m[39mNo tables found to reset

[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mGET /payment-history[2m > [22m[2mshould require authentication
[22m[39mNo tables found to reset

[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mGET /payment-history[2m > [22m[2mshould return empty array for no payments
[22m[39mNo tables found to reset

[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mGET /payment-history[2m > [22m[2mshould order payments by date (newest first)
[22m[39mNo tables found to reset

[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mGET /payment-history[2m > [22m[2mshould not include other users payments
[22m[39mNo tables found to reset

[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mUsage Tracking[2m > [22m[2mshould track manuscript analysis usage
[22m[39mNo tables found to reset

[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mUsage Tracking[2m > [22m[2mshould track different analysis types
[22m[39mNo tables found to reset

[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mUsage Tracking[2m > [22m[2mshould track asset generation separately
[22m[39mNo tables found to reset

[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mUsage Tracking[2m > [22m[2mshould calculate usage within billing period
[22m[39mNo tables found to reset

[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mUsage Tracking[2m > [22m[2mshould separate usage across different billing periods
[22m[39mNo tables found to reset

[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mUsage Tracking[2m > [22m[2mshould track usage for users without subscription (pay-per-use)
[22m[39mNo tables found to reset

[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mUsage Tracking[2m > [22m[2mshould link usage to specific manuscript
[22m[39mNo tables found to reset

[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mUsage Tracking[2m > [22m[2mshould accumulate credits across multiple analyses
[22m[39mNo tables found to reset

[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mUsage Tracking[2m > [22m[2mshould track timestamp for usage analytics
[22m[39mNo tables found to reset

[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mUsage Tracking[2m > [22m[2mshould delete usage records when manuscript is deleted (CASCADE)
[22m[39mNo tables found to reset

[90mstdout[2m | tests/integration/handlers/payment-handlers.test.js
[22m[39m
ðŸ§¹ Tearing down test environment...

[90mstdout[2m | tests/integration/handlers/payment-handlers.test.js
[22m[39mâœ“ Test database cleaned

[90mstdout[2m | tests/integration/handlers/payment-handlers.test.js
[22m[39mâœ“ Database adapter closed

[90mstdout[2m | tests/integration/handlers/payment-handlers.test.js
[22m[39mâœ“ Test database disconnected

[90mstdout[2m | tests/integration/handlers/payment-handlers.test.js
[22m[39mâœ“ Test database cleaned up
âœ“ Test environment cleaned up


 [31mâ¯[39m tests/integration/handlers/payment-handlers.test.js [2m([22m[2m54 tests[22m[2m | [22m[31m54 failed[39m[2m)[22m[33m 26452[2mms[22m[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /create-checkout-session[2m > [22mshould create checkout session for valid subscription[39m[33m 5055[2mms[22m[39m
[31m     â†’ invalid input syntax for type integer: "true"[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /create-checkout-session[2m > [22mshould require authentication for checkout[39m[33m 3349[2mms[22m[39m
[31m     â†’ invalid input syntax for type integer: "true"[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /create-checkout-session[2m > [22mshould reject invalid price IDs[39m[33m 2883[2mms[22m[39m
[31m     â†’ relation "users" does not exist[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /create-checkout-session[2m > [22mshould include userId in session metadata[39m[32m 73[2mms[22m[39m
[31m     â†’ relation "users" does not exist[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /create-checkout-session[2m > [22mshould handle missing priceId field[39m[32m 75[2mms[22m[39m
[31m     â†’ relation "users" does not exist[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /create-checkout-session[2m > [22mshould handle missing planType field[39m[32m 70[2mms[22m[39m
[31m     â†’ relation "users" does not exist[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /create-checkout-session[2m > [22mshould create customer if not exists[39m[32m 71[2mms[22m[39m
[31m     â†’ relation "users" does not exist[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /create-checkout-session[2m > [22mshould set correct success and cancel URLs[39m[32m 84[2mms[22m[39m
[31m     â†’ relation "users" does not exist[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /create-checkout-session[2m > [22mshould handle Stripe API errors gracefully[39m[32m 77[2mms[22m[39m
[31m     â†’ relation "users" does not exist[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /create-checkout-session[2m > [22mshould log checkout session creation[39m[32m 76[2mms[22m[39m
[31m     â†’ relation "users" does not exist[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Signature Verification[2m > [22mshould accept webhook with valid signature[39m[32m 37[2mms[22m[39m
[31m     â†’ expected [ 200, 404 ] to include 503[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Signature Verification[2m > [22mshould reject webhook with invalid signature[39m[32m 6[2mms[22m[39m
[31m     â†’ expected [ 400, 404 ] to include 503[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Signature Verification[2m > [22mshould reject webhook with missing signature[39m[32m 6[2mms[22m[39m
[31m     â†’ expected [ 400, 404 ] to include 503[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Signature Verification[2m > [22mshould reject webhook with expired signature (>5 minutes)[39m[32m 5[2mms[22m[39m
[31m     â†’ expected [ 400, 404 ] to include 503[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Signature Verification[2m > [22mshould reject replay attacks (duplicate event ID)[39m[32m 7[2mms[22m[39m
[31m     â†’ expected [ 200, 404 ] to include 503[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Signature Verification[2m > [22mshould handle malformed signature header[39m[32m 6[2mms[22m[39m
[31m     â†’ expected [ 400, 404 ] to include 503[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Signature Verification[2m > [22mshould log signature verification failures[39m[32m 6[2mms[22m[39m
[31m     â†’ relation "audit_log" does not exist[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Signature Verification[2m > [22mshould return 400 for invalid signatures (not 500)[39m[32m 5[2mms[22m[39m
[31m     â†’ expected [ 400, 404 ] to include 503[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle checkout.session.completed - activate subscription[39m[32m 61[2mms[22m[39m
[31m     â†’ relation "users" does not exist[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle checkout.session.completed - record payment[39m[32m 59[2mms[22m[39m
[31m     â†’ relation "users" does not exist[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle customer.subscription.updated - sync status[39m[32m 63[2mms[22m[39m
[31m     â†’ relation "users" does not exist[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle customer.subscription.deleted - downgrade to free[39m[32m 59[2mms[22m[39m
[31m     â†’ relation "users" does not exist[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle customer.subscription.deleted - preserve data[39m[32m 58[2mms[22m[39m
[31m     â†’ relation "users" does not exist[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle invoice.payment_succeeded - record payment[39m[32m 60[2mms[22m[39m
[31m     â†’ relation "users" does not exist[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle invoice.payment_succeeded - extend billing period[39m[32m 58[2mms[22m[39m
[31m     â†’ relation "users" does not exist[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle invoice.payment_failed - mark past_due[39m[32m 57[2mms[22m[39m
[31m     â†’ relation "users" does not exist[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle invoice.payment_failed - cancel after 3 failures[39m[32m 59[2mms[22m[39m
[31m     â†’ relation "users" does not exist[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould ignore unhandled event types[39m[32m 61[2mms[22m[39m
[31m     â†’ relation "users" does not exist[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle duplicate webhook deliveries (idempotent)[39m[32m 65[2mms[22m[39m
[31m     â†’ relation "users" does not exist[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle webhook for deleted user gracefully[39m[32m 76[2mms[22m[39m
[31m     â†’ relation "users" does not exist[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle malformed webhook data gracefully[39m[32m 89[2mms[22m[39m
[31m     â†’ relation "users" does not exist[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould log all webhook events[39m[32m 80[2mms[22m[39m
[31m     â†’ relation "users" does not exist[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould return 200 for all webhooks (even errors)[39m[32m 95[2mms[22m[39m
[31m     â†’ relation "users" does not exist[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould process webhook in under 5 seconds[39m[32m 79[2mms[22m[39m
[31m     â†’ relation "users" does not exist[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mGET /subscription[2m > [22mshould return current subscription details[39m[32m 61[2mms[22m[39m
[31m     â†’ relation "users" does not exist[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mGET /subscription[2m > [22mshould require authentication[39m[32m 57[2mms[22m[39m
[31m     â†’ relation "users" does not exist[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mGET /subscription[2m > [22mshould return free plan for users without subscription[39m[32m 60[2mms[22m[39m
[31m     â†’ relation "users" does not exist[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mGET /subscription[2m > [22mshould include Stripe subscription ID[39m[32m 61[2mms[22m[39m
[31m     â†’ relation "users" does not exist[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mGET /subscription[2m > [22mshould include current period dates[39m[32m 61[2mms[22m[39m
[31m     â†’ relation "users" does not exist[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mGET /payment-history[2m > [22mshould return payment history for user[39m[32m 57[2mms[22m[39m
[31m     â†’ relation "users" does not exist[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mGET /payment-history[2m > [22mshould require authentication[39m[32m 57[2mms[22m[39m
[31m     â†’ relation "users" does not exist[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mGET /payment-history[2m > [22mshould return empty array for no payments[39m[32m 59[2mms[22m[39m
[31m     â†’ relation "users" does not exist[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mGET /payment-history[2m > [22mshould order payments by date (newest first)[39m[32m 59[2mms[22m[39m
[31m     â†’ relation "users" does not exist[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mGET /payment-history[2m > [22mshould not include other users payments[39m[32m 57[2mms[22m[39m
[31m     â†’ relation "users" does not exist[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould track manuscript analysis usage[39m[32m 58[2mms[22m[39m
[31m     â†’ relation "users" does not exist[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould track different analysis types[39m[32m 66[2mms[22m[39m
[31m     â†’ relation "users" does not exist[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould track asset generation separately[39m[32m 85[2mms[22m[39m
[31m     â†’ relation "users" does not exist[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould calculate usage within billing period[39m[32m 76[2mms[22m[39m
[31m     â†’ relation "users" does not exist[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould separate usage across different billing periods[39m[32m 88[2mms[22m[39m
[31m     â†’ relation "users" does not exist[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould track usage for users without subscription (pay-per-use)[39m[32m 70[2mms[22m[39m
[31m     â†’ relation "users" does not exist[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould link usage to specific manuscript[39m[32m 60[2mms[22m[39m
[31m     â†’ relation "users" does not exist[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould accumulate credits across multiple analyses[39m[32m 58[2mms[22m[39m
[31m     â†’ relation "users" does not exist[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould track timestamp for usage analytics[39m[32m 58[2mms[22m[39m
[31m     â†’ relation "users" does not exist[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould delete usage records when manuscript is deleted (CASCADE)[39m[32m 59[2mms[22m[39m
[31m     â†’ relation "users" does not exist[39m
[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js
[22m[39m
ðŸ§ª Setting up test environment...

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js
[22m[39mâœ“ Test database connected

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js
[22m[39m  Applying base schema...

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js
[22m[39m  âœ“ Schema and migrations applied

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js
[22m[39mâœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js
[22m[39mâœ“ Test database initialized
âœ“ Test environment ready


[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/register[2m > [22m[2mshould register a new user with valid credentials
[22m[39mDatabase query error: error: null value in column "updated_at" of relation "users" violates not-null constraint
    at [90mD:\manuscript-platform\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at PreparedStatement._executeQuery [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:163:20[90m)[39m
    at Module.handleRegister [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:157:5[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:65:22
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20 {
  length: [33m394[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'23502'[39m,
  detail: [32m'Failing row contains (6123c7ab-9dee-40e3-b1a8-0da7f9d00ced, newuser@example.com, $2b$12$MRWbw.6VDqCamA27ky/6Vu4Q2YK8sBOLS5uzFkB/LxOsmpMVHev.i, null, author, FREE, 1762722772, null, null, 0, null, null, null, null, null).'[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [32m'public'[39m,
  table: [32m'users'[39m,
  column: [32m'updated_at'[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'execMain.c'[39m,
  line: [32m'1993'[39m,
  routine: [32m'ExecConstraints'[39m
}
Query: 
      INSERT INTO users (id, email, password_hash, role, created_at, email_verified)
      VALUES ($1, $2, $3, $4, $5, 0)
    
Params: [
  [32m'6123c7ab-9dee-40e3-b1a8-0da7f9d00ced'[39m,
  [32m'newuser@example.com'[39m,
  [32m'$2b$12$MRWbw.6VDqCamA27ky/6Vu4Q2YK8sBOLS5uzFkB/LxOsmpMVHev.i'[39m,
  [32m'author'[39m,
  [33m1762722772[39m
]

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/register[2m > [22m[2mshould register a new user with valid credentials
[22m[39mRegistration error: error: null value in column "updated_at" of relation "users" violates not-null constraint
    at [90mD:\manuscript-platform\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at PreparedStatement._executeQuery [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:163:20[90m)[39m
    at Module.handleRegister [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:157:5[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:65:22
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20 {
  length: [33m394[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'23502'[39m,
  detail: [32m'Failing row contains (6123c7ab-9dee-40e3-b1a8-0da7f9d00ced, newuser@example.com, $2b$12$MRWbw.6VDqCamA27ky/6Vu4Q2YK8sBOLS5uzFkB/LxOsmpMVHev.i, null, author, FREE, 1762722772, null, null, 0, null, null, null, null, null).'[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [32m'public'[39m,
  table: [32m'users'[39m,
  column: [32m'updated_at'[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'execMain.c'[39m,
  line: [32m'1993'[39m,
  routine: [32m'ExecConstraints'[39m
}

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/register[2m > [22m[2mshould reject registration with duplicate email
[22m[39mDatabase query error: error: null value in column "updated_at" of relation "users" violates not-null constraint
    at [90mD:\manuscript-platform\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at PreparedStatement._executeQuery [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:163:20[90m)[39m
    at Module.handleRegister [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:157:5[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:133:22
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20 {
  length: [33m396[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'23502'[39m,
  detail: [32m'Failing row contains (f7c84437-8155-47bc-8739-2c001034acef, duplicate@example.com, $2b$12$GwvuoQ.TVLwJPvdMTLueoODVEhfFN0j0opeTIX25GefnQEUSG9apW, null, author, FREE, 1762722778, null, null, 0, null, null, null, null, null).'[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [32m'public'[39m,
  table: [32m'users'[39m,
  column: [32m'updated_at'[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'execMain.c'[39m,
  line: [32m'1993'[39m,
  routine: [32m'ExecConstraints'[39m
}
Query: 
      INSERT INTO users (id, email, password_hash, role, created_at, email_verified)
      VALUES ($1, $2, $3, $4, $5, 0)
    
Params: [
  [32m'f7c84437-8155-47bc-8739-2c001034acef'[39m,
  [32m'duplicate@example.com'[39m,
  [32m'$2b$12$GwvuoQ.TVLwJPvdMTLueoODVEhfFN0j0opeTIX25GefnQEUSG9apW'[39m,
  [32m'author'[39m,
  [33m1762722778[39m
]

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/register[2m > [22m[2mshould reject registration with duplicate email
[22m[39mRegistration error: error: null value in column "updated_at" of relation "users" violates not-null constraint
    at [90mD:\manuscript-platform\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at PreparedStatement._executeQuery [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:163:20[90m)[39m
    at Module.handleRegister [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:157:5[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:133:22
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20 {
  length: [33m396[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'23502'[39m,
  detail: [32m'Failing row contains (f7c84437-8155-47bc-8739-2c001034acef, duplicate@example.com, $2b$12$GwvuoQ.TVLwJPvdMTLueoODVEhfFN0j0opeTIX25GefnQEUSG9apW, null, author, FREE, 1762722778, null, null, 0, null, null, null, null, null).'[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [32m'public'[39m,
  table: [32m'users'[39m,
  column: [32m'updated_at'[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'execMain.c'[39m,
  line: [32m'1993'[39m,
  routine: [32m'ExecConstraints'[39m
}

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/register[2m > [22m[2mshould hash password with bcrypt
[22m[39mDatabase query error: error: null value in column "updated_at" of relation "users" violates not-null constraint
    at [90mD:\manuscript-platform\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at PreparedStatement._executeQuery [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:163:20[90m)[39m
    at Module.handleRegister [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:157:5[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:150:5
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20 {
  length: [33m398[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'23502'[39m,
  detail: [32m'Failing row contains (8489b4bf-2ba5-4c2f-ab71-ac9c137dc336, bcrypt-test@example.com, $2b$12$Yql52Bd5LPKiBCeFT8gA4u7MrcEr6LM4FNVwDGEwUQwIGh5qxn07i, null, author, FREE, 1762722781, null, null, 0, null, null, null, null, null).'[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [32m'public'[39m,
  table: [32m'users'[39m,
  column: [32m'updated_at'[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'execMain.c'[39m,
  line: [32m'1993'[39m,
  routine: [32m'ExecConstraints'[39m
}
Query: 
      INSERT INTO users (id, email, password_hash, role, created_at, email_verified)
      VALUES ($1, $2, $3, $4, $5, 0)
    
Params: [
  [32m'8489b4bf-2ba5-4c2f-ab71-ac9c137dc336'[39m,
  [32m'bcrypt-test@example.com'[39m,
  [32m'$2b$12$Yql52Bd5LPKiBCeFT8gA4u7MrcEr6LM4FNVwDGEwUQwIGh5qxn07i'[39m,
  [32m'author'[39m,
  [33m1762722781[39m
]

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/register[2m > [22m[2mshould hash password with bcrypt
[22m[39mRegistration error: error: null value in column "updated_at" of relation "users" violates not-null constraint
    at [90mD:\manuscript-platform\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at PreparedStatement._executeQuery [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:163:20[90m)[39m
    at Module.handleRegister [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:157:5[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:150:5
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20 {
  length: [33m398[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'23502'[39m,
  detail: [32m'Failing row contains (8489b4bf-2ba5-4c2f-ab71-ac9c137dc336, bcrypt-test@example.com, $2b$12$Yql52Bd5LPKiBCeFT8gA4u7MrcEr6LM4FNVwDGEwUQwIGh5qxn07i, null, author, FREE, 1762722781, null, null, 0, null, null, null, null, null).'[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [32m'public'[39m,
  table: [32m'users'[39m,
  column: [32m'updated_at'[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'execMain.c'[39m,
  line: [32m'1993'[39m,
  routine: [32m'ExecConstraints'[39m
}

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/register[2m > [22m[2mshould normalize email to lowercase
[22m[39mDatabase query error: error: null value in column "updated_at" of relation "users" violates not-null constraint
    at [90mD:\manuscript-platform\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at PreparedStatement._executeQuery [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:163:20[90m)[39m
    at Module.handleRegister [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:157:5[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:174:5
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20 {
  length: [33m400[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'23502'[39m,
  detail: [32m'Failing row contains (d4e78315-610d-4210-9e21-fb9460d2ba09, casesensitive@example.com, $2b$12$UI3w0d5Rv8kTm.P3r7hv5eDCzUtTO548E1l1NgvYj0f/6HNSyTxWi, null, author, FREE, 1762722783, null, null, 0, null, null, null, null, null).'[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [32m'public'[39m,
  table: [32m'users'[39m,
  column: [32m'updated_at'[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'execMain.c'[39m,
  line: [32m'1993'[39m,
  routine: [32m'ExecConstraints'[39m
}
Query: 
      INSERT INTO users (id, email, password_hash, role, created_at, email_verified)
      VALUES ($1, $2, $3, $4, $5, 0)
    
Params: [
  [32m'd4e78315-610d-4210-9e21-fb9460d2ba09'[39m,
  [32m'casesensitive@example.com'[39m,
  [32m'$2b$12$UI3w0d5Rv8kTm.P3r7hv5eDCzUtTO548E1l1NgvYj0f/6HNSyTxWi'[39m,
  [32m'author'[39m,
  [33m1762722783[39m
]

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/register[2m > [22m[2mshould normalize email to lowercase
[22m[39mRegistration error: error: null value in column "updated_at" of relation "users" violates not-null constraint
    at [90mD:\manuscript-platform\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at PreparedStatement._executeQuery [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:163:20[90m)[39m
    at Module.handleRegister [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:157:5[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:174:5
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20 {
  length: [33m400[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'23502'[39m,
  detail: [32m'Failing row contains (d4e78315-610d-4210-9e21-fb9460d2ba09, casesensitive@example.com, $2b$12$UI3w0d5Rv8kTm.P3r7hv5eDCzUtTO548E1l1NgvYj0f/6HNSyTxWi, null, author, FREE, 1762722783, null, null, 0, null, null, null, null, null).'[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [32m'public'[39m,
  table: [32m'users'[39m,
  column: [32m'updated_at'[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'execMain.c'[39m,
  line: [32m'1993'[39m,
  routine: [32m'ExecConstraints'[39m
}

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/register[2m > [22m[2mshould create verification token
[22m[39mDatabase query error: error: null value in column "updated_at" of relation "users" violates not-null constraint
    at [90mD:\manuscript-platform\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at PreparedStatement._executeQuery [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:163:20[90m)[39m
    at Module.handleRegister [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:157:5[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:190:22
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20 {
  length: [33m398[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'23502'[39m,
  detail: [32m'Failing row contains (5c09a4f0-7cec-4006-8bf8-58f3a4322ed3, verify-test@example.com, $2b$12$eiDtzYPwp0wRU9mxDlkIV.N98kxGlbZs6z7kh24Opw/fRF58pKST6, null, author, FREE, 1762722786, null, null, 0, null, null, null, null, null).'[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [32m'public'[39m,
  table: [32m'users'[39m,
  column: [32m'updated_at'[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'execMain.c'[39m,
  line: [32m'1993'[39m,
  routine: [32m'ExecConstraints'[39m
}
Query: 
      INSERT INTO users (id, email, password_hash, role, created_at, email_verified)
      VALUES ($1, $2, $3, $4, $5, 0)
    
Params: [
  [32m'5c09a4f0-7cec-4006-8bf8-58f3a4322ed3'[39m,
  [32m'verify-test@example.com'[39m,
  [32m'$2b$12$eiDtzYPwp0wRU9mxDlkIV.N98kxGlbZs6z7kh24Opw/fRF58pKST6'[39m,
  [32m'author'[39m,
  [33m1762722786[39m
]

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/register[2m > [22m[2mshould create verification token
[22m[39mRegistration error: error: null value in column "updated_at" of relation "users" violates not-null constraint
    at [90mD:\manuscript-platform\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at PreparedStatement._executeQuery [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:163:20[90m)[39m
    at Module.handleRegister [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:157:5[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:190:22
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20 {
  length: [33m398[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'23502'[39m,
  detail: [32m'Failing row contains (5c09a4f0-7cec-4006-8bf8-58f3a4322ed3, verify-test@example.com, $2b$12$eiDtzYPwp0wRU9mxDlkIV.N98kxGlbZs6z7kh24Opw/fRF58pKST6, null, author, FREE, 1762722786, null, null, 0, null, null, null, null, null).'[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [32m'public'[39m,
  table: [32m'users'[39m,
  column: [32m'updated_at'[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'execMain.c'[39m,
  line: [32m'1993'[39m,
  routine: [32m'ExecConstraints'[39m
}

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/register[2m > [22m[2mshould send verification email
[22m[39mDatabase query error: error: null value in column "updated_at" of relation "users" violates not-null constraint
    at [90mD:\manuscript-platform\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at PreparedStatement._executeQuery [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:163:20[90m)[39m
    at Module.handleRegister [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:157:5[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:217:5
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20 {
  length: [33m397[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'23502'[39m,
  detail: [32m'Failing row contains (605ef8a2-6903-4b08-8995-9959d838a41e, email-test@example.com, $2b$12$uM4w4N7s2RpG5Ms/NF40rumtJtTmVQcnO5EDTyuNkJxEXP2qT3EbS, null, author, FREE, 1762722789, null, null, 0, null, null, null, null, null).'[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [32m'public'[39m,
  table: [32m'users'[39m,
  column: [32m'updated_at'[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'execMain.c'[39m,
  line: [32m'1993'[39m,
  routine: [32m'ExecConstraints'[39m
}
Query: 
      INSERT INTO users (id, email, password_hash, role, created_at, email_verified)
      VALUES ($1, $2, $3, $4, $5, 0)
    
Params: [
  [32m'605ef8a2-6903-4b08-8995-9959d838a41e'[39m,
  [32m'email-test@example.com'[39m,
  [32m'$2b$12$uM4w4N7s2RpG5Ms/NF40rumtJtTmVQcnO5EDTyuNkJxEXP2qT3EbS'[39m,
  [32m'author'[39m,
  [33m1762722789[39m
]

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/register[2m > [22m[2mshould send verification email
[22m[39mRegistration error: error: null value in column "updated_at" of relation "users" violates not-null constraint
    at [90mD:\manuscript-platform\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at PreparedStatement._executeQuery [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:163:20[90m)[39m
    at Module.handleRegister [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:157:5[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:217:5
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20 {
  length: [33m397[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'23502'[39m,
  detail: [32m'Failing row contains (605ef8a2-6903-4b08-8995-9959d838a41e, email-test@example.com, $2b$12$uM4w4N7s2RpG5Ms/NF40rumtJtTmVQcnO5EDTyuNkJxEXP2qT3EbS, null, author, FREE, 1762722789, null, null, 0, null, null, null, null, null).'[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [32m'public'[39m,
  table: [32m'users'[39m,
  column: [32m'updated_at'[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'execMain.c'[39m,
  line: [32m'1993'[39m,
  routine: [32m'ExecConstraints'[39m
}

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/register[2m > [22m[2mshould log registration event in audit log
[22m[39mDatabase query error: error: null value in column "updated_at" of relation "users" violates not-null constraint
    at [90mD:\manuscript-platform\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at PreparedStatement._executeQuery [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:163:20[90m)[39m
    at Module.handleRegister [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:157:5[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:238:5
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20 {
  length: [33m397[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'23502'[39m,
  detail: [32m'Failing row contains (6036df29-bdb2-4711-8eb2-75e4292dc1b9, audit-test@example.com, $2b$12$cz.V9KBYucCvLnKYTsKHMuzhKEUoHzbEsHpt8j7OWdSmLMTisSswe, null, author, FREE, 1762722791, null, null, 0, null, null, null, null, null).'[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [32m'public'[39m,
  table: [32m'users'[39m,
  column: [32m'updated_at'[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'execMain.c'[39m,
  line: [32m'1993'[39m,
  routine: [32m'ExecConstraints'[39m
}
Query: 
      INSERT INTO users (id, email, password_hash, role, created_at, email_verified)
      VALUES ($1, $2, $3, $4, $5, 0)
    
Params: [
  [32m'6036df29-bdb2-4711-8eb2-75e4292dc1b9'[39m,
  [32m'audit-test@example.com'[39m,
  [32m'$2b$12$cz.V9KBYucCvLnKYTsKHMuzhKEUoHzbEsHpt8j7OWdSmLMTisSswe'[39m,
  [32m'author'[39m,
  [33m1762722791[39m
]

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/register[2m > [22m[2mshould log registration event in audit log
[22m[39mRegistration error: error: null value in column "updated_at" of relation "users" violates not-null constraint
    at [90mD:\manuscript-platform\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at PreparedStatement._executeQuery [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:163:20[90m)[39m
    at Module.handleRegister [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:157:5[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:238:5
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20 {
  length: [33m397[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'23502'[39m,
  detail: [32m'Failing row contains (6036df29-bdb2-4711-8eb2-75e4292dc1b9, audit-test@example.com, $2b$12$cz.V9KBYucCvLnKYTsKHMuzhKEUoHzbEsHpt8j7OWdSmLMTisSswe, null, author, FREE, 1762722791, null, null, 0, null, null, null, null, null).'[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [32m'public'[39m,
  table: [32m'users'[39m,
  column: [32m'updated_at'[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'execMain.c'[39m,
  line: [32m'1993'[39m,
  routine: [32m'ExecConstraints'[39m
}

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/register[2m > [22m[2mshould set default role to author if not specified
[22m[39mDatabase query error: error: null value in column "updated_at" of relation "users" violates not-null constraint
    at [90mD:\manuscript-platform\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at PreparedStatement._executeQuery [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:163:20[90m)[39m
    at Module.handleRegister [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:157:5[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:255:5
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20 {
  length: [33m399[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'23502'[39m,
  detail: [32m'Failing row contains (fbd0bc25-d3ad-4b4b-9d6e-84b5df9ebe8f, default-role@example.com, $2b$12$cApkNKTitQbhEf3WfVqQB.lLUW6Srkg7O1Sh6a6KZsQT1LyghgCli, null, author, FREE, 1762722793, null, null, 0, null, null, null, null, null).'[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [32m'public'[39m,
  table: [32m'users'[39m,
  column: [32m'updated_at'[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'execMain.c'[39m,
  line: [32m'1993'[39m,
  routine: [32m'ExecConstraints'[39m
}
Query: 
      INSERT INTO users (id, email, password_hash, role, created_at, email_verified)
      VALUES ($1, $2, $3, $4, $5, 0)
    
Params: [
  [32m'fbd0bc25-d3ad-4b4b-9d6e-84b5df9ebe8f'[39m,
  [32m'default-role@example.com'[39m,
  [32m'$2b$12$cApkNKTitQbhEf3WfVqQB.lLUW6Srkg7O1Sh6a6KZsQT1LyghgCli'[39m,
  [32m'author'[39m,
  [33m1762722793[39m
]

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/register[2m > [22m[2mshould set default role to author if not specified
[22m[39mRegistration error: error: null value in column "updated_at" of relation "users" violates not-null constraint
    at [90mD:\manuscript-platform\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at PreparedStatement._executeQuery [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:163:20[90m)[39m
    at Module.handleRegister [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:157:5[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:255:5
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20 {
  length: [33m399[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'23502'[39m,
  detail: [32m'Failing row contains (fbd0bc25-d3ad-4b4b-9d6e-84b5df9ebe8f, default-role@example.com, $2b$12$cApkNKTitQbhEf3WfVqQB.lLUW6Srkg7O1Sh6a6KZsQT1LyghgCli, null, author, FREE, 1762722793, null, null, 0, null, null, null, null, null).'[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [32m'public'[39m,
  table: [32m'users'[39m,
  column: [32m'updated_at'[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'execMain.c'[39m,
  line: [32m'1993'[39m,
  routine: [32m'ExecConstraints'[39m
}

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/login[2m > [22m[2mshould login with valid credentials
[22m[39mDatabase query error: error: column "action" of relation "audit_log" does not exist
    at [90mD:\manuscript-platform\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at PreparedStatement._executeQuery [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(D:\manuscript-platform\[39msrc\utils\auth-utils.js:316:5[90m)[39m
    at Module.handleLogin [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:262:7[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:292:22
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'34967a55-5bf0-4e4c-9f40-542996a5a2c1'[39m,
  [32m'anonymous'[39m,
  [32m'login_failed'[39m,
  [32m'auth'[39m,
  [32m'anonymous'[39m,
  [33m1762722795[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"login-test@example.com","reason":"invalid_credentials"}'[39m
]

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/login[2m > [22m[2mshould login with valid credentials
[22m[39mAudit log error: error: column "action" of relation "audit_log" does not exist
    at [90mD:\manuscript-platform\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at PreparedStatement._executeQuery [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(D:\manuscript-platform\[39msrc\utils\auth-utils.js:316:5[90m)[39m
    at Module.handleLogin [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:262:7[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:292:22
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/login[2m > [22m[2mshould reject login with wrong password
[22m[39mDatabase query error: error: column "action" of relation "audit_log" does not exist
    at [90mD:\manuscript-platform\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at PreparedStatement._executeQuery [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(D:\manuscript-platform\[39msrc\utils\auth-utils.js:316:5[90m)[39m
    at Module.handleLogin [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:262:7[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:318:22
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'bf2b3f5d-79f3-47c4-9bd4-4967684e31b6'[39m,
  [32m'anonymous'[39m,
  [32m'login_failed'[39m,
  [32m'auth'[39m,
  [32m'anonymous'[39m,
  [33m1762722797[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"login-test@example.com","reason":"invalid_credentials"}'[39m
]

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/login[2m > [22m[2mshould reject login with wrong password
[22m[39mAudit log error: error: column "action" of relation "audit_log" does not exist
    at [90mD:\manuscript-platform\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at PreparedStatement._executeQuery [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(D:\manuscript-platform\[39msrc\utils\auth-utils.js:316:5[90m)[39m
    at Module.handleLogin [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:262:7[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:318:22
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/login[2m > [22m[2mshould reject login with non-existent email
[22m[39mDatabase query error: error: column "action" of relation "audit_log" does not exist
    at [90mD:\manuscript-platform\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at PreparedStatement._executeQuery [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(D:\manuscript-platform\[39msrc\utils\auth-utils.js:316:5[90m)[39m
    at Module.handleLogin [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:262:7[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:336:22
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'ed755279-b65f-4c94-a155-54cb40043085'[39m,
  [32m'anonymous'[39m,
  [32m'login_failed'[39m,
  [32m'auth'[39m,
  [32m'anonymous'[39m,
  [33m1762722799[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"nonexistent@example.com","reason":"invalid_credentials"}'[39m
]

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/login[2m > [22m[2mshould reject login with non-existent email
[22m[39mAudit log error: error: column "action" of relation "audit_log" does not exist
    at [90mD:\manuscript-platform\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at PreparedStatement._executeQuery [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(D:\manuscript-platform\[39msrc\utils\auth-utils.js:316:5[90m)[39m
    at Module.handleLogin [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:262:7[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:336:22
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/login[2m > [22m[2mshould reject login with unverified email
[22m[39mDatabase query error: error: column "action" of relation "audit_log" does not exist
    at [90mD:\manuscript-platform\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at PreparedStatement._executeQuery [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(D:\manuscript-platform\[39msrc\utils\auth-utils.js:316:5[90m)[39m
    at Module.handleLogin [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:262:7[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:361:22
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'5e368d68-b652-4bb8-98f7-65dc663eed9f'[39m,
  [32m'anonymous'[39m,
  [32m'login_failed'[39m,
  [32m'auth'[39m,
  [32m'anonymous'[39m,
  [33m1762722802[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"unverified@example.com","reason":"invalid_credentials"}'[39m
]

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/login[2m > [22m[2mshould reject login with unverified email
[22m[39mAudit log error: error: column "action" of relation "audit_log" does not exist
    at [90mD:\manuscript-platform\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at PreparedStatement._executeQuery [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(D:\manuscript-platform\[39msrc\utils\auth-utils.js:316:5[90m)[39m
    at Module.handleLogin [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:262:7[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:361:22
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/login[2m > [22m[2mshould rate limit after 5 failed attempts
[22m[39mDatabase query error: error: column "action" of relation "audit_log" does not exist
    at [90mD:\manuscript-platform\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at PreparedStatement._executeQuery [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(D:\manuscript-platform\[39msrc\utils\auth-utils.js:316:5[90m)[39m
    at Module.handleLogin [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:262:7[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:381:7
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'b9740f1a-aacc-412d-a899-c9fe525d540f'[39m,
  [32m'anonymous'[39m,
  [32m'login_failed'[39m,
  [32m'auth'[39m,
  [32m'anonymous'[39m,
  [33m1762722804[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"login-test@example.com","reason":"invalid_credentials"}'[39m
]

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/login[2m > [22m[2mshould rate limit after 5 failed attempts
[22m[39mAudit log error: error: column "action" of relation "audit_log" does not exist
    at [90mD:\manuscript-platform\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at PreparedStatement._executeQuery [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(D:\manuscript-platform\[39msrc\utils\auth-utils.js:316:5[90m)[39m
    at Module.handleLogin [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:262:7[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:381:7
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/login[2m > [22m[2mshould rate limit after 5 failed attempts
[22m[39mDatabase query error: error: column "action" of relation "audit_log" does not exist
    at [90mD:\manuscript-platform\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at PreparedStatement._executeQuery [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(D:\manuscript-platform\[39msrc\utils\auth-utils.js:316:5[90m)[39m
    at Module.handleLogin [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:262:7[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:381:7
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'259c53e9-5cf6-4c2a-a788-2cb62f2f1958'[39m,
  [32m'anonymous'[39m,
  [32m'login_failed'[39m,
  [32m'auth'[39m,
  [32m'anonymous'[39m,
  [33m1762722804[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"login-test@example.com","reason":"invalid_credentials"}'[39m
]

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/login[2m > [22m[2mshould rate limit after 5 failed attempts
[22m[39mAudit log error: error: column "action" of relation "audit_log" does not exist
    at [90mD:\manuscript-platform\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at PreparedStatement._executeQuery [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(D:\manuscript-platform\[39msrc\utils\auth-utils.js:316:5[90m)[39m
    at Module.handleLogin [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:262:7[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:381:7
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/login[2m > [22m[2mshould rate limit after 5 failed attempts
[22m[39mDatabase query error: error: column "action" of relation "audit_log" does not exist
    at [90mD:\manuscript-platform\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at PreparedStatement._executeQuery [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(D:\manuscript-platform\[39msrc\utils\auth-utils.js:316:5[90m)[39m
    at Module.handleLogin [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:262:7[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:381:7
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'27b18cf2-7cd7-44eb-82d2-f59c66a4cdbc'[39m,
  [32m'anonymous'[39m,
  [32m'login_failed'[39m,
  [32m'auth'[39m,
  [32m'anonymous'[39m,
  [33m1762722804[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"login-test@example.com","reason":"invalid_credentials"}'[39m
]

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/login[2m > [22m[2mshould rate limit after 5 failed attempts
[22m[39mAudit log error: error: column "action" of relation "audit_log" does not exist
    at [90mD:\manuscript-platform\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at PreparedStatement._executeQuery [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(D:\manuscript-platform\[39msrc\utils\auth-utils.js:316:5[90m)[39m
    at Module.handleLogin [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:262:7[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:381:7
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/login[2m > [22m[2mshould rate limit after 5 failed attempts
[22m[39mDatabase query error: error: column "action" of relation "audit_log" does not exist
    at [90mD:\manuscript-platform\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at PreparedStatement._executeQuery [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(D:\manuscript-platform\[39msrc\utils\auth-utils.js:316:5[90m)[39m
    at Module.handleLogin [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:262:7[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:381:7
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'7d402f69-4fff-499f-aae5-79fd7f92bb3f'[39m,
  [32m'anonymous'[39m,
  [32m'login_failed'[39m,
  [32m'auth'[39m,
  [32m'anonymous'[39m,
  [33m1762722804[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"login-test@example.com","reason":"invalid_credentials"}'[39m
]

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/login[2m > [22m[2mshould rate limit after 5 failed attempts
[22m[39mAudit log error: error: column "action" of relation "audit_log" does not exist
    at [90mD:\manuscript-platform\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at PreparedStatement._executeQuery [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(D:\manuscript-platform\[39msrc\utils\auth-utils.js:316:5[90m)[39m
    at Module.handleLogin [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:262:7[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:381:7
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/login[2m > [22m[2mshould rate limit after 5 failed attempts
[22m[39mDatabase query error: error: column "action" of relation "audit_log" does not exist
    at [90mD:\manuscript-platform\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at PreparedStatement._executeQuery [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(D:\manuscript-platform\[39msrc\utils\auth-utils.js:316:5[90m)[39m
    at Module.handleLogin [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:262:7[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:381:7
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'de44fcf9-bea9-4792-bd66-cebed5962fbe'[39m,
  [32m'anonymous'[39m,
  [32m'login_failed'[39m,
  [32m'auth'[39m,
  [32m'anonymous'[39m,
  [33m1762722804[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"login-test@example.com","reason":"invalid_credentials"}'[39m
]

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/login[2m > [22m[2mshould rate limit after 5 failed attempts
[22m[39mAudit log error: error: column "action" of relation "audit_log" does not exist
    at [90mD:\manuscript-platform\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at PreparedStatement._executeQuery [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(D:\manuscript-platform\[39msrc\utils\auth-utils.js:316:5[90m)[39m
    at Module.handleLogin [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:262:7[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:381:7
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/login[2m > [22m[2mshould update last_login timestamp
[22m[39mDatabase query error: error: column "action" of relation "audit_log" does not exist
    at [90mD:\manuscript-platform\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at PreparedStatement._executeQuery [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(D:\manuscript-platform\[39msrc\utils\auth-utils.js:316:5[90m)[39m
    at Module.handleLogin [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:262:7[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:413:5
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'18f70744-3781-4ab6-abcd-3acdbfa7b3cd'[39m,
  [32m'anonymous'[39m,
  [32m'login_failed'[39m,
  [32m'auth'[39m,
  [32m'anonymous'[39m,
  [33m1762722806[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"login-test@example.com","reason":"invalid_credentials"}'[39m
]

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/login[2m > [22m[2mshould update last_login timestamp
[22m[39mAudit log error: error: column "action" of relation "audit_log" does not exist
    at [90mD:\manuscript-platform\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at PreparedStatement._executeQuery [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(D:\manuscript-platform\[39msrc\utils\auth-utils.js:316:5[90m)[39m
    at Module.handleLogin [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:262:7[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:413:5
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/login[2m > [22m[2mshould create session in Redis
[22m[39mDatabase query error: error: column "action" of relation "audit_log" does not exist
    at [90mD:\manuscript-platform\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at PreparedStatement._executeQuery [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(D:\manuscript-platform\[39msrc\utils\auth-utils.js:316:5[90m)[39m
    at Module.handleLogin [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:262:7[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:432:22
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'3b132284-c919-4139-9987-86f115742f43'[39m,
  [32m'anonymous'[39m,
  [32m'login_failed'[39m,
  [32m'auth'[39m,
  [32m'anonymous'[39m,
  [33m1762722809[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"login-test@example.com","reason":"invalid_credentials"}'[39m
]

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/login[2m > [22m[2mshould create session in Redis
[22m[39mAudit log error: error: column "action" of relation "audit_log" does not exist
    at [90mD:\manuscript-platform\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at PreparedStatement._executeQuery [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(D:\manuscript-platform\[39msrc\utils\auth-utils.js:316:5[90m)[39m
    at Module.handleLogin [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:262:7[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:432:22
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/login[2m > [22m[2mshould log successful login
[22m[39mDatabase query error: error: column "action" of relation "audit_log" does not exist
    at [90mD:\manuscript-platform\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at PreparedStatement._executeQuery [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(D:\manuscript-platform\[39msrc\utils\auth-utils.js:316:5[90m)[39m
    at Module.handleLogin [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:262:7[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:461:5
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'074c0505-9fd1-4220-bfac-e494c17ab6f0'[39m,
  [32m'anonymous'[39m,
  [32m'login_failed'[39m,
  [32m'auth'[39m,
  [32m'anonymous'[39m,
  [33m1762722811[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"login-test@example.com","reason":"invalid_credentials"}'[39m
]

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/login[2m > [22m[2mshould log successful login
[22m[39mAudit log error: error: column "action" of relation "audit_log" does not exist
    at [90mD:\manuscript-platform\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at PreparedStatement._executeQuery [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(D:\manuscript-platform\[39msrc\utils\auth-utils.js:316:5[90m)[39m
    at Module.handleLogin [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:262:7[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:461:5
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/login[2m > [22m[2mshould log failed login attempts
[22m[39mDatabase query error: error: column "action" of relation "audit_log" does not exist
    at [90mD:\manuscript-platform\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at PreparedStatement._executeQuery [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(D:\manuscript-platform\[39msrc\utils\auth-utils.js:316:5[90m)[39m
    at Module.handleLogin [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:262:7[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:478:5
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'e7f0533c-3574-46cf-b6a3-f956c04ac28b'[39m,
  [32m'anonymous'[39m,
  [32m'login_failed'[39m,
  [32m'auth'[39m,
  [32m'anonymous'[39m,
  [33m1762722814[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"login-test@example.com","reason":"invalid_credentials"}'[39m
]

[90mstderr[2m | tests/integration/handlers/auth-handlers.test.js[2m > [22m[2mPOST /auth/login[2m > [22m[2mshould log failed login attempts
[22m[39mAudit log error: error: column "action" of relation "audit_log" does not exist
    at [90mD:\manuscript-platform\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at PreparedStatement._executeQuery [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(D:\manuscript-platform\[39msrc\utils\auth-utils.js:316:5[90m)[39m
    at Module.handleLogin [90m(D:\manuscript-platform\[39msrc\handlers\auth-handlers.js:262:7[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\handlers\auth-handlers.test.js:478:5
    at [90mfile:///D:/manuscript-platform/[39mnode_modules/[4m@vitest/runner[24m/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js
[22m[39m
ðŸ§¹ Tearing down test environment...

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js
[22m[39mâœ“ Test database cleaned

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js
[22m[39mâœ“ Database adapter closed

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js
[22m[39mâœ“ Test database disconnected

[90mstdout[2m | tests/integration/handlers/auth-handlers.test.js
[22m[39mâœ“ Test database cleaned up
âœ“ Test environment cleaned up


 [31mâ¯[39m tests/integration/handlers/auth-handlers.test.js [2m([22m[2m53 tests[22m[2m | [22m[31m47 failed[39m[2m)[22m[33m 127455[2mms[22m[39m
[31m   [31mÃ—[31m POST /auth/register[2m > [22mshould register a new user with valid credentials[39m[33m 2437[2mms[22m[39m
[31m     â†’ expected 500 to be 201 // Object.is equality[39m
   [33m[2mâœ“[22m[39m POST /auth/register[2m > [22mshould reject registration with weak password [33m 1700[2mms[22m[39m
   [33m[2mâœ“[22m[39m POST /auth/register[2m > [22mshould reject registration with invalid email [33m 1654[2mms[22m[39m
[31m   [31mÃ—[31m POST /auth/register[2m > [22mshould reject registration with duplicate email[39m[33m 2094[2mms[22m[39m
[31m     â†’ expected 500 to be 409 // Object.is equality[39m
[31m   [31mÃ—[31m POST /auth/register[2m > [22mshould hash password with bcrypt[39m[33m 3436[2mms[22m[39m
[31m     â†’ Cannot read properties of null (reading 'password_hash')[39m
[31m   [31mÃ—[31m POST /auth/register[2m > [22mshould normalize email to lowercase[39m[33m 2084[2mms[22m[39m
[31m     â†’ expected null to be truthy[39m
[31m   [31mÃ—[31m POST /auth/register[2m > [22mshould create verification token[39m[33m 2383[2mms[22m[39m
[31m     â†’ expected undefined to be truthy[39m
[31m   [31mÃ—[31m POST /auth/register[2m > [22mshould send verification email[39m[33m 2960[2mms[22m[39m
[31m     â†’ expected "spy" to be called with arguments: [ ObjectContaining{â€¦}, Any<Object> ][90m

Number of calls: [1m0[22m
[31m[39m
[31m   [31mÃ—[31m POST /auth/register[2m > [22mshould log registration event in audit log[39m[33m 2376[2mms[22m[39m
[31m     â†’ expected 0 to be greater than 0[39m
[31m   [31mÃ—[31m POST /auth/register[2m > [22mshould set default role to author if not specified[39m[33m 1993[2mms[22m[39m
[31m     â†’ Cannot read properties of null (reading 'role')[39m
[31m   [31mÃ—[31m POST /auth/login[2m > [22mshould login with valid credentials[39m[33m 2197[2mms[22m[39m
[31m     â†’ expected 400 to be 200 // Object.is equality[39m
   [33m[2mâœ“[22m[39m POST /auth/login[2m > [22mshould reject login with wrong password [33m 2100[2mms[22m[39m
   [33m[2mâœ“[22m[39m POST /auth/login[2m > [22mshould reject login with non-existent email [33m 1851[2mms[22m[39m
[31m   [31mÃ—[31m POST /auth/login[2m > [22mshould reject login with unverified email[39m[33m 2575[2mms[22m[39m
[31m     â†’ expected 400 to be 403 // Object.is equality[39m
   [33m[2mâœ“[22m[39m POST /auth/login[2m > [22mshould rate limit after 5 failed attempts [33m 2203[2mms[22m[39m
[31m   [31mÃ—[31m POST /auth/login[2m > [22mshould update last_login timestamp[39m[33m 1929[2mms[22m[39m
[31m     â†’ Cannot read properties of null (reading 'last_login')[39m
[31m   [31mÃ—[31m POST /auth/login[2m > [22mshould create session in Redis[39m[33m 3470[2mms[22m[39m
[31m     â†’ Cannot read properties of null (reading 'match')[39m
[31m   [31mÃ—[31m POST /auth/login[2m > [22mshould log successful login[39m[33m 1879[2mms[22m[39m
[31m     â†’ expected 0 to be greater than 0[39m
[31m   [31mÃ—[31m POST /auth/login[2m > [22mshould log failed login attempts[39m[33m 2389[2mms[22m[39m
[31m     â†’ expected 0 to be greater than 0[39m
[31m   [31mÃ—[31m POST /auth/verify-email[2m > [22mshould verify email with valid token[39m[33m 2011[2mms[22m[39m
[31m     â†’ createVerificationToken is not a function[39m
[31m   [31mÃ—[31m POST /auth/verify-email[2m > [22mshould reject invalid token[39m[33m 2370[2mms[22m[39m
[31m     â†’ createVerificationToken is not a function[39m
[31m   [31mÃ—[31m POST /auth/verify-email[2m > [22mshould reject expired token[39m[33m 1783[2mms[22m[39m
[31m     â†’ createVerificationToken is not a function[39m
[31m   [31mÃ—[31m POST /auth/verify-email[2m > [22mshould reject already used token[39m[33m 1804[2mms[22m[39m
[31m     â†’ createVerificationToken is not a function[39m
[31m   [31mÃ—[31m POST /auth/verify-email[2m > [22mshould handle missing token[39m[33m 3954[2mms[22m[39m
[31m     â†’ createVerificationToken is not a function[39m
[31m   [31mÃ—[31m POST /auth/verify-email[2m > [22mshould log email verification event[39m[33m 1772[2mms[22m[39m
[31m     â†’ createVerificationToken is not a function[39m
[31m   [31mÃ—[31m POST /auth/request-password-reset[2m > [22mshould create password reset token for valid email[39m[33m 2912[2mms[22m[39m
[31m     â†’ handleRequestPasswordReset is not a function[39m
[31m   [31mÃ—[31m POST /auth/request-password-reset[2m > [22mshould send password reset email[39m[33m 1792[2mms[22m[39m
[31m     â†’ handleRequestPasswordReset is not a function[39m
[31m   [31mÃ—[31m POST /auth/request-password-reset[2m > [22mshould not reveal if email does not exist (security)[39m[33m 2045[2mms[22m[39m
[31m     â†’ handleRequestPasswordReset is not a function[39m
[31m   [31mÃ—[31m POST /auth/request-password-reset[2m > [22mshould rate limit password reset requests[39m[33m 2804[2mms[22m[39m
[31m     â†’ handleRequestPasswordReset is not a function[39m
[31m   [31mÃ—[31m POST /auth/request-password-reset[2m > [22mshould normalize email to lowercase[39m[33m 1816[2mms[22m[39m
[31m     â†’ handleRequestPasswordReset is not a function[39m
[31m   [31mÃ—[31m POST /auth/request-password-reset[2m > [22mshould reject invalid email format[39m[33m 2859[2mms[22m[39m
[31m     â†’ handleRequestPasswordReset is not a function[39m
[31m   [31mÃ—[31m POST /auth/request-password-reset[2m > [22mshould handle missing email[39m[33m 2608[2mms[22m[39m
[31m     â†’ handleRequestPasswordReset is not a function[39m
[31m   [31mÃ—[31m POST /auth/request-password-reset[2m > [22mshould log password reset request[39m[33m 1786[2mms[22m[39m
[31m     â†’ handleRequestPasswordReset is not a function[39m
[31m   [31mÃ—[31m POST /auth/reset-password[2m > [22mshould reset password with valid token[39m[33m 1758[2mms[22m[39m
[31m     â†’ createVerificationToken is not a function[39m
[31m   [31mÃ—[31m POST /auth/reset-password[2m > [22mshould mark reset token as used[39m[33m 1746[2mms[22m[39m
[31m     â†’ createVerificationToken is not a function[39m
[31m   [31mÃ—[31m POST /auth/reset-password[2m > [22mshould reject weak new password[39m[33m 3403[2mms[22m[39m
[31m     â†’ createVerificationToken is not a function[39m
[31m   [31mÃ—[31m POST /auth/reset-password[2m > [22mshould reject invalid token[39m[33m 1838[2mms[22m[39m
[31m     â†’ createVerificationToken is not a function[39m
[31m   [31mÃ—[31m POST /auth/reset-password[2m > [22mshould reject expired token[39m[33m 2239[2mms[22m[39m
[31m     â†’ createVerificationToken is not a function[39m
[31m   [31mÃ—[31m POST /auth/reset-password[2m > [22mshould reject already used token[39m[33m 1776[2mms[22m[39m
[31m     â†’ createVerificationToken is not a function[39m
[31m   [31mÃ—[31m POST /auth/reset-password[2m > [22mshould hash new password with bcrypt[39m[33m 1749[2mms[22m[39m
[31m     â†’ createVerificationToken is not a function[39m
[31m   [31mÃ—[31m POST /auth/reset-password[2m > [22mshould log password reset event[39m[33m 3051[2mms[22m[39m
[31m     â†’ createVerificationToken is not a function[39m
[31m   [31mÃ—[31m POST /auth/logout[2m > [22mshould logout and destroy session[39m[33m 2321[2mms[22m[39m
[31m     â†’ expected 401 to be 200 // Object.is equality[39m
[31m   [31mÃ—[31m POST /auth/logout[2m > [22mshould clear session cookie[39m[33m 2140[2mms[22m[39m
[31m     â†’ the given combination of arguments (null and string) is invalid for this assertion. You can use an array, a map, an object, a set, a string, or a weakset instead of a string[39m
[31m   [31mÃ—[31m POST /auth/logout[2m > [22mshould log logout event[39m[33m 1980[2mms[22m[39m
[31m     â†’ expected 0 to be greater than 0[39m
[31m   [31mÃ—[31m GET /auth/me[2m > [22mshould return current user with valid session[39m[33m 1792[2mms[22m[39m
[31m     â†’ handleGetCurrentUser is not a function[39m
[31m   [31mÃ—[31m GET /auth/me[2m > [22mshould not return password hash[39m[33m 3281[2mms[22m[39m
[31m     â†’ handleGetCurrentUser is not a function[39m
[31m   [31mÃ—[31m GET /auth/me[2m > [22mshould reject request without session[39m[33m 1935[2mms[22m[39m
[31m     â†’ handleGetCurrentUser is not a function[39m
[31m   [31mÃ—[31m GET /auth/me[2m > [22mshould reject request with invalid session[39m[33m 2786[2mms[22m[39m
[31m     â†’ handleGetCurrentUser is not a function[39m
[31m   [31mÃ—[31m GET /auth/me[2m > [22mshould return email verification status[39m[33m 1773[2mms[22m[39m
[31m     â†’ handleGetCurrentUser is not a function[39m
[31m   [31mÃ—[31m POST /auth/resend-verification[2m > [22mshould resend verification email for unverified user[39m[33m 2251[2mms[22m[39m
[31m     â†’ expected "spy" to be called with arguments: [ ObjectContaining{â€¦}, Any<Object> ][90m

Number of calls: [1m0[22m
[31m[39m
[31m   [31mÃ—[31m POST /auth/resend-verification[2m > [22mshould reject resend for already verified user[39m[33m 3383[2mms[22m[39m
[31m     â†’ column "email_verified" is of type integer but expression is of type boolean[39m
[31m   [31mÃ—[31m POST /auth/resend-verification[2m > [22mshould rate limit resend requests[39m[33m 2598[2mms[22m[39m
[31m     â†’ expected 200 to be 429 // Object.is equality[39m
   [33m[2mâœ“[22m[39m POST /auth/resend-verification[2m > [22mshould not reveal if email does not exist (security) [33m 1727[2mms[22m[39m
[90mstdout[2m | tests/integration/infrastructure.test.js
[22m[39m[dotenv@17.2.3] injecting env (0) from .env.local -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild
Initializing adapters...

[90mstderr[2m | tests/integration/infrastructure.test.js
[22m[39mFailed to initialize adapters: Error: DATABASE_URL environment variable is required
    at createDatabaseAdapter [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:214:11[90m)[39m
    at initializeAdapters [90m(D:\manuscript-platform\[39mserver.js:68:16[90m)[39m
    at start [90m(D:\manuscript-platform\[39mserver.js:306:5[90m)[39m
    at [90mD:\manuscript-platform\[39mserver.js:320:3
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at VitestExecutor.runModule [90m(file:///D:/manuscript-platform/[39mnode_modules/[4mvite-node[24m/dist/client.mjs:397:4[90m)[39m
    at VitestExecutor.directRequest [90m(file:///D:/manuscript-platform/[39mnode_modules/[4mvite-node[24m/dist/client.mjs:375:3[90m)[39m
    at VitestExecutor.cachedRequest [90m(file:///D:/manuscript-platform/[39mnode_modules/[4mvite-node[24m/dist/client.mjs:189:11[90m)[39m
    at VitestExecutor.dependencyRequest [90m(file:///D:/manuscript-platform/[39mnode_modules/[4mvite-node[24m/dist/client.mjs:239:10[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\test-helpers\api-client.js:12:1
    at VitestExecutor.runModule [90m(file:///D:/manuscript-platform/[39mnode_modules/[4mvite-node[24m/dist/client.mjs:397:4[90m)[39m
    at VitestExecutor.directRequest [90m(file:///D:/manuscript-platform/[39mnode_modules/[4mvite-node[24m/dist/client.mjs:375:3[90m)[39m
    at VitestExecutor.cachedRequest [90m(file:///D:/manuscript-platform/[39mnode_modules/[4mvite-node[24m/dist/client.mjs:189:11[90m)[39m
    at VitestExecutor.dependencyRequest [90m(file:///D:/manuscript-platform/[39mnode_modules/[4mvite-node[24m/dist/client.mjs:239:10[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\infrastructure.test.js:13:1
    at VitestExecutor.runModule [90m(file:///D:/manuscript-platform/[39mnode_modules/[4mvite-node[24m/dist/client.mjs:397:4[90m)[39m

[90mstderr[2m | tests/integration/infrastructure.test.js
[22m[39mFailed to initialize adapters: Error: DATABASE_URL environment variable is required
    at createDatabaseAdapter [90m(D:\manuscript-platform\[39msrc\adapters\database-adapter.js:214:11[90m)[39m
    at initializeAdapters [90m(D:\manuscript-platform\[39mserver.js:68:16[90m)[39m
    at start [90m(D:\manuscript-platform\[39mserver.js:306:5[90m)[39m
    at [90mD:\manuscript-platform\[39mserver.js:320:3
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at VitestExecutor.runModule [90m(file:///D:/manuscript-platform/[39mnode_modules/[4mvite-node[24m/dist/client.mjs:397:4[90m)[39m
    at VitestExecutor.directRequest [90m(file:///D:/manuscript-platform/[39mnode_modules/[4mvite-node[24m/dist/client.mjs:375:3[90m)[39m
    at VitestExecutor.cachedRequest [90m(file:///D:/manuscript-platform/[39mnode_modules/[4mvite-node[24m/dist/client.mjs:189:11[90m)[39m
    at VitestExecutor.dependencyRequest [90m(file:///D:/manuscript-platform/[39mnode_modules/[4mvite-node[24m/dist/client.mjs:239:10[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\test-helpers\api-client.js:12:1
    at VitestExecutor.runModule [90m(file:///D:/manuscript-platform/[39mnode_modules/[4mvite-node[24m/dist/client.mjs:397:4[90m)[39m
    at VitestExecutor.directRequest [90m(file:///D:/manuscript-platform/[39mnode_modules/[4mvite-node[24m/dist/client.mjs:375:3[90m)[39m
    at VitestExecutor.cachedRequest [90m(file:///D:/manuscript-platform/[39mnode_modules/[4mvite-node[24m/dist/client.mjs:189:11[90m)[39m
    at VitestExecutor.dependencyRequest [90m(file:///D:/manuscript-platform/[39mnode_modules/[4mvite-node[24m/dist/client.mjs:239:10[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\infrastructure.test.js:13:1
    at VitestExecutor.runModule [90m(file:///D:/manuscript-platform/[39mnode_modules/[4mvite-node[24m/dist/client.mjs:397:4[90m)[39m
Server will continue running but API requests will fail until adapters are ready

[90mstdout[2m | tests/integration/infrastructure.test.js
[22m[39m
âœ“ Server running on port 3000
âœ“ Environment: development
âœ“ Health check: http://localhost:3000/health
â³ Initializing adapters...


[90mstdout[2m | tests/integration/infrastructure.test.js
[22m[39m
ðŸ§ª Setting up test environment...

[90mstdout[2m | tests/integration/infrastructure.test.js
[22m[39mâœ“ Test database connected

[90mstdout[2m | tests/integration/infrastructure.test.js
[22m[39m  Applying base schema...

[90mstdout[2m | tests/integration/infrastructure.test.js
[22m[39m  âœ“ Schema and migrations applied

[90mstdout[2m | tests/integration/infrastructure.test.js
[22m[39mâœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

[90mstdout[2m | tests/integration/infrastructure.test.js
[22m[39mâœ“ Test database initialized
âœ“ Test environment ready


[0mGET /health [31m503[0m 3.617 ms - 46[0m
[90mstdout[2m | tests/integration/infrastructure.test.js
[22m[39m
ðŸ§¹ Tearing down test environment...

[90mstdout[2m | tests/integration/infrastructure.test.js
[22m[39mâœ“ Test database cleaned

[90mstdout[2m | tests/integration/infrastructure.test.js
[22m[39mâœ“ Database adapter closed

[90mstdout[2m | tests/integration/infrastructure.test.js
[22m[39mâœ“ Test database disconnected

[90mstdout[2m | tests/integration/infrastructure.test.js
[22m[39mâœ“ Test database cleaned up
âœ“ Test environment cleaned up


 [31mâ¯[39m tests/integration/infrastructure.test.js [2m([22m[2m13 tests[22m[2m | [22m[31m7 failed[39m[2m)[22m[33m 45487[2mms[22m[39m
[31m   [31mÃ—[31m Test Infrastructure[2m > [22mDatabase Utilities[2m > [22mshould insert and retrieve test records[39m[33m 1962[2mms[22m[39m
[31m     â†’ invalid input syntax for type integer: "true"[39m
[31m   [31mÃ—[31m Test Infrastructure[2m > [22mDatabase Utilities[2m > [22mshould count test records[39m[33m 2447[2mms[22m[39m
[31m     â†’ invalid input syntax for type integer: "true"[39m
   [33m[2mâœ“[22m[39m Test Infrastructure[2m > [22mDatabase Utilities[2m > [22mshould reset database between tests [33m 2487[2mms[22m[39m
[31m   [31mÃ—[31m Test Infrastructure[2m > [22mAPI Client[2m > [22mshould make HTTP requests[39m[33m 4023[2mms[22m[39m
[31m     â†’ expected 503 to be less than or equal to 404[39m
   [33m[2mâœ“[22m[39m Test Infrastructure[2m > [22mMock Factories[2m > [22mshould create mock Redis client [33m 2528[2mms[22m[39m
[31m   [31mÃ—[31m Test Infrastructure[2m > [22mMock Factories[2m > [22mshould create mock Redis client with expiration[39m[33m 2598[2mms[22m[39m
[31m     â†’ expected -2 to be greater than 0[39m
[31m   [31mÃ—[31m Test Infrastructure[2m > [22mMock Factories[2m > [22mshould create mock storage adapter[39m[33m 3391[2mms[22m[39m
[31m     â†’ The first argument must be of type string or an instance of Buffer, ArrayBuffer, or Array or an Array-like Object. Received undefined[39m
   [33m[2mâœ“[22m[39m Test Infrastructure[2m > [22mTest Data Factories[2m > [22mshould create test user data [33m 2403[2mms[22m[39m
   [33m[2mâœ“[22m[39m Test Infrastructure[2m > [22mTest Data Factories[2m > [22mshould create test user with overrides [33m 2414[2mms[22m[39m
   [33m[2mâœ“[22m[39m Test Infrastructure[2m > [22mTest Data Factories[2m > [22mshould create test manuscript data [33m 3470[2mms[22m[39m
   [33m[2mâœ“[22m[39m Test Infrastructure[2m > [22mTest Data Factories[2m > [22mshould generate unique test emails [33m 3486[2mms[22m[39m
[31m   [31mÃ—[31m Test Infrastructure[2m > [22mIntegration: Factories + Database[2m > [22mshould insert factory-generated user into database[39m[33m 2448[2mms[22m[39m
[31m     â†’ invalid input syntax for type integer: "true"[39m
[31m   [31mÃ—[31m Test Infrastructure[2m > [22mIntegration: Factories + Database[2m > [22mshould insert factory-generated manuscript into database[39m[33m 2511[2mms[22m[39m
[31m     â†’ invalid input syntax for type integer: "true"[39m
[90mstdout[2m | tests/auth-utils.test.js
[22m[39m
ðŸ§ª Setting up test environment...

[90mstdout[2m | tests/auth-utils.test.js
[22m[39mâœ“ Test database connected

[90mstdout[2m | tests/auth-utils.test.js
[22m[39m  Applying base schema...

[90mstdout[2m | tests/auth-utils.test.js
[22m[39m  âœ“ Schema and migrations applied

[90mstdout[2m | tests/auth-utils.test.js
[22m[39mâœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

[90mstdout[2m | tests/auth-utils.test.js
[22m[39mâœ“ Test database initialized
âœ“ Test environment ready


[90mstdout[2m | tests/auth-utils.test.js
[22m[39m
ðŸ§¹ Tearing down test environment...

[90mstdout[2m | tests/auth-utils.test.js
[22m[39mâœ“ Test database cleaned

[90mstdout[2m | tests/auth-utils.test.js
[22m[39mâœ“ Database adapter closed

[90mstdout[2m | tests/auth-utils.test.js
[22m[39mâœ“ Test database disconnected

[90mstdout[2m | tests/auth-utils.test.js
[22m[39mâœ“ Test database cleaned up
âœ“ Test environment cleaned up


 [32mâœ“[39m tests/auth-utils.test.js [2m([22m[2m22 tests[22m[2m)[22m[33m 45821[2mms[22m[39m
   [33m[2mâœ“[22m[39m Authentication Utilities[2m > [22mvalidatePassword[2m > [22mshould accept a valid password [33m 1463[2mms[22m[39m
   [33m[2mâœ“[22m[39m Authentication Utilities[2m > [22mvalidatePassword[2m > [22mshould reject password shorter than 8 characters [33m 1421[2mms[22m[39m
   [33m[2mâœ“[22m[39m Authentication Utilities[2m > [22mvalidatePassword[2m > [22mshould reject password without uppercase letter [33m 1423[2mms[22m[39m
   [33m[2mâœ“[22m[39m Authentication Utilities[2m > [22mvalidatePassword[2m > [22mshould reject password without lowercase letter [33m 1462[2mms[22m[39m
   [33m[2mâœ“[22m[39m Authentication Utilities[2m > [22mvalidatePassword[2m > [22mshould reject password without number [33m 1371[2mms[22m[39m
   [33m[2mâœ“[22m[39m Authentication Utilities[2m > [22mvalidatePassword[2m > [22mshould reject password without special character [33m 2236[2mms[22m[39m
   [33m[2mâœ“[22m[39m Authentication Utilities[2m > [22mvalidatePassword[2m > [22mshould reject null or undefined password [33m 1642[2mms[22m[39m
   [33m[2mâœ“[22m[39m Authentication Utilities[2m > [22mvalidatePassword[2m > [22mshould accept password with all requirements [33m 1397[2mms[22m[39m
   [33m[2mâœ“[22m[39m Authentication Utilities[2m > [22mvalidatePassword[2m > [22mshould return multiple errors for invalid password [33m 2117[2mms[22m[39m
   [33m[2mâœ“[22m[39m Authentication Utilities[2m > [22mvalidateEmail[2m > [22mshould accept valid email addresses [33m 1441[2mms[22m[39m
   [33m[2mâœ“[22m[39m Authentication Utilities[2m > [22mvalidateEmail[2m > [22mshould reject invalid email addresses [33m 1410[2mms[22m[39m
   [33m[2mâœ“[22m[39m Authentication Utilities[2m > [22mvalidateEmail[2m > [22mshould handle edge cases [33m 1358[2mms[22m[39m
   [33m[2mâœ“[22m[39m Authentication Utilities[2m > [22mhashPassword and verifyPassword[2m > [22mshould hash a password [33m 2532[2mms[22m[39m
   [33m[2mâœ“[22m[39m Authentication Utilities[2m > [22mhashPassword and verifyPassword[2m > [22mshould produce different hashes for same password [33m 1924[2mms[22m[39m
   [33m[2mâœ“[22m[39m Authentication Utilities[2m > [22mhashPassword and verifyPassword[2m > [22mshould verify correct password [33m 1872[2mms[22m[39m
   [33m[2mâœ“[22m[39m Authentication Utilities[2m > [22mhashPassword and verifyPassword[2m > [22mshould reject incorrect password [33m 2099[2mms[22m[39m
   [33m[2mâœ“[22m[39m Authentication Utilities[2m > [22mhashPassword and verifyPassword[2m > [22mshould handle empty passwords [33m 3376[2mms[22m[39m
   [33m[2mâœ“[22m[39m Authentication Utilities[2m > [22mhashPassword and verifyPassword[2m > [22mshould be case sensitive [33m 1831[2mms[22m[39m
   [33m[2mâœ“[22m[39m Authentication Utilities[2m > [22mhashPassword and verifyPassword[2m > [22mshould handle long passwords [33m 1829[2mms[22m[39m
   [33m[2mâœ“[22m[39m Authentication Utilities[2m > [22mAUTH_CONFIG[2m > [22mshould have valid configuration values [33m 1840[2mms[22m[39m
   [33m[2mâœ“[22m[39m Authentication Utilities[2m > [22mAUTH_CONFIG[2m > [22mshould have password requirements defined [33m 2109[2mms[22m[39m
   [33m[2mâœ“[22m[39m Authentication Utilities[2m > [22mAUTH_CONFIG[2m > [22mshould have rate limit configuration [33m 1438[2mms[22m[39m
[90mstdout[2m | tests/submission-packages.test.js
[22m[39m
ðŸ§ª Setting up test environment...

[90mstdout[2m | tests/submission-packages.test.js
[22m[39mâœ“ Test database connected

[90mstdout[2m | tests/submission-packages.test.js
[22m[39m  Applying base schema...

[90mstdout[2m | tests/submission-packages.test.js
[22m[39m  âœ“ Schema and migrations applied

[90mstdout[2m | tests/submission-packages.test.js
[22m[39mâœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

[90mstdout[2m | tests/submission-packages.test.js
[22m[39mâœ“ Test database initialized
âœ“ Test environment ready


[90mstdout[2m | tests/submission-packages.test.js
[22m[39m
ðŸ§¹ Tearing down test environment...

[90mstdout[2m | tests/submission-packages.test.js
[22m[39mâœ“ Test database cleaned

[90mstdout[2m | tests/submission-packages.test.js
[22m[39mâœ“ Database adapter closed

[90mstdout[2m | tests/submission-packages.test.js
[22m[39mâœ“ Test database disconnected

[90mstdout[2m | tests/submission-packages.test.js
[22m[39mâœ“ Test database cleaned up
âœ“ Test environment cleaned up


 [32mâœ“[39m tests/submission-packages.test.js [2m([22m[2m31 tests[22m[2m)[22m[33m 62503[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mPackage Templates[2m > [22mshould have agent query template [33m 1436[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mPackage Templates[2m > [22mshould have full manuscript template [33m 1477[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mPackage Templates[2m > [22mshould have query only template [33m 1940[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mPackage Templates[2m > [22mshould have contest template [33m 1401[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mPackage Templates[2m > [22mshould validate required documents [33m 1422[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mPackage Creation[2m > [22mshould create package with metadata [33m 1465[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mPackage Creation[2m > [22mshould include document list with ordering [33m 2353[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mPackage Creation[2m > [22mshould validate package has at least one document [33m 1593[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mPackage Creation[2m > [22mshould allow custom package names [33m 1426[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mDocument Selection[2m > [22mshould allow selecting multiple documents [33m 1548[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mDocument Selection[2m > [22mshould maintain document order [33m 1464[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mDocument Selection[2m > [22mshould allow reordering documents [33m 1387[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mZIP File Generation[2m > [22mshould generate ZIP with multiple files [33m 3757[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mZIP File Generation[2m > [22mshould prefix files with order numbers [33m 1379[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mZIP File Generation[2m > [22mshould sanitize filenames [33m 1473[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mZIP File Generation[2m > [22mshould support different file formats [33m 1467[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mZIP File Generation[2m > [22mshould include metadata file in ZIP [33m 2270[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mPackage Duplication[2m > [22mshould create copy of existing package [33m 1390[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mPackage Duplication[2m > [22mshould increment copy counter in name [33m 1464[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mPackage Management[2m > [22mshould list packages for manuscript [33m 2074[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mPackage Management[2m > [22mshould update package details [33m 1467[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mPackage Management[2m > [22mshould delete package [33m 3125[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mValidation[2m > [22mshould validate package has required documents [33m 1376[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mValidation[2m > [22mshould validate document exists before adding to package [33m 1471[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mValidation[2m > [22mshould prevent duplicate documents in package [33m 1459[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mDownload Tracking[2m > [22mshould track download count [33m 2221[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mDownload Tracking[2m > [22mshould track last downloaded timestamp [33m 1471[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mEdge Cases[2m > [22mshould handle empty package name [33m 1408[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mEdge Cases[2m > [22mshould handle very long package name [33m 2512[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mEdge Cases[2m > [22mshould handle package with only one document [33m 1457[2mms[22m[39m
   [33m[2mâœ“[22m[39m Submission Package Bundler[2m > [22mEdge Cases[2m > [22mshould handle large file sizes [33m 2134[2mms[22m[39m
[90mstdout[2m | tests/document-generation.test.js
[22m[39m
ðŸ§ª Setting up test environment...

[90mstdout[2m | tests/document-generation.test.js
[22m[39mâœ“ Test database connected

[90mstdout[2m | tests/document-generation.test.js
[22m[39m  Applying base schema...

[90mstdout[2m | tests/document-generation.test.js
[22m[39m  âœ“ Schema and migrations applied

[90mstdout[2m | tests/document-generation.test.js
[22m[39mâœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

[90mstdout[2m | tests/document-generation.test.js
[22m[39mâœ“ Test database initialized
âœ“ Test environment ready


[90mstdout[2m | tests/document-generation.test.js
[22m[39m
ðŸ§¹ Tearing down test environment...

[90mstdout[2m | tests/document-generation.test.js
[22m[39mâœ“ Test database cleaned

[90mstdout[2m | tests/document-generation.test.js
[22m[39mâœ“ Database adapter closed

[90mstdout[2m | tests/document-generation.test.js
[22m[39mâœ“ Test database disconnected

[90mstdout[2m | tests/document-generation.test.js
[22m[39mâœ“ Test database cleaned up
âœ“ Test environment cleaned up


 [32mâœ“[39m tests/document-generation.test.js [2m([22m[2m27 tests[22m[2m)[22m[33m 52967[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mQuery Letter Generation[2m > [22mshould generate query letter within word count range [33m 1371[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mQuery Letter Generation[2m > [22mshould include essential query letter components [33m 1588[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mQuery Letter Generation[2m > [22mshould validate query letter structure [33m 2190[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mQuery Letter Generation[2m > [22mshould reject query letters that are too short [33m 1470[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mQuery Letter Generation[2m > [22mshould reject query letters that are too long [33m 1313[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mSynopsis Generation[2m > [22mshould generate short synopsis at 500 words [33m 1363[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mSynopsis Generation[2m > [22mshould generate long synopsis at 2500 words [33m 2099[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mSynopsis Generation[2m > [22mshould include beginning, middle, and end [33m 2426[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mSynopsis Generation[2m > [22mshould reveal ending (unlike blurb) [33m 1444[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mSynopsis Generation[2m > [22mshould maintain chronological order [33m 2032[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mVersion Management[2m > [22mshould create new version on update [33m 1544[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mVersion Management[2m > [22mshould track version metadata [33m 1411[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mVersion Management[2m > [22mshould allow rollback to previous version [33m 1810[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mVersion Management[2m > [22mshould maintain version history after rollback [33m 1785[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mDocument Validation[2m > [22mshould validate document type [33m 1281[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mDocument Validation[2m > [22mshould reject invalid document type [33m 2974[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mDocument Validation[2m > [22mshould validate required fields [33m 1287[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mDocument Validation[2m > [22mshould calculate word count accurately [33m 1293[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mDocument Validation[2m > [22mshould handle empty document [33m 1282[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mAI Generation Metadata[2m > [22mshould track generation parameters [33m 1906[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mAI Generation Metadata[2m > [22mshould calculate cost based on token usage [33m 1296[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mBatch Generation[2m > [22mshould generate all document types at once [33m 1326[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mBatch Generation[2m > [22mshould track individual generation status [33m 1286[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mEdge Cases[2m > [22mshould handle very short manuscript title [33m 1870[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mEdge Cases[2m > [22mshould handle very long manuscript title [33m 1622[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mEdge Cases[2m > [22mshould handle special characters in content [33m 1304[2mms[22m[39m
   [33m[2mâœ“[22m[39m Document Generation[2m > [22mEdge Cases[2m > [22mshould handle unicode characters [33m 3506[2mms[22m[39m
[90mstdout[2m | tests/unit/test-helpers.test.js
[22m[39m
ðŸ§ª Setting up test environment...

[90mstdout[2m | tests/unit/test-helpers.test.js
[22m[39mâœ“ Test database connected

[90mstdout[2m | tests/unit/test-helpers.test.js
[22m[39m  Applying base schema...

[90mstdout[2m | tests/unit/test-helpers.test.js
[22m[39m  âœ“ Schema and migrations applied

[90mstdout[2m | tests/unit/test-helpers.test.js
[22m[39mâœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

[90mstdout[2m | tests/unit/test-helpers.test.js
[22m[39mâœ“ Test database initialized
âœ“ Test environment ready


[90mstdout[2m | tests/unit/test-helpers.test.js
[22m[39m
ðŸ§¹ Tearing down test environment...

[90mstdout[2m | tests/unit/test-helpers.test.js
[22m[39mâœ“ Test database cleaned

[90mstdout[2m | tests/unit/test-helpers.test.js
[22m[39mâœ“ Database adapter closed

[90mstdout[2m | tests/unit/test-helpers.test.js
[22m[39mâœ“ Test database disconnected

[90mstdout[2m | tests/unit/test-helpers.test.js
[22m[39mâœ“ Test database cleaned up
âœ“ Test environment cleaned up


 [32mâœ“[39m tests/unit/test-helpers.test.js [2m([22m[2m24 tests[22m[2m)[22m[33m 51492[2mms[22m[39m
   [33m[2mâœ“[22m[39m Mock Factories[2m > [22mStorage Adapter Mock[2m > [22mshould put and get objects [33m 1343[2mms[22m[39m
   [33m[2mâœ“[22m[39m Mock Factories[2m > [22mStorage Adapter Mock[2m > [22mshould delete objects [33m 1480[2mms[22m[39m
   [33m[2mâœ“[22m[39m Mock Factories[2m > [22mStorage Adapter Mock[2m > [22mshould list objects by prefix [33m 1668[2mms[22m[39m
   [33m[2mâœ“[22m[39m Mock Factories[2m > [22mRedis Mock[2m > [22mshould set and get values [33m 1644[2mms[22m[39m
   [33m[2mâœ“[22m[39m Mock Factories[2m > [22mRedis Mock[2m > [22mshould set values with expiration [33m 2099[2mms[22m[39m
   [33m[2mâœ“[22m[39m Mock Factories[2m > [22mRedis Mock[2m > [22mshould delete keys [33m 2007[2mms[22m[39m
   [33m[2mâœ“[22m[39m Mock Factories[2m > [22mRedis Mock[2m > [22mshould increment values [33m 2034[2mms[22m[39m
   [33m[2mâœ“[22m[39m Mock Factories[2m > [22mClaude API Mock[2m > [22mshould return mock AI responses [33m 2108[2mms[22m[39m
   [33m[2mâœ“[22m[39m Mock Factories[2m > [22mClaude API Mock[2m > [22mshould include custom response text [33m 1604[2mms[22m[39m
   [33m[2mâœ“[22m[39m Mock Factories[2m > [22mEmail Service Mock[2m > [22mshould track sent emails [33m 1886[2mms[22m[39m
   [33m[2mâœ“[22m[39m Mock Factories[2m > [22mEmail Service Mock[2m > [22mshould find emails by recipient [33m 1926[2mms[22m[39m
   [33m[2mâœ“[22m[39m Mock Factories[2m > [22mEmail Service Mock[2m > [22mshould clear sent emails [33m 1639[2mms[22m[39m
   [33m[2mâœ“[22m[39m Mock Factories[2m > [22mStripe Mock[2m > [22mshould create checkout sessions [33m 1657[2mms[22m[39m
   [33m[2mâœ“[22m[39m Mock Factories[2m > [22mStripe Mock[2m > [22mshould create payment intents [33m 2348[2mms[22m[39m
   [33m[2mâœ“[22m[39m Mock Factories[2m > [22mStripe Mock[2m > [22mshould construct webhook events [33m 1950[2mms[22m[39m
   [33m[2mâœ“[22m[39m Test Data Factories[2m > [22mUser Factory[2m > [22mshould create valid user data [33m 1734[2mms[22m[39m
   [33m[2mâœ“[22m[39m Test Data Factories[2m > [22mUser Factory[2m > [22mshould accept overrides [33m 2201[2mms[22m[39m
   [33m[2mâœ“[22m[39m Test Data Factories[2m > [22mManuscript Factory[2m > [22mshould create valid manuscript data [33m 2335[2mms[22m[39m
   [33m[2mâœ“[22m[39m Test Data Factories[2m > [22mManuscript Factory[2m > [22mshould accept overrides [33m 1726[2mms[22m[39m
   [33m[2mâœ“[22m[39m Test Data Factories[2m > [22mAnalysis Factory[2m > [22mshould create valid analysis data [33m 1655[2mms[22m[39m
   [33m[2mâœ“[22m[39m Test Data Factories[2m > [22mAnalysis Factory[2m > [22mshould include result JSON [33m 1602[2mms[22m[39m
   [33m[2mâœ“[22m[39m Test Data Factories[2m > [22mPayment Factory[2m > [22mshould create valid payment data [33m 1629[2mms[22m[39m
   [33m[2mâœ“[22m[39m Test Data Factories[2m > [22mUtility Functions[2m > [22mshould generate unique email addresses [33m 2172[2mms[22m[39m
   [33m[2mâœ“[22m[39m Test Data Factories[2m > [22mUtility Functions[2m > [22mshould generate unique IDs [33m 2178[2mms[22m[39m
[90mstdout[2m | tests/metadata-handlers.test.js
[22m[39m
ðŸ§ª Setting up test environment...

[90mstdout[2m | tests/metadata-handlers.test.js
[22m[39mâœ“ Test database connected

[90mstdout[2m | tests/metadata-handlers.test.js
[22m[39m  Applying base schema...

[90mstdout[2m | tests/metadata-handlers.test.js
[22m[39m  âœ“ Schema and migrations applied

[90mstdout[2m | tests/metadata-handlers.test.js
[22m[39mâœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

[90mstdout[2m | tests/metadata-handlers.test.js
[22m[39mâœ“ Test database initialized
âœ“ Test environment ready


[90mstdout[2m | tests/metadata-handlers.test.js
[22m[39m
ðŸ§¹ Tearing down test environment...

[90mstdout[2m | tests/metadata-handlers.test.js
[22m[39mâœ“ Test database cleaned

[90mstdout[2m | tests/metadata-handlers.test.js
[22m[39mâœ“ Database adapter closed

[90mstdout[2m | tests/metadata-handlers.test.js
[22m[39mâœ“ Test database disconnected

[90mstdout[2m | tests/metadata-handlers.test.js
[22m[39mâœ“ Test database cleaned up
âœ“ Test environment cleaned up


 [32mâœ“[39m tests/metadata-handlers.test.js [2m([22m[2m21 tests[22m[2m)[22m[33m 51972[2mms[22m[39m
   [33m[2mâœ“[22m[39m Enhanced Metadata Handlers[2m > [22mGenre Validation[2m > [22mshould validate word count for romance novel [33m 1736[2mms[22m[39m
   [33m[2mâœ“[22m[39m Enhanced Metadata Handlers[2m > [22mGenre Validation[2m > [22mshould flag word count outside genre norms [33m 1671[2mms[22m[39m
   [33m[2mâœ“[22m[39m Enhanced Metadata Handlers[2m > [22mGenre Validation[2m > [22mshould accept novella word counts for appropriate genres [33m 2697[2mms[22m[39m
   [33m[2mâœ“[22m[39m Enhanced Metadata Handlers[2m > [22mContent Warning Validation[2m > [22mshould validate content warning categories [33m 1667[2mms[22m[39m
   [33m[2mâœ“[22m[39m Enhanced Metadata Handlers[2m > [22mContent Warning Validation[2m > [22mshould validate severity levels [33m 1560[2mms[22m[39m
   [33m[2mâœ“[22m[39m Enhanced Metadata Handlers[2m > [22mContent Warning Validation[2m > [22mshould handle multiple content warnings [33m 2899[2mms[22m[39m
   [33m[2mâœ“[22m[39m Enhanced Metadata Handlers[2m > [22mMetadata Structure[2m > [22mshould validate primary genre and subgenres [33m 1676[2mms[22m[39m
   [33m[2mâœ“[22m[39m Enhanced Metadata Handlers[2m > [22mMetadata Structure[2m > [22mshould validate age category [33m 1790[2mms[22m[39m
   [33m[2mâœ“[22m[39m Enhanced Metadata Handlers[2m > [22mMetadata Structure[2m > [22mshould validate manuscript status [33m 2303[2mms[22m[39m
   [33m[2mâœ“[22m[39m Enhanced Metadata Handlers[2m > [22mMetadata Structure[2m > [22mshould validate series information [33m 1692[2mms[22m[39m
   [33m[2mâœ“[22m[39m Enhanced Metadata Handlers[2m > [22mMetadata History Tracking[2m > [22mshould record metadata changes with timestamp [33m 2515[2mms[22m[39m
   [33m[2mâœ“[22m[39m Enhanced Metadata Handlers[2m > [22mMetadata History Tracking[2m > [22mshould track multiple change types [33m 1631[2mms[22m[39m
   [33m[2mâœ“[22m[39m Enhanced Metadata Handlers[2m > [22mGenre Hierarchy[2m > [22mshould validate parent-child genre relationships [33m 1631[2mms[22m[39m
   [33m[2mâœ“[22m[39m Enhanced Metadata Handlers[2m > [22mGenre Hierarchy[2m > [22mshould handle subgenre depth [33m 2548[2mms[22m[39m
   [33m[2mâœ“[22m[39m Enhanced Metadata Handlers[2m > [22mWord Count Validation Logic[2m > [22mshould categorize flash fiction correctly [33m 1829[2mms[22m[39m
   [33m[2mâœ“[22m[39m Enhanced Metadata Handlers[2m > [22mWord Count Validation Logic[2m > [22mshould categorize novel correctly [33m 1695[2mms[22m[39m
   [33m[2mâœ“[22m[39m Enhanced Metadata Handlers[2m > [22mWord Count Validation Logic[2m > [22mshould categorize epic correctly [33m 3803[2mms[22m[39m
   [33m[2mâœ“[22m[39m Enhanced Metadata Handlers[2m > [22mEdge Cases[2m > [22mshould handle missing optional metadata fields [33m 1912[2mms[22m[39m
   [33m[2mâœ“[22m[39m Enhanced Metadata Handlers[2m > [22mEdge Cases[2m > [22mshould handle empty subgenres array [33m 1814[2mms[22m[39m
   [33m[2mâœ“[22m[39m Enhanced Metadata Handlers[2m > [22mEdge Cases[2m > [22mshould validate completion percentage range [33m 1665[2mms[22m[39m
   [33m[2mâœ“[22m[39m Enhanced Metadata Handlers[2m > [22mEdge Cases[2m > [22mshould reject invalid completion percentage [33m 1600[2mms[22m[39m
[90mstdout[2m | tests/error-handling.test.js
[22m[39m
ðŸ§ª Setting up test environment...

[90mstdout[2m | tests/error-handling.test.js
[22m[39mâœ“ Test database connected

[90mstdout[2m | tests/error-handling.test.js
[22m[39m  Applying base schema...

[90mstdout[2m | tests/error-handling.test.js
[22m[39m  âœ“ Schema and migrations applied

[90mstdout[2m | tests/error-handling.test.js
[22m[39mâœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

[90mstdout[2m | tests/error-handling.test.js
[22m[39mâœ“ Test database initialized
âœ“ Test environment ready


[90mstdout[2m | tests/error-handling.test.js
[22m[39m
ðŸ§¹ Tearing down test environment...

[90mstdout[2m | tests/error-handling.test.js
[22m[39mâœ“ Test database cleaned

[90mstdout[2m | tests/error-handling.test.js
[22m[39mâœ“ Database adapter closed

[90mstdout[2m | tests/error-handling.test.js
[22m[39mâœ“ Test database disconnected

[90mstdout[2m | tests/error-handling.test.js
[22m[39mâœ“ Test database cleaned up
âœ“ Test environment cleaned up


 [32mâœ“[39m tests/error-handling.test.js [2m([22m[2m24 tests[22m[2m)[22m[33m 56807[2mms[22m[39m
   [33m[2mâœ“[22m[39m Error Handling[2m > [22mError Classes[2m > [22mshould create AppError with correct properties [33m 1734[2mms[22m[39m
   [33m[2mâœ“[22m[39m Error Handling[2m > [22mError Classes[2m > [22mshould serialize AppError to JSON correctly [33m 1807[2mms[22m[39m
   [33m[2mâœ“[22m[39m Error Handling[2m > [22mError Classes[2m > [22mshould create AuthenticationError with 401 status [33m 2760[2mms[22m[39m
   [33m[2mâœ“[22m[39m Error Handling[2m > [22mError Classes[2m > [22mshould create AuthorizationError with 403 status [33m 1652[2mms[22m[39m
   [33m[2mâœ“[22m[39m Error Handling[2m > [22mError Classes[2m > [22mshould create ValidationError with 400 status [33m 1794[2mms[22m[39m
   [33m[2mâœ“[22m[39m Error Handling[2m > [22mError Classes[2m > [22mshould create NotFoundError with 404 status [33m 1672[2mms[22m[39m
   [33m[2mâœ“[22m[39m Error Handling[2m > [22mError Classes[2m > [22mshould create RateLimitError with 429 status [33m 1667[2mms[22m[39m
   [33m[2mâœ“[22m[39m Error Handling[2m > [22mError Classes[2m > [22mshould create ConflictError with 409 status [33m 1773[2mms[22m[39m
   [33m[2mâœ“[22m[39m Error Handling[2m > [22mError Classes[2m > [22mshould create ServerError with 500 status [33m 2588[2mms[22m[39m
   [33m[2mâœ“[22m[39m Error Handling[2m > [22mError Classes[2m > [22mshould create ExternalServiceError with service name [33m 1660[2mms[22m[39m
   [33m[2mâœ“[22m[39m Error Handling[2m > [22mcreateErrorResponse[2m > [22mshould create Response with correct status and JSON [33m 2731[2mms[22m[39m
   [33m[2mâœ“[22m[39m Error Handling[2m > [22mcreateErrorResponse[2m > [22mshould handle generic Error objects [33m 1681[2mms[22m[39m
   [33m[2mâœ“[22m[39m Error Handling[2m > [22mcreateErrorResponse[2m > [22mshould include Retry-After header for rate limit errors [33m 1650[2mms[22m[39m
   [33m[2mâœ“[22m[39m Error Handling[2m > [22mcreateErrorResponse[2m > [22mshould merge additional headers [33m 4632[2mms[22m[39m
   [33m[2mâœ“[22m[39m Error Handling[2m > [22mAssertion Helpers[2m > [22massert should not throw when condition is true [33m 1970[2mms[22m[39m
   [33m[2mâœ“[22m[39m Error Handling[2m > [22mAssertion Helpers[2m > [22massert should throw ValidationError when condition is false [33m 1948[2mms[22m[39m
   [33m[2mâœ“[22m[39m Error Handling[2m > [22mAssertion Helpers[2m > [22massert should include details in error [33m 1675[2mms[22m[39m
   [33m[2mâœ“[22m[39m Error Handling[2m > [22mAssertion Helpers[2m > [22massertAuthenticated should not throw when userId exists [33m 2604[2mms[22m[39m
   [33m[2mâœ“[22m[39m Error Handling[2m > [22mAssertion Helpers[2m > [22massertAuthenticated should throw when userId is null [33m 1652[2mms[22m[39m
   [33m[2mâœ“[22m[39m Error Handling[2m > [22mAssertion Helpers[2m > [22massertAuthenticated should throw when userId is undefined [33m 1629[2mms[22m[39m
   [33m[2mâœ“[22m[39m Error Handling[2m > [22mAssertion Helpers[2m > [22massertAuthorized should not throw when permission is true [33m 2808[2mms[22m[39m
   [33m[2mâœ“[22m[39m Error Handling[2m > [22mAssertion Helpers[2m > [22massertAuthorized should throw when permission is false [33m 2090[2mms[22m[39m
   [33m[2mâœ“[22m[39m Error Handling[2m > [22mError Inheritance[2m > [22mshould maintain instanceof relationships [33m 1841[2mms[22m[39m
   [33m[2mâœ“[22m[39m Error Handling[2m > [22mError Inheritance[2m > [22mshould have correct error names [33m 2124[2mms[22m[39m
[90mstdout[2m | tests/integration/webhook-signature-verification.test.js
[22m[39m
ðŸ§ª Setting up test environment...

[90mstdout[2m | tests/integration/webhook-signature-verification.test.js
[22m[39mâœ“ Test database connected

[90mstdout[2m | tests/integration/webhook-signature-verification.test.js
[22m[39m  Applying base schema...

[90mstdout[2m | tests/integration/webhook-signature-verification.test.js
[22m[39m  âœ“ Schema and migrations applied

[90mstdout[2m | tests/integration/webhook-signature-verification.test.js
[22m[39mâœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

[90mstdout[2m | tests/integration/webhook-signature-verification.test.js
[22m[39mâœ“ Test database initialized
âœ“ Test environment ready


[90mstdout[2m | tests/integration/webhook-signature-verification.test.js[2m > [22m[2mWebhook Signature Verification[2m > [22m[2mValid Signatures[2m > [22m[2mshould accept webhook with valid signature
[22m[39m[Webhook] Processing event: checkout.session.completed evt_test_1447f1768fa1480202c09a02
[Webhook] Checkout completed for user: user-123 plan: [90mundefined[39m

[90mstdout[2m | tests/integration/webhook-signature-verification.test.js[2m > [22m[2mWebhook Signature Verification[2m > [22m[2mValid Signatures[2m > [22m[2mshould accept webhook with valid signature
[22m[39m[Webhook] One-time payment recorded: d163649f-74b4-45f9-a6f2-4d96de90175c

[90mstderr[2m | tests/integration/webhook-signature-verification.test.js[2m > [22m[2mWebhook Signature Verification[2m > [22m[2mValid Signatures[2m > [22m[2mshould accept webhook with valid signature
[22m[39m[Budget] Error updating spend: TypeError: env.DB.prepare(...).first is not a function
    at updateBudgetSpend [90m(D:\manuscript-platform\[39msrc\utils\cost-utils.js:226:85[90m)[39m
    at logCost [90m(D:\manuscript-platform\[39msrc\utils\cost-utils.js:164:11[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at handleCheckoutCompleted [90m(D:\manuscript-platform\[39msrc\handlers\webhook-handlers.js:181:7[90m)[39m
    at handleStripeWebhook [90m(D:\manuscript-platform\[39msrc\handlers\webhook-handlers.js:54:9[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\webhook-signature-verification.test.js:107:26

[90mstderr[2m | tests/integration/webhook-signature-verification.test.js[2m > [22m[2mWebhook Signature Verification[2m > [22m[2mValid Signatures[2m > [22m[2mshould accept webhook with valid signature
[22m[39m[Budget] Error updating user spend: TypeError: Cannot read properties of null (reading 'current_spend_usd')
    at updateUserSpend [90m(D:\manuscript-platform\[39msrc\utils\cost-utils.js:291:34[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at logCost [90m(D:\manuscript-platform\[39msrc\utils\cost-utils.js:168:7[90m)[39m
    at handleCheckoutCompleted [90m(D:\manuscript-platform\[39msrc\handlers\webhook-handlers.js:181:7[90m)[39m
    at handleStripeWebhook [90m(D:\manuscript-platform\[39msrc\handlers\webhook-handlers.js:54:9[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\webhook-signature-verification.test.js:107:26

[90mstdout[2m | tests/integration/webhook-signature-verification.test.js[2m > [22m[2mWebhook Signature Verification[2m > [22m[2mValid Signatures[2m > [22m[2mshould accept webhook with valid signature
[22m[39m[Cost Tracking] Logged stripe_fees/payment_processing/one_time_payment: $1.1697

[90mstdout[2m | tests/integration/webhook-signature-verification.test.js[2m > [22m[2mWebhook Signature Verification[2m > [22m[2mValid Signatures[2m > [22m[2mshould accept webhook with recent timestamp (within 5 min)
[22m[39m[Webhook] Processing event: checkout.session.completed evt_test_dfe266dd1f7d22452579c86f
[Webhook] Checkout completed for user: [90mundefined[39m plan: [90mundefined[39m

[90mstdout[2m | tests/integration/webhook-signature-verification.test.js[2m > [22m[2mWebhook Signature Verification[2m > [22m[2mValid Signatures[2m > [22m[2mshould accept webhook with recent timestamp (within 5 min)
[22m[39m[Webhook] One-time payment recorded: 94f05e7d-1e63-4a4e-8128-1a164fb890f0

[90mstderr[2m | tests/integration/webhook-signature-verification.test.js[2m > [22m[2mWebhook Signature Verification[2m > [22m[2mValid Signatures[2m > [22m[2mshould accept webhook with recent timestamp (within 5 min)
[22m[39m[Budget] Error updating spend: TypeError: env.DB.prepare(...).first is not a function
    at updateBudgetSpend [90m(D:\manuscript-platform\[39msrc\utils\cost-utils.js:226:85[90m)[39m
    at logCost [90m(D:\manuscript-platform\[39msrc\utils\cost-utils.js:164:11[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at handleCheckoutCompleted [90m(D:\manuscript-platform\[39msrc\handlers\webhook-handlers.js:181:7[90m)[39m
    at handleStripeWebhook [90m(D:\manuscript-platform\[39msrc\handlers\webhook-handlers.js:54:9[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\webhook-signature-verification.test.js:107:26

[90mstdout[2m | tests/integration/webhook-signature-verification.test.js[2m > [22m[2mWebhook Signature Verification[2m > [22m[2mValid Signatures[2m > [22m[2mshould accept webhook with recent timestamp (within 5 min)
[22m[39m[Cost Tracking] Logged stripe_fees/payment_processing/one_time_payment: $1.1697

[90mstderr[2m | tests/integration/webhook-signature-verification.test.js[2m > [22m[2mWebhook Signature Verification[2m > [22m[2mInvalid Signatures[2m > [22m[2mshould reject webhook with incorrect signature
[22m[39m[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[90mstderr[2m | tests/integration/webhook-signature-verification.test.js[2m > [22m[2mWebhook Signature Verification[2m > [22m[2mInvalid Signatures[2m > [22m[2mshould reject webhook with malformed signature format
[22m[39m[Webhook] Signature verification failed: No signatures found with expected scheme

[90mstderr[2m | tests/integration/webhook-signature-verification.test.js[2m > [22m[2mWebhook Signature Verification[2m > [22m[2mInvalid Signatures[2m > [22m[2mshould reject webhook with tampered payload
[22m[39m[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[90mstderr[2m | tests/integration/webhook-signature-verification.test.js[2m > [22m[2mWebhook Signature Verification[2m > [22m[2mReplay Attack Prevention[2m > [22m[2mshould reject webhook with expired timestamp (>5 min old)
[22m[39m[Webhook] Signature verification failed: Timestamp outside the tolerance zone

[90mstdout[2m | tests/integration/webhook-signature-verification.test.js[2m > [22m[2mWebhook Signature Verification[2m > [22m[2mReplay Attack Prevention[2m > [22m[2mshould accept webhook with future timestamp (Stripe allows clock skew)
[22m[39m[Webhook] Processing event: checkout.session.completed evt_test_918464f423b10d5c0eea40e3
[Webhook] Checkout completed for user: [90mundefined[39m plan: [90mundefined[39m

[90mstdout[2m | tests/integration/webhook-signature-verification.test.js[2m > [22m[2mWebhook Signature Verification[2m > [22m[2mReplay Attack Prevention[2m > [22m[2mshould accept webhook with future timestamp (Stripe allows clock skew)
[22m[39m[Webhook] One-time payment recorded: 58bc39ca-3293-4d42-8593-9d96d9c3791f

[90mstderr[2m | tests/integration/webhook-signature-verification.test.js[2m > [22m[2mWebhook Signature Verification[2m > [22m[2mReplay Attack Prevention[2m > [22m[2mshould accept webhook with future timestamp (Stripe allows clock skew)
[22m[39m[Budget] Error updating spend: TypeError: env.DB.prepare(...).first is not a function
    at updateBudgetSpend [90m(D:\manuscript-platform\[39msrc\utils\cost-utils.js:226:85[90m)[39m
    at logCost [90m(D:\manuscript-platform\[39msrc\utils\cost-utils.js:164:11[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at handleCheckoutCompleted [90m(D:\manuscript-platform\[39msrc\handlers\webhook-handlers.js:181:7[90m)[39m
    at handleStripeWebhook [90m(D:\manuscript-platform\[39msrc\handlers\webhook-handlers.js:54:9[90m)[39m
    at [90mD:\manuscript-platform\[39mtests\integration\webhook-signature-verification.test.js:107:26

[90mstdout[2m | tests/integration/webhook-signature-verification.test.js[2m > [22m[2mWebhook Signature Verification[2m > [22m[2mReplay Attack Prevention[2m > [22m[2mshould accept webhook with future timestamp (Stripe allows clock skew)
[22m[39m[Cost Tracking] Logged stripe_fees/payment_processing/one_time_payment: $1.1697

[90mstdout[2m | tests/integration/webhook-signature-verification.test.js
[22m[39m
ðŸ§¹ Tearing down test environment...

[90mstdout[2m | tests/integration/webhook-signature-verification.test.js
[22m[39mâœ“ Test database cleaned

[90mstdout[2m | tests/integration/webhook-signature-verification.test.js
[22m[39mâœ“ Database adapter closed

[90mstdout[2m | tests/integration/webhook-signature-verification.test.js
[22m[39mâœ“ Test database disconnected

[90mstdout[2m | tests/integration/webhook-signature-verification.test.js
[22m[39mâœ“ Test database cleaned up
âœ“ Test environment cleaned up


 [32mâœ“[39m tests/integration/webhook-signature-verification.test.js [2m([22m[2m9 tests[22m[2m)[22m[33m 29580[2mms[22m[39m
   [33m[2mâœ“[22m[39m Webhook Signature Verification[2m > [22mValid Signatures[2m > [22mshould accept webhook with valid signature [33m 1950[2mms[22m[39m
   [33m[2mâœ“[22m[39m Webhook Signature Verification[2m > [22mValid Signatures[2m > [22mshould accept webhook with recent timestamp (within 5 min) [33m 1755[2mms[22m[39m
   [33m[2mâœ“[22m[39m Webhook Signature Verification[2m > [22mMissing Signature[2m > [22mshould reject webhook with no signature header [33m 1737[2mms[22m[39m
   [33m[2mâœ“[22m[39m Webhook Signature Verification[2m > [22mMissing Signature[2m > [22mshould reject webhook with empty signature [33m 2632[2mms[22m[39m
   [33m[2mâœ“[22m[39m Webhook Signature Verification[2m > [22mInvalid Signatures[2m > [22mshould reject webhook with incorrect signature [33m 1813[2mms[22m[39m
   [33m[2mâœ“[22m[39m Webhook Signature Verification[2m > [22mInvalid Signatures[2m > [22mshould reject webhook with malformed signature format [33m 3631[2mms[22m[39m
   [33m[2mâœ“[22m[39m Webhook Signature Verification[2m > [22mInvalid Signatures[2m > [22mshould reject webhook with tampered payload [33m 2847[2mms[22m[39m
   [33m[2mâœ“[22m[39m Webhook Signature Verification[2m > [22mReplay Attack Prevention[2m > [22mshould reject webhook with expired timestamp (>5 min old) [33m 3083[2mms[22m[39m
   [33m[2mâœ“[22m[39m Webhook Signature Verification[2m > [22mReplay Attack Prevention[2m > [22mshould accept webhook with future timestamp (Stripe allows clock skew) [33m 2562[2mms[22m[39m

[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m[1m[41m Failed Tests 108 [49m[22m[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m

[41m[1m FAIL [22m[49m tests/integration/infrastructure.test.js[2m > [22mTest Infrastructure[2m > [22mDatabase Utilities[2m > [22mshould insert and retrieve test records
[31m[1merror[22m: invalid input syntax for type integer: "true"[39m
[90m [2mâ¯[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[36m [2mâ¯[22m insertTestRecord tests/test-helpers/database.js:[2m205:18[22m[39m
    [90m203| [39m  `[39m[33m;[39m
    [90m204| [39m
    [90m205| [39m  [35mconst[39m result [33m=[39m [35mawait[39m testDb[33m.[39m[34mquery[39m(query[33m,[39m values)[33m;[39m
    [90m   | [39m                 [31m^[39m
    [90m206| [39m  [35mreturn[39m result[33m.[39mrows[[34m0[39m][33m;[39m
    [90m207| [39m}
[90m [2mâ¯[22m tests/integration/infrastructure.test.js:[2m22:24[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[1/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/infrastructure.test.js[2m > [22mTest Infrastructure[2m > [22mDatabase Utilities[2m > [22mshould count test records
[31m[1merror[22m: invalid input syntax for type integer: "true"[39m
[90m [2mâ¯[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[36m [2mâ¯[22m insertTestRecord tests/test-helpers/database.js:[2m205:18[22m[39m
    [90m203| [39m  `[39m[33m;[39m
    [90m204| [39m
    [90m205| [39m  [35mconst[39m result [33m=[39m [35mawait[39m testDb[33m.[39m[34mquery[39m(query[33m,[39m values)[33m;[39m
    [90m   | [39m                 [31m^[39m
    [90m206| [39m  [35mreturn[39m result[33m.[39mrows[[34m0[39m][33m;[39m
    [90m207| [39m}
[90m [2mâ¯[22m tests/integration/infrastructure.test.js:[2m36:7[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[2/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/infrastructure.test.js[2m > [22mTest Infrastructure[2m > [22mAPI Client[2m > [22mshould make HTTP requests
[31m[1mAssertionError[22m: expected 503 to be less than or equal to 404[39m
[36m [2mâ¯[22m tests/integration/infrastructure.test.js:[2m62:31[22m[39m
    [90m 60| [39m
    [90m 61| [39m      [90m// Health endpoint should exist and return 200[39m
    [90m 62| [39m      expect(response.status).toBeLessThanOrEqual(404); // Either 200 â€¦
    [90m   | [39m                              [31m^[39m
    [90m 63| [39m    })[33m;[39m
    [90m 64| [39m  })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[3/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/infrastructure.test.js[2m > [22mTest Infrastructure[2m > [22mMock Factories[2m > [22mshould create mock Redis client with expiration
[31m[1mAssertionError[22m: expected -2 to be greater than 0[39m
[36m [2mâ¯[22m tests/integration/infrastructure.test.js:[2m87:19[22m[39m
    [90m 85| [39m
    [90m 86| [39m      [35mconst[39m ttl [33m=[39m [35mawait[39m redis[33m.[39m[34mttl[39m([32m'expiring-key'[39m)[33m;[39m
    [90m 87| [39m      [34mexpect[39m(ttl)[33m.[39m[34mtoBeGreaterThan[39m([34m0[39m)[33m;[39m
    [90m   | [39m                  [31m^[39m
    [90m 88| [39m      [34mexpect[39m(ttl)[33m.[39m[34mtoBeLessThanOrEqual[39m([34m1[39m)[33m;[39m
    [90m 89| [39m    })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[4/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/infrastructure.test.js[2m > [22mTest Infrastructure[2m > [22mMock Factories[2m > [22mshould create mock storage adapter
[31m[1mTypeError[22m: The first argument must be of type string or an instance of Buffer, ArrayBuffer, or Array or an Array-like Object. Received undefined[39m
[36m [2mâ¯[22m Object.<anonymous> tests/test-helpers/mocks.js:[2m28:60[22m[39m
    [90m 26| [39m      [35mreturn[39m {
    [90m 27| [39m        key[33m,[39m
    [90m 28| [39m        size: Buffer.isBuffer(body) ? body.length : Buffer.from(body).â€¦
    [90m   | [39m                                                           [31m^[39m
    [90m 29| [39m        etag[33m:[39m crypto[33m.[39m[34mrandomBytes[39m([34m16[39m)[33m.[39m[34mtoString[39m([32m'hex'[39m)
    [90m 30| [39m      }[33m;[39m
[90m [2mâ¯[22m tests/integration/infrastructure.test.js:[2m98:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[5/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/infrastructure.test.js[2m > [22mTest Infrastructure[2m > [22mIntegration: Factories + Database[2m > [22mshould insert factory-generated user into database
[31m[1merror[22m: invalid input syntax for type integer: "true"[39m
[90m [2mâ¯[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[36m [2mâ¯[22m insertTestRecord tests/test-helpers/database.js:[2m205:18[22m[39m
    [90m203| [39m  `[39m[33m;[39m
    [90m204| [39m
    [90m205| [39m  [35mconst[39m result [33m=[39m [35mawait[39m testDb[33m.[39m[34mquery[39m(query[33m,[39m values)[33m;[39m
    [90m   | [39m                 [31m^[39m
    [90m206| [39m  [35mreturn[39m result[33m.[39mrows[[34m0[39m][33m;[39m
    [90m207| [39m}
[90m [2mâ¯[22m tests/integration/infrastructure.test.js:[2m163:7[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[6/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/infrastructure.test.js[2m > [22mTest Infrastructure[2m > [22mIntegration: Factories + Database[2m > [22mshould insert factory-generated manuscript into database
[31m[1merror[22m: invalid input syntax for type integer: "true"[39m
[90m [2mâ¯[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[36m [2mâ¯[22m insertTestRecord tests/test-helpers/database.js:[2m205:18[22m[39m
    [90m203| [39m  `[39m[33m;[39m
    [90m204| [39m
    [90m205| [39m  [35mconst[39m result [33m=[39m [35mawait[39m testDb[33m.[39m[34mquery[39m(query[33m,[39m values)[33m;[39m
    [90m   | [39m                 [31m^[39m
    [90m206| [39m  [35mreturn[39m result[33m.[39mrows[[34m0[39m][33m;[39m
    [90m207| [39m}
[90m [2mâ¯[22m tests/integration/infrastructure.test.js:[2m173:7[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[7/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/register[2m > [22mshould register a new user with valid credentials
[31m[1mAssertionError[22m: expected 500 to be 201 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 201[39m
[31m+ 500[39m

[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m68:29[22m[39m
    [90m 66| [39m    [35mconst[39m result [33m=[39m [35mawait[39m response[33m.[39m[34mjson[39m()[33m;[39m
    [90m 67| [39m
    [90m 68| [39m    [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m201[39m)[33m;[39m
    [90m   | [39m                            [31m^[39m
    [90m 69| [39m    [34mexpect[39m(result[33m.[39muserId)[33m.[39m[34mtoBeDefined[39m()[33m;[39m
    [90m 70| [39m    [34mexpect[39m(result[33m.[39mverificationToken)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[8/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/register[2m > [22mshould reject registration with duplicate email
[31m[1mAssertionError[22m: expected 500 to be 409 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 409[39m
[31m+ 500[39m

[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m136:29[22m[39m
    [90m134| [39m    [35mconst[39m result [33m=[39m [35mawait[39m response[33m.[39m[34mjson[39m()[33m;[39m
    [90m135| [39m
    [90m136| [39m    [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m409[39m)[33m;[39m
    [90m   | [39m                            [31m^[39m
    [90m137| [39m    [34mexpect[39m(result[33m.[39merror)[33m.[39m[34mtoMatch[39m([36m/email already registered/i[39m)[33m;[39m
    [90m138| [39m  })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[9/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/register[2m > [22mshould hash password with bcrypt
[31m[1mTypeError[22m: Cannot read properties of null (reading 'password_hash')[39m
[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m153:23[22m[39m
    [90m151| [39m
    [90m152| [39m    const user = await findTestRecord('users', { email: 'bcrypt-test@eâ€¦
    [90m153| [39m    [35mconst[39m hash [33m=[39m user[33m.[39mpassword_hash[33m;[39m
    [90m   | [39m                      [31m^[39m
    [90m154| [39m
    [90m155| [39m    [90m// bcrypt hashes start with $2a$10$ or $2b$10$[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[10/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/register[2m > [22mshould normalize email to lowercase
[31m[1mAssertionError[22m: expected null to be truthy[39m

[32m- Expected:[39m 
true

[31m+ Received:[39m 
null

[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m177:18[22m[39m
    [90m175| [39m
    [90m176| [39m    const user = await findTestRecord('users', { email: 'casesensitiveâ€¦
    [90m177| [39m    [34mexpect[39m(user)[33m.[39m[34mtoBeTruthy[39m()[33m;[39m
    [90m   | [39m                 [31m^[39m
    [90m178| [39m  })[33m;[39m
    [90m179| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[11/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/register[2m > [22mshould create verification token
[31m[1mAssertionError[22m: expected undefined to be truthy[39m

[32m- Expected:[39m 
true

[31m+ Received:[39m 
undefined

[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m194:19[22m[39m
    [90m192| [39m
    [90m193| [39m    [35mconst[39m token [33m=[39m result[33m.[39mverificationToken[33m;[39m
    [90m194| [39m    [34mexpect[39m(token)[33m.[39m[34mtoBeTruthy[39m()[33m;[39m
    [90m   | [39m                  [31m^[39m
    [90m195| [39m    [34mexpect[39m(token[33m.[39mlength)[33m.[39m[34mtoBeGreaterThan[39m([34m20[39m)[33m;[39m [90m// Secure token length[39m
    [90m196| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[12/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/register[2m > [22mshould send verification email
[31m[1mAssertionError[22m: expected "spy" to be called with arguments: [ ObjectContaining{â€¦}, Any<Object> ][90m

Number of calls: [1m0[22m
[31m[39m
[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m219:52[22m[39m
    [90m217| [39m    [35mawait[39m authHandlers[33m.[39m[34mhandleRegister[39m(mockRequest[33m,[39m mockEnv)[33m;[39m
    [90m218| [39m
    [90m219| [39m    expect(mockEmailService.sendEmailVerification).toHaveBeenCalledWitâ€¦
    [90m   | [39m                                                   [31m^[39m
    [90m220| [39m      expect[33m.[39m[34mobjectContaining[39m({
    [90m221| [39m        userEmail[33m:[39m [32m'email-test@example.com'[39m[33m,[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[13/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/register[2m > [22mshould log registration event in audit log
[31m[1mAssertionError[22m: expected 0 to be greater than 0[39m
[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m241:24[22m[39m
    [90m239| [39m
    [90m240| [39m    const auditCount = await countTestRecords('audit_log', { event_typâ€¦
    [90m241| [39m    [34mexpect[39m(auditCount)[33m.[39m[34mtoBeGreaterThan[39m([34m0[39m)[33m;[39m
    [90m   | [39m                       [31m^[39m
    [90m242| [39m  })[33m;[39m
    [90m243| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[14/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/register[2m > [22mshould set default role to author if not specified
[31m[1mTypeError[22m: Cannot read properties of null (reading 'role')[39m
[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m258:17[22m[39m
    [90m256| [39m
    [90m257| [39m    const user = await findTestRecord('users', { email: 'default-role@â€¦
    [90m258| [39m    [34mexpect[39m(user[33m.[39mrole)[33m.[39m[34mtoBe[39m([32m'author'[39m)[33m;[39m
    [90m   | [39m                [31m^[39m
    [90m259| [39m  })[33m;[39m
    [90m260| [39m})[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[15/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/login[2m > [22mshould login with valid credentials
[31m[1mAssertionError[22m: expected 400 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 400[39m

[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m295:29[22m[39m
    [90m293| [39m    [35mconst[39m result [33m=[39m [35mawait[39m response[33m.[39m[34mjson[39m()[33m;[39m
    [90m294| [39m
    [90m295| [39m    [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                            [31m^[39m
    [90m296| [39m    [34mexpect[39m(result[33m.[39muserId)[33m.[39m[34mtoBeDefined[39m()[33m;[39m
    [90m297| [39m    [34mexpect[39m(result[33m.[39memail)[33m.[39m[34mtoBe[39m([32m'login-test@example.com'[39m)[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[16/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/login[2m > [22mshould reject login with unverified email
[31m[1mAssertionError[22m: expected 400 to be 403 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 403[39m
[31m+ 400[39m

[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m364:29[22m[39m
    [90m362| [39m    [35mconst[39m result [33m=[39m [35mawait[39m response[33m.[39m[34mjson[39m()[33m;[39m
    [90m363| [39m
    [90m364| [39m    [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m403[39m)[33m;[39m
    [90m   | [39m                            [31m^[39m
    [90m365| [39m    [34mexpect[39m(result[33m.[39merror)[33m.[39m[34mtoMatch[39m([36m/email not verified/i[39m)[33m;[39m
    [90m366| [39m  })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[17/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/login[2m > [22mshould update last_login timestamp
[31m[1mTypeError[22m: Cannot read properties of null (reading 'last_login')[39m
[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m416:37[22m[39m
    [90m414| [39m
    [90m415| [39m    const user = await findTestRecord('users', { email: 'login-test@exâ€¦
    [90m416| [39m    [35mconst[39m lastLogin [33m=[39m [35mnew[39m [33mDate[39m(user[33m.[39mlast_login)[33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m417| [39m
    [90m418| [39m    [34mexpect[39m(lastLogin [33m>=[39m beforeLogin)[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[18/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/login[2m > [22mshould create session in Redis
[31m[1mTypeError[22m: Cannot read properties of null (reading 'match')[39m
[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m436:38[22m[39m
    [90m434| [39m    [90m// Extract session ID from Set-Cookie header[39m
    [90m435| [39m    [35mconst[39m setCookie [33m=[39m response[33m.[39mheaders[33m.[39m[35mget[39m([32m'Set-Cookie'[39m)[33m;[39m
    [90m436| [39m    [35mconst[39m sessionIdMatch [33m=[39m setCookie[33m.[39m[34mmatch[39m([36m/session_id=([^;]+)/[39m)[33m;[39m
    [90m   | [39m                                     [31m^[39m
    [90m437| [39m    [34mexpect[39m(sessionIdMatch)[33m.[39m[34mtoBeTruthy[39m()[33m;[39m
    [90m438| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[19/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/login[2m > [22mshould log successful login
[31m[1mAssertionError[22m: expected 0 to be greater than 0[39m
[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m464:24[22m[39m
    [90m462| [39m
    [90m463| [39m    const auditCount = await countTestRecords('audit_log', { event_typâ€¦
    [90m464| [39m    [34mexpect[39m(auditCount)[33m.[39m[34mtoBeGreaterThan[39m([34m0[39m)[33m;[39m
    [90m   | [39m                       [31m^[39m
    [90m465| [39m  })[33m;[39m
    [90m466| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[20/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/login[2m > [22mshould log failed login attempts
[31m[1mAssertionError[22m: expected 0 to be greater than 0[39m
[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m481:24[22m[39m
    [90m479| [39m
    [90m480| [39m    const auditCount = await countTestRecords('audit_log', { event_typâ€¦
    [90m481| [39m    [34mexpect[39m(auditCount)[33m.[39m[34mtoBeGreaterThan[39m([34m0[39m)[33m;[39m
    [90m   | [39m                       [31m^[39m
    [90m482| [39m  })[33m;[39m
    [90m483| [39m})[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[21/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/verify-email[2m > [22mshould verify email with valid token
[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/verify-email[2m > [22mshould reject invalid token
[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/verify-email[2m > [22mshould reject expired token
[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/verify-email[2m > [22mshould reject already used token
[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/verify-email[2m > [22mshould handle missing token
[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/verify-email[2m > [22mshould log email verification event
[31m[1mTypeError[22m: createVerificationToken is not a function[39m
[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m504:31[22m[39m
    [90m502| [39m    })[33m;[39m
    [90m503| [39m
    [90m504| [39m    verificationToken [33m=[39m [35mawait[39m [34mcreateVerificationToken[39m(testDb[33m,[39m {
    [90m   | [39m                              [31m^[39m
    [90m505| [39m      user_id[33m:[39m testUser[33m.[39mid[33m,[39m
    [90m506| [39m      token_type[33m:[39m [32m'email_verification'[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/request-password-reset[2m > [22mshould create password reset token for valid email
[31m[1mTypeError[22m: handleRequestPasswordReset is not a function[39m
[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m653:41[22m[39m
    [90m651| [39m    [35mconst[39m mockEnv [33m=[39m { [33mDB[39m[33m:[39m testDbAdapter[33m,[39m [33mREDIS[39m[33m:[39m mockRedisInstance }[33m;[39m
    [90m652| [39m
    [90m653| [39m    const response = await authHandlers.handleRequestPasswordReset(mocâ€¦
    [90m   | [39m                                        [31m^[39m
    [90m654| [39m    [35mconst[39m result [33m=[39m [35mawait[39m response[33m.[39m[34mjson[39m()[33m;[39m
    [90m655| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[23/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/request-password-reset[2m > [22mshould send password reset email
[31m[1mTypeError[22m: handleRequestPasswordReset is not a function[39m
[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m677:24[22m[39m
    [90m675| [39m    [35mconst[39m mockEnv [33m=[39m { [33mDB[39m[33m:[39m testDbAdapter[33m,[39m [33mREDIS[39m[33m:[39m mockRedisInstance }[33m;[39m
    [90m676| [39m
    [90m677| [39m    await authHandlers.handleRequestPasswordReset(mockRequest, mockEnvâ€¦
    [90m   | [39m                       [31m^[39m
    [90m678| [39m
    [90m679| [39m    expect(mockEmailService.sendPasswordResetEmail).toHaveBeenCalledWiâ€¦

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[24/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/request-password-reset[2m > [22mshould not reveal if email does not exist (security)
[31m[1mTypeError[22m: handleRequestPasswordReset is not a function[39m
[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m698:41[22m[39m
    [90m696| [39m    [35mconst[39m mockEnv [33m=[39m { [33mDB[39m[33m:[39m testDbAdapter[33m,[39m [33mREDIS[39m[33m:[39m mockRedisInstance }[33m;[39m
    [90m697| [39m
    [90m698| [39m    const response = await authHandlers.handleRequestPasswordReset(mocâ€¦
    [90m   | [39m                                        [31m^[39m
    [90m699| [39m    [35mconst[39m result [33m=[39m [35mawait[39m response[33m.[39m[34mjson[39m()[33m;[39m
    [90m700| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[25/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/request-password-reset[2m > [22mshould rate limit password reset requests
[31m[1mTypeError[22m: handleRequestPasswordReset is not a function[39m
[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m718:26[22m[39m
    [90m716| [39m      }[33m;[39m
    [90m717| [39m
    [90m718| [39m      await authHandlers.handleRequestPasswordReset(mockRequest, mockEâ€¦
    [90m   | [39m                         [31m^[39m
    [90m719| [39m    }
    [90m720| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[26/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/request-password-reset[2m > [22mshould normalize email to lowercase
[31m[1mTypeError[22m: handleRequestPasswordReset is not a function[39m
[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m752:41[22m[39m
    [90m750| [39m    [35mconst[39m mockEnv [33m=[39m { [33mDB[39m[33m:[39m testDbAdapter[33m,[39m [33mREDIS[39m[33m:[39m mockRedisInstance }[33m;[39m
    [90m751| [39m
    [90m752| [39m    const response = await authHandlers.handleRequestPasswordReset(mocâ€¦
    [90m   | [39m                                        [31m^[39m
    [90m753| [39m
    [90m754| [39m    [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[27/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/request-password-reset[2m > [22mshould reject invalid email format
[31m[1mTypeError[22m: handleRequestPasswordReset is not a function[39m
[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m767:41[22m[39m
    [90m765| [39m    [35mconst[39m mockEnv [33m=[39m { [33mDB[39m[33m:[39m testDbAdapter[33m,[39m [33mREDIS[39m[33m:[39m mockRedisInstance }[33m;[39m
    [90m766| [39m
    [90m767| [39m    const response = await authHandlers.handleRequestPasswordReset(mocâ€¦
    [90m   | [39m                                        [31m^[39m
    [90m768| [39m    [35mconst[39m result [33m=[39m [35mawait[39m response[33m.[39m[34mjson[39m()[33m;[39m
    [90m769| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[28/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/request-password-reset[2m > [22mshould handle missing email
[31m[1mTypeError[22m: handleRequestPasswordReset is not a function[39m
[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m782:41[22m[39m
    [90m780| [39m    [35mconst[39m mockEnv [33m=[39m { [33mDB[39m[33m:[39m testDbAdapter[33m,[39m [33mREDIS[39m[33m:[39m mockRedisInstance }[33m;[39m
    [90m781| [39m
    [90m782| [39m    const response = await authHandlers.handleRequestPasswordReset(mocâ€¦
    [90m   | [39m                                        [31m^[39m
    [90m783| [39m    [35mconst[39m result [33m=[39m [35mawait[39m response[33m.[39m[34mjson[39m()[33m;[39m
    [90m784| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[29/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/request-password-reset[2m > [22mshould log password reset request
[31m[1mTypeError[22m: handleRequestPasswordReset is not a function[39m
[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m799:24[22m[39m
    [90m797| [39m    [35mconst[39m mockEnv [33m=[39m { [33mDB[39m[33m:[39m testDbAdapter[33m,[39m [33mREDIS[39m[33m:[39m mockRedisInstance }[33m;[39m
    [90m798| [39m
    [90m799| [39m    await authHandlers.handleRequestPasswordReset(mockRequest, mockEnvâ€¦
    [90m   | [39m                       [31m^[39m
    [90m800| [39m
    [90m801| [39m    const auditCount = await countTestRecords('audit_log', { event_typâ€¦

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[30/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/reset-password[2m > [22mshould reset password with valid token
[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/reset-password[2m > [22mshould mark reset token as used
[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/reset-password[2m > [22mshould reject weak new password
[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/reset-password[2m > [22mshould reject invalid token
[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/reset-password[2m > [22mshould reject expired token
[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/reset-password[2m > [22mshould reject already used token
[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/reset-password[2m > [22mshould hash new password with bcrypt
[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/reset-password[2m > [22mshould log password reset event
[31m[1mTypeError[22m: createVerificationToken is not a function[39m
[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m824:24[22m[39m
    [90m822| [39m    })[33m;[39m
    [90m823| [39m
    [90m824| [39m    resetToken [33m=[39m [35mawait[39m [34mcreateVerificationToken[39m(testDb[33m,[39m {
    [90m   | [39m                       [31m^[39m
    [90m825| [39m      user_id[33m:[39m testUser[33m.[39mid[33m,[39m
    [90m826| [39m      token_type[33m:[39m [32m'password_reset'[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[31/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/logout[2m > [22mshould logout and destroy session
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m1029:29[22m[39m
    [90m1027| [39m    [35mconst[39m result [33m=[39m [35mawait[39m response[33m.[39m[34mjson[39m()[33m;[39m
    [90m1028| [39m
    [90m1029| [39m    [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                            [31m^[39m
    [90m1030| [39m    [34mexpect[39m(result[33m.[39mmessage)[33m.[39m[34mtoMatch[39m([36m/logged out/i[39m)[33m;[39m
    [90m1031| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[32/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/logout[2m > [22mshould clear session cookie
[31m[1mAssertionError[22m: the given combination of arguments (null and string) is invalid for this assertion. You can use an array, a map, an object, a set, a string, or a weakset instead of a string[39m
[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m1047:23[22m[39m
    [90m1045| [39m
    [90m1046| [39m    [35mconst[39m setCookie [33m=[39m response[33m.[39mheaders[33m.[39m[35mget[39m([32m'Set-Cookie'[39m)[33m;[39m
    [90m1047| [39m    [34mexpect[39m(setCookie)[33m.[39m[34mtoContain[39m([32m'session_id='[39m)[33m;[39m
    [90m   | [39m                      [31m^[39m
    [90m1048| [39m    [34mexpect[39m(setCookie)[33m.[39m[34mtoContain[39m([32m'Max-Age=0'[39m)[33m;[39m [90m// Cookie expired[39m
    [90m1049| [39m  })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[33/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/logout[2m > [22mshould log logout event
[31m[1mAssertionError[22m: expected 0 to be greater than 0[39m
[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m1061:24[22m[39m
    [90m1059| [39m
    [90m1060| [39m    const auditCount = await countTestRecords('audit_log', { event_typâ€¦
    [90m1061| [39m    [34mexpect[39m(auditCount)[33m.[39m[34mtoBeGreaterThan[39m([34m0[39m)[33m;[39m
    [90m   | [39m                       [31m^[39m
    [90m1062| [39m  })[33m;[39m
    [90m1063| [39m})[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[34/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mGET /auth/me[2m > [22mshould return current user with valid session
[31m[1mTypeError[22m: handleGetCurrentUser is not a function[39m
[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m1105:41[22m[39m
    [90m1103| [39m    [35mconst[39m mockEnv [33m=[39m { [33mDB[39m[33m:[39m testDbAdapter[33m,[39m [33mREDIS[39m[33m:[39m mockRedisInstance }[33m;[39m
    [90m1104| [39m
    [90m1105| [39m    const response = await authHandlers.handleGetCurrentUser(mockRequeâ€¦
    [90m   | [39m                                        [31m^[39m
    [90m1106| [39m    [35mconst[39m result [33m=[39m [35mawait[39m response[33m.[39m[34mjson[39m()[33m;[39m
    [90m1107| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[35/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mGET /auth/me[2m > [22mshould not return password hash
[31m[1mTypeError[22m: handleGetCurrentUser is not a function[39m
[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m1122:41[22m[39m
    [90m1120| [39m    [35mconst[39m mockEnv [33m=[39m { [33mDB[39m[33m:[39m testDbAdapter[33m,[39m [33mREDIS[39m[33m:[39m mockRedisInstance }[33m;[39m
    [90m1121| [39m
    [90m1122| [39m    const response = await authHandlers.handleGetCurrentUser(mockRequeâ€¦
    [90m   | [39m                                        [31m^[39m
    [90m1123| [39m    [35mconst[39m result [33m=[39m [35mawait[39m response[33m.[39m[34mjson[39m()[33m;[39m
    [90m1124| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[36/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mGET /auth/me[2m > [22mshould reject request without session
[31m[1mTypeError[22m: handleGetCurrentUser is not a function[39m
[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m1136:41[22m[39m
    [90m1134| [39m    [35mconst[39m mockEnv [33m=[39m { [33mDB[39m[33m:[39m testDbAdapter[33m,[39m [33mREDIS[39m[33m:[39m mockRedisInstance }[33m;[39m
    [90m1135| [39m
    [90m1136| [39m    const response = await authHandlers.handleGetCurrentUser(mockRequeâ€¦
    [90m   | [39m                                        [31m^[39m
    [90m1137| [39m    [35mconst[39m result [33m=[39m [35mawait[39m response[33m.[39m[34mjson[39m()[33m;[39m
    [90m1138| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[37/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mGET /auth/me[2m > [22mshould reject request with invalid session
[31m[1mTypeError[22m: handleGetCurrentUser is not a function[39m
[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m1150:41[22m[39m
    [90m1148| [39m    [35mconst[39m mockEnv [33m=[39m { [33mDB[39m[33m:[39m testDbAdapter[33m,[39m [33mREDIS[39m[33m:[39m mockRedisInstance }[33m;[39m
    [90m1149| [39m
    [90m1150| [39m    const response = await authHandlers.handleGetCurrentUser(mockRequeâ€¦
    [90m   | [39m                                        [31m^[39m
    [90m1151| [39m    [35mconst[39m result [33m=[39m [35mawait[39m response[33m.[39m[34mjson[39m()[33m;[39m
    [90m1152| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[38/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mGET /auth/me[2m > [22mshould return email verification status
[31m[1mTypeError[22m: handleGetCurrentUser is not a function[39m
[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m1164:41[22m[39m
    [90m1162| [39m    [35mconst[39m mockEnv [33m=[39m { [33mDB[39m[33m:[39m testDbAdapter[33m,[39m [33mREDIS[39m[33m:[39m mockRedisInstance }[33m;[39m
    [90m1163| [39m
    [90m1164| [39m    const response = await authHandlers.handleGetCurrentUser(mockRequeâ€¦
    [90m   | [39m                                        [31m^[39m
    [90m1165| [39m    [35mconst[39m result [33m=[39m [35mawait[39m response[33m.[39m[34mjson[39m()[33m;[39m
    [90m1166| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/resend-verification[2m > [22mshould resend verification email for unverified user
[31m[1mAssertionError[22m: expected "spy" to be called with arguments: [ ObjectContaining{â€¦}, Any<Object> ][90m

Number of calls: [1m0[22m
[31m[39m
[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m1206:52[22m[39m
    [90m1204| [39m    [34mexpect[39m(result[33m.[39mmessage)[33m.[39m[34mtoMatch[39m([36m/verification.*sent/i[39m)[33m;[39m
    [90m1205| [39m
    [90m1206| [39m    expect(mockEmailService.sendEmailVerification).toHaveBeenCalledWitâ€¦
    [90m   | [39m                                                   [31m^[39m
    [90m1207| [39m      expect[33m.[39m[34mobjectContaining[39m({
    [90m1208| [39m        userEmail[33m:[39m [32m'resend@example.com'[39m[33m,[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[40/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/resend-verification[2m > [22mshould reject resend for already verified user
[31m[1merror[22m: column "email_verified" is of type integer but expression is of type boolean[39m
[90m [2mâ¯[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m1216:5[22m[39m
    [90m1214| [39m
    [90m1215| [39m  [34mit[39m([32m'should reject resend for already verified user'[39m[33m,[39m [35masync[39m () [33m=>[39m {
    [90m1216| [39m    [35mawait[39m testDb[33m.[39m[34mquery[39m(
    [90m   | [39m    [31m^[39m
    [90m1217| [39m      [32m'UPDATE users SET email_verified = TRUE WHERE id = $1'[39m[33m,[39m
    [90m1218| [39m      [testUser[33m.[39mid]

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[41/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/auth-handlers.test.js[2m > [22mPOST /auth/resend-verification[2m > [22mshould rate limit resend requests
[31m[1mAssertionError[22m: expected 200 to be 429 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 429[39m
[31m+ 200[39m

[36m [2mâ¯[22m tests/integration/handlers/auth-handlers.test.js:[2m1263:29[22m[39m
    [90m1261| [39m    [35mconst[39m result [33m=[39m [35mawait[39m response[33m.[39m[34mjson[39m()[33m;[39m
    [90m1262| [39m
    [90m1263| [39m    [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m429[39m)[33m;[39m
    [90m   | [39m                            [31m^[39m
    [90m1264| [39m    [34mexpect[39m(result[33m.[39merror)[33m.[39m[34mtoMatch[39m([36m/too many.*requests/i[39m)[33m;[39m
    [90m1265| [39m  })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[42/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /create-checkout-session[2m > [22mshould create checkout session for valid subscription
[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /create-checkout-session[2m > [22mshould require authentication for checkout
[31m[1merror[22m: invalid input syntax for type integer: "true"[39m
[90m [2mâ¯[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[36m [2mâ¯[22m insertTestRecord tests/test-helpers/database.js:[2m205:18[22m[39m
    [90m203| [39m  `[39m[33m;[39m
    [90m204| [39m
    [90m205| [39m  [35mconst[39m result [33m=[39m [35mawait[39m testDb[33m.[39m[34mquery[39m(query[33m,[39m values)[33m;[39m
    [90m   | [39m                 [31m^[39m
    [90m206| [39m  [35mreturn[39m result[33m.[39mrows[[34m0[39m][33m;[39m
    [90m207| [39m}
[90m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m57:7[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[43/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /create-checkout-session[2m > [22mshould reject invalid price IDs
[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /create-checkout-session[2m > [22mshould include userId in session metadata
[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /create-checkout-session[2m > [22mshould handle missing priceId field
[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /create-checkout-session[2m > [22mshould handle missing planType field
[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /create-checkout-session[2m > [22mshould create customer if not exists
[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /create-checkout-session[2m > [22mshould set correct success and cancel URLs
[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /create-checkout-session[2m > [22mshould handle Stripe API errors gracefully
[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /create-checkout-session[2m > [22mshould log checkout session creation
[31m[1merror[22m: relation "users" does not exist[39m
[90m [2mâ¯[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[36m [2mâ¯[22m insertTestRecord tests/test-helpers/database.js:[2m205:18[22m[39m
    [90m203| [39m  `[39m[33m;[39m
    [90m204| [39m
    [90m205| [39m  [35mconst[39m result [33m=[39m [35mawait[39m testDb[33m.[39m[34mquery[39m(query[33m,[39m values)[33m;[39m
    [90m   | [39m                 [31m^[39m
    [90m206| [39m  [35mreturn[39m result[33m.[39mrows[[34m0[39m][33m;[39m
    [90m207| [39m}
[90m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m57:7[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[44/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Signature Verification[2m > [22mshould accept webhook with valid signature
[31m[1mAssertionError[22m: expected [ 200, 404 ] to include 503[39m
[36m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m250:26[22m[39m
    [90m248| [39m
    [90m249| [39m      [90m// Accept 200 (processed) or 404 (endpoint not implemented)[39m
    [90m250| [39m      [34mexpect[39m([[34m200[39m[33m,[39m [34m404[39m])[33m.[39m[34mtoContain[39m(response[33m.[39mstatus)[33m;[39m
    [90m   | [39m                         [31m^[39m
    [90m251| [39m    })[33m;[39m
    [90m252| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[45/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Signature Verification[2m > [22mshould reject webhook with invalid signature
[31m[1mAssertionError[22m: expected [ 400, 404 ] to include 503[39m
[36m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m263:26[22m[39m
    [90m261| [39m        [33m.[39m[34msend[39m(payload)[33m;[39m
    [90m262| [39m
    [90m263| [39m      [34mexpect[39m([[34m400[39m[33m,[39m [34m404[39m])[33m.[39m[34mtoContain[39m(response[33m.[39mstatus)[33m;[39m
    [90m   | [39m                         [31m^[39m
    [90m264| [39m      [35mif[39m (response[33m.[39mstatus [33m===[39m [34m400[39m) {
    [90m265| [39m        [34mexpect[39m(response[33m.[39mbody[33m.[39merror)[33m.[39m[34mtoMatch[39m([36m/signature/i[39m)[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[46/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Signature Verification[2m > [22mshould reject webhook with missing signature
[31m[1mAssertionError[22m: expected [ 400, 404 ] to include 503[39m
[36m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m277:26[22m[39m
    [90m275| [39m        [33m.[39m[34msend[39m(event)[33m;[39m
    [90m276| [39m
    [90m277| [39m      [34mexpect[39m([[34m400[39m[33m,[39m [34m404[39m])[33m.[39m[34mtoContain[39m(response[33m.[39mstatus)[33m;[39m
    [90m   | [39m                         [31m^[39m
    [90m278| [39m    })[33m;[39m
    [90m279| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[47/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Signature Verification[2m > [22mshould reject webhook with expired signature (>5 minutes)
[31m[1mAssertionError[22m: expected [ 400, 404 ] to include 503[39m
[36m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m299:26[22m[39m
    [90m297| [39m
    [90m298| [39m      [90m// Stripe would reject expired signatures[39m
    [90m299| [39m      [34mexpect[39m([[34m400[39m[33m,[39m [34m404[39m])[33m.[39m[34mtoContain[39m(response[33m.[39mstatus)[33m;[39m
    [90m   | [39m                         [31m^[39m
    [90m300| [39m    })[33m;[39m
    [90m301| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[48/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Signature Verification[2m > [22mshould reject replay attacks (duplicate event ID)
[31m[1mAssertionError[22m: expected [ 200, 404 ] to include 503[39m
[36m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m316:26[22m[39m
    [90m314| [39m        [33m.[39m[34msend[39m(payload)[33m;[39m
    [90m315| [39m
    [90m316| [39m      [34mexpect[39m([[34m200[39m[33m,[39m [34m404[39m])[33m.[39m[34mtoContain[39m(response1[33m.[39mstatus)[33m;[39m
    [90m   | [39m                         [31m^[39m
    [90m317| [39m
    [90m318| [39m      [90m// Duplicate request with same event ID should be idempotent[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[49/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Signature Verification[2m > [22mshould handle malformed signature header
[31m[1mAssertionError[22m: expected [ 400, 404 ] to include 503[39m
[36m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m336:26[22m[39m
    [90m334| [39m        [33m.[39m[34msend[39m(event)[33m;[39m
    [90m335| [39m
    [90m336| [39m      [34mexpect[39m([[34m400[39m[33m,[39m [34m404[39m])[33m.[39m[34mtoContain[39m(response[33m.[39mstatus)[33m;[39m
    [90m   | [39m                         [31m^[39m
    [90m337| [39m    })[33m;[39m
    [90m338| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[50/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Signature Verification[2m > [22mshould log signature verification failures
[31m[1merror[22m: relation "audit_log" does not exist[39m
[90m [2mâ¯[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[36m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m348:24[22m[39m
    [90m346| [39m
    [90m347| [39m      [90m// Security audit log would track failed webhook attempts[39m
    [90m348| [39m      [35mconst[39m auditLog [33m=[39m [35mawait[39m [34mqueryTestDb[39m(
    [90m   | [39m                       [31m^[39m
    [90m349| [39m        'SELECT * FROM audit_log WHERE event_type LIKE $1 ORDER BY creâ€¦
    [90m350| [39m        [[32m'%webhook%'[39m]

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[51/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Signature Verification[2m > [22mshould return 400 for invalid signatures (not 500)
[31m[1mAssertionError[22m: expected [ 400, 404 ] to include 503[39m
[36m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m366:26[22m[39m
    [90m364| [39m
    [90m365| [39m      [90m// Should return 400 (client error), not 500 (server error)[39m
    [90m366| [39m      [34mexpect[39m([[34m400[39m[33m,[39m [34m404[39m])[33m.[39m[34mtoContain[39m(response[33m.[39mstatus)[33m;[39m
    [90m   | [39m                         [31m^[39m
    [90m367| [39m    })[33m;[39m
    [90m368| [39m  })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[52/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle checkout.session.completed - activate subscription
[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle checkout.session.completed - record payment
[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle customer.subscription.updated - sync status
[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle customer.subscription.deleted - downgrade to free
[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle customer.subscription.deleted - preserve data
[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle invoice.payment_succeeded - record payment
[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle invoice.payment_succeeded - extend billing period
[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle invoice.payment_failed - mark past_due
[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle invoice.payment_failed - cancel after 3 failures
[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould ignore unhandled event types
[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle duplicate webhook deliveries (idempotent)
[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle webhook for deleted user gracefully
[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle malformed webhook data gracefully
[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould log all webhook events
[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould return 200 for all webhooks (even errors)
[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould process webhook in under 5 seconds
[31m[1merror[22m: relation "users" does not exist[39m
[90m [2mâ¯[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[36m [2mâ¯[22m insertTestRecord tests/test-helpers/database.js:[2m205:18[22m[39m
    [90m203| [39m  `[39m[33m;[39m
    [90m204| [39m
    [90m205| [39m  [35mconst[39m result [33m=[39m [35mawait[39m testDb[33m.[39m[34mquery[39m(query[33m,[39m values)[33m;[39m
    [90m   | [39m                 [31m^[39m
    [90m206| [39m  [35mreturn[39m result[33m.[39mrows[[34m0[39m][33m;[39m
    [90m207| [39m}
[90m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m386:7[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[53/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mGET /subscription[2m > [22mshould return current subscription details
[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mGET /subscription[2m > [22mshould require authentication
[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mGET /subscription[2m > [22mshould return free plan for users without subscription
[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mGET /subscription[2m > [22mshould include Stripe subscription ID
[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mGET /subscription[2m > [22mshould include current period dates
[31m[1merror[22m: relation "users" does not exist[39m
[90m [2mâ¯[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[36m [2mâ¯[22m insertTestRecord tests/test-helpers/database.js:[2m205:18[22m[39m
    [90m203| [39m  `[39m[33m;[39m
    [90m204| [39m
    [90m205| [39m  [35mconst[39m result [33m=[39m [35mawait[39m testDb[33m.[39m[34mquery[39m(query[33m,[39m values)[33m;[39m
    [90m   | [39m                 [31m^[39m
    [90m206| [39m  [35mreturn[39m result[33m.[39mrows[[34m0[39m][33m;[39m
    [90m207| [39m}
[90m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m800:7[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[54/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mGET /payment-history[2m > [22mshould return payment history for user
[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mGET /payment-history[2m > [22mshould require authentication
[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mGET /payment-history[2m > [22mshould return empty array for no payments
[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mGET /payment-history[2m > [22mshould order payments by date (newest first)
[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mGET /payment-history[2m > [22mshould not include other users payments
[31m[1merror[22m: relation "users" does not exist[39m
[90m [2mâ¯[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[36m [2mâ¯[22m insertTestRecord tests/test-helpers/database.js:[2m205:18[22m[39m
    [90m203| [39m  `[39m[33m;[39m
    [90m204| [39m
    [90m205| [39m  [35mconst[39m result [33m=[39m [35mawait[39m testDb[33m.[39m[34mquery[39m(query[33m,[39m values)[33m;[39m
    [90m   | [39m                 [31m^[39m
    [90m206| [39m  [35mreturn[39m result[33m.[39mrows[[34m0[39m][33m;[39m
    [90m207| [39m}
[90m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m895:7[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[55/108]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould track manuscript analysis usage
[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould track different analysis types
[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould track asset generation separately
[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould calculate usage within billing period
[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould separate usage across different billing periods
[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould track usage for users without subscription (pay-per-use)
[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould link usage to specific manuscript
[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould accumulate credits across multiple analyses
[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould track timestamp for usage analytics
[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould delete usage records when manuscript is deleted (CASCADE)
[31m[1merror[22m: relation "users" does not exist[39m
[90m [2mâ¯[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[36m [2mâ¯[22m insertTestRecord tests/test-helpers/database.js:[2m205:18[22m[39m
    [90m203| [39m  `[39m[33m;[39m
    [90m204| [39m
    [90m205| [39m  [35mconst[39m result [33m=[39m [35mawait[39m testDb[33m.[39m[34mquery[39m(query[33m,[39m values)[33m;[39m
    [90m   | [39m                 [31m^[39m
    [90m206| [39m  [35mreturn[39m result[33m.[39mrows[[34m0[39m][33m;[39m
    [90m207| [39m}
[90m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m1018:7[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[56/108]âŽ¯[22m[39m


[2m Test Files [22m [1m[31m3 failed[39m[22m[2m | [22m[1m[32m7 passed[39m[22m[90m (10)[39m
[2m      Tests [22m [1m[31m108 failed[39m[22m[2m | [22m[1m[32m170 passed[39m[22m[90m (278)[39m
[2m   Start at [22m 16:12:13
[2m   Duration [22m 562.22s[2m (transform 628ms, setup 691ms, collect 7.49s, tests 550.54s, environment 2ms, prepare 1.37s)[22m


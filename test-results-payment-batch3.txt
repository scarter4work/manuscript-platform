
> manuscript-upload-api@1.0.0 test
> cross-env NODE_ENV=test TEST_DATABASE_URL=postgresql://postgres:Bjoran32!@127.0.0.1:5432/manuscript_platform_test vitest run tests/integration/handlers/payment-handlers.test.js


[1m[46m RUN [49m[22m [36mv3.2.4 [39m[90mD:/manuscript-platform[39m

[90mstdout[2m | tests/integration/handlers/payment-handlers.test.js
[22m[39m[dotenv@17.2.3] injecting env (0) from .env.local -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/handlers/payment-handlers.test.js
[22m[39m
ğŸ§ª Setting up test environment...

[90mstdout[2m | tests/integration/handlers/payment-handlers.test.js
[22m[39mâœ“ Test database connected

[90mstdout[2m | tests/integration/handlers/payment-handlers.test.js
[22m[39m  Applying base schema...

[90mstdout[2m | tests/integration/handlers/payment-handlers.test.js
[22m[39m  âœ“ Schema and migrations applied

[90mstdout[2m | tests/integration/handlers/payment-handlers.test.js
[22m[39mâœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

[90mstdout[2m | tests/integration/handlers/payment-handlers.test.js
[22m[39mâœ“ Test database initialized
Initializing adapters...
âœ“ Database adapter initialized
âœ“ Storage adapter initialized
âš  Running in test mode without Redis - using in-memory session store

[90mstdout[2m | tests/integration/handlers/payment-handlers.test.js
[22m[39mâœ“ Session store initialized
âœ“ Cache adapter initialized
âœ“ Queue service initialized
âœ“ Environment initialized
âœ“ Session middleware applied
[VirusScanner] Initializing ClamAV at localhost:3310...

[90mstdout[2m | tests/integration/handlers/payment-handlers.test.js
[22m[39mâœ“ Server adapters initialized
âœ“ Test environment ready


[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /create-checkout-session[2m > [22m[2mshould create checkout session for valid subscription
[22m[39m[VirusScanner] Failed to initialize: 

[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /create-checkout-session[2m > [22m[2mshould create checkout session for valid subscription
[22m[39mâš  Virus scanner initialization failed (uploads will continue without scanning)

[0mPOST /auth/login [32m200[0m 123.055 ms - 128[0m
[0mPOST /create-checkout-session [33m400[0m 24.899 ms - 29[0m
[0mPOST /auth/login [32m200[0m 90.787 ms - 128[0m
[0mPOST /create-checkout-session [33m401[0m 2.398 ms - 24[0m
[0mPOST /auth/login [32m200[0m 241.662 ms - 128[0m
[0mPOST /create-checkout-session [33m400[0m 1.337 ms - 29[0m
[0mPOST /auth/login [32m200[0m 102.569 ms - 128[0m
[0mPOST /create-checkout-session [33m400[0m 1.351 ms - 29[0m
[0mPOST /auth/login [32m200[0m 96.029 ms - 128[0m
[0mPOST /create-checkout-session [33m400[0m 2.291 ms - 29[0m
[0mPOST /auth/login [32m200[0m 259.007 ms - 128[0m
[0mPOST /create-checkout-session [33m400[0m 1.771 ms - 29[0m
[0mPOST /auth/login [32m200[0m 69.420 ms - 128[0m
[0mPOST /create-checkout-session [33m400[0m 1.047 ms - 29[0m
[0mPOST /auth/login [32m200[0m 72.679 ms - 128[0m
[0mPOST /create-checkout-session [33m400[0m 1.939 ms - 29[0m
[0mPOST /auth/login [32m200[0m 239.217 ms - 128[0m
[0mPOST /create-checkout-session [33m400[0m 0.888 ms - 29[0m
[0mPOST /auth/login [32m200[0m 124.966 ms - 128[0m
[0mPOST /create-checkout-session [33m400[0m 1.319 ms - 29[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Signature Verification[2m > [22m[2mshould accept webhook with valid signature
[22m[39m[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 2.757 ms - 29[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Signature Verification[2m > [22m[2mshould reject webhook with invalid signature
[22m[39m[Webhook] Signature verification failed: Unable to extract timestamp and signatures from header

[0mPOST /webhooks/stripe [33m400[0m 1.023 ms - 29[0m
[0mPOST /webhooks/stripe [33m400[0m 0.735 ms - 33[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Signature Verification[2m > [22m[2mshould reject webhook with expired signature (>5 minutes)
[22m[39m[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.486 ms - 29[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Signature Verification[2m > [22m[2mshould reject replay attacks (duplicate event ID)
[22m[39m[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 2.313 ms - 29[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Signature Verification[2m > [22m[2mshould handle malformed signature header
[22m[39m[Webhook] Signature verification failed: Unable to extract timestamp and signatures from header

[0mPOST /webhooks/stripe [33m400[0m 1.136 ms - 29[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Signature Verification[2m > [22m[2mshould log signature verification failures
[22m[39m[Webhook] Signature verification failed: Unable to extract timestamp and signatures from header

[0mPOST /webhooks/stripe [33m400[0m 1.458 ms - 29[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Signature Verification[2m > [22m[2mshould return 400 for invalid signatures (not 500)
[22m[39m[Webhook] Signature verification failed: Unable to extract timestamp and signatures from header

[0mPOST /webhooks/stripe [33m400[0m 1.109 ms - 29[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Event Handling[2m > [22m[2mshould handle checkout.session.completed - activate subscription
[22m[39m[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.081 ms - 29[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Event Handling[2m > [22m[2mshould handle checkout.session.completed - record payment
[22m[39m[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.295 ms - 29[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Event Handling[2m > [22m[2mshould handle customer.subscription.updated - sync status
[22m[39m[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.223 ms - 29[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Event Handling[2m > [22m[2mshould handle customer.subscription.deleted - downgrade to free
[22m[39m[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.288 ms - 29[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Event Handling[2m > [22m[2mshould handle invoice.payment_succeeded - record payment
[22m[39m[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.435 ms - 29[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Event Handling[2m > [22m[2mshould handle invoice.payment_succeeded - extend billing period
[22m[39m[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.806 ms - 29[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Event Handling[2m > [22m[2mshould handle invoice.payment_failed - mark past_due
[22m[39m[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.029 ms - 29[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Event Handling[2m > [22m[2mshould handle invoice.payment_failed - cancel after 3 failures
[22m[39m[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.396 ms - 29[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Event Handling[2m > [22m[2mshould ignore unhandled event types
[22m[39m[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 0.988 ms - 29[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Event Handling[2m > [22m[2mshould handle duplicate webhook deliveries (idempotent)
[22m[39m[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.573 ms - 29[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Event Handling[2m > [22m[2mshould handle duplicate webhook deliveries (idempotent)
[22m[39m[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.513 ms - 29[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Event Handling[2m > [22m[2mshould handle webhook for deleted user gracefully
[22m[39m[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.187 ms - 29[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Event Handling[2m > [22m[2mshould handle malformed webhook data gracefully
[22m[39m[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.050 ms - 29[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Event Handling[2m > [22m[2mshould log all webhook events
[22m[39m[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.363 ms - 29[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Event Handling[2m > [22m[2mshould return 200 for all webhooks (even errors)
[22m[39m[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.212 ms - 29[0m
[90mstderr[2m | tests/integration/handlers/payment-handlers.test.js[2m > [22m[2mPayment & Webhook Handlers[2m > [22m[2mPOST /webhooks/stripe - Event Handling[2m > [22m[2mshould process webhook in under 5 seconds
[22m[39m[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.154 ms - 29[0m
[0mPOST /auth/login [32m200[0m 247.098 ms - 132[0m
[0mGET /subscription [32m200[0m 9.280 ms - 221[0m
[0mPOST /auth/login [32m200[0m 65.927 ms - 132[0m
[0mGET /subscription [33m401[0m 1.321 ms - 24[0m
[0mPOST /auth/login [32m200[0m 278.916 ms - 132[0m
[0mGET /subscription [32m200[0m 6.529 ms - 175[0m
[0mPOST /auth/login [32m200[0m 88.070 ms - 132[0m
[0mGET /subscription [32m200[0m 5.772 ms - 221[0m
[0mPOST /auth/login [32m200[0m 68.594 ms - 132[0m
[0mGET /subscription [32m200[0m 5.473 ms - 221[0m
[0mPOST /auth/login [32m200[0m 219.519 ms - 135[0m
[0mGET /payment-history [32m200[0m 4.862 ms - 534[0m
[0mPOST /auth/login [32m200[0m 67.054 ms - 135[0m
[0mGET /payment-history [33m401[0m 1.241 ms - 24[0m
[0mPOST /auth/login [32m200[0m 70.980 ms - 135[0m
[0mGET /payment-history [32m200[0m 3.877 ms - 15[0m
[0mPOST /auth/login [32m200[0m 92.236 ms - 135[0m
[0mGET /payment-history [32m200[0m 3.231 ms - 534[0m
[0mPOST /auth/login [32m200[0m 70.727 ms - 135[0m
[0mGET /payment-history [32m200[0m 3.732 ms - 534[0m
[0mPOST /auth/login [32m200[0m 75.826 ms - 134[0m
[0mPOST /auth/login [32m200[0m 330.760 ms - 134[0m
[0mPOST /auth/login [32m200[0m 65.009 ms - 134[0m
[0mPOST /auth/login [32m200[0m 259.075 ms - 134[0m
[0mPOST /auth/login [32m200[0m 64.602 ms - 134[0m
[0mPOST /auth/login [32m200[0m 72.524 ms - 134[0m
[0mPOST /auth/login [32m200[0m 248.503 ms - 134[0m
[0mPOST /auth/login [32m200[0m 73.095 ms - 134[0m
[0mPOST /auth/login [32m200[0m 66.621 ms - 134[0m
[0mPOST /auth/login [32m200[0m 68.231 ms - 134[0m
[90mstdout[2m | tests/integration/handlers/payment-handlers.test.js
[22m[39m
ğŸ§¹ Tearing down test environment...

[90mstdout[2m | tests/integration/handlers/payment-handlers.test.js
[22m[39mâœ“ Test database cleaned

[90mstdout[2m | tests/integration/handlers/payment-handlers.test.js
[22m[39mâœ“ Database adapter closed

[90mstdout[2m | tests/integration/handlers/payment-handlers.test.js
[22m[39mâœ“ Test database disconnected

[90mstdout[2m | tests/integration/handlers/payment-handlers.test.js
[22m[39mâœ“ Test database cleaned up
âœ“ Test environment cleaned up


 [31mâ¯[39m tests/integration/handlers/payment-handlers.test.js [2m([22m[2m54 tests[22m[2m | [22m[31m12 failed[39m[2m)[22m[33m 107395[2mms[22m[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /create-checkout-session[2m > [22mshould create checkout session for valid subscription[39m[33m 1659[2mms[22m[39m
[31m     â†’ expected [ 200, 404, 501 ] to include 400[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /create-checkout-session[2m > [22mshould require authentication for checkout [33m 1601[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /create-checkout-session[2m > [22mshould reject invalid price IDs [33m 2028[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /create-checkout-session[2m > [22mshould include userId in session metadata [33m 2728[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /create-checkout-session[2m > [22mshould handle missing priceId field [33m 1602[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /create-checkout-session[2m > [22mshould handle missing planType field [33m 2043[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /create-checkout-session[2m > [22mshould create customer if not exists [33m 1570[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /create-checkout-session[2m > [22mshould set correct success and cancel URLs [33m 1527[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /create-checkout-session[2m > [22mshould handle Stripe API errors gracefully [33m 1838[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /create-checkout-session[2m > [22mshould log checkout session creation [33m 2733[2mms[22m[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Signature Verification[2m > [22mshould accept webhook with valid signature[39m[33m 1355[2mms[22m[39m
[31m     â†’ expected [ 200, 404 ] to include 400[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Signature Verification[2m > [22mshould reject webhook with invalid signature [33m 1389[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Signature Verification[2m > [22mshould reject webhook with missing signature [33m 2191[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Signature Verification[2m > [22mshould reject webhook with expired signature (>5 minutes) [33m 1433[2mms[22m[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Signature Verification[2m > [22mshould reject replay attacks (duplicate event ID)[39m[33m 1412[2mms[22m[39m
[31m     â†’ expected [ 200, 404 ] to include 400[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Signature Verification[2m > [22mshould handle malformed signature header [33m 2488[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Signature Verification[2m > [22mshould log signature verification failures [33m 1520[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Signature Verification[2m > [22mshould return 400 for invalid signatures (not 500) [33m 1468[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle checkout.session.completed - activate subscription [33m 2068[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle checkout.session.completed - record payment [33m 1459[2mms[22m[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle customer.subscription.updated - sync status[39m[33m 1435[2mms[22m[39m
[31m     â†’ expected [ 200, 404 ] to include 400[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle customer.subscription.deleted - downgrade to free [33m 2221[2mms[22m[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle customer.subscription.deleted - preserve data[39m[33m 2213[2mms[22m[39m
[31m     â†’ column "created_at" of relation "manuscripts" does not exist[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle invoice.payment_succeeded - record payment[39m[33m 1564[2mms[22m[39m
[31m     â†’ expected [ 200, 404 ] to include 400[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle invoice.payment_succeeded - extend billing period [33m 2350[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle invoice.payment_failed - mark past_due [33m 1426[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle invoice.payment_failed - cancel after 3 failures [33m 1456[2mms[22m[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould ignore unhandled event types[39m[33m 2224[2mms[22m[39m
[31m     â†’ expected [ 200, 404 ] to include 400[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle duplicate webhook deliveries (idempotent)[39m[33m 2037[2mms[22m[39m
[31m     â†’ expected [ 200, 404 ] to include 400[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle webhook for deleted user gracefully [33m 2190[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle malformed webhook data gracefully [33m 1422[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould log all webhook events [33m 1479[2mms[22m[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould return 200 for all webhooks (even errors)[39m[33m 1456[2mms[22m[39m
[31m     â†’ expected [ 200, 404, 500 ] to include 400[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould process webhook in under 5 seconds [33m 1949[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mGET /subscription[2m > [22mshould return current subscription details [33m 2504[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mGET /subscription[2m > [22mshould require authentication [33m 1487[2mms[22m[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mGET /subscription[2m > [22mshould return free plan for users without subscription[39m[33m 2205[2mms[22m[39m
[31m     â†’ expected null to be 'free' // Object.is equality[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mGET /subscription[2m > [22mshould include Stripe subscription ID [33m 1550[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mGET /subscription[2m > [22mshould include current period dates [33m 1532[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mGET /payment-history[2m > [22mshould return payment history for user [33m 2723[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mGET /payment-history[2m > [22mshould require authentication [33m 1980[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mGET /payment-history[2m > [22mshould return empty array for no payments [33m 1594[2mms[22m[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mGET /payment-history[2m > [22mshould order payments by date (newest first)[39m[33m 2298[2mms[22m[39m
[31m     â†’ actual value must be number or bigint, received "string"[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mGET /payment-history[2m > [22mshould not include other users payments [33m 1779[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould track manuscript analysis usage [33m 1581[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould track different analysis types [33m 2670[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould track asset generation separately [33m 1536[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould calculate usage within billing period [33m 2145[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould separate usage across different billing periods [33m 2037[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould track usage for users without subscription (pay-per-use) [33m 1635[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould link usage to specific manuscript [33m 2546[2mms[22m[39m
[31m   [31mÃ—[31m Payment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould accumulate credits across multiple analyses[39m[33m 1603[2mms[22m[39m
[31m     â†’ expected '5' to be 5 // Object.is equality[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould track timestamp for usage analytics [33m 1604[2mms[22m[39m
   [33m[2mâœ“[22m[39m Payment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould delete usage records when manuscript is deleted (CASCADE) [33m 3662[2mms[22m[39m

[31mâ¯â¯â¯â¯â¯â¯[39m[1m[41m Failed Tests 12 [49m[22m[31mâ¯â¯â¯â¯â¯â¯â¯[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /create-checkout-session[2m > [22mshould create checkout session for valid subscription
[31m[1mAssertionError[22m: expected [ 200, 404, 501 ] to include 400[39m
[36m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m95:33[22m[39m
    [90m 93| [39m        expect(response.body.url).toMatch(/checkout\.stripe\.com|stripâ€¦
    [90m 94| [39m      } [35melse[39m {
    [90m 95| [39m        [34mexpect[39m([[34m200[39m[33m,[39m [34m404[39m[33m,[39m [34m501[39m])[33m.[39m[34mtoContain[39m(response[33m.[39mstatus)[33m;[39m
    [90m   | [39m                                [31m^[39m
    [90m 96| [39m      }
    [90m 97| [39m    })[33m;[39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/12]â¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Signature Verification[2m > [22mshould accept webhook with valid signature
[31m[1mAssertionError[22m: expected [ 200, 404 ] to include 400[39m
[36m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m252:26[22m[39m
    [90m250| [39m
    [90m251| [39m      [90m// Accept 200 (processed) or 404 (endpoint not implemented)[39m
    [90m252| [39m      [34mexpect[39m([[34m200[39m[33m,[39m [34m404[39m])[33m.[39m[34mtoContain[39m(response[33m.[39mstatus)[33m;[39m
    [90m   | [39m                         [31m^[39m
    [90m253| [39m    })[33m;[39m
    [90m254| [39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[2/12]â¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Signature Verification[2m > [22mshould reject replay attacks (duplicate event ID)
[31m[1mAssertionError[22m: expected [ 200, 404 ] to include 400[39m
[36m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m318:26[22m[39m
    [90m316| [39m        [33m.[39m[34msend[39m(payload)[33m;[39m
    [90m317| [39m
    [90m318| [39m      [34mexpect[39m([[34m200[39m[33m,[39m [34m404[39m])[33m.[39m[34mtoContain[39m(response1[33m.[39mstatus)[33m;[39m
    [90m   | [39m                         [31m^[39m
    [90m319| [39m
    [90m320| [39m      [90m// Duplicate request with same event ID should be idempotent[39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[3/12]â¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle customer.subscription.updated - sync status
[31m[1mAssertionError[22m: expected [ 200, 404 ] to include 400[39m
[36m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m482:26[22m[39m
    [90m480| [39m        [33m.[39m[34msend[39m(payload)[33m;[39m
    [90m481| [39m
    [90m482| [39m      [34mexpect[39m([[34m200[39m[33m,[39m [34m404[39m])[33m.[39m[34mtoContain[39m(response[33m.[39mstatus)[33m;[39m
    [90m   | [39m                         [31m^[39m
    [90m483| [39m    })[33m;[39m
    [90m484| [39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[4/12]â¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle customer.subscription.deleted - preserve data
[31m[1merror[22m: column "created_at" of relation "manuscripts" does not exist[39m
[90m [2mâ¯[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[36m [2mâ¯[22m insertTestRecord tests/test-helpers/database.js:[2m217:18[22m[39m
    [90m215| [39m  `[39m[33m;[39m
    [90m216| [39m
    [90m217| [39m  [35mconst[39m result [33m=[39m [35mawait[39m testDb[33m.[39m[34mquery[39m(query[33m,[39m values)[33m;[39m
    [90m   | [39m                 [31m^[39m
    [90m218| [39m  [35mreturn[39m result[33m.[39mrows[[34m0[39m][33m;[39m
    [90m219| [39m}
[90m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m517:7[22m[39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[5/12]â¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle invoice.payment_succeeded - record payment
[31m[1mAssertionError[22m: expected [ 200, 404 ] to include 400[39m
[36m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m568:26[22m[39m
    [90m566| [39m        [33m.[39m[34msend[39m(payload)[33m;[39m
    [90m567| [39m
    [90m568| [39m      [34mexpect[39m([[34m200[39m[33m,[39m [34m404[39m])[33m.[39m[34mtoContain[39m(response[33m.[39mstatus)[33m;[39m
    [90m   | [39m                         [31m^[39m
    [90m569| [39m    })[33m;[39m
    [90m570| [39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[6/12]â¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould ignore unhandled event types
[31m[1mAssertionError[22m: expected [ 200, 404 ] to include 400[39m
[36m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m657:26[22m[39m
    [90m655| [39m
    [90m656| [39m      [90m// Should return 200 even for unhandled events[39m
    [90m657| [39m      [34mexpect[39m([[34m200[39m[33m,[39m [34m404[39m])[33m.[39m[34mtoContain[39m(response[33m.[39mstatus)[33m;[39m
    [90m   | [39m                         [31m^[39m
    [90m658| [39m    })[33m;[39m
    [90m659| [39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[7/12]â¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould handle duplicate webhook deliveries (idempotent)
[31m[1mAssertionError[22m: expected [ 200, 404 ] to include 400[39m
[36m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m682:26[22m[39m
    [90m680| [39m
    [90m681| [39m      [90m// Both should succeed (idempotent)[39m
    [90m682| [39m      [34mexpect[39m([[34m200[39m[33m,[39m [34m404[39m])[33m.[39m[34mtoContain[39m(response1[33m.[39mstatus)[33m;[39m
    [90m   | [39m                         [31m^[39m
    [90m683| [39m      [34mexpect[39m([[34m200[39m[33m,[39m [34m404[39m])[33m.[39m[34mtoContain[39m(response2[33m.[39mstatus)[33m;[39m
    [90m684| [39m    })[33m;[39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[8/12]â¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mPOST /webhooks/stripe - Event Handling[2m > [22mshould return 200 for all webhooks (even errors)
[31m[1mAssertionError[22m: expected [ 200, 404, 500 ] to include 400[39m
[36m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m761:31[22m[39m
    [90m759| [39m
    [90m760| [39m      [90m// Stripe expects 200 even if processing fails[39m
    [90m761| [39m      [34mexpect[39m([[34m200[39m[33m,[39m [34m404[39m[33m,[39m [34m500[39m])[33m.[39m[34mtoContain[39m(response[33m.[39mstatus)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m762| [39m    })[33m;[39m
    [90m763| [39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[9/12]â¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mGET /subscription[2m > [22mshould return free plan for users without subscription
[31m[1mAssertionError[22m: expected null to be 'free' // Object.is equality[39m

[32m- Expected:[39m 
"free"

[31m+ Received:[39m 
null

[36m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m856:41[22m[39m
    [90m854| [39m
    [90m855| [39m      [35mif[39m (response[33m.[39mstatus [33m===[39m [34m200[39m) {
    [90m856| [39m        [34mexpect[39m(response[33m.[39mbody[33m.[39mplan_type)[33m.[39m[34mtoBe[39m([32m'free'[39m)[33m;[39m
    [90m   | [39m                                        [31m^[39m
    [90m857| [39m      }
    [90m858| [39m    })[33m;[39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[10/12]â¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mGET /payment-history[2m > [22mshould order payments by date (newest first)
[31m[1mTypeError[22m: actual value must be number or bigint, received "string"[39m
[36m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m974:40[22m[39m
    [90m972| [39m      if (response.status === 200 && response.body.payments.length >= â€¦
    [90m973| [39m        [35mconst[39m payments [33m=[39m response[33m.[39mbody[33m.[39mpayments[33m;[39m
    [90m974| [39m        [34mexpect[39m(payments[[34m0[39m][33m.[39mcreated_at)[33m.[39m[34mtoBeGreaterThanOrEqual[39m(
    [90m   | [39m                                       [31m^[39m
    [90m975| [39m          payments[[34m1[39m][33m.[39mcreated_at
    [90m976| [39m        )[33m;[39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[11/12]â¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/handlers/payment-handlers.test.js[2m > [22mPayment & Webhook Handlers[2m > [22mUsage Tracking[2m > [22mshould accumulate credits across multiple analyses
[31m[1mAssertionError[22m: expected '5' to be 5 // Object.is equality[39m

[32m- Expected:[39m 
5

[31m+ Received:[39m 
"5"

[36m [2mâ¯[22m tests/integration/handlers/payment-handlers.test.js:[2m1363:44[22m[39m
    [90m1361| [39m      )[33m;[39m
    [90m1362| [39m
    [90m1363| [39m      [34mexpect[39m(result[33m.[39mrows[[34m0[39m][33m.[39mtotal_credits)[33m.[39m[34mtoBe[39m([34m5[39m)[33m;[39m
    [90m   | [39m                                           [31m^[39m
    [90m1364| [39m    })[33m;[39m
    [90m1365| [39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[12/12]â¯[22m[39m


[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m12 failed[39m[22m[2m | [22m[1m[32m42 passed[39m[22m[90m (54)[39m
[2m   Start at [22m 20:15:48
[2m   Duration [22m 111.78s[2m (transform 448ms, setup 3.66s, collect 152ms, tests 107.39s, environment 1ms, prepare 365ms)[22m


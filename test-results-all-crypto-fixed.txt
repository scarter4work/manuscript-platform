
> manuscript-upload-api@1.0.0 test
> cross-env NODE_ENV=test TEST_DATABASE_URL=postgresql://postgres:Bjoran32!@172.23.176.1:5432/manuscript_platform_test vitest run


 RUN  v3.2.4 /mnt/d/manuscript-platform

stdout | tests/integration/handlers/payment-handlers.test.js
[dotenv@17.2.3] injecting env (0) from .env.local -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

stdout | tests/integration/handlers/payment-handlers.test.js

ðŸ§ª Setting up test environment...

stdout | tests/integration/handlers/payment-handlers.test.js
âœ“ Test database connected

stdout | tests/integration/handlers/payment-handlers.test.js
  Applying base schema...

stdout | tests/integration/handlers/payment-handlers.test.js
  âœ“ Schema and migrations applied

stdout | tests/integration/handlers/payment-handlers.test.js
âœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

stdout | tests/integration/handlers/payment-handlers.test.js
âœ“ Test database initialized
Initializing adapters...
âœ“ Database adapter initialized
âœ“ Storage adapter initialized
âš  Running in test mode without Redis - using in-memory session store

stdout | tests/integration/handlers/payment-handlers.test.js
âœ“ Session store initialized
âœ“ Cache adapter initialized
âœ“ Queue service initialized
âœ“ Environment initialized
âœ“ Session middleware applied
[VirusScanner] Initializing ClamAV at localhost:3310...

stdout | tests/integration/handlers/payment-handlers.test.js
âœ“ Server adapters initialized
âœ“ Test environment ready


stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /create-checkout-session > should create checkout session for valid subscription
[VirusScanner] Failed to initialize: connect ECONNREFUSED 127.0.0.1:3310

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /create-checkout-session > should create checkout session for valid subscription
âš  Virus scanner initialization failed (uploads will continue without scanning)

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /create-checkout-session > should create checkout session for valid subscription
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'eb4f751a-583c-4437-a996-2ae81c7f0f74'[39m,
  [32m'bb0e64c56d397545c79df9d10aa19a5f'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'bb0e64c56d397545c79df9d10aa19a5f'[39m,
  [33m1763070387[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /create-checkout-session > should create checkout session for valid subscription
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 326.197 ms - 128[0m
[0mPOST /create-checkout-session [33m400[0m 80.834 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /create-checkout-session > should require authentication for checkout
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'ba7081dc-129e-4119-8752-bf80e081b5a1'[39m,
  [32m'89c627fdb593c28874cd7c0edeb24f7f'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'89c627fdb593c28874cd7c0edeb24f7f'[39m,
  [33m1763070389[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /create-checkout-session > should require authentication for checkout
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 121.920 ms - 128[0m
[0mPOST /create-checkout-session [33m401[0m 8.783 ms - 24[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /create-checkout-session > should reject invalid price IDs
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'bdfe1165-a909-4a59-a86b-00e751497919'[39m,
  [32m'e57a081c2e3e47e46503a4ca3426a009'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'e57a081c2e3e47e46503a4ca3426a009'[39m,
  [33m1763070391[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /create-checkout-session > should reject invalid price IDs
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 119.267 ms - 128[0m
[0mPOST /create-checkout-session [33m400[0m 8.563 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /create-checkout-session > should include userId in session metadata
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'fab0ba98-6383-40b5-ac7e-3c4db2936d8d'[39m,
  [32m'a61e05b6e5c2b2e0cdaf668ad153605c'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'a61e05b6e5c2b2e0cdaf668ad153605c'[39m,
  [33m1763070392[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /create-checkout-session > should include userId in session metadata
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 113.750 ms - 128[0m
[0mPOST /create-checkout-session [33m400[0m 6.532 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /create-checkout-session > should handle missing priceId field
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'cb0a0b21-b55d-451b-8bc8-d73e6e337b22'[39m,
  [32m'ea7009ab78676f2a90a9eefe0e172470'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'ea7009ab78676f2a90a9eefe0e172470'[39m,
  [33m1763070395[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /create-checkout-session > should handle missing priceId field
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 240.773 ms - 128[0m
[0mPOST /create-checkout-session [33m400[0m 7.757 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /create-checkout-session > should handle missing planType field
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'59f35a09-217d-4e00-aaf4-5a426fc1f6f7'[39m,
  [32m'c8a23762b4050d3bb067dbd95b3b8aaa'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'c8a23762b4050d3bb067dbd95b3b8aaa'[39m,
  [33m1763070397[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /create-checkout-session > should handle missing planType field
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 150.125 ms - 128[0m
[0mPOST /create-checkout-session [33m400[0m 7.664 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /create-checkout-session > should create customer if not exists
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'25876127-2524-46c9-9efc-9c5274f8f300'[39m,
  [32m'6b3ddc2521569f7d33e1c3b5b8b84213'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'6b3ddc2521569f7d33e1c3b5b8b84213'[39m,
  [33m1763070399[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /create-checkout-session > should create customer if not exists
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 119.240 ms - 128[0m
[0mPOST /create-checkout-session [33m400[0m 7.403 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /create-checkout-session > should set correct success and cancel URLs
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'39906f52-3f24-40a9-b15f-fc9ca9593809'[39m,
  [32m'9acbf707527d44f041a0e9c17ef683c7'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'9acbf707527d44f041a0e9c17ef683c7'[39m,
  [33m1763070410[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /create-checkout-session > should set correct success and cancel URLs
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 124.095 ms - 128[0m
[0mPOST /create-checkout-session [33m400[0m 4.923 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /create-checkout-session > should handle Stripe API errors gracefully
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'ab5ad9c5-9326-4866-bb0a-3b1452b7e015'[39m,
  [32m'b447eac31ece3b333b6fd62a246a0119'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'b447eac31ece3b333b6fd62a246a0119'[39m,
  [33m1763070405[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /create-checkout-session > should handle Stripe API errors gracefully
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 125.175 ms - 128[0m
[0mPOST /create-checkout-session [33m400[0m 8.058 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /create-checkout-session > should log checkout session creation
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'fcb073c3-c25d-4e9d-9202-f8c72ea89ef0'[39m,
  [32m'ca385e1a655364850fca3b56dad434b8'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'ca385e1a655364850fca3b56dad434b8'[39m,
  [33m1763070406[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /create-checkout-session > should log checkout session creation
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 122.891 ms - 128[0m
[0mPOST /create-checkout-session [33m400[0m 6.985 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should accept webhook with valid signature
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 5.280 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should reject webhook with invalid signature
[Webhook] Signature verification failed: Unable to extract timestamp and signatures from header

[0mPOST /webhooks/stripe [33m400[0m 1.858 ms - 29[0m
[0mPOST /webhooks/stripe [33m400[0m 1.165 ms - 33[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should reject webhook with expired signature (>5 minutes)
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 2.448 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should reject replay attacks (duplicate event ID)
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 2.594 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should reject replay attacks (duplicate event ID)
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 2.733 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should handle malformed signature header
[Webhook] Signature verification failed: Unable to extract timestamp and signatures from header

[0mPOST /webhooks/stripe [33m400[0m 1.809 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should log signature verification failures
[Webhook] Signature verification failed: Unable to extract timestamp and signatures from header

[0mPOST /webhooks/stripe [33m400[0m 2.446 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should return 400 for invalid signatures (not 500)
[Webhook] Signature verification failed: Unable to extract timestamp and signatures from header

[0mPOST /webhooks/stripe [33m400[0m 1.874 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle checkout.session.completed - activate subscription
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 2.668 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle checkout.session.completed - record payment
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.830 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle customer.subscription.updated - sync status
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 2.655 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle customer.subscription.deleted - downgrade to free
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 2.752 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle customer.subscription.deleted - preserve data
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 2.367 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle invoice.payment_succeeded - record payment
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.891 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle invoice.payment_succeeded - extend billing period
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.583 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle invoice.payment_failed - mark past_due
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 2.297 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle invoice.payment_failed - cancel after 3 failures
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 2.787 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should ignore unhandled event types
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 2.933 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle duplicate webhook deliveries (idempotent)
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 2.363 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle duplicate webhook deliveries (idempotent)
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.944 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle webhook for deleted user gracefully
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.983 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle malformed webhook data gracefully
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.818 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should log all webhook events
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 2.630 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should return 200 for all webhooks (even errors)
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 2.454 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should process webhook in under 5 seconds
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


[0mPOST /webhooks/stripe [33m400[0m 1.650 ms - 29[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > GET /subscription > should return current subscription details
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'e39cf35e-d64c-4212-94d9-39965bf1c780'[39m,
  [32m'e316a7d696037a95b1c9f1ac84ce191a'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'e316a7d696037a95b1c9f1ac84ce191a'[39m,
  [33m1763070457[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > GET /subscription > should return current subscription details
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 122.416 ms - 132[0m
[0mGET /subscription [32m200[0m 58.453 ms - 221[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > GET /subscription > should require authentication
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'dcb42c60-9c25-48e4-9239-472f3cf6bf52'[39m,
  [32m'ea9d1caaeaf39a5d1c735972fa7a97fe'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'ea9d1caaeaf39a5d1c735972fa7a97fe'[39m,
  [33m1763070458[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > GET /subscription > should require authentication
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 82.823 ms - 132[0m
[0mGET /subscription [33m401[0m 7.951 ms - 24[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > GET /subscription > should return free plan for users without subscription
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'90dbed07-82d1-4b84-a567-d212eb52c48b'[39m,
  [32m'4e67318d873179110deff7211c4ddbc2'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'4e67318d873179110deff7211c4ddbc2'[39m,
  [33m1763070460[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > GET /subscription > should return free plan for users without subscription
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 117.254 ms - 132[0m
[0mGET /subscription [32m200[0m 163.547 ms - 114[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > GET /subscription > should include Stripe subscription ID
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'f185e684-44c6-4d5e-bb43-e949ec64d531'[39m,
  [32m'4aea1c08234402d02b8116078e5a80e0'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'4aea1c08234402d02b8116078e5a80e0'[39m,
  [33m1763070462[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > GET /subscription > should include Stripe subscription ID
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 122.105 ms - 132[0m
[0mGET /subscription [32m200[0m 61.168 ms - 221[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > GET /subscription > should include current period dates
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'6d43f404-b7d3-4e4c-8114-75de7d9957c9'[39m,
  [32m'fa38682f1860f0687c1b2cad72a992fa'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'fa38682f1860f0687c1b2cad72a992fa'[39m,
  [33m1763070464[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > GET /subscription > should include current period dates
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 124.424 ms - 132[0m
[0mGET /subscription [32m200[0m 166.084 ms - 221[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > GET /payment-history > should return payment history for user
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'f726d09f-1c09-45c8-a5bb-9c0af8e09b06'[39m,
  [32m'760232f8e5bdaca453b2ee772c790d4a'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'760232f8e5bdaca453b2ee772c790d4a'[39m,
  [33m1763070466[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > GET /payment-history > should return payment history for user
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 81.604 ms - 135[0m
[0mGET /payment-history [32m200[0m 54.624 ms - 484[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > GET /payment-history > should require authentication
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'e58b5725-eac2-4a8f-a82d-b6d86fece239'[39m,
  [32m'e9ff1f6ba339c7df330f1da90fa75fa2'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'e9ff1f6ba339c7df330f1da90fa75fa2'[39m,
  [33m1763070469[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > GET /payment-history > should require authentication
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 125.576 ms - 135[0m
[0mGET /payment-history [33m401[0m 9.400 ms - 24[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > GET /payment-history > should return empty array for no payments
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'309eb477-e911-4f9c-a29a-2cb7cfa3d7fe'[39m,
  [32m'4919b567fd2d4f7b8fbd73ec865b203f'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'4919b567fd2d4f7b8fbd73ec865b203f'[39m,
  [33m1763070471[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > GET /payment-history > should return empty array for no payments
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 118.451 ms - 135[0m
[0mGET /payment-history [32m200[0m 59.912 ms - 15[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > GET /payment-history > should order payments by date (newest first)
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'e69da773-1181-492a-9d55-63bfbfa1f7f8'[39m,
  [32m'92d707105a301f2568f0215bb400e36a'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'92d707105a301f2568f0215bb400e36a'[39m,
  [33m1763070472[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > GET /payment-history > should order payments by date (newest first)
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 77.882 ms - 135[0m
[0mGET /payment-history [32m200[0m 58.333 ms - 484[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > GET /payment-history > should not include other users payments
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'10255d4c-771b-43be-ad6f-97ef68446569'[39m,
  [32m'263818066168b37763eacb17e9219e59'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'263818066168b37763eacb17e9219e59'[39m,
  [33m1763070475[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > GET /payment-history > should not include other users payments
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 88.077 ms - 135[0m
[0mGET /payment-history [32m200[0m 158.118 ms - 484[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > Usage Tracking > should track manuscript analysis usage
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'f20844af-d32d-4636-984c-39fa6ef6db93'[39m,
  [32m'ffbf722458ef5e0147025cb4c73d4bf1'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'ffbf722458ef5e0147025cb4c73d4bf1'[39m,
  [33m1763070477[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > Usage Tracking > should track manuscript analysis usage
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 74.812 ms - 134[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > Usage Tracking > should track different analysis types
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'046434a5-1c81-409f-8245-b207e687e529'[39m,
  [32m'651e0dc48df9efb2e0967cb86cfc1e12'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'651e0dc48df9efb2e0967cb86cfc1e12'[39m,
  [33m1763070479[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > Usage Tracking > should track different analysis types
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 121.096 ms - 134[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > Usage Tracking > should track asset generation separately
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'931153c8-1ce5-4a23-b9ea-f7fa5de05ec5'[39m,
  [32m'6a27f6fd5e029d0d176aae54b921322c'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'6a27f6fd5e029d0d176aae54b921322c'[39m,
  [33m1763070482[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > Usage Tracking > should track asset generation separately
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 114.082 ms - 134[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > Usage Tracking > should calculate usage within billing period
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'cd6f4faf-e57c-4048-b29a-2e11fefdfb50'[39m,
  [32m'f58a272f4d8bf79d90600a1555a1283e'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'f58a272f4d8bf79d90600a1555a1283e'[39m,
  [33m1763070483[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > Usage Tracking > should calculate usage within billing period
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 123.387 ms - 134[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > Usage Tracking > should separate usage across different billing periods
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'c4e83988-8287-4cb1-9493-b1592f88a726'[39m,
  [32m'b088ef20873050af474e3577c54942dc'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'b088ef20873050af474e3577c54942dc'[39m,
  [33m1763070486[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > Usage Tracking > should separate usage across different billing periods
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 123.027 ms - 134[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > Usage Tracking > should track usage for users without subscription (pay-per-use)
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'5ff36981-7d09-4e42-a6f8-dd92f596d2b8'[39m,
  [32m'870da12792eb14865b01a67cec288746'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'870da12792eb14865b01a67cec288746'[39m,
  [33m1763070487[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > Usage Tracking > should track usage for users without subscription (pay-per-use)
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 114.734 ms - 134[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > Usage Tracking > should link usage to specific manuscript
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'448f0167-bb77-4b8f-9965-2e091e4f9441'[39m,
  [32m'c632ebf9b6ebefd441857d598d6851b6'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'c632ebf9b6ebefd441857d598d6851b6'[39m,
  [33m1763070489[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > Usage Tracking > should link usage to specific manuscript
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 123.853 ms - 134[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > Usage Tracking > should accumulate credits across multiple analyses
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'c73d0e31-3e19-4a76-9cc3-0ff02abd9dfc'[39m,
  [32m'4b2d05c90bc057d0d84588865f8e7d8b'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'4b2d05c90bc057d0d84588865f8e7d8b'[39m,
  [33m1763070492[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > Usage Tracking > should accumulate credits across multiple analyses
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 121.225 ms - 134[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > Usage Tracking > should track timestamp for usage analytics
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'93ddace4-e452-44ac-a03b-9894cb5c878c'[39m,
  [32m'072572aa6238249157d6dcae2794262d'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'072572aa6238249157d6dcae2794262d'[39m,
  [33m1763070494[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > Usage Tracking > should track timestamp for usage analytics
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 124.099 ms - 134[0m
stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > Usage Tracking > should delete usage records when manuscript is deleted (CASCADE)
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'945047f9-fea0-45dc-b3d0-8132d17cd5b1'[39m,
  [32m'58d8ede23ed0773c41cef60ed54862e6'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'58d8ede23ed0773c41cef60ed54862e6'[39m,
  [33m1763070496[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/payment-handlers.test.js > Payment & Webhook Handlers > Usage Tracking > should delete usage records when manuscript is deleted (CASCADE)
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Object.handleLogin [as login] [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at routeRequest [90m(/mnt/d/manuscript-platform/[39msrc/router/router.js:71:27[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mserver.js:244:29 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

[0mPOST /auth/login [32m200[0m 265.445 ms - 134[0m
stdout | tests/integration/handlers/payment-handlers.test.js

ðŸ§¹ Tearing down test environment...

stdout | tests/integration/handlers/payment-handlers.test.js
âœ“ Test database cleaned

stdout | tests/integration/handlers/payment-handlers.test.js
âœ“ Database adapter closed

stdout | tests/integration/handlers/payment-handlers.test.js
âœ“ Test database disconnected

stdout | tests/integration/handlers/payment-handlers.test.js
âœ“ Test database cleaned up
âœ“ Test environment cleaned up


 âœ“ tests/integration/handlers/payment-handlers.test.js (54 tests) 133608ms
   âœ“ Payment & Webhook Handlers > POST /create-checkout-session > should create checkout session for valid subscription  2148ms
   âœ“ Payment & Webhook Handlers > POST /create-checkout-session > should require authentication for checkout  2110ms
   âœ“ Payment & Webhook Handlers > POST /create-checkout-session > should reject invalid price IDs  2510ms
   âœ“ Payment & Webhook Handlers > POST /create-checkout-session > should include userId in session metadata  1721ms
   âœ“ Payment & Webhook Handlers > POST /create-checkout-session > should handle missing priceId field  2050ms
   âœ“ Payment & Webhook Handlers > POST /create-checkout-session > should handle missing planType field  2934ms
   âœ“ Payment & Webhook Handlers > POST /create-checkout-session > should create customer if not exists  2319ms
   âœ“ Payment & Webhook Handlers > POST /create-checkout-session > should set correct success and cancel URLs  3080ms
   âœ“ Payment & Webhook Handlers > POST /create-checkout-session > should handle Stripe API errors gracefully  2636ms
   âœ“ Payment & Webhook Handlers > POST /create-checkout-session > should log checkout session creation  1980ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should accept webhook with valid signature  1632ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should reject webhook with invalid signature  1698ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should reject webhook with missing signature  2255ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should reject webhook with expired signature (>5 minutes)  2785ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should reject replay attacks (duplicate event ID)  1945ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should handle malformed signature header  1559ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should log signature verification failures  2776ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Signature Verification > should return 400 for invalid signatures (not 500)  1499ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle checkout.session.completed - activate subscription  1909ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle checkout.session.completed - record payment  3179ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle customer.subscription.updated - sync status  1861ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle customer.subscription.deleted - downgrade to free  2453ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle customer.subscription.deleted - preserve data  1988ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle invoice.payment_succeeded - record payment  1912ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle invoice.payment_succeeded - extend billing period  2636ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle invoice.payment_failed - mark past_due  2178ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle invoice.payment_failed - cancel after 3 failures  1903ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should ignore unhandled event types  3040ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle duplicate webhook deliveries (idempotent)  2147ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle webhook for deleted user gracefully  2523ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should handle malformed webhook data gracefully  2002ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should log all webhook events  1800ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should return 200 for all webhooks (even errors)  3335ms
   âœ“ Payment & Webhook Handlers > POST /webhooks/stripe - Event Handling > should process webhook in under 5 seconds  2102ms
   âœ“ Payment & Webhook Handlers > GET /subscription > should return current subscription details  2166ms
   âœ“ Payment & Webhook Handlers > GET /subscription > should require authentication  1874ms
   âœ“ Payment & Webhook Handlers > GET /subscription > should return free plan for users without subscription  1943ms
   âœ“ Payment & Webhook Handlers > GET /subscription > should include Stripe subscription ID  1987ms
   âœ“ Payment & Webhook Handlers > GET /subscription > should include current period dates  2410ms
   âœ“ Payment & Webhook Handlers > GET /payment-history > should return payment history for user  1942ms
   âœ“ Payment & Webhook Handlers > GET /payment-history > should require authentication  3397ms
   âœ“ Payment & Webhook Handlers > GET /payment-history > should return empty array for no payments  1971ms
   âœ“ Payment & Webhook Handlers > GET /payment-history > should order payments by date (newest first)  1904ms
   âœ“ Payment & Webhook Handlers > GET /payment-history > should not include other users payments  3388ms
   âœ“ Payment & Webhook Handlers > Usage Tracking > should track manuscript analysis usage  1661ms
   âœ“ Payment & Webhook Handlers > Usage Tracking > should track different analysis types  2188ms
   âœ“ Payment & Webhook Handlers > Usage Tracking > should track asset generation separately  3043ms
   âœ“ Payment & Webhook Handlers > Usage Tracking > should calculate usage within billing period  1675ms
   âœ“ Payment & Webhook Handlers > Usage Tracking > should separate usage across different billing periods  2801ms
   âœ“ Payment & Webhook Handlers > Usage Tracking > should track usage for users without subscription (pay-per-use)  1739ms
   âœ“ Payment & Webhook Handlers > Usage Tracking > should link usage to specific manuscript  1700ms
   âœ“ Payment & Webhook Handlers > Usage Tracking > should accumulate credits across multiple analyses  3472ms
   âœ“ Payment & Webhook Handlers > Usage Tracking > should track timestamp for usage analytics  1877ms
   âœ“ Payment & Webhook Handlers > Usage Tracking > should delete usage records when manuscript is deleted (CASCADE)  2544ms
stdout | process.<anonymous> (/mnt/d/manuscript-platform/tests/setup.js:115:11)

âš  Received SIGTERM, cleaning up...

stdout | tests/integration/handlers/auth-handlers.test.js
[dotenv@17.2.3] injecting env (0) from .env.local -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

stdout | tests/integration/handlers/auth-handlers.test.js

ðŸ§ª Setting up test environment...

stdout | tests/integration/handlers/auth-handlers.test.js
âœ“ Test database connected

stdout | tests/integration/handlers/auth-handlers.test.js
  Applying base schema...

stdout | tests/integration/handlers/auth-handlers.test.js
  âœ“ Schema and migrations applied

stdout | tests/integration/handlers/auth-handlers.test.js
âœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

stdout | tests/integration/handlers/auth-handlers.test.js
âœ“ Test database initialized
Initializing adapters...
âœ“ Database adapter initialized
âœ“ Storage adapter initialized
âš  Running in test mode without Redis - using in-memory session store

stdout | tests/integration/handlers/auth-handlers.test.js
âœ“ Session store initialized
âœ“ Cache adapter initialized
âœ“ Queue service initialized
âœ“ Environment initialized
âœ“ Session middleware applied
[VirusScanner] Initializing ClamAV at localhost:3310...

stdout | tests/integration/handlers/auth-handlers.test.js
âœ“ Server adapters initialized
âœ“ Test environment ready


stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should register a new user with valid credentials
[VirusScanner] Failed to initialize: connect ECONNREFUSED 127.0.0.1:3310

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should register a new user with valid credentials
âš  Virus scanner initialization failed (uploads will continue without scanning)

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should register a new user with valid credentials
[Payment] Free subscription created for user a7fc821c-3d77-43cf-ac55-e2636b207d0b

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should register a new user with valid credentials
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:176:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:65:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'13772013-e45b-44e6-9b48-6867ebb0e7de'[39m,
  [32m'a7fc821c-3d77-43cf-ac55-e2636b207d0b'[39m,
  [32m'register'[39m,
  [32m'auth'[39m,
  [32m'a7fc821c-3d77-43cf-ac55-e2636b207d0b'[39m,
  [33m1763070528[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"role":"author","email":"newuser@example.com"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should register a new user with valid credentials
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:176:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:65:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should register a new user with valid credentials
[Email] RESEND_API_KEY not configured

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should register a new user with valid credentials
Verification email sent to: newuser@example.com

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should hash password with bcrypt
[Payment] Free subscription created for user 23de81df-5cd2-44f8-986d-4679d526df06

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should hash password with bcrypt
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:176:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:150:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'16738744-26d8-4774-ad06-dc0f2bd66b07'[39m,
  [32m'23de81df-5cd2-44f8-986d-4679d526df06'[39m,
  [32m'register'[39m,
  [32m'auth'[39m,
  [32m'23de81df-5cd2-44f8-986d-4679d526df06'[39m,
  [33m1763070535[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"role":"author","email":"bcrypt-test@example.com"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should hash password with bcrypt
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:176:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:150:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should hash password with bcrypt
[Email] RESEND_API_KEY not configured

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should hash password with bcrypt
Verification email sent to: bcrypt-test@example.com

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should normalize email to lowercase
[Payment] Free subscription created for user 6be1e303-caab-4a38-abec-bec465cc24f6

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should normalize email to lowercase
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:176:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:174:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'2868f914-6ea0-4cdb-85b5-bfadd23dd6ae'[39m,
  [32m'6be1e303-caab-4a38-abec-bec465cc24f6'[39m,
  [32m'register'[39m,
  [32m'auth'[39m,
  [32m'6be1e303-caab-4a38-abec-bec465cc24f6'[39m,
  [33m1763070537[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"role":"author","email":"casesensitive@example.com"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should normalize email to lowercase
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:176:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:174:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should normalize email to lowercase
[Email] RESEND_API_KEY not configured

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should normalize email to lowercase
Verification email sent to: casesensitive@example.com

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should create verification token
[Payment] Free subscription created for user 51413bf1-8531-4206-8695-db36762a02e8

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should create verification token
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:176:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:190:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'2d16a58b-5f3f-4355-939b-3e2fb6af74d7'[39m,
  [32m'51413bf1-8531-4206-8695-db36762a02e8'[39m,
  [32m'register'[39m,
  [32m'auth'[39m,
  [32m'51413bf1-8531-4206-8695-db36762a02e8'[39m,
  [33m1763070540[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"role":"author","email":"verify-test@example.com"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should create verification token
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:176:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:190:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should create verification token
[Email] RESEND_API_KEY not configured

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should create verification token
Verification email sent to: verify-test@example.com

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should send verification email
[Payment] Free subscription created for user c047f569-042f-4b80-b202-137eb3814a37

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should send verification email
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:176:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:217:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'34635eb7-242d-4740-903d-525ecaa32aaa'[39m,
  [32m'c047f569-042f-4b80-b202-137eb3814a37'[39m,
  [32m'register'[39m,
  [32m'auth'[39m,
  [32m'c047f569-042f-4b80-b202-137eb3814a37'[39m,
  [33m1763070542[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"role":"author","email":"email-test@example.com"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should send verification email
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:176:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:217:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should send verification email
[Email] RESEND_API_KEY not configured

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should send verification email
Verification email sent to: email-test@example.com

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should log registration event in audit log
[Payment] Free subscription created for user 56208844-f0a8-4c58-8247-c5feadf0ccb3

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should log registration event in audit log
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:176:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:241:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'3fe4fda0-5f6d-467d-95ae-b8f2350899e8'[39m,
  [32m'56208844-f0a8-4c58-8247-c5feadf0ccb3'[39m,
  [32m'register'[39m,
  [32m'auth'[39m,
  [32m'56208844-f0a8-4c58-8247-c5feadf0ccb3'[39m,
  [33m1763070544[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"role":"author","email":"audit-test@example.com"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should log registration event in audit log
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:176:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:241:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should log registration event in audit log
[Email] RESEND_API_KEY not configured

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should log registration event in audit log
Verification email sent to: audit-test@example.com

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should set default role to author if not specified
[Payment] Free subscription created for user 73d3c6b4-63af-483d-a3c5-14a22e401821

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should set default role to author if not specified
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:176:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:258:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'35f88132-f89e-487c-9fc9-57f153fcd43a'[39m,
  [32m'73d3c6b4-63af-483d-a3c5-14a22e401821'[39m,
  [32m'register'[39m,
  [32m'auth'[39m,
  [32m'73d3c6b4-63af-483d-a3c5-14a22e401821'[39m,
  [33m1763070546[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"role":"author","email":"default-role@example.com"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should set default role to author if not specified
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleRegister [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:176:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:258:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should set default role to author if not specified
[Email] RESEND_API_KEY not configured

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should set default role to author if not specified
Verification email sent to: default-role@example.com

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should login with valid credentials
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogin [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:295:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'740f973b-276b-4fe9-a9f4-36e08fb0c71d'[39m,
  [32m'ebfcb698ae224add91ea596bc87c1418'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'ebfcb698ae224add91ea596bc87c1418'[39m,
  [33m1763070555[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should login with valid credentials
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogin [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:295:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should reject login with wrong password
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogin [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:263:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:321:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'1d3d1657-1586-46c9-9112-309b6b6845f5'[39m,
  [32m'a8c1fab2762b58e8fef7435f0c4fb617'[39m,
  [32m'login_failed'[39m,
  [32m'auth'[39m,
  [32m'a8c1fab2762b58e8fef7435f0c4fb617'[39m,
  [33m1763070549[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"login-test@example.com","reason":"invalid_credentials"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should reject login with wrong password
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogin [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:263:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:321:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should reject login with non-existent email
[Audit] Skipping audit log for login_failed - no valid user_id

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should reject login with unverified email
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogin [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:273:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:364:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'3fc18953-41b9-4fe2-9271-8f03d10f8729'[39m,
  [32m'327fcbdbaec43efeb8e2a8882f74cc34'[39m,
  [32m'login_failed'[39m,
  [32m'auth'[39m,
  [32m'327fcbdbaec43efeb8e2a8882f74cc34'[39m,
  [33m1763070554[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"reason":"email_not_verified"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should reject login with unverified email
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogin [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:273:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:364:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should rate limit after 5 failed attempts
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogin [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:263:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:384:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'4fdfafb6-f449-4674-87af-e514619b4722'[39m,
  [32m'2c95a984dd4d6160dfe693e4ba7803de'[39m,
  [32m'login_failed'[39m,
  [32m'auth'[39m,
  [32m'2c95a984dd4d6160dfe693e4ba7803de'[39m,
  [33m1763070556[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"login-test@example.com","reason":"invalid_credentials"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should rate limit after 5 failed attempts
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogin [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:263:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:384:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should rate limit after 5 failed attempts
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogin [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:263:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:384:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'8a9690f2-b6f2-45ed-bfd7-578e6137d43d'[39m,
  [32m'2c95a984dd4d6160dfe693e4ba7803de'[39m,
  [32m'login_failed'[39m,
  [32m'auth'[39m,
  [32m'2c95a984dd4d6160dfe693e4ba7803de'[39m,
  [33m1763070556[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"login-test@example.com","reason":"invalid_credentials"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should rate limit after 5 failed attempts
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogin [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:263:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:384:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should rate limit after 5 failed attempts
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogin [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:263:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:384:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'2627c2e9-c722-4854-b237-e8a4fa27527d'[39m,
  [32m'2c95a984dd4d6160dfe693e4ba7803de'[39m,
  [32m'login_failed'[39m,
  [32m'auth'[39m,
  [32m'2c95a984dd4d6160dfe693e4ba7803de'[39m,
  [33m1763070557[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"login-test@example.com","reason":"invalid_credentials"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should rate limit after 5 failed attempts
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogin [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:263:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:384:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should rate limit after 5 failed attempts
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogin [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:263:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:384:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'bb80e823-9520-4aec-8236-17af721565a9'[39m,
  [32m'2c95a984dd4d6160dfe693e4ba7803de'[39m,
  [32m'login_failed'[39m,
  [32m'auth'[39m,
  [32m'2c95a984dd4d6160dfe693e4ba7803de'[39m,
  [33m1763070557[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"login-test@example.com","reason":"invalid_credentials"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should rate limit after 5 failed attempts
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogin [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:263:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:384:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should rate limit after 5 failed attempts
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogin [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:263:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:384:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'f0aed1da-343c-4f34-8646-c144d0443532'[39m,
  [32m'2c95a984dd4d6160dfe693e4ba7803de'[39m,
  [32m'login_failed'[39m,
  [32m'auth'[39m,
  [32m'2c95a984dd4d6160dfe693e4ba7803de'[39m,
  [33m1763070557[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"login-test@example.com","reason":"invalid_credentials"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should rate limit after 5 failed attempts
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogin [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:263:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:384:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should update last_login timestamp
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogin [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:416:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'ab5b4035-3a05-4197-8e64-7b1459c02957'[39m,
  [32m'd735b08152a44f07f5351dd3f99f78ae'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'd735b08152a44f07f5351dd3f99f78ae'[39m,
  [33m1763070558[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should update last_login timestamp
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogin [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:416:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should create session in Redis
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogin [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:436:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'99a0f835-475a-4388-ace1-2fbb295d5705'[39m,
  [32m'237cbec93164a1c4877ea4b0151868ec'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'237cbec93164a1c4877ea4b0151868ec'[39m,
  [33m1763070561[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should create session in Redis
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogin [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:436:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should log successful login
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogin [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:465:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'a575d2c8-dffe-4521-bc57-c084c62e4ca9'[39m,
  [32m'560e63a13eaab02ead9147c07fd40dee'[39m,
  [32m'login'[39m,
  [32m'auth'[39m,
  [32m'560e63a13eaab02ead9147c07fd40dee'[39m,
  [33m1763070562[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"rememberMe":false}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should log successful login
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogin [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:293:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:465:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should log failed login attempts
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogin [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:263:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:482:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'06ad0e66-69d4-4095-99a5-f901c70027e1'[39m,
  [32m'54f311a5686a602cedcc77038ffe7b90'[39m,
  [32m'login_failed'[39m,
  [32m'auth'[39m,
  [32m'54f311a5686a602cedcc77038ffe7b90'[39m,
  [33m1763070564[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"login-test@example.com","reason":"invalid_credentials"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should log failed login attempts
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogin [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:263:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:482:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/verify-email > should verify email with valid token
Cache delete many error: TypeError: Cannot read properties of undefined (reading 'delete')
    at [90m/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:109:49
    at Array.map (<anonymous>)
    at CacheManager.deleteMany [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:109:30[90m)[39m
    at UserCache.invalidate [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:185:22[90m)[39m
    at Module.handleVerifyEmail [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:455:22[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:523:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/verify-email > should verify email with valid token
Cache INVALIDATED: user 8edbfc94585843c2817ee486f25ac392

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/verify-email > should verify email with valid token
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleVerifyEmail [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:459:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:523:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'afb240a4-2993-41ea-a312-f2c043104d16'[39m,
  [32m'8edbfc94585843c2817ee486f25ac392'[39m,
  [32m'email_verified'[39m,
  [32m'auth'[39m,
  [32m'8edbfc94585843c2817ee486f25ac392'[39m,
  [33m1763070567[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/verify-email > should verify email with valid token
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleVerifyEmail [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:459:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:523:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/verify-email > should log email verification event
Cache delete many error: TypeError: Cannot read properties of undefined (reading 'delete')
    at [90m/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:109:49
    at Array.map (<anonymous>)
    at CacheManager.deleteMany [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:109:30[90m)[39m
    at UserCache.invalidate [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:185:22[90m)[39m
    at Module.handleVerifyEmail [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:455:22[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:622:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/verify-email > should log email verification event
Cache INVALIDATED: user 339b5bcda28dfb3eac0aeb8ecf8e7086

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/verify-email > should log email verification event
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleVerifyEmail [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:459:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:622:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'd5ea08bf-1b28-435b-91d0-97b8ab9b3376'[39m,
  [32m'339b5bcda28dfb3eac0aeb8ecf8e7086'[39m,
  [32m'email_verified'[39m,
  [32m'auth'[39m,
  [32m'339b5bcda28dfb3eac0aeb8ecf8e7086'[39m,
  [33m1763070575[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/verify-email > should log email verification event
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleVerifyEmail [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:459:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:622:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should create password reset token for valid email
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:527:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:657:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'8805e4dc-e7c6-450c-b8dc-304092a493b5'[39m,
  [32m'6cf17c18b997d9568866a9773484db6e'[39m,
  [32m'password_reset_requested'[39m,
  [32m'auth'[39m,
  [32m'6cf17c18b997d9568866a9773484db6e'[39m,
  [33m1763070577[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"reset@example.com"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should create password reset token for valid email
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:527:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:657:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should create password reset token for valid email
Failed to send password reset email: Error: Failed to send email: <html>
<head><title>401 Authorization Required</title></head>
<body>
<center><h1>401 Authorization Required</h1></center>
<hr><center>nginx/1.27.1</center>
</body>
</html>

    at sendPasswordResetEmail [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:834:11[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:537:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:657:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should send password reset email
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:527:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:681:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'027e1295-fcb8-4532-bfc6-31b45776fd60'[39m,
  [32m'2f44fb57dda603cb54491f5da9e4061e'[39m,
  [32m'password_reset_requested'[39m,
  [32m'auth'[39m,
  [32m'2f44fb57dda603cb54491f5da9e4061e'[39m,
  [33m1763070581[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"reset@example.com"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should send password reset email
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:527:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:681:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should send password reset email
Failed to send password reset email: Error: Failed to send email: <html>
<head><title>401 Authorization Required</title></head>
<body>
<center><h1>401 Authorization Required</h1></center>
<hr><center>nginx/1.27.1</center>
</body>
</html>

    at sendPasswordResetEmail [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:834:11[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:537:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:681:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should rate limit password reset requests
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:527:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:727:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'a55b9705-a11a-4964-8928-11471eb95079'[39m,
  [32m'a45787229e4053e1473523408949f1d5'[39m,
  [32m'password_reset_requested'[39m,
  [32m'auth'[39m,
  [32m'a45787229e4053e1473523408949f1d5'[39m,
  [33m1763070585[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"reset@example.com"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should rate limit password reset requests
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:527:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:727:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should rate limit password reset requests
Failed to send password reset email: Error: Failed to send email: <html>
<head><title>401 Authorization Required</title></head>
<body>
<center><h1>401 Authorization Required</h1></center>
<hr><center>nginx/1.27.1</center>
</body>
</html>

    at sendPasswordResetEmail [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:834:11[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:537:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:727:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should rate limit password reset requests
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:527:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:727:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'e9c64974-2f02-4a5d-92e5-7bef12feed4b'[39m,
  [32m'a45787229e4053e1473523408949f1d5'[39m,
  [32m'password_reset_requested'[39m,
  [32m'auth'[39m,
  [32m'a45787229e4053e1473523408949f1d5'[39m,
  [33m1763070585[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"reset@example.com"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should rate limit password reset requests
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:527:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:727:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should rate limit password reset requests
Failed to send password reset email: Error: Failed to send email: <html>
<head><title>401 Authorization Required</title></head>
<body>
<center><h1>401 Authorization Required</h1></center>
<hr><center>nginx/1.27.1</center>
</body>
</html>

    at sendPasswordResetEmail [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:834:11[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:537:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:727:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should rate limit password reset requests
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:527:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:727:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'a9f2d15f-e695-4b49-93f1-05b4bc77df14'[39m,
  [32m'a45787229e4053e1473523408949f1d5'[39m,
  [32m'password_reset_requested'[39m,
  [32m'auth'[39m,
  [32m'a45787229e4053e1473523408949f1d5'[39m,
  [33m1763070586[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"reset@example.com"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should rate limit password reset requests
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:527:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:727:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should rate limit password reset requests
Failed to send password reset email: Error: Failed to send email: <html>
<head><title>401 Authorization Required</title></head>
<body>
<center><h1>401 Authorization Required</h1></center>
<hr><center>nginx/1.27.1</center>
</body>
</html>

    at sendPasswordResetEmail [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:834:11[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:537:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:727:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should normalize email to lowercase
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:527:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:761:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'79a8f7f7-eda1-446f-80f7-5238e489ee3b'[39m,
  [32m'63727b508d8b9cc5b31565c0a3bc474a'[39m,
  [32m'password_reset_requested'[39m,
  [32m'auth'[39m,
  [32m'63727b508d8b9cc5b31565c0a3bc474a'[39m,
  [33m1763070588[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"casesensitive@example.com"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should normalize email to lowercase
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:527:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:761:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should normalize email to lowercase
Failed to send password reset email: Error: Failed to send email: <html>
<head><title>401 Authorization Required</title></head>
<body>
<center><h1>401 Authorization Required</h1></center>
<hr><center>nginx/1.27.1</center>
</body>
</html>

    at sendPasswordResetEmail [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:834:11[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:537:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:761:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should log password reset request
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:527:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:808:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'c05fd5d1-b3ad-460a-88ac-5be4b3d54433'[39m,
  [32m'5b5f31d55d063fe3fbcc6a13a5cf54e4'[39m,
  [32m'password_reset_requested'[39m,
  [32m'auth'[39m,
  [32m'5b5f31d55d063fe3fbcc6a13a5cf54e4'[39m,
  [33m1763070592[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"reset@example.com"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should log password reset request
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:527:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:808:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should log password reset request
Failed to send password reset email: Error: Failed to send email: <html>
<head><title>401 Authorization Required</title></head>
<body>
<center><h1>401 Authorization Required</h1></center>
<hr><center>nginx/1.27.1</center>
</body>
</html>

    at sendPasswordResetEmail [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:834:11[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at Module.handlePasswordResetRequest [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:537:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:808:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/reset-password > should reset password with valid token
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handlePasswordReset [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:617:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:849:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'62cc4bd0-5b7b-436a-9861-050004b1c487'[39m,
  [32m'fc23b78ad85578a5942de2928aebe526'[39m,
  [32m'password_reset'[39m,
  [32m'auth'[39m,
  [32m'fc23b78ad85578a5942de2928aebe526'[39m,
  [33m1763070595[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/reset-password > should reset password with valid token
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handlePasswordReset [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:617:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:849:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/reset-password > should mark reset token as used
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handlePasswordReset [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:617:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:875:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'd66f743f-57c9-4061-a64d-c2824bb055b8'[39m,
  [32m'9ecb189aea8b1ad5fa88ae332b016a8c'[39m,
  [32m'password_reset'[39m,
  [32m'auth'[39m,
  [32m'9ecb189aea8b1ad5fa88ae332b016a8c'[39m,
  [33m1763070598[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/reset-password > should mark reset token as used
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handlePasswordReset [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:617:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:875:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/reset-password > should hash new password with bcrypt
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handlePasswordReset [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:617:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:970:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'0c2fbbed-96b6-4959-aa09-e02770041755'[39m,
  [32m'21c09d6f78ef39be732757845ac8f4b0'[39m,
  [32m'password_reset'[39m,
  [32m'auth'[39m,
  [32m'21c09d6f78ef39be732757845ac8f4b0'[39m,
  [33m1763070607[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/reset-password > should hash new password with bcrypt
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handlePasswordReset [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:617:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:970:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/reset-password > should log password reset event
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handlePasswordReset [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:617:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:990:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'70f7fe78-f517-44fa-9064-8fbb7e07c5a7'[39m,
  [32m'96a48d67350964a00d388efac464ac08'[39m,
  [32m'password_reset'[39m,
  [32m'auth'[39m,
  [32m'96a48d67350964a00d388efac464ac08'[39m,
  [33m1763070610[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/reset-password > should log password reset event
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handlePasswordReset [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:617:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:990:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/logout > should logout and destroy session
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogout [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:343:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1037:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'7a77f1fb-add4-482d-951b-fd6ab3735381'[39m,
  [32m'988210bb8c9e26e8288b3f234eac66a1'[39m,
  [32m'logout'[39m,
  [32m'auth'[39m,
  [32m'988210bb8c9e26e8288b3f234eac66a1'[39m,
  [33m1763070614[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/logout > should logout and destroy session
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogout [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:343:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1037:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/logout > should clear session cookie
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogout [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:343:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1055:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'aba79f13-faff-494b-8a28-cb48889b53cb'[39m,
  [32m'f34363dcb757a156815efba497d73038'[39m,
  [32m'logout'[39m,
  [32m'auth'[39m,
  [32m'f34363dcb757a156815efba497d73038'[39m,
  [33m1763070616[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/logout > should clear session cookie
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogout [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:343:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1055:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/logout > should log logout event
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogout [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:343:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1069:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'53d9810a-11cb-4daa-8a90-f2a68dc25001'[39m,
  [32m'59a1214602843365cc142218821d4597'[39m,
  [32m'logout'[39m,
  [32m'auth'[39m,
  [32m'59a1214602843365cc142218821d4597'[39m,
  [33m1763070618[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/logout > should log logout event
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleLogout [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:343:7[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1069:5
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > GET /auth/me > should return current user with valid session
Cache get error for key user:86348f1bc657f47317568fac6dd1349e: TypeError: Cannot read properties of undefined (reading 'get')
    at CacheManager.get [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:62:35[90m)[39m
    at CacheManager.getOrFetch [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:124:31[90m)[39m
    at UserCache.getProfile [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:153:23[90m)[39m
    at Module.handleGetMe [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:387:35[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1118:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > GET /auth/me > should return current user with valid session
Cache set error for key user:86348f1bc657f47317568fac6dd1349e: TypeError: Cannot read properties of undefined (reading 'put')
    at CacheManager.set [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:79:21[90m)[39m
    at CacheManager.getOrFetch [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:134:18[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at Module.handleGetMe [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:387:18[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1118:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > GET /auth/me > should not return password hash
Cache get error for key user:ad56404ea512501902f42d6bcfbb3518: TypeError: Cannot read properties of undefined (reading 'get')
    at CacheManager.get [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:62:35[90m)[39m
    at CacheManager.getOrFetch [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:124:31[90m)[39m
    at UserCache.getProfile [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:153:23[90m)[39m
    at Module.handleGetMe [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:387:35[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1135:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > GET /auth/me > should not return password hash
Cache set error for key user:ad56404ea512501902f42d6bcfbb3518: TypeError: Cannot read properties of undefined (reading 'put')
    at CacheManager.set [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:79:21[90m)[39m
    at CacheManager.getOrFetch [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:134:18[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at Module.handleGetMe [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:387:18[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1135:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > GET /auth/me > should return email verification status
Cache get error for key user:2d1a4626f7f959791db2e68fcbdc5d28: TypeError: Cannot read properties of undefined (reading 'get')
    at CacheManager.get [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:62:35[90m)[39m
    at CacheManager.getOrFetch [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:124:31[90m)[39m
    at UserCache.getProfile [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:153:23[90m)[39m
    at Module.handleGetMe [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:387:35[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1177:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > GET /auth/me > should return email verification status
Cache set error for key user:2d1a4626f7f959791db2e68fcbdc5d28: TypeError: Cannot read properties of undefined (reading 'put')
    at CacheManager.set [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:79:21[90m)[39m
    at CacheManager.getOrFetch [90m(/mnt/d/manuscript-platform/[39msrc/utils/db-cache.js:134:18[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at Module.handleGetMe [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:387:18[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1177:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/resend-verification > should resend verification email for unverified user
[Email] RESEND_API_KEY not configured

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/resend-verification > should resend verification email for unverified user
Verification email resent to: resend@example.com

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/resend-verification > should resend verification email for unverified user
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleResendVerification [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:747:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1213:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'51ad1001-c4f8-44c1-acf2-be1dabcec67c'[39m,
  [32m'3caf8dfacf39a0f0795404fb083ad6aa'[39m,
  [32m'verification_resent'[39m,
  [32m'auth'[39m,
  [32m'3caf8dfacf39a0f0795404fb083ad6aa'[39m,
  [33m1763070635[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"resend@example.com"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/resend-verification > should resend verification email for unverified user
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleResendVerification [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:747:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1213:22
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/resend-verification > should rate limit resend requests
[Email] RESEND_API_KEY not configured

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/resend-verification > should rate limit resend requests
Verification email resent to: resend@example.com

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/resend-verification > should rate limit resend requests
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleResendVerification [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:747:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1262:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'22ace978-b416-4e79-b5f5-2dceb5057c59'[39m,
  [32m'ab82ee65404e6477247b16179de6129e'[39m,
  [32m'verification_resent'[39m,
  [32m'auth'[39m,
  [32m'ab82ee65404e6477247b16179de6129e'[39m,
  [33m1763070639[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"resend@example.com"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/resend-verification > should rate limit resend requests
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleResendVerification [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:747:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1262:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/resend-verification > should rate limit resend requests
[Email] RESEND_API_KEY not configured

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/resend-verification > should rate limit resend requests
Verification email resent to: resend@example.com

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/resend-verification > should rate limit resend requests
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleResendVerification [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:747:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1262:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'5b9c7a22-1aad-421f-804c-42c803ecd569'[39m,
  [32m'ab82ee65404e6477247b16179de6129e'[39m,
  [32m'verification_resent'[39m,
  [32m'auth'[39m,
  [32m'ab82ee65404e6477247b16179de6129e'[39m,
  [33m1763070639[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"resend@example.com"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/resend-verification > should rate limit resend requests
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleResendVerification [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:747:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1262:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/resend-verification > should rate limit resend requests
[Email] RESEND_API_KEY not configured

stdout | tests/integration/handlers/auth-handlers.test.js > POST /auth/resend-verification > should rate limit resend requests
Verification email resent to: resend@example.com

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/resend-verification > should rate limit resend requests
Database query error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleResendVerification [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:747:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1262:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}
Query: 
      INSERT INTO audit_log (id, user_id, action, resource_type, resource_id, timestamp, ip_address, user_agent, metadata)
      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
    
Params: [
  [32m'5b3eeb5e-234c-449f-81b7-0067b49a6747'[39m,
  [32m'ab82ee65404e6477247b16179de6129e'[39m,
  [32m'verification_resent'[39m,
  [32m'auth'[39m,
  [32m'ab82ee65404e6477247b16179de6129e'[39m,
  [33m1763070639[39m,
  [32m'unknown'[39m,
  [32m'unknown'[39m,
  [32m'{"email":"resend@example.com"}'[39m
]

stderr | tests/integration/handlers/auth-handlers.test.js > POST /auth/resend-verification > should rate limit resend requests
Audit log error: error: column "action" of relation "audit_log" does not exist
    at [90m/mnt/d/manuscript-platform/[39mnode_modules/[4mpg-pool[24m/index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at PreparedStatement._executeQuery [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:185:22[90m)[39m
    at PreparedStatement.run [90m(/mnt/d/manuscript-platform/[39msrc/adapters/database-adapter.js:163:20[90m)[39m
    at logAuthEvent [90m(/mnt/d/manuscript-platform/[39msrc/utils/auth-utils.js:330:5[90m)[39m
    at Module.handleResendVerification [90m(/mnt/d/manuscript-platform/[39msrc/handlers/auth-handlers.js:747:5[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/handlers/auth-handlers.test.js:1262:7
    at [90mfile:///mnt/d/manuscript-platform/[39mnode_modules/[4m@vitest[24m/runner/dist/chunk-hooks.js:752:20 {
  length: [33m128[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42703'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'44'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_target.c'[39m,
  line: [32m'1070'[39m,
  routine: [32m'checkInsertTargets'[39m
}

stdout | tests/integration/handlers/auth-handlers.test.js

ðŸ§¹ Tearing down test environment...

stdout | tests/integration/handlers/auth-handlers.test.js
âœ“ Test database cleaned

stdout | tests/integration/handlers/auth-handlers.test.js
âœ“ Database adapter closed

stdout | tests/integration/handlers/auth-handlers.test.js
âœ“ Test database disconnected

stdout | tests/integration/handlers/auth-handlers.test.js
âœ“ Test database cleaned up
âœ“ Test environment cleaned up


 â¯ tests/integration/handlers/auth-handlers.test.js (53 tests | 7 failed) 134669ms
   âœ“ POST /auth/register > should register a new user with valid credentials  1776ms
   âœ“ POST /auth/register > should reject registration with weak password  1494ms
   âœ“ POST /auth/register > should reject registration with invalid email  1527ms
   âœ“ POST /auth/register > should reject registration with duplicate email  2623ms
   âœ“ POST /auth/register > should hash password with bcrypt  2169ms
   âœ“ POST /auth/register > should normalize email to lowercase  2616ms
   âœ“ POST /auth/register > should create verification token  2472ms
   âœ“ POST /auth/register > should send verification email  2530ms
   Ã— POST /auth/register > should log registration event in audit log 2250ms
     â†’ expected 0 to be greater than 0
   âœ“ POST /auth/register > should set default role to author if not specified  1580ms
   âœ“ POST /auth/login > should login with valid credentials  1619ms
   âœ“ POST /auth/login > should reject login with wrong password  2401ms
   âœ“ POST /auth/login > should reject login with non-existent email  2423ms
   âœ“ POST /auth/login > should reject login with unverified email  2173ms
   âœ“ POST /auth/login > should rate limit after 5 failed attempts  3309ms
   âœ“ POST /auth/login > should update last_login timestamp  2021ms
   âœ“ POST /auth/login > should create session in Redis  2444ms
   Ã— POST /auth/login > should log successful login 1990ms
     â†’ expected 0 to be greater than 0
   Ã— POST /auth/login > should log failed login attempts 1702ms
     â†’ expected 0 to be greater than 0
   âœ“ POST /auth/verify-email > should verify email with valid token  2813ms
   âœ“ POST /auth/verify-email > should reject invalid token  2650ms
   âœ“ POST /auth/verify-email > should reject expired token  2052ms
   âœ“ POST /auth/verify-email > should reject already used token  1790ms
   âœ“ POST /auth/verify-email > should handle missing token  1574ms
   Ã— POST /auth/verify-email > should log email verification event 1577ms
     â†’ expected 0 to be greater than 0
   âœ“ POST /auth/request-password-reset > should create password reset token for valid email  4077ms
   âœ“ POST /auth/request-password-reset > should send password reset email  1959ms
   âœ“ POST /auth/request-password-reset > should not reveal if email does not exist (security)  2965ms
   âœ“ POST /auth/request-password-reset > should rate limit password reset requests  2184ms
   âœ“ POST /auth/request-password-reset > should normalize email to lowercase  2551ms
   âœ“ POST /auth/request-password-reset > should reject invalid email format  1648ms
   âœ“ POST /auth/request-password-reset > should handle missing email  1552ms
   Ã— POST /auth/request-password-reset > should log password reset request 1972ms
     â†’ expected 0 to be greater than 0
   âœ“ POST /auth/reset-password > should reset password with valid token  3014ms
   âœ“ POST /auth/reset-password > should mark reset token as used  3122ms
   âœ“ POST /auth/reset-password > should reject weak new password  2849ms
   âœ“ POST /auth/reset-password > should reject invalid token  1542ms
   âœ“ POST /auth/reset-password > should reject expired token  2462ms
   âœ“ POST /auth/reset-password > should reject already used token  1663ms
   âœ“ POST /auth/reset-password > should hash new password with bcrypt  2088ms
   Ã— POST /auth/reset-password > should log password reset event 2533ms
     â†’ expected 0 to be greater than 0
   âœ“ POST /auth/logout > should logout and destroy session  4371ms
   âœ“ POST /auth/logout > should clear session cookie  1796ms
   Ã— POST /auth/logout > should log logout event 2584ms
     â†’ expected 0 to be greater than 0
   âœ“ GET /auth/me > should return current user with valid session  2587ms
   âœ“ GET /auth/me > should not return password hash  7577ms
   âœ“ GET /auth/me > should reject request without session  1854ms
   âœ“ GET /auth/me > should reject request with invalid session  2041ms
   âœ“ GET /auth/me > should return email verification status  2227ms
   âœ“ POST /auth/resend-verification > should resend verification email for unverified user  2437ms
   âœ“ POST /auth/resend-verification > should reject resend for already verified user  2478ms
   âœ“ POST /auth/resend-verification > should rate limit resend requests  1963ms
   âœ“ POST /auth/resend-verification > should not reveal if email does not exist (security)  1605ms
stdout | process.<anonymous> (/mnt/d/manuscript-platform/tests/setup.js:115:11)

âš  Received SIGTERM, cleaning up...

stdout | tests/error-handling.test.js
[dotenv@17.2.3] injecting env (0) from .env.local -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

stdout | tests/error-handling.test.js

ðŸ§ª Setting up test environment...

stdout | tests/error-handling.test.js
âœ“ Test database connected

stdout | tests/error-handling.test.js
  Applying base schema...

stdout | tests/error-handling.test.js
  âœ“ Schema and migrations applied

stdout | tests/error-handling.test.js
âœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

stdout | tests/error-handling.test.js
âœ“ Test database initialized
Initializing adapters...
âœ“ Database adapter initialized
âœ“ Storage adapter initialized
âš  Running in test mode without Redis - using in-memory session store

stdout | tests/error-handling.test.js
âœ“ Session store initialized
âœ“ Cache adapter initialized
âœ“ Queue service initialized
âœ“ Environment initialized
âœ“ Session middleware applied
[VirusScanner] Initializing ClamAV at localhost:3310...

stdout | tests/error-handling.test.js
âœ“ Server adapters initialized
âœ“ Test environment ready


stderr | tests/error-handling.test.js > Error Handling > Error Classes > should create AppError with correct properties
[VirusScanner] Failed to initialize: connect ECONNREFUSED 127.0.0.1:3310

stderr | tests/error-handling.test.js > Error Handling > Error Classes > should create AppError with correct properties
âš  Virus scanner initialization failed (uploads will continue without scanning)

stdout | tests/error-handling.test.js

ðŸ§¹ Tearing down test environment...

stdout | tests/error-handling.test.js
âœ“ Test database cleaned

stdout | tests/error-handling.test.js
âœ“ Database adapter closed

stdout | tests/error-handling.test.js
âœ“ Test database disconnected

stdout | tests/error-handling.test.js
âœ“ Test database cleaned up
âœ“ Test environment cleaned up


 âœ“ tests/error-handling.test.js (24 tests) 70058ms
   âœ“ Error Handling > Error Classes > should create AppError with correct properties  1981ms
   âœ“ Error Handling > Error Classes > should serialize AppError to JSON correctly  1915ms
   âœ“ Error Handling > Error Classes > should create AuthenticationError with 401 status  1896ms
   âœ“ Error Handling > Error Classes > should create AuthorizationError with 403 status  2229ms
   âœ“ Error Handling > Error Classes > should create ValidationError with 400 status  2030ms
   âœ“ Error Handling > Error Classes > should create NotFoundError with 404 status  1661ms
   âœ“ Error Handling > Error Classes > should create RateLimitError with 429 status  1531ms
   âœ“ Error Handling > Error Classes > should create ConflictError with 409 status  2240ms
   âœ“ Error Handling > Error Classes > should create ServerError with 500 status  2700ms
   âœ“ Error Handling > Error Classes > should create ExternalServiceError with service name  1728ms
   âœ“ Error Handling > createErrorResponse > should create Response with correct status and JSON  2791ms
   âœ“ Error Handling > createErrorResponse > should handle generic Error objects  1485ms
   âœ“ Error Handling > createErrorResponse > should include Retry-After header for rate limit errors  1612ms
   âœ“ Error Handling > createErrorResponse > should merge additional headers  4927ms
   âœ“ Error Handling > Assertion Helpers > assert should not throw when condition is true  4819ms
   âœ“ Error Handling > Assertion Helpers > assert should throw ValidationError when condition is false  1522ms
   âœ“ Error Handling > Assertion Helpers > assert should include details in error  3988ms
   âœ“ Error Handling > Assertion Helpers > assertAuthenticated should not throw when userId exists  1477ms
   âœ“ Error Handling > Assertion Helpers > assertAuthenticated should throw when userId is null  4450ms
   âœ“ Error Handling > Assertion Helpers > assertAuthenticated should throw when userId is undefined  1611ms
   âœ“ Error Handling > Assertion Helpers > assertAuthorized should not throw when permission is true  3974ms
   âœ“ Error Handling > Assertion Helpers > assertAuthorized should throw when permission is false  1496ms
   âœ“ Error Handling > Error Inheritance > should maintain instanceof relationships  4141ms
   âœ“ Error Handling > Error Inheritance > should have correct error names  1809ms
stdout | process.<anonymous> (/mnt/d/manuscript-platform/tests/setup.js:115:11)

âš  Received SIGTERM, cleaning up...

stdout | tests/integration/webhook-signature-verification.test.js
[dotenv@17.2.3] injecting env (0) from .env.local -- tip: âš™ï¸  suppress all logs with { quiet: true }

stdout | tests/integration/webhook-signature-verification.test.js

ðŸ§ª Setting up test environment...

stdout | tests/integration/webhook-signature-verification.test.js
âœ“ Test database connected

stdout | tests/integration/webhook-signature-verification.test.js
  Applying base schema...

stdout | tests/integration/webhook-signature-verification.test.js
  âœ“ Schema and migrations applied

stdout | tests/integration/webhook-signature-verification.test.js
âœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

stdout | tests/integration/webhook-signature-verification.test.js
âœ“ Test database initialized
Initializing adapters...
âœ“ Database adapter initialized
âœ“ Storage adapter initialized
âš  Running in test mode without Redis - using in-memory session store

stdout | tests/integration/webhook-signature-verification.test.js
âœ“ Session store initialized
âœ“ Cache adapter initialized
âœ“ Queue service initialized
âœ“ Environment initialized
âœ“ Session middleware applied
[VirusScanner] Initializing ClamAV at localhost:3310...

stdout | tests/integration/webhook-signature-verification.test.js
âœ“ Server adapters initialized
âœ“ Test environment ready


stderr | tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Valid Signatures > should accept webhook with valid signature
[VirusScanner] Failed to initialize: connect ECONNREFUSED 127.0.0.1:3310

stderr | tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Valid Signatures > should accept webhook with valid signature
âš  Virus scanner initialization failed (uploads will continue without scanning)

stdout | tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Valid Signatures > should accept webhook with valid signature
[Webhook] Processing event: checkout.session.completed evt_test_d69eeb1154fe62db99ba9859
[Webhook] Checkout completed for user: user-123 plan: [90mundefined[39m

stdout | tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Valid Signatures > should accept webhook with valid signature
[Webhook] One-time payment recorded: bb31e032-0528-4c28-8d66-dfec9aaf4842

stderr | tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Valid Signatures > should accept webhook with valid signature
[Budget] No budget config found

stderr | tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Valid Signatures > should accept webhook with valid signature
[Budget] Error updating user spend: TypeError: Cannot read properties of undefined (reading 'current_spend_usd')
    at updateUserSpend [90m(/mnt/d/manuscript-platform/[39msrc/utils/cost-utils.js:296:34[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:95:5)[39m
    at logCost [90m(/mnt/d/manuscript-platform/[39msrc/utils/cost-utils.js:169:7[90m)[39m
    at handleCheckoutCompleted [90m(/mnt/d/manuscript-platform/[39msrc/handlers/webhook-handlers.js:183:7[90m)[39m
    at handleStripeWebhook [90m(/mnt/d/manuscript-platform/[39msrc/handlers/webhook-handlers.js:55:9[90m)[39m
    at [90m/mnt/d/manuscript-platform/[39mtests/integration/webhook-signature-verification.test.js:110:26

stdout | tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Valid Signatures > should accept webhook with valid signature
[Cost Tracking] Logged stripe_fees/payment_processing/one_time_payment: $1.1697

stdout | tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Valid Signatures > should accept webhook with recent timestamp (within 5 min)
[Webhook] Processing event: checkout.session.completed evt_test_c49adee56f320be1d00d25e3
[Webhook] Checkout completed for user: [90mundefined[39m plan: [90mundefined[39m

stdout | tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Valid Signatures > should accept webhook with recent timestamp (within 5 min)
[Webhook] One-time payment recorded: 10d22af8-d756-484d-8ce4-6b4402384d3b

stderr | tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Valid Signatures > should accept webhook with recent timestamp (within 5 min)
[Budget] No budget config found

stdout | tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Valid Signatures > should accept webhook with recent timestamp (within 5 min)
[Cost Tracking] Logged stripe_fees/payment_processing/one_time_payment: $1.1697

stderr | tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Invalid Signatures > should reject webhook with incorrect signature
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


stderr | tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Invalid Signatures > should reject webhook with malformed signature format
[Webhook] Signature verification failed: No signatures found with expected scheme

stderr | tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Invalid Signatures > should reject webhook with tampered payload
[Webhook] Signature verification failed: No signatures found matching the expected signature for payload. Are you passing the raw request body you received from Stripe? 
 If a webhook request is being forwarded by a third-party tool, ensure that the exact request body, including JSON formatting and new line style, is preserved.

Learn more about webhook signing and explore webhook integration examples for various frameworks at https://docs.stripe.com/webhooks/signature


stderr | tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Replay Attack Prevention > should reject webhook with expired timestamp (>5 min old)
[Webhook] Signature verification failed: Timestamp outside the tolerance zone

stdout | tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Replay Attack Prevention > should accept webhook with future timestamp (Stripe allows clock skew)
[Webhook] Processing event: checkout.session.completed evt_test_aa938543806794a0868d4524
[Webhook] Checkout completed for user: [90mundefined[39m plan: [90mundefined[39m

stdout | tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Replay Attack Prevention > should accept webhook with future timestamp (Stripe allows clock skew)
[Webhook] One-time payment recorded: a3447f09-4931-44a2-bb39-d41a9b746491

stderr | tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Replay Attack Prevention > should accept webhook with future timestamp (Stripe allows clock skew)
[Budget] No budget config found

stdout | tests/integration/webhook-signature-verification.test.js > Webhook Signature Verification > Replay Attack Prevention > should accept webhook with future timestamp (Stripe allows clock skew)
[Cost Tracking] Logged stripe_fees/payment_processing/one_time_payment: $1.1697

stdout | tests/integration/webhook-signature-verification.test.js

ðŸ§¹ Tearing down test environment...

stdout | tests/integration/webhook-signature-verification.test.js
âœ“ Test database cleaned

stdout | tests/integration/webhook-signature-verification.test.js
âœ“ Database adapter closed

stdout | tests/integration/webhook-signature-verification.test.js
âœ“ Test database disconnected

stdout | tests/integration/webhook-signature-verification.test.js
âœ“ Test database cleaned up
âœ“ Test environment cleaned up


 âœ“ tests/integration/webhook-signature-verification.test.js (9 tests) 39475ms
   âœ“ Webhook Signature Verification > Valid Signatures > should accept webhook with valid signature  2184ms
   âœ“ Webhook Signature Verification > Valid Signatures > should accept webhook with recent timestamp (within 5 min)  2010ms
   âœ“ Webhook Signature Verification > Missing Signature > should reject webhook with no signature header  2008ms
   âœ“ Webhook Signature Verification > Missing Signature > should reject webhook with empty signature  2243ms
   âœ“ Webhook Signature Verification > Invalid Signatures > should reject webhook with incorrect signature  5695ms
   âœ“ Webhook Signature Verification > Invalid Signatures > should reject webhook with malformed signature format  3181ms
   âœ“ Webhook Signature Verification > Invalid Signatures > should reject webhook with tampered payload  1983ms
   âœ“ Webhook Signature Verification > Replay Attack Prevention > should reject webhook with expired timestamp (>5 min old)  5646ms
   âœ“ Webhook Signature Verification > Replay Attack Prevention > should accept webhook with future timestamp (Stripe allows clock skew)  3800ms
stdout | process.<anonymous> (/mnt/d/manuscript-platform/tests/setup.js:115:11)

âš  Received SIGTERM, cleaning up...

stdout | tests/document-generation.test.js
[dotenv@17.2.3] injecting env (0) from .env.local -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

stdout | tests/document-generation.test.js

ðŸ§ª Setting up test environment...

stdout | tests/document-generation.test.js
âœ“ Test database connected

stdout | tests/document-generation.test.js
  Applying base schema...

stdout | tests/document-generation.test.js
  âœ“ Schema and migrations applied

stdout | tests/document-generation.test.js
âœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

stdout | tests/document-generation.test.js
âœ“ Test database initialized
Initializing adapters...
âœ“ Database adapter initialized
âœ“ Storage adapter initialized
âš  Running in test mode without Redis - using in-memory session store

stdout | tests/document-generation.test.js
âœ“ Session store initialized
âœ“ Cache adapter initialized
âœ“ Queue service initialized
âœ“ Environment initialized
âœ“ Session middleware applied
[VirusScanner] Initializing ClamAV at localhost:3310...

stdout | tests/document-generation.test.js
âœ“ Server adapters initialized
âœ“ Test environment ready


stderr | tests/document-generation.test.js > Document Generation > Query Letter Generation > should generate query letter within word count range
[VirusScanner] Failed to initialize: connect ECONNREFUSED 127.0.0.1:3310

stderr | tests/document-generation.test.js > Document Generation > Query Letter Generation > should generate query letter within word count range
âš  Virus scanner initialization failed (uploads will continue without scanning)

stdout | tests/document-generation.test.js

ðŸ§¹ Tearing down test environment...

stdout | tests/document-generation.test.js
âœ“ Test database cleaned

stdout | tests/document-generation.test.js
âœ“ Database adapter closed

stdout | tests/document-generation.test.js
âœ“ Test database disconnected

stdout | tests/document-generation.test.js
âœ“ Test database cleaned up
âœ“ Test environment cleaned up


 âœ“ tests/document-generation.test.js (27 tests) 85541ms
   âœ“ Document Generation > Query Letter Generation > should generate query letter within word count range  2014ms
   âœ“ Document Generation > Query Letter Generation > should include essential query letter components  2989ms
   âœ“ Document Generation > Query Letter Generation > should validate query letter structure  2437ms
   âœ“ Document Generation > Query Letter Generation > should reject query letters that are too short  4053ms
   âœ“ Document Generation > Query Letter Generation > should reject query letters that are too long  2825ms
   âœ“ Document Generation > Synopsis Generation > should generate short synopsis at 500 words  4431ms
   âœ“ Document Generation > Synopsis Generation > should generate long synopsis at 2500 words  3699ms
   âœ“ Document Generation > Synopsis Generation > should include beginning, middle, and end  2733ms
   âœ“ Document Generation > Synopsis Generation > should reveal ending (unlike blurb)  3648ms
   âœ“ Document Generation > Synopsis Generation > should maintain chronological order  2967ms
   âœ“ Document Generation > Version Management > should create new version on update  3761ms
   âœ“ Document Generation > Version Management > should track version metadata  3063ms
   âœ“ Document Generation > Version Management > should allow rollback to previous version  3348ms
   âœ“ Document Generation > Version Management > should maintain version history after rollback  3189ms
   âœ“ Document Generation > Document Validation > should validate document type  3370ms
   âœ“ Document Generation > Document Validation > should reject invalid document type  1616ms
   âœ“ Document Generation > Document Validation > should validate required fields  1506ms
   âœ“ Document Generation > Document Validation > should calculate word count accurately  2103ms
   âœ“ Document Generation > Document Validation > should handle empty document  3223ms
   âœ“ Document Generation > AI Generation Metadata > should track generation parameters  3550ms
   âœ“ Document Generation > AI Generation Metadata > should calculate cost based on token usage  2438ms
   âœ“ Document Generation > Batch Generation > should generate all document types at once  1761ms
   âœ“ Document Generation > Batch Generation > should track individual generation status  1618ms
   âœ“ Document Generation > Edge Cases > should handle very short manuscript title  1465ms
   âœ“ Document Generation > Edge Cases > should handle very long manuscript title  1490ms
   âœ“ Document Generation > Edge Cases > should handle special characters in content  1458ms
   âœ“ Document Generation > Edge Cases > should handle unicode characters  2745ms
stdout | process.<anonymous> (/mnt/d/manuscript-platform/tests/setup.js:115:11)

âš  Received SIGTERM, cleaning up...

stdout | tests/submission-packages.test.js
[dotenv@17.2.3] injecting env (0) from .env.local -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

stdout | tests/submission-packages.test.js

ðŸ§ª Setting up test environment...

stdout | tests/submission-packages.test.js
âœ“ Test database connected

stdout | tests/submission-packages.test.js
  Applying base schema...

stdout | tests/submission-packages.test.js
  âœ“ Schema and migrations applied

stdout | tests/submission-packages.test.js
âœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

stdout | tests/submission-packages.test.js
âœ“ Test database initialized
Initializing adapters...
âœ“ Database adapter initialized
âœ“ Storage adapter initialized
âš  Running in test mode without Redis - using in-memory session store

stdout | tests/submission-packages.test.js
âœ“ Session store initialized
âœ“ Cache adapter initialized
âœ“ Queue service initialized
âœ“ Environment initialized
âœ“ Session middleware applied
[VirusScanner] Initializing ClamAV at localhost:3310...

stdout | tests/submission-packages.test.js
âœ“ Server adapters initialized
âœ“ Test environment ready


stderr | tests/submission-packages.test.js > Submission Package Bundler > Package Templates > should have agent query template
[VirusScanner] Failed to initialize: connect ECONNREFUSED 127.0.0.1:3310

stderr | tests/submission-packages.test.js > Submission Package Bundler > Package Templates > should have agent query template
âš  Virus scanner initialization failed (uploads will continue without scanning)

stdout | tests/submission-packages.test.js

ðŸ§¹ Tearing down test environment...

stdout | tests/submission-packages.test.js
âœ“ Test database cleaned

stdout | tests/submission-packages.test.js
âœ“ Database adapter closed

stdout | tests/submission-packages.test.js
âœ“ Test database disconnected

stdout | tests/submission-packages.test.js
âœ“ Test database cleaned up
âœ“ Test environment cleaned up


 â¯ tests/submission-packages.test.js (31 tests | 1 failed) 72973ms
   âœ“ Submission Package Bundler > Package Templates > should have agent query template  1499ms
   âœ“ Submission Package Bundler > Package Templates > should have full manuscript template  1873ms
   âœ“ Submission Package Bundler > Package Templates > should have query only template  2523ms
   âœ“ Submission Package Bundler > Package Templates > should have contest template  1869ms
   âœ“ Submission Package Bundler > Package Templates > should validate required documents  1678ms
   âœ“ Submission Package Bundler > Package Creation > should create package with metadata  1895ms
   âœ“ Submission Package Bundler > Package Creation > should include document list with ordering  2111ms
   âœ“ Submission Package Bundler > Package Creation > should validate package has at least one document  2083ms
   âœ“ Submission Package Bundler > Package Creation > should allow custom package names  1896ms
   âœ“ Submission Package Bundler > Document Selection > should allow selecting multiple documents  2616ms
   âœ“ Submission Package Bundler > Document Selection > should maintain document order  1450ms
   âœ“ Submission Package Bundler > Document Selection > should allow reordering documents  1458ms
   âœ“ Submission Package Bundler > ZIP File Generation > should generate ZIP with multiple files  2522ms
   âœ“ Submission Package Bundler > ZIP File Generation > should prefix files with order numbers  1446ms
   âœ“ Submission Package Bundler > ZIP File Generation > should sanitize filenames  1489ms
   âœ“ Submission Package Bundler > ZIP File Generation > should support different file formats  2393ms
   âœ“ Submission Package Bundler > ZIP File Generation > should include metadata file in ZIP  2892ms
   Ã— Submission Package Bundler > Package Duplication > should create copy of existing package 2264ms
     â†’ Hook timed out in 10000ms.
If this is a long-running hook, pass a timeout value as the last argument or configure it globally with "hookTimeout".
   âœ“ Submission Package Bundler > Package Duplication > should increment copy counter in name  2528ms
   âœ“ Submission Package Bundler > Package Management > should list packages for manuscript  1448ms
   âœ“ Submission Package Bundler > Package Management > should update package details  2208ms
   âœ“ Submission Package Bundler > Package Management > should delete package  2738ms
   âœ“ Submission Package Bundler > Validation > should validate package has required documents  1477ms
   âœ“ Submission Package Bundler > Validation > should validate document exists before adding to package  1901ms
   âœ“ Submission Package Bundler > Validation > should prevent duplicate documents in package  2730ms
   âœ“ Submission Package Bundler > Download Tracking > should track download count  1484ms
   âœ“ Submission Package Bundler > Download Tracking > should track last downloaded timestamp  1886ms
   âœ“ Submission Package Bundler > Edge Cases > should handle empty package name  1957ms
   âœ“ Submission Package Bundler > Edge Cases > should handle very long package name  1872ms
   âœ“ Submission Package Bundler > Edge Cases > should handle package with only one document  1502ms
   âœ“ Submission Package Bundler > Edge Cases > should handle large file sizes  3111ms
stdout | process.<anonymous> (/mnt/d/manuscript-platform/tests/setup.js:115:11)

âš  Received SIGTERM, cleaning up...

stdout | tests/auth-utils.test.js
[dotenv@17.2.3] injecting env (0) from .env.local -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

stdout | tests/auth-utils.test.js

ðŸ§ª Setting up test environment...

stdout | tests/auth-utils.test.js
âœ“ Test database connected

stdout | tests/auth-utils.test.js
  Applying base schema...

stdout | tests/auth-utils.test.js
  âœ“ Schema and migrations applied

stdout | tests/auth-utils.test.js
âœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

stdout | tests/auth-utils.test.js
âœ“ Test database initialized
Initializing adapters...
âœ“ Database adapter initialized
âœ“ Storage adapter initialized
âš  Running in test mode without Redis - using in-memory session store

stdout | tests/auth-utils.test.js
âœ“ Session store initialized
âœ“ Cache adapter initialized
âœ“ Queue service initialized
âœ“ Environment initialized
âœ“ Session middleware applied
[VirusScanner] Initializing ClamAV at localhost:3310...

stdout | tests/auth-utils.test.js
âœ“ Server adapters initialized
âœ“ Test environment ready


stderr | tests/auth-utils.test.js > Authentication Utilities > validatePassword > should accept a valid password
[VirusScanner] Failed to initialize: connect ECONNREFUSED 127.0.0.1:3310

stderr | tests/auth-utils.test.js > Authentication Utilities > validatePassword > should accept a valid password
âš  Virus scanner initialization failed (uploads will continue without scanning)

stdout | tests/auth-utils.test.js

ðŸ§¹ Tearing down test environment...

stdout | tests/auth-utils.test.js
âœ“ Test database cleaned

stdout | tests/auth-utils.test.js
âœ“ Database adapter closed

stdout | tests/auth-utils.test.js
âœ“ Test database disconnected

stdout | tests/auth-utils.test.js
âœ“ Test database cleaned up
âœ“ Test environment cleaned up


 âœ“ tests/auth-utils.test.js (22 tests) 55248ms
   âœ“ Authentication Utilities > validatePassword > should accept a valid password  1521ms
   âœ“ Authentication Utilities > validatePassword > should reject password shorter than 8 characters  1439ms
   âœ“ Authentication Utilities > validatePassword > should reject password without uppercase letter  2542ms
   âœ“ Authentication Utilities > validatePassword > should reject password without lowercase letter  1652ms
   âœ“ Authentication Utilities > validatePassword > should reject password without number  1468ms
   âœ“ Authentication Utilities > validatePassword > should reject password without special character  1444ms
   âœ“ Authentication Utilities > validatePassword > should reject null or undefined password  3052ms
   âœ“ Authentication Utilities > validatePassword > should accept password with all requirements  3091ms
   âœ“ Authentication Utilities > validatePassword > should return multiple errors for invalid password  2628ms
   âœ“ Authentication Utilities > validateEmail > should accept valid email addresses  1568ms
   âœ“ Authentication Utilities > validateEmail > should reject invalid email addresses  1447ms
   âœ“ Authentication Utilities > validateEmail > should handle edge cases  2774ms
   âœ“ Authentication Utilities > hashPassword and verifyPassword > should hash a password  1656ms
   âœ“ Authentication Utilities > hashPassword and verifyPassword > should produce different hashes for same password  1578ms
   âœ“ Authentication Utilities > hashPassword and verifyPassword > should verify correct password  2569ms
   âœ“ Authentication Utilities > hashPassword and verifyPassword > should reject incorrect password  2498ms
   âœ“ Authentication Utilities > hashPassword and verifyPassword > should handle empty passwords  1636ms
   âœ“ Authentication Utilities > hashPassword and verifyPassword > should be case sensitive  2484ms
   âœ“ Authentication Utilities > hashPassword and verifyPassword > should handle long passwords  2652ms
   âœ“ Authentication Utilities > AUTH_CONFIG > should have valid configuration values  2437ms
   âœ“ Authentication Utilities > AUTH_CONFIG > should have password requirements defined  1813ms
   âœ“ Authentication Utilities > AUTH_CONFIG > should have rate limit configuration  1743ms
stdout | process.<anonymous> (/mnt/d/manuscript-platform/tests/setup.js:115:11)

âš  Received SIGTERM, cleaning up...

stdout | tests/unit/test-helpers.test.js
[dotenv@17.2.3] injecting env (0) from .env.local -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

stdout | tests/unit/test-helpers.test.js

ðŸ§ª Setting up test environment...

stdout | tests/unit/test-helpers.test.js
âœ“ Test database connected

stdout | tests/unit/test-helpers.test.js
  Applying base schema...

stdout | tests/unit/test-helpers.test.js
  âœ“ Schema and migrations applied

stdout | tests/unit/test-helpers.test.js
âœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

stdout | tests/unit/test-helpers.test.js
âœ“ Test database initialized
Initializing adapters...
âœ“ Database adapter initialized
âœ“ Storage adapter initialized
âš  Running in test mode without Redis - using in-memory session store

stdout | tests/unit/test-helpers.test.js
âœ“ Session store initialized
âœ“ Cache adapter initialized
âœ“ Queue service initialized
âœ“ Environment initialized
âœ“ Session middleware applied
[VirusScanner] Initializing ClamAV at localhost:3310...

stdout | tests/unit/test-helpers.test.js
âœ“ Server adapters initialized
âœ“ Test environment ready


stderr | tests/unit/test-helpers.test.js > Mock Factories > Storage Adapter Mock > should put and get objects
[VirusScanner] Failed to initialize: connect ECONNREFUSED 127.0.0.1:3310

stderr | tests/unit/test-helpers.test.js > Mock Factories > Storage Adapter Mock > should put and get objects
âš  Virus scanner initialization failed (uploads will continue without scanning)

stdout | tests/unit/test-helpers.test.js

ðŸ§¹ Tearing down test environment...

stdout | tests/unit/test-helpers.test.js
âœ“ Test database cleaned

stdout | tests/unit/test-helpers.test.js
âœ“ Database adapter closed

stdout | tests/unit/test-helpers.test.js
âœ“ Test database disconnected

stdout | tests/unit/test-helpers.test.js
âœ“ Test database cleaned up
âœ“ Test environment cleaned up


 âœ“ tests/unit/test-helpers.test.js (24 tests) 77586ms
   âœ“ Mock Factories > Storage Adapter Mock > should put and get objects  2222ms
   âœ“ Mock Factories > Storage Adapter Mock > should delete objects  1938ms
   âœ“ Mock Factories > Storage Adapter Mock > should list objects by prefix  1915ms
   âœ“ Mock Factories > Redis Mock > should set and get values  2514ms
   âœ“ Mock Factories > Redis Mock > should set values with expiration  3598ms
   âœ“ Mock Factories > Redis Mock > should delete keys  2751ms
   âœ“ Mock Factories > Redis Mock > should increment values  1928ms
   âœ“ Mock Factories > Claude API Mock > should return mock AI responses  5509ms
   âœ“ Mock Factories > Claude API Mock > should include custom response text  2820ms
   âœ“ Mock Factories > Email Service Mock > should track sent emails  4042ms
   âœ“ Mock Factories > Email Service Mock > should find emails by recipient  2712ms
   âœ“ Mock Factories > Email Service Mock > should clear sent emails  3623ms
   âœ“ Mock Factories > Stripe Mock > should create checkout sessions  2735ms
   âœ“ Mock Factories > Stripe Mock > should create payment intents  4600ms
   âœ“ Mock Factories > Stripe Mock > should construct webhook events  4435ms
   âœ“ Test Data Factories > User Factory > should create valid user data  2748ms
   âœ“ Test Data Factories > User Factory > should accept overrides  3599ms
   âœ“ Test Data Factories > Manuscript Factory > should create valid manuscript data  2037ms
   âœ“ Test Data Factories > Manuscript Factory > should accept overrides  1453ms
   âœ“ Test Data Factories > Analysis Factory > should create valid analysis data  2367ms
   âœ“ Test Data Factories > Analysis Factory > should include result JSON  1519ms
   âœ“ Test Data Factories > Payment Factory > should create valid payment data  1482ms
   âœ“ Test Data Factories > Utility Functions > should generate unique email addresses  1807ms
   âœ“ Test Data Factories > Utility Functions > should generate unique IDs  2021ms
stdout | process.<anonymous> (/mnt/d/manuscript-platform/tests/setup.js:115:11)

âš  Received SIGTERM, cleaning up...

stdout | tests/metadata-handlers.test.js
[dotenv@17.2.3] injecting env (0) from .env.local -- tip: âš™ï¸  override existing env vars with { override: true }

stdout | tests/metadata-handlers.test.js

ðŸ§ª Setting up test environment...

stdout | tests/metadata-handlers.test.js
âœ“ Test database connected

stdout | tests/metadata-handlers.test.js
  Applying base schema...

stdout | tests/metadata-handlers.test.js
  âœ“ Schema and migrations applied

stdout | tests/metadata-handlers.test.js
âœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

stdout | tests/metadata-handlers.test.js
âœ“ Test database initialized
Initializing adapters...
âœ“ Database adapter initialized
âœ“ Storage adapter initialized
âš  Running in test mode without Redis - using in-memory session store

stdout | tests/metadata-handlers.test.js
âœ“ Session store initialized
âœ“ Cache adapter initialized
âœ“ Queue service initialized
âœ“ Environment initialized
âœ“ Session middleware applied
[VirusScanner] Initializing ClamAV at localhost:3310...

stdout | tests/metadata-handlers.test.js
âœ“ Server adapters initialized
âœ“ Test environment ready


stderr | tests/metadata-handlers.test.js > Enhanced Metadata Handlers > Genre Validation > should validate word count for romance novel
[VirusScanner] Failed to initialize: connect ECONNREFUSED 127.0.0.1:3310

stderr | tests/metadata-handlers.test.js > Enhanced Metadata Handlers > Genre Validation > should validate word count for romance novel
âš  Virus scanner initialization failed (uploads will continue without scanning)

stdout | tests/metadata-handlers.test.js

ðŸ§¹ Tearing down test environment...

stdout | tests/metadata-handlers.test.js
âœ“ Test database cleaned

stdout | tests/metadata-handlers.test.js
âœ“ Database adapter closed

stdout | tests/metadata-handlers.test.js
âœ“ Test database disconnected

stdout | tests/metadata-handlers.test.js
âœ“ Test database cleaned up
âœ“ Test environment cleaned up


 âœ“ tests/metadata-handlers.test.js (21 tests) 53125ms
   âœ“ Enhanced Metadata Handlers > Genre Validation > should validate word count for romance novel  1543ms
   âœ“ Enhanced Metadata Handlers > Genre Validation > should flag word count outside genre norms  1460ms
   âœ“ Enhanced Metadata Handlers > Genre Validation > should accept novella word counts for appropriate genres  1886ms
   âœ“ Enhanced Metadata Handlers > Content Warning Validation > should validate content warning categories  1857ms
   âœ“ Enhanced Metadata Handlers > Content Warning Validation > should validate severity levels  1469ms
   âœ“ Enhanced Metadata Handlers > Content Warning Validation > should handle multiple content warnings  1502ms
   âœ“ Enhanced Metadata Handlers > Metadata Structure > should validate primary genre and subgenres  2585ms
   âœ“ Enhanced Metadata Handlers > Metadata Structure > should validate age category  2058ms
   âœ“ Enhanced Metadata Handlers > Metadata Structure > should validate manuscript status  1472ms
   âœ“ Enhanced Metadata Handlers > Metadata Structure > should validate series information  2086ms
   âœ“ Enhanced Metadata Handlers > Metadata History Tracking > should record metadata changes with timestamp  4035ms
   âœ“ Enhanced Metadata Handlers > Metadata History Tracking > should track multiple change types  1912ms
   âœ“ Enhanced Metadata Handlers > Genre Hierarchy > should validate parent-child genre relationships  1473ms
   âœ“ Enhanced Metadata Handlers > Genre Hierarchy > should handle subgenre depth  1491ms
   âœ“ Enhanced Metadata Handlers > Word Count Validation Logic > should categorize flash fiction correctly  1464ms
   âœ“ Enhanced Metadata Handlers > Word Count Validation Logic > should categorize novel correctly  2261ms
   âœ“ Enhanced Metadata Handlers > Word Count Validation Logic > should categorize epic correctly  2297ms
   âœ“ Enhanced Metadata Handlers > Edge Cases > should handle missing optional metadata fields  1667ms
   âœ“ Enhanced Metadata Handlers > Edge Cases > should handle empty subgenres array  5158ms
   âœ“ Enhanced Metadata Handlers > Edge Cases > should validate completion percentage range  1899ms
   âœ“ Enhanced Metadata Handlers > Edge Cases > should reject invalid completion percentage  1466ms
stdout | process.<anonymous> (/mnt/d/manuscript-platform/tests/setup.js:115:11)

âš  Received SIGTERM, cleaning up...

stdout | tests/integration/infrastructure.test.js
[dotenv@17.2.3] injecting env (0) from .env.local -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

stdout | tests/integration/infrastructure.test.js

ðŸ§ª Setting up test environment...

stdout | tests/integration/infrastructure.test.js
âœ“ Test database connected

stdout | tests/integration/infrastructure.test.js
  Applying base schema...

stdout | tests/integration/infrastructure.test.js
  âœ“ Schema and migrations applied

stdout | tests/integration/infrastructure.test.js
âœ“ Migrations applied
âœ“ Database adapter created (D1-compatible interface)

stdout | tests/integration/infrastructure.test.js
âœ“ Test database initialized
Initializing adapters...
âœ“ Database adapter initialized
âœ“ Storage adapter initialized
âš  Running in test mode without Redis - using in-memory session store

stdout | tests/integration/infrastructure.test.js
âœ“ Session store initialized
âœ“ Cache adapter initialized
âœ“ Queue service initialized
âœ“ Environment initialized
âœ“ Session middleware applied
[VirusScanner] Initializing ClamAV at localhost:3310...

stdout | tests/integration/infrastructure.test.js
âœ“ Server adapters initialized
âœ“ Test environment ready


stderr | tests/integration/infrastructure.test.js > Test Infrastructure > Database Utilities > should insert and retrieve test records
[VirusScanner] Failed to initialize: connect ECONNREFUSED 127.0.0.1:3310

stderr | tests/integration/infrastructure.test.js > Test Infrastructure > Database Utilities > should insert and retrieve test records
âš  Virus scanner initialization failed (uploads will continue without scanning)

[0mGET /health [32m200[0m 9.987 ms - 105[0m
stdout | tests/integration/infrastructure.test.js

ðŸ§¹ Tearing down test environment...

stdout | tests/integration/infrastructure.test.js
âœ“ Test database cleaned

stdout | tests/integration/infrastructure.test.js
âœ“ Database adapter closed

stdout | tests/integration/infrastructure.test.js
âœ“ Test database disconnected

stdout | tests/integration/infrastructure.test.js
âœ“ Test database cleaned up
âœ“ Test environment cleaned up


 â¯ tests/integration/infrastructure.test.js (13 tests | 2 failed) 36024ms
   âœ“ Test Infrastructure > Database Utilities > should insert and retrieve test records  1506ms
   âœ“ Test Infrastructure > Database Utilities > should count test records  1518ms
   âœ“ Test Infrastructure > Database Utilities > should reset database between tests  1530ms
   âœ“ Test Infrastructure > API Client > should make HTTP requests  2741ms
   âœ“ Test Infrastructure > Mock Factories > should create mock Redis client  1515ms
   Ã— Test Infrastructure > Mock Factories > should create mock Redis client with expiration 1507ms
     â†’ expected -2 to be greater than 0
   âœ“ Test Infrastructure > Mock Factories > should create mock storage adapter  2438ms
   Ã— Test Infrastructure > Test Data Factories > should create test user data 3759ms
     â†’ Hook timed out in 10000ms.
If this is a long-running hook, pass a timeout value as the last argument or configure it globally with "hookTimeout".
   âœ“ Test Infrastructure > Test Data Factories > should create test user with overrides  2404ms
   âœ“ Test Infrastructure > Test Data Factories > should create test manuscript data  1468ms
   âœ“ Test Infrastructure > Test Data Factories > should generate unique test emails  2580ms
   âœ“ Test Infrastructure > Integration: Factories + Database > should insert factory-generated user into database  2293ms
   âœ“ Test Infrastructure > Integration: Factories + Database > should insert factory-generated manuscript into database  1502ms
stdout | process.<anonymous> (/mnt/d/manuscript-platform/tests/setup.js:115:11)

âš  Received SIGTERM, cleaning up...


âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯ Failed Tests 10 âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯

 FAIL  tests/submission-packages.test.js > Submission Package Bundler > Package Duplication > should create copy of existing package
 FAIL  tests/integration/infrastructure.test.js > Test Infrastructure > Test Data Factories > should create test user data
Error: Hook timed out in 10000ms.
If this is a long-running hook, pass a timeout value as the last argument or configure it globally with "hookTimeout".
 â¯ tests/setup.js:80:11
     78|  * Only runs if database was initialized.
     79|  */
     80| beforeEach(async () => {
       |           ^
     81|   if (testDb) {
     82|     await resetTestDatabase();

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[1/10]âŽ¯

 FAIL  tests/integration/infrastructure.test.js > Test Infrastructure > Mock Factories > should create mock Redis client with expiration
AssertionError: expected -2 to be greater than 0
 â¯ tests/integration/infrastructure.test.js:87:19
     85| 
     86|       const ttl = await redis.ttl('expiring-key');
     87|       expect(ttl).toBeGreaterThan(0);
       |                   ^
     88|       expect(ttl).toBeLessThanOrEqual(1);
     89|     });

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[2/10]âŽ¯

 FAIL  tests/integration/handlers/auth-handlers.test.js > POST /auth/register > should log registration event in audit log
AssertionError: expected 0 to be greater than 0
 â¯ tests/integration/handlers/auth-handlers.test.js:244:24
    242| 
    243|     const auditCount = await countTestRecords('audit_log', { event_typâ€¦
    244|     expect(auditCount).toBeGreaterThan(0);
       |                        ^
    245|   });
    246| 

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[3/10]âŽ¯

 FAIL  tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should log successful login
AssertionError: expected 0 to be greater than 0
 â¯ tests/integration/handlers/auth-handlers.test.js:468:24
    466| 
    467|     const auditCount = await countTestRecords('audit_log', { event_typâ€¦
    468|     expect(auditCount).toBeGreaterThan(0);
       |                        ^
    469|   });
    470| 

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[4/10]âŽ¯

 FAIL  tests/integration/handlers/auth-handlers.test.js > POST /auth/login > should log failed login attempts
AssertionError: expected 0 to be greater than 0
 â¯ tests/integration/handlers/auth-handlers.test.js:485:24
    483| 
    484|     const auditCount = await countTestRecords('audit_log', { event_typâ€¦
    485|     expect(auditCount).toBeGreaterThan(0);
       |                        ^
    486|   });
    487| });

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[5/10]âŽ¯

 FAIL  tests/integration/handlers/auth-handlers.test.js > POST /auth/verify-email > should log email verification event
AssertionError: expected 0 to be greater than 0
 â¯ tests/integration/handlers/auth-handlers.test.js:625:24
    623| 
    624|     const auditCount = await countTestRecords('audit_log', { event_typâ€¦
    625|     expect(auditCount).toBeGreaterThan(0);
       |                        ^
    626|   });
    627| });

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[6/10]âŽ¯

 FAIL  tests/integration/handlers/auth-handlers.test.js > POST /auth/request-password-reset > should log password reset request
AssertionError: expected 0 to be greater than 0
 â¯ tests/integration/handlers/auth-handlers.test.js:811:24
    809| 
    810|     const auditCount = await countTestRecords('audit_log', { event_typâ€¦
    811|     expect(auditCount).toBeGreaterThan(0);
       |                        ^
    812|   });
    813| });

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[7/10]âŽ¯

 FAIL  tests/integration/handlers/auth-handlers.test.js > POST /auth/reset-password > should log password reset event
AssertionError: expected 0 to be greater than 0
 â¯ tests/integration/handlers/auth-handlers.test.js:993:24
    991| 
    992|     const auditCount = await countTestRecords('audit_log', { event_typâ€¦
    993|     expect(auditCount).toBeGreaterThan(0);
       |                        ^
    994|   });
    995| });

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[8/10]âŽ¯

 FAIL  tests/integration/handlers/auth-handlers.test.js > POST /auth/logout > should log logout event
AssertionError: expected 0 to be greater than 0
 â¯ tests/integration/handlers/auth-handlers.test.js:1072:24
    1070| 
    1071|     const auditCount = await countTestRecords('audit_log', { event_typâ€¦
    1072|     expect(auditCount).toBeGreaterThan(0);
       |                        ^
    1073|   });
    1074| });

âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[9/10]âŽ¯


 Test Files  3 failed | 7 passed (10)
      Tests  10 failed | 268 passed (278)
   Start at  21:45:47
   Duration  997.26s (transform 2.25s, setup 216.71s, collect 2.34s, tests 758.31s, environment 2ms, prepare 9.05s)


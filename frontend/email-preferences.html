<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Email Preferences - Manuscript Hub</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 24px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 32px;
      text-align: center;
    }

    .header h1 {
      font-size: 32px;
      margin-bottom: 8px;
    }

    .header p {
      font-size: 16px;
      opacity: 0.9;
    }

    .content {
      padding: 32px;
    }

    .section {
      margin-bottom: 32px;
    }

    .section-title {
      font-size: 20px;
      font-weight: 600;
      color: #1a202c;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 2px solid #e2e8f0;
    }

    .preference-item {
      display: flex;
      align-items: flex-start;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 12px;
      background: #f7fafc;
      transition: background 0.2s;
    }

    .preference-item:hover {
      background: #edf2f7;
    }

    .preference-item.critical {
      background: #fef5e7;
      border-left: 4px solid #f59e0b;
    }

    .preference-content {
      flex: 1;
    }

    .preference-title {
      font-size: 16px;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 4px;
    }

    .preference-description {
      font-size: 14px;
      color: #718096;
      line-height: 1.5;
    }

    .toggle-switch {
      position: relative;
      width: 48px;
      height: 24px;
      margin-left: 16px;
      flex-shrink: 0;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #cbd5e0;
      transition: .3s;
      border-radius: 24px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    input:checked + .slider:before {
      transform: translateX(24px);
    }

    input:disabled + .slider {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .actions {
      display: flex;
      gap: 16px;
      padding-top: 24px;
      border-top: 2px solid #e2e8f0;
    }

    .btn {
      flex: 1;
      padding: 14px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
    }

    .btn-secondary:hover {
      background: #f7fafc;
    }

    .btn-danger {
      background: white;
      color: #e53e3e;
      border: 2px solid #e53e3e;
    }

    .btn-danger:hover {
      background: #fff5f5;
    }

    .notification {
      position: fixed;
      top: 24px;
      right: 24px;
      padding: 16px 24px;
      border-radius: 8px;
      background: white;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      display: none;
      align-items: center;
      gap: 12px;
      z-index: 1000;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .notification.success {
      border-left: 4px solid #10b981;
    }

    .notification.error {
      border-left: 4px solid #e53e3e;
    }

    .notification-icon {
      font-size: 24px;
    }

    .notification-text {
      font-size: 14px;
      color: #2d3748;
    }

    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: white;
      text-decoration: none;
      margin-bottom: 16px;
      opacity: 0.9;
      transition: opacity 0.2s;
    }

    .back-link:hover {
      opacity: 1;
    }

    .loading {
      text-align: center;
      padding: 48px;
      color: #718096;
    }

    .spinner {
      border: 3px solid #e2e8f0;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .info-box {
      background: #e6f7ff;
      border-left: 4px solid #1890ff;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 24px;
      font-size: 14px;
      color: #2d3748;
      line-height: 1.6;
    }

    @media (max-width: 768px) {
      body {
        padding: 0;
      }

      .container {
        border-radius: 0;
      }

      .header, .content {
        padding: 24px 16px;
      }

      .actions {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <a href="/dashboard-spa.html" class="back-link">
        <span>←</span>
        <span>Back to Dashboard</span>
      </a>
      <h1>Email Notifications</h1>
      <p>Manage which emails you'd like to receive from Manuscript Hub</p>
    </div>

    <div class="content" id="content">
      <div class="loading">
        <div class="spinner"></div>
        <p>Loading your preferences...</p>
      </div>
    </div>
  </div>

  <div class="notification" id="notification">
    <span class="notification-icon" id="notificationIcon"></span>
    <span class="notification-text" id="notificationText"></span>
  </div>

  <script>
    const API_BASE = 'https://scarter4workmanuscripthub.com';

    // Notification types with descriptions
    const NOTIFICATION_TYPES = {
      analysis_complete: {
        title: 'Analysis Complete',
        description: 'Receive an email when your manuscript analysis finishes'
      },
      asset_generation_complete: {
        title: 'Marketing Assets Ready',
        description: 'Notification when book descriptions, keywords, and covers are generated'
      },
      payment_confirmation: {
        title: 'Payment Confirmations',
        description: 'Receipts and confirmations when your subscription is created or renewed'
      },
      payment_failed: {
        title: 'Payment Failures',
        description: 'Critical alerts when payment fails - always sent regardless of preferences',
        critical: true
      },
      usage_warning: {
        title: 'Usage Warnings',
        description: 'Alerts when approaching your manuscript limit (80%, 90%, 100%)'
      },
      dmca_notification: {
        title: 'DMCA Notices',
        description: 'Important legal notifications about DMCA claims - always sent',
        critical: true
      },
      team_invitation: {
        title: 'Team Invitations',
        description: 'Receive invitations to join teams (Enterprise tier)'
      },
      team_activity: {
        title: 'Team Activity',
        description: 'Updates when team members share manuscripts or make changes'
      },
      weekly_digest: {
        title: 'Weekly Digest',
        description: 'Weekly summary of your usage stats and recommendations'
      },
      admin_alerts: {
        title: 'Admin Alerts',
        description: 'Administrative alerts about new signups and platform activity (admin only)'
      }
    };

    let preferences = {};

    // Show notification
    function showNotification(message, type = 'success') {
      const notification = document.getElementById('notification');
      const icon = document.getElementById('notificationIcon');
      const text = document.getElementById('notificationText');

      notification.className = `notification ${type}`;
      icon.textContent = type === 'success' ? '✅' : '❌';
      text.textContent = message;

      notification.style.display = 'flex';

      setTimeout(() => {
        notification.style.display = 'none';
      }, 4000);
    }

    // Load preferences
    async function loadPreferences() {
      try {
        const token = localStorage.getItem('token');
        if (!token) {
          window.location.href = '/login.html';
          return;
        }

        const response = await fetch(`${API_BASE}/user/email-preferences`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          throw new Error('Failed to load preferences');
        }

        preferences = await response.json();
        renderPreferences();
      } catch (error) {
        console.error('Error loading preferences:', error);
        showNotification('Failed to load preferences', 'error');
      }
    }

    // Render preferences UI
    function renderPreferences() {
      const content = document.getElementById('content');

      const html = `
        <div class="info-box">
          <strong>About Email Notifications:</strong><br>
          You can customize which types of emails you receive. Critical notifications (payment failures and DMCA notices)
          will always be sent regardless of your preferences to ensure you don't miss important information.
        </div>

        <div class="section">
          <h2 class="section-title">Analysis & Generation</h2>
          ${renderPreference('analysis_complete')}
          ${renderPreference('asset_generation_complete')}
        </div>

        <div class="section">
          <h2 class="section-title">Billing & Account</h2>
          ${renderPreference('payment_confirmation')}
          ${renderPreference('payment_failed')}
          ${renderPreference('usage_warning')}
        </div>

        <div class="section">
          <h2 class="section-title">Team Collaboration</h2>
          ${renderPreference('team_invitation')}
          ${renderPreference('team_activity')}
        </div>

        <div class="section">
          <h2 class="section-title">Other Notifications</h2>
          ${renderPreference('weekly_digest')}
          ${renderPreference('dmca_notification')}
          ${renderPreference('admin_alerts')}
        </div>

        <div class="actions">
          <button class="btn btn-primary" onclick="savePreferences()">Save Preferences</button>
          <button class="btn btn-secondary" onclick="enableAll()">Enable All</button>
          <button class="btn btn-danger" onclick="disableAll()">Disable All</button>
        </div>
      `;

      content.innerHTML = html;
    }

    // Render individual preference toggle
    function renderPreference(key) {
      const pref = NOTIFICATION_TYPES[key];
      const checked = preferences[key] ? 'checked' : '';
      const disabled = pref.critical ? 'disabled' : '';
      const criticalClass = pref.critical ? 'critical' : '';

      return `
        <div class="preference-item ${criticalClass}">
          <div class="preference-content">
            <div class="preference-title">${pref.title}</div>
            <div class="preference-description">${pref.description}</div>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="${key}" ${checked} ${disabled} onchange="togglePreference('${key}')">
            <span class="slider"></span>
          </label>
        </div>
      `;
    }

    // Toggle individual preference
    function togglePreference(key) {
      const checkbox = document.getElementById(key);
      preferences[key] = checkbox.checked;
    }

    // Save preferences
    async function savePreferences() {
      try {
        const token = localStorage.getItem('token');
        if (!token) {
          window.location.href = '/login.html';
          return;
        }

        const response = await fetch(`${API_BASE}/user/email-preferences`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(preferences)
        });

        if (!response.ok) {
          throw new Error('Failed to save preferences');
        }

        preferences = await response.json();
        showNotification('Preferences saved successfully!', 'success');
      } catch (error) {
        console.error('Error saving preferences:', error);
        showNotification('Failed to save preferences', 'error');
      }
    }

    // Enable all non-critical notifications
    function enableAll() {
      for (const key in NOTIFICATION_TYPES) {
        if (!NOTIFICATION_TYPES[key].critical) {
          preferences[key] = true;
          const checkbox = document.getElementById(key);
          if (checkbox) checkbox.checked = true;
        }
      }
      showNotification('All notifications enabled', 'success');
    }

    // Disable all non-critical notifications
    function disableAll() {
      for (const key in NOTIFICATION_TYPES) {
        if (!NOTIFICATION_TYPES[key].critical) {
          preferences[key] = false;
          const checkbox = document.getElementById(key);
          if (checkbox) checkbox.checked = false;
        }
      }
      showNotification('Non-critical notifications disabled', 'success');
    }

    // Initialize on page load
    loadPreferences();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submission Packages - ManuscriptHub</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .header h1 { font-size: 2em; margin-bottom: 5px; }
        .header p { font-size: 0.9em; opacity: 0.9; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .card { background: white; border-radius: 12px; padding: 30px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        h2 { margin-bottom: 20px; color: #333; }
        h3 { margin: 20px 0 10px; color: #667eea; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        input, select, textarea { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #667eea; }
        .btn { padding: 14px 28px; font-size: 16px; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4); }
        .btn-secondary { background: #6c757d; color: white; margin-left: 10px; }
        .btn-small { padding: 8px 16px; font-size: 14px; margin-right: 10px; }
        .template-card { background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #667eea; cursor: pointer; transition: all 0.3s; }
        .template-card:hover { background: #e9ecef; transform: translateX(5px); }
        .template-card.selected { background: #e7f3ff; border-left-color: #0066cc; }
        .template-card h4 { color: #667eea; margin-bottom: 5px; }
        .template-card .badge { display: inline-block; padding: 4px 10px; background: #667eea; color: white; border-radius: 12px; font-size: 12px; margin-top: 5px; }
        .package-item { background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #667eea; }
        .package-item h3 { color: #667eea; margin-bottom: 10px; }
        .package-meta { font-size: 0.9em; color: #666; margin: 10px 0; }
        .loading { display: none; text-align: center; padding: 20px; }
        .loading.active { display: block; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .alert { padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .alert-success { background: #d1fae5; border: 2px solid #10b981; color: #065f46; }
        .alert-error { background: #fecaca; border: 2px solid #ef4444; color: #991b1b; }
        .document-selector { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin: 15px 0; }
        .document-checkbox { padding: 15px; background: #f8f9fa; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.3s; }
        .document-checkbox:hover { background: #e9ecef; }
        .document-checkbox.selected { background: #e7f3ff; border-color: #667eea; }
        .document-checkbox input[type="checkbox"] { margin-right: 8px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .hidden { display: none; }
    </style>
    <!-- JSZip for creating ZIP files client-side -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>
    <div class="header">
        <h1>Submission Packages</h1>
        <p>Bundle manuscripts with supporting documents for publisher submissions</p>
    </div>

    <div class="container">
        <!-- Manuscript Selection -->
        <div class="card">
            <h2>Select Manuscript</h2>
            <div class="form-group">
                <select id="manuscriptSelect">
                    <option value="">-- Select manuscript --</option>
                </select>
            </div>
        </div>

        <!-- Create Package Section -->
        <div id="createPackageSection" class="hidden">
            <div class="card">
                <h2>Create Submission Package</h2>

                <!-- Template Selection -->
                <h3>Choose a Template</h3>
                <div id="templates"></div>

                <!-- Custom Package Form -->
                <div id="customPackageForm" class="hidden">
                    <h3>Package Details</h3>
                    <div class="form-group">
                        <label>Package Name</label>
                        <input type="text" id="packageName" placeholder="e.g., Query to Agent XYZ">
                    </div>
                    <div class="form-group">
                        <label>Description (optional)</label>
                        <textarea id="packageDescription" rows="3" placeholder="Notes about this submission"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Target Publisher/Agent (optional)</label>
                        <input type="text" id="targetPublisher" placeholder="e.g., Jane Doe Literary Agency">
                    </div>

                    <h3>Select Documents</h3>
                    <div id="documentSelector" class="document-selector"></div>

                    <button class="btn btn-primary" onclick="createPackage()">Create Package</button>
                    <button class="btn btn-secondary" onclick="cancelCreate()">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p style="margin-top: 15px; color: #667eea;">Processing...</p>
        </div>

        <!-- Existing Packages -->
        <div id="packagesSection" class="hidden">
            <div class="card">
                <h2>Your Submission Packages</h2>
                <div id="packagesList"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let authToken = localStorage.getItem('authToken');
        let currentManuscriptId = null;
        let selectedTemplate = null;
        let availableDocuments = [];

        if (!authToken) window.location.href = '/login.html';

        async function init() {
            // Load manuscripts
            const res = await fetch(`${API_BASE}/manuscripts`, {
                headers: { 'Authorization': `Bearer ${authToken}` }
            });
            const data = await res.json();
            const select = document.getElementById('manuscriptSelect');
            (data.manuscripts || []).forEach(ms => {
                const opt = document.createElement('option');
                opt.value = ms.id;
                opt.textContent = ms.title || ms.original_filename;
                select.appendChild(opt);
            });
        }

        document.getElementById('manuscriptSelect').addEventListener('change', async (e) => {
            currentManuscriptId = e.target.value;
            if (currentManuscriptId) {
                await loadTemplatesAndDocuments();
                await loadPackages();
                document.getElementById('createPackageSection').classList.remove('hidden');
                document.getElementById('packagesSection').classList.remove('hidden');
            } else {
                document.getElementById('createPackageSection').classList.add('hidden');
                document.getElementById('packagesSection').classList.add('hidden');
            }
        });

        async function loadTemplatesAndDocuments() {
            try {
                const res = await fetch(`${API_BASE}/manuscripts/${currentManuscriptId}/packages/templates`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await res.json();

                availableDocuments = data.availableDocuments || [];
                displayTemplates(data.templates);
            } catch (error) {
                showAlert('Error loading templates: ' + error.message, 'error');
            }
        }

        function displayTemplates(templates) {
            const container = document.getElementById('templates');
            container.innerHTML = Object.entries(templates).map(([key, template]) => `
                <div class="template-card" onclick="selectTemplate('${key}', ${JSON.stringify(template).replace(/"/g, '&quot;')})">
                    <h4>${template.name}</h4>
                    <p>${template.description}</p>
                    <span class="badge">${template.packageType}</span>
                    <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                        ${template.notes}
                    </div>
                </div>
            `).join('');
        }

        function selectTemplate(key, template) {
            selectedTemplate = template;

            // Highlight selected template
            document.querySelectorAll('.template-card').forEach(card => card.classList.remove('selected'));
            event.target.closest('.template-card').classList.add('selected');

            // Show custom form
            document.getElementById('customPackageForm').classList.remove('hidden');

            // Pre-fill package name
            document.getElementById('packageName').value = template.name;

            // Load document selector
            displayDocumentSelector(template);
        }

        function displayDocumentSelector(template) {
            const container = document.getElementById('documentSelector');
            const requiredDocs = template.requiredDocuments || [];
            const optionalDocs = template.optionalDocuments || [];

            container.innerHTML = availableDocuments.map(doc => {
                const isRequired = requiredDocs.includes(doc.document_type);
                const isOptional = optionalDocs.includes(doc.document_type);
                const checked = isRequired ? 'checked' : '';
                const disabled = isRequired ? 'disabled' : '';

                return `
                    <div class="document-checkbox ${checked ? 'selected' : ''}" onclick="toggleDocument(this, '${doc.id}', '${doc.document_type}')">
                        <input type="checkbox" ${checked} ${disabled} data-doc-id="${doc.id}" data-doc-type="${doc.document_type}">
                        <strong>${doc.document_type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</strong>
                        <div style="font-size: 0.9em; color: #666;">
                            ${doc.word_count} words | v${doc.version_number}
                        </div>
                        ${isRequired ? '<div style="font-size: 0.8em; color: #10b981;">âœ“ Required</div>' : ''}
                    </div>
                `;
            }).join('');
        }

        function toggleDocument(element, docId, docType) {
            const checkbox = element.querySelector('input[type="checkbox"]');
            if (!checkbox.disabled) {
                checkbox.checked = !checkbox.checked;
                element.classList.toggle('selected', checkbox.checked);
            }
        }

        async function createPackage() {
            const packageName = document.getElementById('packageName').value;
            const description = document.getElementById('packageDescription').value;
            const targetPublisher = document.getElementById('targetPublisher').value;

            if (!packageName) {
                showAlert('Package name is required', 'error');
                return;
            }

            // Get selected documents
            const selectedDocs = [];
            document.querySelectorAll('#documentSelector input[type="checkbox"]:checked').forEach((checkbox, index) => {
                selectedDocs.push({
                    id: checkbox.dataset.docId,
                    type: checkbox.dataset.docType,
                    order: index + 1,
                    includeFull: true
                });
            });

            if (selectedDocs.length === 0) {
                showAlert('Please select at least one document', 'error');
                return;
            }

            showLoading(true);
            try {
                const res = await fetch(`${API_BASE}/manuscripts/${currentManuscriptId}/packages`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        packageName: packageName,
                        packageType: selectedTemplate?.packageType || 'custom',
                        description: description,
                        documents: selectedDocs,
                        metadata: {
                            targetPublisher: targetPublisher,
                            templateUsed: selectedTemplate?.name
                        }
                    })
                });
                const data = await res.json();
                if (data.success) {
                    showAlert('Package created successfully!', 'success');
                    cancelCreate();
                    await loadPackages();
                } else {
                    showAlert(data.error || 'Failed to create package', 'error');
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
            showLoading(false);
        }

        function cancelCreate() {
            document.getElementById('customPackageForm').classList.add('hidden');
            document.getElementById('packageName').value = '';
            document.getElementById('packageDescription').value = '';
            document.getElementById('targetPublisher').value = '';
            selectedTemplate = null;
            document.querySelectorAll('.template-card').forEach(card => card.classList.remove('selected'));
        }

        async function loadPackages() {
            try {
                const res = await fetch(`${API_BASE}/manuscripts/${currentManuscriptId}/packages`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await res.json();
                displayPackages(data.packages || []);
            } catch (error) {
                console.error('Error loading packages:', error);
            }
        }

        function displayPackages(packages) {
            const container = document.getElementById('packagesList');
            if (packages.length === 0) {
                container.innerHTML = '<p>No packages yet. Create one above!</p>';
                return;
            }

            container.innerHTML = packages.map(pkg => `
                <div class="package-item">
                    <h3>${pkg.package_name}</h3>
                    <div class="package-meta">
                        <strong>Type:</strong> ${pkg.package_type} |
                        <strong>Documents:</strong> ${pkg.document_count} |
                        <strong>Created:</strong> ${new Date(pkg.created_at * 1000).toLocaleDateString()}
                    </div>
                    <button class="btn btn-primary btn-small" onclick="downloadPackage('${pkg.id}', '${pkg.package_name}')">Download ZIP</button>
                    <button class="btn btn-secondary btn-small" onclick="duplicatePackage('${pkg.id}')">Duplicate</button>
                    <button class="btn btn-secondary btn-small" onclick="deletePackage('${pkg.id}')">Delete</button>
                </div>
            `).join('');
        }

        async function downloadPackage(packageId, packageName) {
            showLoading(true);
            try {
                const res = await fetch(`${API_BASE}/manuscripts/${currentManuscriptId}/packages/${packageId}/download`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await res.json();

                if (data.success && data.files) {
                    // Create ZIP using JSZip
                    const zip = new JSZip();
                    data.files.forEach(file => {
                        zip.file(file.name, file.content);
                    });

                    // Generate ZIP and download
                    const blob = await zip.generateAsync({type: 'blob'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${packageName.replace(/[^a-z0-9]/gi, '_')}.zip`;
                    a.click();
                    URL.revokeObjectURL(url);

                    showAlert('Package downloaded successfully!', 'success');
                } else {
                    showAlert(data.error || 'Failed to download package', 'error');
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
            showLoading(false);
        }

        async function duplicatePackage(packageId) {
            const newName = prompt('Enter name for duplicate package:');
            if (!newName) return;

            showLoading(true);
            try {
                const res = await fetch(`${API_BASE}/manuscripts/${currentManuscriptId}/packages/${packageId}/duplicate`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ newPackageName: newName })
                });
                const data = await res.json();
                if (data.success) {
                    showAlert('Package duplicated successfully!', 'success');
                    await loadPackages();
                } else {
                    showAlert(data.error || 'Failed to duplicate package', 'error');
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
            showLoading(false);
        }

        async function deletePackage(packageId) {
            if (!confirm('Are you sure you want to delete this package?')) return;

            showLoading(true);
            try {
                const res = await fetch(`${API_BASE}/manuscripts/${currentManuscriptId}/packages/${packageId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await res.json();
                if (data.success) {
                    showAlert('Package deleted successfully!', 'success');
                    await loadPackages();
                } else {
                    showAlert(data.error || 'Failed to delete package', 'error');
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
            showLoading(false);
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('active', show);
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);
            setTimeout(() => alertDiv.remove(), 5000);
        }

        init();
    </script>
</body>
</html>

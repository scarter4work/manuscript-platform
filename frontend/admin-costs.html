<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cost Tracking - Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .nav-menu {
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .nav-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            gap: 5px;
            overflow-x: auto;
        }

        .nav-item {
            padding: 15px 20px;
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .nav-item:hover {
            background: #f8f9fa;
            border-bottom-color: #667eea;
        }

        .nav-item.active {
            border-bottom-color: #667eea;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px 40px;
        }

        .section-title {
            font-size: 1.5em;
            margin: 30px 0 20px;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #333;
        }

        .stat-value.warning {
            color: #ff9800;
        }

        .stat-value.danger {
            color: #f44336;
        }

        .stat-value.success {
            color: #4caf50;
        }

        .stat-subtitle {
            font-size: 0.9em;
            color: #999;
            margin-top: 5px;
        }

        .budget-progress {
            margin-top: 15px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            transition: width 0.3s ease;
        }

        .progress-fill.warning {
            background: linear-gradient(90deg, #ff9800, #ffc107);
        }

        .progress-fill.danger {
            background: linear-gradient(90deg, #f44336, #e91e63);
        }

        .breakdown-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .breakdown-label {
            font-weight: 600;
            color: #666;
        }

        .breakdown-value {
            font-weight: bold;
            color: #333;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            overflow: hidden;
        }

        .card-header {
            padding: 20px 25px;
            border-bottom: 1px solid #e0e0e0;
            background: #fafafa;
        }

        .card-header h2 {
            font-size: 1.2em;
            color: #333;
        }

        .card-body {
            padding: 25px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 12px;
            background: #f8f9fa;
            color: #666;
            font-weight: 600;
            border-bottom: 2px solid #e0e0e0;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #666;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
        }

        .alert-danger {
            background: #f8d7da;
            border: 1px solid #f44336;
            color: #721c24;
        }

        .alert-info {
            background: #d1ecf1;
            border: 1px solid #0dcaf0;
            color: #0c5460;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #f44336;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge-success {
            background: #4caf50;
            color: white;
        }

        .badge-warning {
            background: #ff9800;
            color: white;
        }

        .badge-danger {
            background: #f44336;
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid #e0e0e0;
        }

        .modal-body {
            padding: 25px;
        }

        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>üí∞ Cost Tracking & Budget Management</h1>
            <p>Monitor operational costs and manage monthly budgets</p>
        </div>
    </div>

    <nav class="nav-menu">
        <div class="nav-content">
            <a href="/dashboard-spa.html" class="nav-item">‚Üê My Manuscripts</a>
            <a href="/admin-dashboard.html" class="nav-item">Dashboard</a>
            <a href="/admin-users.html" class="nav-item">Users</a>
            <a href="/admin-manuscripts.html" class="nav-item">Manuscripts</a>
            <a href="/admin-billing.html" class="nav-item">Billing</a>
            <a href="/admin-costs.html" class="nav-item active">Costs</a>
            <a href="/admin-analytics.html" class="nav-item">Analytics</a>
            <a href="/admin-dmca.html" class="nav-item">DMCA</a>
        </div>
    </nav>

    <div class="container">
        <div id="loading" class="loading">
            <p>Loading cost data...</p>
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div id="content" style="display: none;">
            <!-- Budget Overview -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Monthly Budget</h3>
                    <div class="stat-value" id="budgetLimit">$0</div>
                    <div class="budget-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="budgetProgress" style="width: 0%"></div>
                        </div>
                        <div class="stat-subtitle" id="budgetUsage">0% used</div>
                    </div>
                </div>
                <div class="stat-card">
                    <h3>Current Spend</h3>
                    <div class="stat-value" id="currentSpend">$0</div>
                    <div class="stat-subtitle" id="remaining">$0 remaining</div>
                </div>
                <div class="stat-card">
                    <h3>Total Operations</h3>
                    <div class="stat-value" id="totalOps">0</div>
                    <div class="stat-subtitle">This month</div>
                </div>
                <div class="stat-card">
                    <h3>Claude API Tokens</h3>
                    <div class="stat-value" id="totalTokens">0</div>
                    <div class="stat-subtitle" id="tokenBreakdown">0 in / 0 out</div>
                </div>
            </div>

            <!-- Budget Alerts -->
            <div id="alertsContainer"></div>

            <!-- Cost Breakdown -->
            <div class="card">
                <div class="card-header">
                    <h2>Cost Breakdown by Service</h2>
                </div>
                <div class="card-body">
                    <div class="breakdown-grid" id="costBreakdown"></div>
                </div>
            </div>

            <!-- Top Features -->
            <div class="card">
                <div class="card-header">
                    <h2>Top Cost-Generating Features</h2>
                </div>
                <div class="card-body">
                    <table id="featureTable">
                        <thead>
                            <tr>
                                <th>Feature</th>
                                <th>Cost Center</th>
                                <th>Operations</th>
                                <th>Total Cost</th>
                                <th>Avg Cost</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Top Spenders -->
            <div class="card">
                <div class="card-header">
                    <h2>Top Spending Users</h2>
                </div>
                <div class="card-body">
                    <table id="spendersTable">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Tier</th>
                                <th>Manuscripts</th>
                                <th>Total Spent</th>
                                <th>Monthly Limit</th>
                                <th>Usage</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Budget Configuration -->
            <div class="section-title">
                <span>Budget Configuration</span>
                <button class="btn btn-primary" onclick="openBudgetModal()">Edit Budget Settings</button>
            </div>
        </div>
    </div>

    <!-- Budget Configuration Modal -->
    <div id="budgetModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Budget Configuration</h2>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Monthly Budget Limit (USD)</label>
                    <input type="number" id="monthlyLimit" step="0.01" min="0" placeholder="2000.00">
                </div>
                <div class="form-group">
                    <label>Daily Budget Limit (USD) - Optional</label>
                    <input type="number" id="dailyLimit" step="0.01" min="0" placeholder="200.00">
                </div>
                <div class="form-group">
                    <label>Alert Thresholds</label>
                    <div class="checkbox-group">
                        <input type="checkbox" id="alert50">
                        <label for="alert50">50% threshold</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="alert75">
                        <label for="alert75">75% threshold</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="alert90">
                        <label for="alert90">90% threshold</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="alert100">
                        <label for="alert100">100% threshold</label>
                    </div>
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="autoDisable">
                        <label for="autoDisable">Auto-disable expensive features at 100% budget</label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeBudgetModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveBudgetConfig()">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;

        async function fetchWithAuth(url, options = {}) {
            const response = await fetch(url, {
                ...options,
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });

            if (response.status === 401) {
                window.location.href = '/login.html';
                return null;
            }

            return response;
        }

        async function loadCostData() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('error').style.display = 'none';
                document.getElementById('content').style.display = 'none';

                // Fetch cost overview
                const overviewRes = await fetchWithAuth(`${API_BASE}/admin/costs/overview`);
                if (!overviewRes) return;

                const overviewData = await overviewRes.json();

                if (!overviewData.success) {
                    throw new Error(overviewData.error || 'Failed to load cost data');
                }

                const { budget, monthlyStats, topFeatures } = overviewData.data;

                // Update budget overview
                document.getElementById('budgetLimit').textContent = `$${budget.monthlyLimit.toFixed(2)}`;
                document.getElementById('currentSpend').textContent = `$${budget.currentSpend.toFixed(2)}`;
                document.getElementById('remaining').textContent = `$${budget.remaining.toFixed(2)} remaining`;
                document.getElementById('budgetUsage').textContent = `${budget.usagePercent.toFixed(1)}% used`;

                // Update progress bar
                const progressBar = document.getElementById('budgetProgress');
                progressBar.style.width = `${Math.min(budget.usagePercent, 100)}%`;
                progressBar.className = 'progress-fill';
                if (budget.usagePercent >= 90) {
                    progressBar.classList.add('danger');
                } else if (budget.usagePercent >= 75) {
                    progressBar.classList.add('warning');
                }

                // Update stats
                document.getElementById('totalOps').textContent = monthlyStats.totalOperations.toLocaleString();
                document.getElementById('totalTokens').textContent = (monthlyStats.tokens.input + monthlyStats.tokens.output).toLocaleString();
                document.getElementById('tokenBreakdown').textContent = `${monthlyStats.tokens.input.toLocaleString()} in / ${monthlyStats.tokens.output.toLocaleString()} out`;

                // Update cost breakdown
                const breakdownContainer = document.getElementById('costBreakdown');
                breakdownContainer.innerHTML = `
                    <div class="breakdown-item">
                        <span class="breakdown-label">Claude API</span>
                        <span class="breakdown-value">$${monthlyStats.breakdown.claude.toFixed(2)}</span>
                    </div>
                    <div class="breakdown-item">
                        <span class="breakdown-label">Stripe Fees</span>
                        <span class="breakdown-value">$${monthlyStats.breakdown.stripe.toFixed(2)}</span>
                    </div>
                    <div class="breakdown-item">
                        <span class="breakdown-label">Cloudflare</span>
                        <span class="breakdown-value">$${monthlyStats.breakdown.cloudflare.toFixed(2)}</span>
                    </div>
                    <div class="breakdown-item">
                        <span class="breakdown-label">Email</span>
                        <span class="breakdown-value">$${monthlyStats.breakdown.email.toFixed(2)}</span>
                    </div>
                `;

                // Load features
                await loadFeatures();

                // Load top spenders
                await loadTopSpenders();

                // Load alerts
                await loadAlerts();

                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';

            } catch (error) {
                console.error('Error loading cost data:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = `Error: ${error.message}`;
            }
        }

        async function loadFeatures() {
            const res = await fetchWithAuth(`${API_BASE}/admin/costs/features`);
            if (!res) return;

            const data = await res.json();
            if (!data.success) return;

            const tbody = document.querySelector('#featureTable tbody');
            tbody.innerHTML = data.data.map(feature => `
                <tr>
                    <td>${feature.feature_name}</td>
                    <td>${feature.cost_center}</td>
                    <td>${feature.operation_count}</td>
                    <td>$${feature.total_cost_usd.toFixed(4)}</td>
                    <td>$${feature.avg_cost_usd.toFixed(4)}</td>
                </tr>
            `).join('');
        }

        async function loadTopSpenders() {
            const res = await fetchWithAuth(`${API_BASE}/admin/costs/top-users?limit=20`);
            if (!res) return;

            const data = await res.json();
            if (!data.success) return;

            const tbody = document.querySelector('#spendersTable tbody');
            tbody.innerHTML = data.data.map(user => `
                <tr>
                    <td>${user.email}</td>
                    <td><span class="badge badge-${user.subscription_tier === 'ENTERPRISE' ? 'danger' : user.subscription_tier === 'PRO' ? 'warning' : 'success'}">${user.subscription_tier}</span></td>
                    <td>${user.manuscripts}</td>
                    <td>$${user.total_spent_usd.toFixed(2)}</td>
                    <td>$${user.monthly_limit_usd.toFixed(2)}</td>
                    <td>${user.limit_usage_percent.toFixed(1)}%</td>
                </tr>
            `).join('');
        }

        async function loadAlerts() {
            const res = await fetchWithAuth(`${API_BASE}/admin/costs/alerts?acknowledged=false`);
            if (!res) return;

            const data = await res.json();
            if (!data.success) return;

            const container = document.getElementById('alertsContainer');
            if (data.data.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = data.data.map(alert => `
                <div class="alert alert-${alert.severity === 'critical' ? 'danger' : 'warning'}">
                    <div style="flex: 1;">
                        <strong>${alert.alert_type.replace('_', ' ').toUpperCase()}</strong>
                        <p>${alert.message}</p>
                    </div>
                    <button class="btn btn-secondary" onclick="acknowledgeAlert('${alert.id}')">Acknowledge</button>
                </div>
            `).join('');
        }

        async function acknowledgeAlert(alertId) {
            try {
                const res = await fetchWithAuth(`${API_BASE}/admin/costs/alerts/${alertId}/acknowledge`, {
                    method: 'PATCH'
                });

                if (res) {
                    await loadAlerts();
                }
            } catch (error) {
                console.error('Error acknowledging alert:', error);
            }
        }

        function openBudgetModal() {
            document.getElementById('budgetModal').classList.add('active');
        }

        function closeBudgetModal() {
            document.getElementById('budgetModal').classList.remove('active');
        }

        async function saveBudgetConfig() {
            try {
                const config = {
                    monthlyLimit: parseFloat(document.getElementById('monthlyLimit').value),
                    dailyLimit: parseFloat(document.getElementById('dailyLimit').value) || null,
                    alertThreshold50: document.getElementById('alert50').checked,
                    alertThreshold75: document.getElementById('alert75').checked,
                    alertThreshold90: document.getElementById('alert90').checked,
                    alertThreshold100: document.getElementById('alert100').checked,
                    autoDisableAtLimit: document.getElementById('autoDisable').checked,
                };

                const res = await fetchWithAuth(`${API_BASE}/admin/costs/budget`, {
                    method: 'PATCH',
                    body: JSON.stringify(config)
                });

                if (res) {
                    const data = await res.json();
                    if (data.success) {
                        closeBudgetModal();
                        await loadCostData();
                    } else {
                        alert('Error saving budget config: ' + data.error);
                    }
                }
            } catch (error) {
                console.error('Error saving budget config:', error);
                alert('Error saving budget config');
            }
        }

        // Initialize
        loadCostData();

        // Refresh every 30 seconds
        setInterval(loadCostData, 30000);
    </script>
</body>
</html>
